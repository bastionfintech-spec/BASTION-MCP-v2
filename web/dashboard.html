<!DOCTYPE html>
<html lang="en" class="bg-[#050505] antialiased"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="BASTION Lite ‚Äî AI-powered crypto risk intelligence terminal">
    <meta name="theme-color" content="#050505">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='80'>üõ°Ô∏è</text></svg>">
    <title>BASTION LITE // TERMINAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              crimson: { 400: '#f87171', 500: '#ef4444', 600: '#dc2626', 700: '#b91c1c', 800: '#991b1b', 900: '#7f1d1d', 950: '#450a0a' }
            }
          }
        }
      }
    </script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.2.2/dist/lightweight-charts.standalone.production.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500;700&display=swap');
      body { font-family: 'Inter', sans-serif; }
      .font-mono { font-family: 'JetBrains Mono', monospace; }

      /* Scrollbar */
      .bastion-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
      .bastion-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .bastion-scrollbar::-webkit-scrollbar-thumb { background: #27272a; border-radius: 4px; }
      .bastion-scrollbar::-webkit-scrollbar-thumb:hover { background: #dc2626; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

      /* Grid / Scanline */
      .bg-grid { background-size: 40px 40px; background-image: linear-gradient(to right, rgba(39,39,42,0.4) 1px, transparent 1px), linear-gradient(to bottom, rgba(39,39,42,0.4) 1px, transparent 1px); }
      .scanline { background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.15) 50%, rgba(0,0,0,0.15)); background-size: 100% 4px; pointer-events: none; }

      /* Toggle */
      .toggle-checkbox:checked { right: 0; border-color: #dc2626; }
      .toggle-checkbox:checked + .toggle-label { background-color: #dc2626; }

      /* Typing dots */
      .typing-dot { animation: typingBounce 1.4s infinite ease-in-out both; }
      .typing-dot:nth-child(1) { animation-delay: -0.32s; }
      .typing-dot:nth-child(2) { animation-delay: -0.16s; }
      @keyframes typingBounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

      /* Shield glow */
      .shield-active { box-shadow: 0 0 30px rgba(220,38,38,0.25), inset 0 0 30px rgba(220,38,38,0.08); transition: box-shadow 0.5s ease; }
      @keyframes shieldSweep { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
      .shield-card-active {
        border-left: 2px solid #dc2626 !important;
        background: linear-gradient(90deg, transparent 0%, rgba(220,38,38,0.06) 25%, rgba(220,38,38,0.12) 50%, rgba(220,38,38,0.06) 75%, transparent 100%) !important;
        background-size: 200% 100%; animation: shieldSweep 3s ease-in-out infinite;
        box-shadow: inset 0 0 20px rgba(220,38,38,0.08); transition: all 0.4s ease;
      }
      .shield-card-active::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; border: 1px solid rgba(220,38,38,0.15); pointer-events: none; border-radius: inherit; }
      @keyframes shieldPulse { 0%, 100% { box-shadow: 0 0 8px rgba(220,38,38,0.2), 0 0 16px rgba(220,38,38,0.1); } 50% { box-shadow: 0 0 16px rgba(220,38,38,0.4), 0 0 32px rgba(220,38,38,0.2); } }
      .shield-pulse { animation: shieldPulse 2s ease-in-out infinite; }

      /* Marquee */
      @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
      .animate-marquee { animation: marquee 30s linear infinite; }
      .animate-marquee:hover { animation-play-state: paused; }

      /* Toast */
      @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
      @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
      .toast-in { animation: slideIn 0.3s ease-out forwards; }
      .toast-out { animation: slideOut 0.3s ease-in forwards; }

      /* Pulse glow */
      @keyframes pulseGlow { 0%,100% { box-shadow: 0 0 8px rgba(220,38,38,0.2); } 50% { box-shadow: 0 0 16px rgba(220,38,38,0.5); } }
      .pulse-glow { animation: pulseGlow 2s ease-in-out infinite; }

      /* Animations */
      @keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
      .fade-up { animation: fadeUp 0.4s ease-out forwards; }
      @keyframes msgSlide { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
      .msg-new { animation: msgSlide 0.25s ease-out forwards; }

      /* Position / Report cards */
      .pos-card { transition: all 0.2s ease; cursor: pointer; }
      .pos-card:hover { background: rgba(24,24,27,0.5); }
      .report-card { transition: all 0.2s ease; }
      .report-card:hover { background: rgba(24,24,27,0.4) !important; }

      /* Shield action badges */
      .action-hold { background: rgba(34,197,94,0.1); color: #22c55e; border-color: rgba(34,197,94,0.2); }
      .action-reduce, .action-reduce_size { background: rgba(234,179,8,0.1); color: #eab308; border-color: rgba(234,179,8,0.2); }
      .action-exit, .action-exit_full, .action-exit_100_percent_immediately { background: rgba(239,68,68,0.1); color: #ef4444; border-color: rgba(239,68,68,0.2); }
      .action-tp, .action-tp_partial, .action-tp_full { background: rgba(34,197,94,0.1); color: #22c55e; border-color: rgba(34,197,94,0.2); }
      .action-move_stop_to_breakeven, .action-trail_stop, .action-adjust_stop { background: rgba(59,130,246,0.1); color: #3b82f6; border-color: rgba(59,130,246,0.2); }
      .action-scale_in { background: rgba(59,130,246,0.1); color: #3b82f6; border-color: rgba(59,130,246,0.2); }

      /* Shield analysis panel on position card */
      .shield-analysis {
        margin-top: 8px; padding: 8px 10px; border-radius: 6px;
        border: 1px solid rgba(220,38,38,0.15); background: rgba(220,38,38,0.04);
        font-family: 'JetBrains Mono', monospace;
      }
      .shield-analysis .sa-header { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; }
      .shield-analysis .sa-action-badge { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 4px; border: 1px solid; text-transform: uppercase; letter-spacing: 0.05em; }
      .shield-analysis .sa-confidence { font-size: 9px; color: #71717a; }
      .shield-analysis .sa-reason { font-size: 10px; color: #a1a1aa; line-height: 1.5; margin-bottom: 4px; }
      .shield-analysis .sa-sources { font-size: 8px; color: #52525b; display: flex; align-items: center; gap: 4px; }
      @keyframes shieldFadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
      .shield-analysis { animation: shieldFadeIn 0.3s ease-out forwards; }

      /* Chart loading */
      .chart-loading-bar { position: absolute; top: 0; left: 0; height: 2px; width: 100%; z-index: 20; overflow: hidden; }
      .chart-loading-bar::after { content: ''; position: absolute; top: 0; left: -40%; height: 100%; width: 40%; background: linear-gradient(90deg, transparent, #dc2626, transparent); animation: loadSlide 0.8s ease-in-out infinite; }
      @keyframes loadSlide { 0% { left: -40%; } 100% { left: 100%; } }

      /* Risk gauge */
      .risk-ring { transition: stroke-dashoffset 1s ease-out; }

      /* Safe area */
      .safe-pb { padding-bottom: max(12px, env(safe-area-inset-bottom)); }

      /* Print styles */
      @media print {
        .splash-screen, .scanline, .bg-grid, #fab-btn, #fab-menu, #toast-container,
        #chat-panel, [id="mobile-nav"] { display: none !important; }
        body { background: white !important; color: black !important; }
      }

      /* Mobile scroll fixes */
      @media (max-width: 767px) {
        body { -webkit-overflow-scrolling: touch; touch-action: pan-y; }
        #view-positions:not(.hidden),
        #view-intel:not(.hidden),
        #view-reports:not(.hidden) { min-height: 400px; }
      }

      /* Intel card hover */
      .intel-card { transition: all 0.15s ease; }
      .intel-card:hover { background: rgba(24,24,27,0.3); }

      /* Loading splash */
      .splash-screen {
        position: fixed; inset: 0; z-index: 9999;
        background: #050505;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        transition: opacity 0.5s ease, visibility 0.5s ease;
      }
      .splash-screen.fade-out { opacity: 0; visibility: hidden; }
      @keyframes shieldBoot { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
      .splash-icon { animation: shieldBoot 0.6s ease-out forwards; }
      @keyframes loadingBar { 0% { width: 0%; } 100% { width: 100%; } }
      .splash-bar { height: 2px; background: #dc2626; animation: loadingBar 1.5s ease-out forwards; border-radius: 1px; }

      /* Smooth tab transitions */
      [id^="view-"] { transition: opacity 0.15s ease; }
      [id^="view-"].hidden { opacity: 0; }

      /* Position card divider refinement */
      .pos-card:last-child { border-bottom: none; }

      /* Better focus styles */
      input:focus-visible, button:focus-visible { outline: 1px solid rgba(220,38,38,0.4); outline-offset: 2px; }

      /* Hover lift for position cards */
      .pos-card:hover { transform: translateX(2px); }

      /* Price tick flash */
      @keyframes priceFlash { 0% { opacity: 1; } 100% { opacity: 0; } }
      .price-flash-up { background: rgba(34,197,94,0.15); animation: priceFlash 0.5s ease-out forwards; }
      .price-flash-down { background: rgba(239,68,68,0.15); animation: priceFlash 0.5s ease-out forwards; }

      /* Intel card zebra stripe (subtle) */
      .intel-card:nth-child(even) { background: rgba(9,9,11,0.3); }
    </style>
  </head>
  <body class="bg-[#050505] text-zinc-400 min-h-screen md:h-screen flex flex-col overflow-y-auto md:overflow-hidden selection:bg-red-600/30 selection:text-red-100 relative">
    <!-- Loading Splash -->
    <div id="splash" class="splash-screen">
      <div class="splash-icon flex items-center gap-3 mb-6">
        <img src="/static/bastion-logo.png" alt="BASTION" class="w-10 h-10">
        <div>
          <div class="text-xl font-mono font-bold text-white tracking-tight">BASTION</div>
          <div class="text-[8px] font-mono text-zinc-600 uppercase tracking-[0.3em]">LITE TERMINAL</div>
        </div>
      </div>
      <div class="w-48 bg-zinc-900 rounded-full overflow-hidden">
        <div class="splash-bar"></div>
      </div>
      <div class="mt-4 text-[9px] font-mono text-zinc-700 tracking-widest uppercase">Initializing neural engine...</div>
    </div>

    <div class="absolute inset-0 pointer-events-none opacity-[0.02] bg-grid z-0"></div>
    <div class="absolute inset-0 pointer-events-none opacity-[0.06] scanline z-50 mix-blend-overlay"></div>

    <!-- Header -->
    <header class="h-12 border-b border-zinc-800/80 bg-[#050505]/95 backdrop-blur-md flex items-center justify-between shrink-0 px-3 md:px-6 relative z-40">
      <div class="flex items-center gap-2 md:gap-3">
        <a href="/" class="flex items-center gap-1.5 md:gap-2 group cursor-pointer no-underline">
          <iconify-icon icon="solar:shield-bold" class="text-red-600 text-lg group-hover:scale-110 transition-transform"></iconify-icon>
          <span class="text-sm md:text-base font-mono font-bold tracking-tight text-white group-hover:text-red-500 transition-colors">BASTION</span>
          <span class="text-[7px] md:text-[8px] font-mono bg-red-950/40 text-red-500 px-1 md:px-1.5 py-0.5 rounded border border-red-900/30 tracking-widest">LITE</span>
          <span class="text-[7px] font-mono text-zinc-800 hidden md:inline ml-0.5">v6</span>
        </a>
      </div>
      <!-- Ticker ‚Äî visible on ALL screens -->
      <div id="header-ticker" class="flex items-center gap-1.5 md:gap-3 px-2 md:px-4 py-1 border border-zinc-800/60 bg-zinc-900/20 rounded-full backdrop-blur-sm">
        <span id="ticker-symbol" class="text-[9px] md:text-[11px] font-mono font-bold text-white tracking-wide">BTC-PERP</span>
        <div class="w-px h-3 bg-zinc-800 hidden md:block"></div>
        <span id="ticker-price" class="text-[10px] md:text-[11px] font-mono text-zinc-300">--</span>
        <span id="ticker-change" class="text-[9px] md:text-[10px] font-mono text-zinc-500 bg-zinc-900/30 px-1 md:px-1.5 py-0.5 rounded flex items-center gap-0.5">
          <iconify-icon icon="solar:arrow-right-up-linear" class="text-[9px]"></iconify-icon>--
        </span>
      </div>
      <div class="flex items-center gap-3 md:gap-5">
        <!-- Connection status -->
        <div id="conn-status" class="flex items-center gap-1.5" title="API Status">
          <span class="relative flex h-1.5 w-1.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-500 opacity-40"></span><span id="conn-dot" class="relative inline-flex rounded-full h-1.5 w-1.5 bg-green-500"></span></span>
          <span id="conn-label" class="text-[8px] font-mono text-zinc-600 hidden md:inline">CONNECTED</span>
        </div>
        <nav class="hidden md:flex items-center gap-5 text-[10px] font-mono uppercase tracking-widest">
          <a href="/lite" class="text-white relative after:content-[''] after:absolute after:-bottom-[14px] after:left-0 after:w-full after:h-0.5 after:bg-red-600">Dashboard</a>
          <a href="/frontend" class="text-zinc-500 hover:text-zinc-300 transition-colors flex items-center gap-1">
            <iconify-icon icon="solar:crown-bold" class="text-amber-500/60 text-[9px]"></iconify-icon>Pro
          </a>
          <a href="/monitor" class="text-zinc-500 hover:text-zinc-300 transition-colors">Monitor</a>
          <a href="/account" class="text-zinc-500 hover:text-zinc-300 transition-colors">Account</a>
          <a href="/playground" class="text-zinc-500 hover:text-zinc-300 transition-colors">Playground</a>
          <a href="/usage" class="text-zinc-500 hover:text-zinc-300 transition-colors">Usage</a>
        </nav>
        <button class="md:hidden text-zinc-400 hover:text-white" onclick="document.getElementById('mobile-nav').classList.toggle('hidden')">
          <iconify-icon icon="solar:hamburger-menu-linear" width="20"></iconify-icon>
        </button>
      </div>
    </header>

    <!-- Mobile Nav -->
    <div id="mobile-nav" class="hidden md:hidden absolute top-12 left-0 right-0 z-50 bg-[#080808]/98 backdrop-blur-lg border-b border-zinc-800 px-4 py-3 space-y-1">
      <a href="/lite" class="flex items-center gap-3 px-3 py-2.5 rounded-md bg-red-950/10 border border-red-900/20 text-xs font-mono text-white">
        <iconify-icon icon="solar:shield-bold" class="text-red-600 text-sm"></iconify-icon>Dashboard
        <span class="ml-auto text-[8px] text-red-500/60 font-bold">ACTIVE</span>
      </a>
      <a href="/frontend" class="flex items-center gap-3 px-3 py-2.5 rounded-md hover:bg-zinc-800/50 text-xs font-mono text-zinc-500 hover:text-white transition-all">
        <iconify-icon icon="solar:crown-bold" class="text-amber-500/60 text-sm"></iconify-icon>Pro Terminal
        <span class="ml-auto text-[8px] text-amber-700 border border-amber-900/20 px-1.5 py-0.5 rounded">PRO</span>
      </a>
      <a href="/research" class="flex items-center gap-3 px-3 py-2.5 rounded-md hover:bg-zinc-800/50 text-xs font-mono text-zinc-500 hover:text-white transition-all">
        <iconify-icon icon="solar:document-text-linear" class="text-sm"></iconify-icon>Research
      </a>
      <a href="/monitor" class="flex items-center gap-3 px-3 py-2.5 rounded-md hover:bg-zinc-800/50 text-xs font-mono text-zinc-500 hover:text-white transition-all">
        <iconify-icon icon="solar:chart-2-bold" class="text-sm"></iconify-icon>Monitor
      </a>
      <a href="/account" class="flex items-center gap-3 px-3 py-2.5 rounded-md hover:bg-zinc-800/50 text-xs font-mono text-zinc-500 hover:text-white transition-all">
        <iconify-icon icon="solar:user-circle-linear" class="text-sm"></iconify-icon>Account
      </a>
      <a href="/playground" class="flex items-center gap-3 px-3 py-2.5 rounded-md hover:bg-zinc-800/50 text-xs font-mono text-zinc-500 hover:text-white transition-all">
        <iconify-icon icon="solar:code-square-linear" class="text-sm"></iconify-icon>Playground
      </a>
      <a href="/usage" class="flex items-center gap-3 px-3 py-2.5 rounded-md hover:bg-zinc-800/50 text-xs font-mono text-zinc-500 hover:text-white transition-all">
        <iconify-icon icon="solar:chart-square-linear" class="text-sm"></iconify-icon>Usage
      </a>
      <a href="/presets" class="flex items-center gap-3 px-3 py-2.5 rounded-md hover:bg-zinc-800/50 text-xs font-mono text-zinc-500 hover:text-white transition-all">
        <iconify-icon icon="solar:layers-linear" class="text-sm"></iconify-icon>Presets
      </a>
    </div>

    <!-- Market Pulse Bar ‚Äî hidden on mobile to save space -->
    <div class="hidden md:flex h-7 border-b border-zinc-800/40 bg-[#060606] items-center shrink-0 relative z-30 overflow-hidden">
      <div class="flex items-center gap-1 px-2 shrink-0 border-r border-zinc-800/40">
        <iconify-icon icon="solar:pulse-2-bold" class="text-red-600 text-[10px]"></iconify-icon>
        <span class="text-[7px] font-mono font-bold text-zinc-600 uppercase tracking-[0.2em]">PULSE</span>
      </div>
      <div id="pulse-strip" class="flex-1 overflow-hidden relative">
        <div id="pulse-content" class="flex items-center gap-6 px-4 whitespace-nowrap animate-marquee">
          <span class="flex items-center gap-2 text-[10px] font-mono"><span class="text-zinc-600">Fear & Greed</span><span id="pulse-fg" class="text-zinc-400 font-bold">--</span><span id="pulse-fg-label" class="text-[8px] px-1 rounded bg-zinc-800 text-zinc-500">--</span></span>
          <span class="text-zinc-800/50">|</span>
          <span class="flex items-center gap-2 text-[10px] font-mono"><span class="text-zinc-600">BTC Fund</span><span id="pulse-funding" class="text-zinc-400 font-bold">--</span></span>
          <span class="text-zinc-800/50">|</span>
          <span class="flex items-center gap-2 text-[10px] font-mono"><span class="text-zinc-600">USDT.D</span><span id="pulse-usdt" class="text-zinc-400 font-bold">--</span></span>
          <span class="text-zinc-800/50">|</span>
          <span class="flex items-center gap-2 text-[10px] font-mono"><span class="text-zinc-600">ETH Fund</span><span id="pulse-eth-funding" class="text-zinc-400 font-bold">--</span></span>
          <span class="text-zinc-800/50">|</span>
          <span class="flex items-center gap-2 text-[10px] font-mono"><span class="text-zinc-600">SOL Fund</span><span id="pulse-sol-funding" class="text-zinc-400 font-bold">--</span></span>
          <span class="text-zinc-800/50">|</span>
          <span class="flex items-center gap-2 text-[10px] font-mono"><span class="text-red-600/50"><iconify-icon icon="solar:shield-bold" class="text-[9px]"></iconify-icon></span><span class="text-zinc-600">Tracked</span><span id="pulse-positions" class="text-zinc-400 font-bold">--</span></span>
          <!-- Dup for seamless scroll -->
          <span class="text-zinc-800/50">|</span>
          <span class="flex items-center gap-2 text-[10px] font-mono"><span class="text-zinc-600">Fear & Greed</span><span class="pulse-fg-dup text-zinc-400 font-bold">--</span><span class="pulse-fg-label-dup text-[8px] px-1 rounded bg-zinc-800 text-zinc-500">--</span></span>
          <span class="text-zinc-800/50">|</span>
          <span class="flex items-center gap-2 text-[10px] font-mono"><span class="text-zinc-600">BTC Fund</span><span class="pulse-funding-dup text-zinc-400 font-bold">--</span></span>
          <span class="text-zinc-800/50">|</span>
          <span class="flex items-center gap-2 text-[10px] font-mono"><span class="text-zinc-600">USDT.D</span><span class="pulse-usdt-dup text-zinc-400 font-bold">--</span></span>
          <span class="text-zinc-800/50">|</span>
          <span class="flex items-center gap-2 text-[10px] font-mono"><span class="text-zinc-600">ETH Fund</span><span class="pulse-eth-funding-dup text-zinc-400 font-bold">--</span></span>
          <span class="text-zinc-800/50">|</span>
          <span class="flex items-center gap-2 text-[10px] font-mono"><span class="text-zinc-600">SOL Fund</span><span class="pulse-sol-funding-dup text-zinc-400 font-bold">--</span></span>
          <span class="text-zinc-800/50">|</span>
          <span class="flex items-center gap-2 text-[10px] font-mono"><span class="text-red-600/50"><iconify-icon icon="solar:shield-bold" class="text-[9px]"></iconify-icon></span><span class="text-zinc-600">Tracked</span><span class="pulse-positions-dup text-zinc-400 font-bold">--</span></span>
        </div>
      </div>
    </div>

    <!-- Symbol / Timeframe Bar -->
    <div class="h-11 border-b border-zinc-800/60 bg-[#070707] flex items-center shrink-0 relative z-30">
      <div class="flex-1 flex items-center overflow-x-auto no-scrollbar px-3 gap-1.5">
        <button onclick="switchSymbol('BTC')" data-sym="BTC" class="sym-btn sym-active flex items-center gap-1.5 px-3 py-1.5 rounded-md bg-red-600/10 border border-red-600/40 text-red-500 text-[10px] font-mono font-bold hover:bg-red-600/20 transition-all whitespace-nowrap">
          <iconify-icon icon="solar:star-bold" class="text-[9px]"></iconify-icon>BTC
        </button>
        <button onclick="switchSymbol('ETH')" data-sym="ETH" class="sym-btn px-3 py-1.5 rounded-md hover:bg-zinc-800/70 text-zinc-500 hover:text-white text-[10px] font-mono font-medium transition-all whitespace-nowrap">ETH</button>
        <button onclick="switchSymbol('SOL')" data-sym="SOL" class="sym-btn px-3 py-1.5 rounded-md hover:bg-zinc-800/70 text-zinc-500 hover:text-white text-[10px] font-mono font-medium transition-all whitespace-nowrap">SOL</button>
        <button onclick="switchSymbol('XRP')" data-sym="XRP" class="sym-btn px-3 py-1.5 rounded-md hover:bg-zinc-800/70 text-zinc-500 hover:text-white text-[10px] font-mono font-medium transition-all whitespace-nowrap">XRP</button>
        <button onclick="switchSymbol('BNB')" data-sym="BNB" class="sym-btn px-3 py-1.5 rounded-md hover:bg-zinc-800/70 text-zinc-500 hover:text-white text-[10px] font-mono font-medium transition-all whitespace-nowrap">BNB</button>
        <button onclick="switchSymbol('AVAX')" data-sym="AVAX" class="sym-btn px-3 py-1.5 rounded-md hover:bg-zinc-800/70 text-zinc-500 hover:text-white text-[10px] font-mono font-medium transition-all whitespace-nowrap">AVAX</button>
        <button onclick="switchSymbol('DOGE')" data-sym="DOGE" class="sym-btn px-3 py-1.5 rounded-md hover:bg-zinc-800/70 text-zinc-500 hover:text-white text-[10px] font-mono font-medium transition-all whitespace-nowrap">DOGE</button>
        <button onclick="switchSymbol('LINK')" data-sym="LINK" class="sym-btn px-3 py-1.5 rounded-md hover:bg-zinc-800/70 text-zinc-500 hover:text-white text-[10px] font-mono font-medium transition-all whitespace-nowrap">LINK</button>
        <div class="w-px h-4 bg-zinc-800/60 mx-1.5 shrink-0"></div>
        <button onclick="switchTimeframe('15m')" data-tf="15m" class="tf-btn px-2.5 py-1 rounded-md hover:bg-zinc-800/70 text-zinc-500 hover:text-zinc-300 text-[10px] font-mono transition-all">15m</button>
        <button onclick="switchTimeframe('1h')" data-tf="1h" class="tf-btn tf-active px-2.5 py-1 rounded-md bg-zinc-800/80 text-white text-[10px] font-mono font-bold transition-all border border-zinc-700/60">1H</button>
        <button onclick="switchTimeframe('4h')" data-tf="4h" class="tf-btn px-2.5 py-1 rounded-md hover:bg-zinc-800/70 text-zinc-500 hover:text-zinc-300 text-[10px] font-mono transition-all">4H</button>
        <button onclick="switchTimeframe('1d')" data-tf="1d" class="tf-btn px-2.5 py-1 rounded-md hover:bg-zinc-800/70 text-zinc-500 hover:text-zinc-300 text-[10px] font-mono transition-all">1D</button>
      </div>
    </div>

    <!-- Main Grid -->
    <main class="flex-1 flex flex-col md:grid md:grid-cols-5 min-h-0 bg-[#050505] md:overflow-hidden">
      <!-- LEFT: Chart + Chat -->
      <div id="chart-col" class="md:col-span-3 flex flex-col border-b md:border-b-0 md:border-r border-zinc-800/60 bg-[#050505] relative z-10 overflow-hidden h-[250px] md:h-auto shrink-0 md:shrink">
        <div class="absolute inset-0 md:bottom-[100px] z-0 bg-[#080808]">
          <!-- Chart loading bar -->
          <div id="chart-loader" class="chart-loading-bar hidden"></div>
          <div id="tv-chart" class="w-full h-full"></div>
          <div id="ohlc-overlay" class="absolute top-3 left-3 flex gap-2 pointer-events-none z-10">
            <span class="text-[9px] font-mono bg-[#080808]/90 text-zinc-500 px-2 py-1 border border-zinc-800/60 rounded backdrop-blur-sm">O: -- H: -- L: -- C: --</span>
          </div>
          <div class="absolute bottom-2 left-3 pointer-events-none z-10">
            <span class="flex items-center gap-1.5 text-[8px] font-mono text-red-500/80 bg-[#080808]/80 px-2 py-1 border border-red-900/20 rounded backdrop-blur-sm">
              <span class="relative flex h-1.5 w-1.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-500 opacity-60"></span><span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-red-500"></span></span>LIVE
            </span>
          </div>
          <div id="chart-watermark" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none z-0 flex flex-col items-center">
            <span class="text-[80px] md:text-[120px] font-mono font-black text-zinc-800/[0.04] select-none tracking-tighter leading-none">BTC</span>
          </div>
          <!-- Chart attribution (polished) -->
          <div class="absolute bottom-2 right-3 pointer-events-none z-10">
            <span class="text-[7px] font-mono text-zinc-800">Powered by TradingView</span>
          </div>
        </div>

        <!-- Chat Overlay ‚Äî desktop only, mobile uses separate section below -->
        <div id="chat-panel" class="hidden md:flex absolute bottom-0 left-0 right-0 z-20 flex-col justify-end pointer-events-none">
          <div id="chat-backdrop" onclick="ui.toggleChat(false)" class="absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-300 pointer-events-none" style="height: 100vh; top: -100vh;"></div>
          <div id="chat-container" class="bg-[#050505]/95 border-t border-zinc-800/60 backdrop-blur-md shadow-[0_-10px_40px_rgba(0,0,0,0.5)] transition-transform duration-300 pointer-events-auto translate-y-0">
            <div id="chat-expanded-content" class="h-0 opacity-0 overflow-hidden transition-all duration-300 flex flex-col">
              <div class="h-6 flex items-center justify-center cursor-pointer active:bg-zinc-800/50" onclick="ui.toggleChat(false)">
                <div class="w-10 h-1 bg-zinc-700 rounded-full"></div>
              </div>
              <div class="flex-1 overflow-y-auto bastion-scrollbar p-4 space-y-4 max-h-[60vh]" id="chat-messages">
                <div class="flex gap-3 max-w-[90%] msg-new">
                  <div class="w-7 h-7 rounded-md bg-red-950/40 border border-red-900/30 flex items-center justify-center shrink-0 text-red-500">
                    <iconify-icon icon="solar:shield-bold" class="text-sm"></iconify-icon>
                  </div>
                  <div class="flex flex-col gap-1">
                    <div class="text-[10px] font-mono text-zinc-600">BASTION &bull; Neural Engine</div>
                    <div class="bg-[#0A0A0A] border border-zinc-800/60 p-3 rounded-tr-lg rounded-b-lg text-xs leading-relaxed text-zinc-400 space-y-2">
                      <p class="text-zinc-300 font-medium">Neural engine online.</p>
                      <p>Ask me about market structure, risk analysis, key levels, whale activity, or trade setups. I analyze 560+ data streams in real-time.</p>
                      <div class="flex flex-wrap gap-1 mt-1">
                        <span class="text-[8px] font-mono text-zinc-600 bg-zinc-900/50 px-1.5 py-0.5 rounded border border-zinc-800/30">VPVR</span>
                        <span class="text-[8px] font-mono text-zinc-600 bg-zinc-900/50 px-1.5 py-0.5 rounded border border-zinc-800/30">OI</span>
                        <span class="text-[8px] font-mono text-zinc-600 bg-zinc-900/50 px-1.5 py-0.5 rounded border border-zinc-800/30">Funding</span>
                        <span class="text-[8px] font-mono text-zinc-600 bg-zinc-900/50 px-1.5 py-0.5 rounded border border-zinc-800/30">On-chain</span>
                        <span class="text-[8px] font-mono text-zinc-600 bg-zinc-900/50 px-1.5 py-0.5 rounded border border-zinc-800/30">MCF</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="p-3 bg-[#070707] border-t border-zinc-800/40 relative safe-pb">
              <div class="flex gap-1.5 mb-2 overflow-x-auto no-scrollbar" id="quick-chips">
                <button class="px-2.5 py-1 bg-zinc-900/60 border border-zinc-800/60 rounded-md hover:border-red-600/40 hover:bg-red-950/20 text-[9px] font-mono text-zinc-500 hover:text-zinc-300 whitespace-nowrap transition-all active:scale-95" onclick="window.fillPrompt('What is the current market outlook for ' + currentSymbol + '?')">üìä Market Outlook</button>
                <button class="px-2.5 py-1 bg-zinc-900/60 border border-zinc-800/60 rounded-md hover:border-red-600/40 hover:bg-red-950/20 text-[9px] font-mono text-zinc-500 hover:text-zinc-300 whitespace-nowrap transition-all active:scale-95" onclick="window.fillPrompt('What are the key support and resistance levels for ' + currentSymbol + '?')">üìç Key Levels</button>
                <button class="px-2.5 py-1 bg-zinc-900/60 border border-zinc-800/60 rounded-md hover:border-red-600/40 hover:bg-red-950/20 text-[9px] font-mono text-zinc-500 hover:text-zinc-300 whitespace-nowrap transition-all active:scale-95" onclick="window.fillPrompt('Analyze whale and smart money activity for ' + currentSymbol + '')">üêã Whale Activity</button>
                <button class="px-2.5 py-1 bg-zinc-900/60 border border-zinc-800/60 rounded-md hover:border-red-600/40 hover:bg-red-950/20 text-[9px] font-mono text-zinc-500 hover:text-zinc-300 whitespace-nowrap transition-all active:scale-95" onclick="window.fillPrompt('Give me a trade setup for ' + currentSymbol + ' with entry, stop loss, and take profit levels')">üéØ Trade Setup</button>
              </div>
              <div class="relative">
                <input type="text" id="chat-input" placeholder="Ask BASTION anything..." class="w-full bg-[#050505] border border-zinc-800/60 text-xs font-mono text-white pl-3 pr-10 py-2.5 rounded-md focus:outline-none focus:border-red-600/40 focus:ring-1 focus:ring-red-900/40 transition-all placeholder:text-zinc-600" onfocus="ui.toggleChat(true)" onkeydown="if(event.key==='Enter')api.sendChat()">
                <button class="absolute right-2 top-1/2 -translate-y-1/2 text-red-600 hover:text-red-500 transition-colors" onclick="api.sendChat()">
                  <iconify-icon icon="solar:plain-bold-duotone" class="text-lg"></iconify-icon>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- FAB ‚Äî hidden on mobile (chat input already visible) -->
        <div class="hidden md:flex fixed md:absolute bottom-[110px] right-4 z-[56] md:z-40 flex-col-reverse items-end gap-2.5 pointer-events-none">
          <button id="fab-btn" onclick="ui.toggleFab()" class="pointer-events-auto hover:bg-red-500 flex transition-all active:scale-95 group text-white bg-red-600 w-11 h-11 rounded-full shadow-[0_0_20px_rgba(220,38,38,0.3)] items-center justify-center">
            <iconify-icon icon="solar:shield-bold" class="text-xl group-hover:rotate-12 transition-transform"></iconify-icon>
          </button>
          <div id="fab-menu" class="flex flex-col gap-2 items-end transition-all duration-300 opacity-0 translate-y-4 pointer-events-none scale-95 origin-bottom-right" style="opacity:0;pointer-events:none;">
            <button onclick="api.generateReport(); ui.toggleFab();" class="pointer-events-auto flex items-center gap-2 px-3 py-1.5 bg-[#0A0A0A] border border-zinc-800/60 rounded-md shadow-xl text-[10px] font-mono text-zinc-400 hover:text-white hover:border-purple-600/40 transition-all">Generate Report<iconify-icon icon="solar:document-add-linear" class="text-purple-400 ml-1"></iconify-icon></button>
            <button onclick="ui.switchTab('positions'); ui.toggleShield(true); ui.toggleFab();" class="pointer-events-auto flex items-center gap-2 px-3 py-1.5 bg-[#0A0A0A] border border-zinc-800/60 rounded-md shadow-xl text-[10px] font-mono text-zinc-400 hover:text-white hover:border-red-600/40 transition-all">Shield All<iconify-icon icon="solar:shield-check-bold" class="text-red-500 ml-1"></iconify-icon></button>
            <button onclick="ui.toggleChat(true); ui.toggleFab();" class="pointer-events-auto flex items-center gap-2 px-3 py-1.5 bg-[#0A0A0A] border border-zinc-800/60 rounded-md shadow-xl text-[10px] font-mono text-zinc-400 hover:text-white hover:border-red-600/40 transition-all">Ask BASTION<iconify-icon icon="solar:chat-line-linear" class="text-red-400 ml-1"></iconify-icon></button>
          </div>
        </div>
      </div>

      <!-- MOBILE CHAT ‚Äî sits between chart and panels, expands downward -->
      <div id="mobile-chat" class="md:hidden flex flex-col bg-[#070707] border-b border-zinc-800/60 shrink-0 relative z-20">
        <!-- Collapsed: just input bar -->
        <div class="p-2.5 bg-[#070707]">
          <div class="relative">
            <input type="text" id="mobile-chat-input" placeholder="Ask BASTION anything..." class="w-full bg-[#050505] border border-zinc-800/60 text-xs font-mono text-white pl-3 pr-10 py-2.5 rounded-md focus:outline-none focus:border-red-600/40 focus:ring-1 focus:ring-red-900/40 transition-all placeholder:text-zinc-600" onfocus="mobileChat.open()" onkeydown="if(event.key==='Enter')mobileChat.send()">
            <button class="absolute right-2 top-1/2 -translate-y-1/2 text-red-600 hover:text-red-500 transition-colors" onclick="mobileChat.send()">
              <iconify-icon icon="solar:plain-bold-duotone" class="text-lg"></iconify-icon>
            </button>
          </div>
        </div>
        <!-- Expanded: messages + chips (hidden by default) -->
        <div id="mobile-chat-expanded" class="hidden flex flex-col max-h-[50vh] overflow-hidden">
          <div class="flex gap-1.5 px-2.5 pb-2 overflow-x-auto no-scrollbar">
            <button class="px-2 py-1 bg-zinc-900/60 border border-zinc-800/60 rounded-md text-[9px] font-mono text-zinc-500 whitespace-nowrap" onclick="mobileChat.fill('Market outlook for ' + (window.currentSymbol||'BTC') + '?')">üìä Outlook</button>
            <button class="px-2 py-1 bg-zinc-900/60 border border-zinc-800/60 rounded-md text-[9px] font-mono text-zinc-500 whitespace-nowrap" onclick="mobileChat.fill('Key levels for ' + (window.currentSymbol||'BTC') + '?')">üìç Levels</button>
            <button class="px-2 py-1 bg-zinc-900/60 border border-zinc-800/60 rounded-md text-[9px] font-mono text-zinc-500 whitespace-nowrap" onclick="mobileChat.fill('Whale activity for ' + (window.currentSymbol||'BTC'))">üêã Whales</button>
            <button class="px-2 py-1 bg-zinc-900/60 border border-zinc-800/60 rounded-md text-[9px] font-mono text-zinc-500 whitespace-nowrap" onclick="mobileChat.fill('Trade setup for ' + (window.currentSymbol||'BTC'))">üéØ Setup</button>
          </div>
          <div id="mobile-chat-messages" class="flex-1 overflow-y-auto bastion-scrollbar p-3 space-y-3 bg-[#050505]">
            <div class="flex gap-2 max-w-[95%]">
              <div class="w-6 h-6 rounded-md bg-red-950/40 border border-red-900/30 flex items-center justify-center shrink-0 text-red-500">
                <iconify-icon icon="solar:shield-bold" class="text-xs"></iconify-icon>
              </div>
              <div class="bg-[#0A0A0A] border border-zinc-800/60 p-2.5 rounded-lg text-[11px] leading-relaxed text-zinc-400">
                Neural engine online. Ask about market structure, risk, levels, or trade setups.
              </div>
            </div>
          </div>
          <button onclick="mobileChat.close()" class="w-full py-1.5 bg-[#070707] border-t border-zinc-800/40 text-[9px] font-mono text-zinc-600 hover:text-zinc-400">
            <iconify-icon icon="solar:alt-arrow-up-linear" class="mr-1"></iconify-icon>Collapse
          </button>
        </div>
      </div>

      <!-- RIGHT: Positions + Intel + Reports -->
      <div class="md:col-span-2 flex flex-col bg-[#050505] min-h-[50vh] md:min-h-0 md:h-full md:overflow-hidden relative">
        <!-- Upgrade CTA ‚Äî hidden on mobile -->
        <a href="/frontend" class="hidden md:block shrink-0 border-b border-zinc-800/40 bg-gradient-to-r from-amber-950/10 via-[#070707] to-red-950/10 px-4 py-2 group hover:from-amber-950/20 hover:to-red-950/20 transition-all cursor-pointer overflow-hidden relative">
          <div class="absolute inset-0 bg-gradient-to-r from-amber-600/[0.03] to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
          <div class="flex items-center justify-between relative">
            <div class="flex items-center gap-2.5">
              <div class="w-6 h-6 rounded bg-amber-950/30 border border-amber-900/20 flex items-center justify-center group-hover:border-amber-800/40 transition-colors">
                <iconify-icon icon="solar:crown-bold" class="text-amber-500/70 text-xs group-hover:scale-110 transition-transform"></iconify-icon>
              </div>
              <div>
                <span class="text-[10px] font-mono font-bold text-zinc-400 group-hover:text-white transition-colors">PRO TERMINAL</span>
                <span class="text-[8px] font-mono text-zinc-600 ml-2 hidden sm:inline">Full TradingView &bull; Trade manager &bull; Research desk</span>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-[8px] font-mono text-amber-700 border border-amber-900/20 px-1.5 py-0.5 rounded hidden sm:inline">UPGRADE</span>
              <iconify-icon icon="solar:arrow-right-linear" class="text-zinc-700 group-hover:text-amber-500 group-hover:translate-x-0.5 transition-all text-sm"></iconify-icon>
            </div>
          </div>
        </a>

        <!-- Tabs -->
        <div class="h-10 border-b border-zinc-800/60 flex shrink-0 bg-[#070707] z-20 relative">
          <button onclick="ui.switchTab('positions')" id="tab-positions" class="flex-1 relative text-[10px] font-mono font-bold text-white bg-zinc-900/30 transition-all hover:bg-zinc-800/50">
            POSITIONS
            <span class="absolute bottom-0 left-0 w-full h-0.5 bg-red-600 transition-all" id="ind-positions"></span>
          </button>
          <button onclick="ui.switchTab('intel')" id="tab-intel" class="flex-1 relative text-[10px] font-mono font-bold text-zinc-500 transition-all hover:text-zinc-300 hover:bg-zinc-800/50">
            INTEL
            <span class="absolute bottom-0 left-0 w-full h-0.5 bg-transparent transition-all" id="ind-intel"></span>
          </button>
          <button onclick="ui.switchTab('reports')" id="tab-reports" class="flex-1 relative text-[10px] font-mono font-bold text-zinc-500 transition-all hover:text-zinc-300 hover:bg-zinc-800/50">
            REPORTS
            <span class="absolute bottom-0 left-0 w-full h-0.5 bg-transparent transition-all" id="ind-reports"></span>
          </button>
        </div>

        <div class="flex-1 relative md:overflow-hidden bg-[#050505]">
          <!-- Positions Tab -->
          <div id="view-positions" class="relative md:absolute md:inset-0 flex flex-col">
            <!-- Risk Score Bar -->
            <div id="risk-score-bar" class="shrink-0 border-b border-zinc-800/40 bg-[#070707] px-3 py-2.5">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2.5">
                  <div class="relative w-9 h-9">
                    <svg class="w-9 h-9 -rotate-90" viewBox="0 0 36 36">
                      <circle cx="18" cy="18" r="15.5" fill="none" stroke="#18181b" stroke-width="2.5"/>
                      <circle id="risk-ring" class="risk-ring" cx="18" cy="18" r="15.5" fill="none" stroke="#22c55e" stroke-width="2.5" stroke-dasharray="97.4" stroke-dashoffset="97.4" stroke-linecap="round"/>
                    </svg>
                    <span id="risk-value" class="absolute inset-0 flex items-center justify-center text-[10px] font-mono font-bold text-zinc-500">--</span>
                  </div>
                  <div class="flex flex-col">
                    <span class="text-[9px] font-mono font-bold text-zinc-400 uppercase tracking-wider">Portfolio Risk</span>
                    <span id="risk-label" class="text-[8px] font-mono text-zinc-600">Analyzing...</span>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <div class="flex flex-col items-end">
                    <span class="text-[8px] font-mono text-zinc-600 uppercase">Exposure</span>
                    <span id="total-exposure" class="text-[11px] font-mono text-zinc-300 font-medium">$0.00</span>
                  </div>
                  <div class="flex flex-col items-end">
                    <span class="text-[8px] font-mono text-zinc-600 uppercase">PnL</span>
                    <span id="total-pnl" class="text-[11px] font-mono text-zinc-500 font-bold">$0.00</span>
                  </div>
                </div>
              </div>
            </div>
            <div id="positions-list" class="flex-1 overflow-y-auto bastion-scrollbar min-h-[120px]">
              <div id="positions-loading" class="p-8 text-center">
                <iconify-icon icon="svg-spinners:ring-resize" class="text-red-600 text-xl"></iconify-icon>
                <p class="text-[10px] font-mono text-zinc-600 mt-2">Loading positions...</p>
              </div>
            </div>
            <!-- Shield + Engine Footer -->
            <div class="p-3 bg-[#070707] border-t border-zinc-800/60 shrink-0 safe-pb space-y-2">
              <!-- Shield Toggle (Advisory) -->
              <div class="flex items-center justify-between bg-zinc-900/20 border border-zinc-800/40 p-2.5 rounded-md transition-all duration-500" id="shield-container">
                <div class="flex items-center gap-2.5">
                  <div class="w-8 h-8 rounded-md bg-red-950/30 border border-red-900/20 flex items-center justify-center">
                    <iconify-icon icon="solar:shield-warning-bold" class="text-red-600 text-base"></iconify-icon>
                  </div>
                  <div class="flex flex-col">
                    <span class="text-[10px] font-mono font-bold text-white uppercase tracking-wider">BASTION SHIELD</span>
                    <span id="shield-status" class="text-[8px] text-zinc-600 font-mono">AI Risk Engine ‚Äî Inactive</span>
                  </div>
                </div>
                <div class="relative inline-block w-9 h-[18px]">
                  <input type="checkbox" id="shield-toggle" class="toggle-checkbox absolute block w-[18px] h-[18px] rounded-full bg-white border-2 border-zinc-600 appearance-none cursor-pointer transition-all duration-300 z-10" onchange="ui.toggleShield(this.checked)">
                  <label for="shield-toggle" class="toggle-label block overflow-hidden h-[18px] rounded-full bg-zinc-700 cursor-pointer transition-colors duration-300"></label>
                </div>
              </div>
              <!-- Autonomous Engine Toggle -->
              <div class="flex items-center justify-between bg-zinc-900/10 border border-zinc-800/30 p-2 rounded-md transition-all duration-500" id="engine-container">
                <div class="flex items-center gap-2">
                  <iconify-icon icon="solar:cpu-bolt-bold" class="text-amber-600 text-sm"></iconify-icon>
                  <div class="flex flex-col">
                    <span class="text-[9px] font-mono font-bold text-zinc-400 uppercase tracking-wider">AUTO ENGINE</span>
                    <span id="engine-status" class="text-[8px] text-zinc-600 font-mono">Autonomous TP/SL ‚Äî Off</span>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <span id="engine-eval-count" class="text-[8px] font-mono text-zinc-700"></span>
                  <button id="engine-toggle-btn" onclick="toggleEngine()" class="px-2 py-0.5 text-[8px] font-mono font-bold uppercase rounded border border-zinc-700 text-zinc-500 hover:text-amber-400 hover:border-amber-600/40 transition-all">Start</button>
                </div>
              </div>
              <!-- Execution Controls (visible when engine running) -->
              <div id="exec-controls" class="hidden space-y-1.5">
                <div class="flex items-center justify-between bg-zinc-900/10 border border-zinc-800/30 p-2 rounded-md" id="arm-container">
                  <div class="flex items-center gap-2">
                    <iconify-icon icon="solar:bolt-circle-bold" class="text-emerald-600 text-sm" id="arm-icon"></iconify-icon>
                    <div class="flex flex-col">
                      <span class="text-[9px] font-mono font-bold text-zinc-400 uppercase tracking-wider">EXECUTION</span>
                      <span id="arm-status" class="text-[8px] text-zinc-600 font-mono">Advisory Only ‚Äî Not Armed</span>
                    </div>
                  </div>
                  <div class="flex items-center gap-1.5">
                    <span id="exec-count" class="text-[8px] font-mono text-zinc-700"></span>
                    <button id="arm-btn" onclick="armEngine()" class="px-2 py-0.5 text-[8px] font-mono font-bold uppercase rounded border border-zinc-700 text-zinc-500 hover:text-emerald-400 hover:border-emerald-600/40 transition-all">Arm</button>
                  </div>
                </div>
                <!-- Kill Switch -->
                <button id="kill-switch-btn" onclick="killSwitch()" class="hidden w-full py-1.5 text-[9px] font-mono font-bold uppercase rounded border border-red-900/40 text-red-500 bg-red-950/10 hover:bg-red-950/30 transition-all tracking-wider">
                  <iconify-icon icon="solar:danger-triangle-bold" class="text-xs mr-1"></iconify-icon>EMERGENCY STOP
                </button>
                <!-- Execution Stats -->
                <div id="exec-stats" class="hidden grid grid-cols-3 gap-1.5">
                  <div class="bg-zinc-900/20 border border-zinc-800/30 rounded p-1.5 text-center">
                    <div class="text-[7px] font-mono text-zinc-600 uppercase">Executions</div>
                    <div id="exec-stat-total" class="text-[10px] font-mono text-amber-400 font-bold">0</div>
                  </div>
                  <div class="bg-zinc-900/20 border border-zinc-800/30 rounded p-1.5 text-center">
                    <div class="text-[7px] font-mono text-zinc-600 uppercase">Volume</div>
                    <div id="exec-stat-volume" class="text-[10px] font-mono text-zinc-300 font-bold">$0</div>
                  </div>
                  <div class="bg-zinc-900/20 border border-zinc-800/30 rounded p-1.5 text-center">
                    <div class="text-[7px] font-mono text-zinc-600 uppercase">Confidence</div>
                    <div id="exec-stat-conf" class="text-[10px] font-mono text-zinc-300 font-bold">0.7</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Intel Tab -->
          <div id="view-intel" class="relative md:absolute md:inset-0 flex flex-col hidden">
            <div id="intel-content" class="flex-1 md:overflow-y-auto bastion-scrollbar">

              <!-- Market Sentiment Card -->
              <div class="mx-3 mt-3 mb-2 bg-[#0A0A0A] border border-zinc-800/50 rounded-lg overflow-hidden">
                <div class="px-3 py-2 bg-[#080808] border-b border-zinc-800/30 flex items-center gap-2">
                  <iconify-icon icon="solar:heart-pulse-bold" class="text-red-500 text-xs"></iconify-icon>
                  <span class="text-[9px] font-mono font-bold text-zinc-300 uppercase tracking-wider">Market Sentiment</span>
                </div>
                <div class="grid grid-cols-3 divide-x divide-zinc-800/30" id="sentiment-grid">
                  <div class="p-2.5 text-center">
                    <div class="text-[8px] font-mono text-zinc-600 uppercase mb-1">Fear & Greed</div>
                    <div id="sent-fg-val" class="text-lg font-mono font-bold text-zinc-500">--</div>
                    <div id="sent-fg-label" class="text-[8px] font-mono text-zinc-600 mt-0.5">--</div>
                  </div>
                  <div class="p-2.5 text-center">
                    <div class="text-[8px] font-mono text-zinc-600 uppercase mb-1">BTC Funding</div>
                    <div id="sent-funding" class="text-lg font-mono font-bold text-zinc-500">--</div>
                    <div class="text-[8px] font-mono text-zinc-600 mt-0.5">8h Rate</div>
                  </div>
                  <div class="p-2.5 text-center">
                    <div class="text-[8px] font-mono text-zinc-600 uppercase mb-1">USDT.D</div>
                    <div id="sent-usdt" class="text-lg font-mono font-bold text-zinc-500">--</div>
                    <div class="text-[8px] font-mono text-zinc-600 mt-0.5">Dominance</div>
                  </div>
                </div>
              </div>

              <!-- OI Changes Table -->
              <div class="mx-3 mb-2 bg-[#0A0A0A] border border-zinc-800/50 rounded-lg overflow-hidden">
                <div class="px-3 py-2 bg-[#080808] border-b border-zinc-800/30 flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <iconify-icon icon="solar:chart-2-bold" class="text-red-500 text-xs"></iconify-icon>
                    <span class="text-[9px] font-mono font-bold text-zinc-300 uppercase tracking-wider">Open Interest</span>
                  </div>
                  <span class="text-[7px] font-mono text-zinc-600 bg-zinc-900 px-1.5 py-0.5 rounded border border-zinc-800/40">24H</span>
                </div>
                <!-- Table header -->
                <div class="grid grid-cols-4 px-3 py-1.5 bg-[#080808]/50 border-b border-zinc-800/30 text-[8px] font-mono text-zinc-600 uppercase tracking-wider">
                  <span>Asset</span><span class="text-right">Change</span><span class="text-right">USD</span><span class="text-right">Price</span>
                </div>
                <div id="oi-list">
                  <div class="p-4 text-center"><iconify-icon icon="svg-spinners:ring-resize" class="text-red-500/60 text-sm"></iconify-icon></div>
                </div>
              </div>

              <!-- Funding Rates Table -->
              <div class="mx-3 mb-2 bg-[#0A0A0A] border border-zinc-800/50 rounded-lg overflow-hidden">
                <div class="px-3 py-2 bg-[#080808] border-b border-zinc-800/30 flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <iconify-icon icon="solar:wallet-money-bold" class="text-red-500 text-xs"></iconify-icon>
                    <span class="text-[9px] font-mono font-bold text-zinc-300 uppercase tracking-wider">Funding Rates</span>
                  </div>
                  <span class="text-[7px] font-mono text-zinc-600 bg-zinc-900 px-1.5 py-0.5 rounded border border-zinc-800/40">LIVE</span>
                </div>
                <div class="grid grid-cols-3 px-3 py-1.5 bg-[#080808]/50 border-b border-zinc-800/30 text-[8px] font-mono text-zinc-600 uppercase tracking-wider">
                  <span>Asset</span><span class="text-right">Rate</span><span class="text-right">Annual</span>
                </div>
                <div id="funding-list">
                  <div class="p-4 text-center"><iconify-icon icon="svg-spinners:ring-resize" class="text-red-500/60 text-sm"></iconify-icon></div>
                </div>
              </div>

              <!-- Whale Activity -->
              <div class="mx-3 mb-2 bg-[#0A0A0A] border border-zinc-800/50 rounded-lg overflow-hidden">
                <div class="px-3 py-2 bg-[#080808] border-b border-zinc-800/30 flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <iconify-icon icon="solar:ghost-bold" class="text-red-500 text-xs"></iconify-icon>
                    <span class="text-[9px] font-mono font-bold text-zinc-300 uppercase tracking-wider">Whale Alerts</span>
                  </div>
                  <span class="text-[7px] font-mono text-zinc-600 bg-zinc-900 px-1.5 py-0.5 rounded border border-zinc-800/40">$1M+</span>
                </div>
                <div class="grid grid-cols-4 px-3 py-1.5 bg-[#080808]/50 border-b border-zinc-800/30 text-[8px] font-mono text-zinc-600 uppercase tracking-wider">
                  <span>Asset</span><span>Type</span><span class="text-right">Value</span><span class="text-right">Time</span>
                </div>
                <div id="whale-list">
                  <div class="p-4 text-center"><iconify-icon icon="svg-spinners:ring-resize" class="text-red-500/60 text-sm"></iconify-icon></div>
                </div>
              </div>

              <!-- Liquidations -->
              <div class="mx-3 mb-2 bg-[#0A0A0A] border border-zinc-800/50 rounded-lg overflow-hidden">
                <div class="px-3 py-2 bg-[#080808] border-b border-zinc-800/30 flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <iconify-icon icon="solar:fire-bold" class="text-red-500 text-xs"></iconify-icon>
                    <span class="text-[9px] font-mono font-bold text-zinc-300 uppercase tracking-wider">Liquidations</span>
                  </div>
                  <span id="liq-symbol-label" class="text-[7px] font-mono text-red-500 bg-red-950/30 px-1.5 py-0.5 rounded border border-red-900/20">BTC</span>
                </div>
                <div id="liq-list">
                  <div class="p-4 text-center"><iconify-icon icon="svg-spinners:ring-resize" class="text-red-500/60 text-sm"></iconify-icon></div>
                </div>
              </div>

              <!-- Signal Scanner -->
              <div class="mx-3 mb-3 bg-[#0A0A0A] border border-zinc-800/50 rounded-lg overflow-hidden">
                <div class="px-3 py-2 bg-[#080808] border-b border-zinc-800/30 flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <iconify-icon icon="solar:radar-2-bold" class="text-red-500 text-xs"></iconify-icon>
                    <span class="text-[9px] font-mono font-bold text-zinc-300 uppercase tracking-wider">AI Signal Scanner</span>
                  </div>
                  <button onclick="loadSignals()" class="text-[8px] font-mono text-red-500 hover:text-red-400 bg-red-950/20 hover:bg-red-950/40 px-2 py-0.5 rounded border border-red-900/20 transition-all flex items-center gap-1">
                    <iconify-icon icon="solar:radar-2-bold" class="text-[9px]"></iconify-icon>SCAN NOW
                  </button>
                </div>
                <div id="signal-list">
                  <div class="p-5 text-center flex flex-col items-center gap-2.5">
                    <div class="w-10 h-10 rounded-lg bg-zinc-900/40 border border-zinc-800/30 flex items-center justify-center">
                      <iconify-icon icon="solar:radar-2-linear" class="text-zinc-700 text-xl"></iconify-icon>
                    </div>
                    <div>
                      <span class="text-[10px] font-mono text-zinc-500 block">No active signals</span>
                      <span class="text-[9px] font-mono text-zinc-700 mt-0.5 block">Hit SCAN NOW to run AI signal detection</span>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <!-- Reports Tab -->
          <div id="view-reports" class="relative md:absolute md:inset-0 flex flex-col hidden">
            <div class="h-10 border-b border-zinc-800/40 flex items-center justify-between px-4 bg-[#070707] shrink-0">
              <span class="text-[10px] font-mono font-bold text-zinc-400 uppercase tracking-wider">MCF Reports</span>
              <button class="flex items-center gap-1.5 bg-purple-900/15 hover:bg-purple-900/30 text-purple-400 border border-purple-900/30 px-2.5 py-1 rounded-md text-[9px] font-mono font-bold transition-all" id="btn-generate" onclick="api.generateReport()">
                <iconify-icon icon="solar:magic-stick-3-linear" class="text-xs"></iconify-icon>GENERATE
              </button>
            </div>
            <div id="report-list" class="flex-1 md:overflow-y-auto bastion-scrollbar">
              <div id="reports-loading" class="p-8 text-center">
                <iconify-icon icon="svg-spinners:ring-resize" class="text-purple-500 text-xl"></iconify-icon>
                <p class="text-[10px] font-mono text-zinc-600 mt-2">Loading reports...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Keyboard Shortcuts Hint (desktop only) -->
    <div class="hidden md:flex fixed bottom-2 left-3 z-40 items-center gap-3 text-[8px] font-mono text-zinc-800 pointer-events-none select-none">
      <span><kbd class="px-1 py-0.5 bg-zinc-900/50 border border-zinc-800/30 rounded text-zinc-700">1</kbd><kbd class="px-1 py-0.5 bg-zinc-900/50 border border-zinc-800/30 rounded text-zinc-700 ml-0.5">2</kbd><kbd class="px-1 py-0.5 bg-zinc-900/50 border border-zinc-800/30 rounded text-zinc-700 ml-0.5">3</kbd> Tabs</span>
      <span><kbd class="px-1 py-0.5 bg-zinc-900/50 border border-zinc-800/30 rounded text-zinc-700">/</kbd> Chat</span>
      <span><kbd class="px-1 py-0.5 bg-zinc-900/50 border border-zinc-800/30 rounded text-zinc-700">S</kbd> Shield</span>
    </div>

    <!-- Toast -->
    <div id="toast-container" class="fixed top-14 right-4 z-[70] flex flex-col gap-2 max-w-[340px] pointer-events-none"></div>

    <!-- Report Modal -->
    <div id="report-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center">
      <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="document.getElementById('report-modal').classList.add('hidden')"></div>
      <div class="relative w-full h-full md:w-[640px] md:h-[85vh] bg-[#080808] border border-zinc-800/60 md:rounded-xl shadow-2xl shadow-black/50 flex flex-col overflow-hidden">
        <div class="h-12 border-b border-zinc-800/60 flex items-center justify-between px-5 bg-[#080808] shrink-0">
          <div class="flex items-center gap-3">
            <div class="w-6 h-6 rounded bg-purple-950/40 border border-purple-900/20 flex items-center justify-center">
              <iconify-icon icon="solar:documents-bold" class="text-purple-500 text-xs"></iconify-icon>
            </div>
            <span id="modal-title-bar" class="text-xs font-mono font-bold text-white uppercase tracking-widest">MCF / REPORT</span>
          </div>
          <button onclick="document.getElementById('report-modal').classList.add('hidden')" class="w-7 h-7 rounded-md flex items-center justify-center text-zinc-500 hover:text-white hover:bg-zinc-800/50 transition-all">
            <iconify-icon icon="solar:close-circle-linear" class="text-lg"></iconify-icon>
          </button>
        </div>
        <div id="modal-body" class="flex-1 overflow-y-auto bastion-scrollbar p-6 bg-[#050505]">
          <div class="p-6 text-center"><iconify-icon icon="svg-spinners:ring-resize" class="text-purple-500 text-xl"></iconify-icon></div>
        </div>
      </div>
    </div>

    <script>
      (function(){const n=function(){};if(location.hostname!=='localhost'&&location.hostname!=='127.0.0.1'){console.log=n;console.debug=n;console.info=n;console.warn=n}})();

      // ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let currentSymbol = 'BTC';
      let currentTimeframe = '1h';
      let chartInstance = null, candleSeries = null, volumeSeries = null;
      let priceInterval = null, positionsInterval = null, shieldInterval = null, liveTickInterval = null;
      let shieldActive = localStorage.getItem('bastion_shield_lite') === 'true';
      let cachedPositions = [];
      let shieldResults = {};  // Cache: symbol ‚Üí { evaluation, data_sources, timestamp }
      let chartAbortController = null;
      let isChartLoading = false;
      let lastCandleData = null; // For live updates
      let fabOpen = false;
      let apiAlive = true;

      // ‚îÄ‚îÄ SESSION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function getSessionId() {
        let sid = localStorage.getItem('bastion_session_id');
        if (!sid) { sid = 'guest_' + Math.random().toString(36).substring(2, 15); localStorage.setItem('bastion_session_id', sid); }
        return sid;
      }
      const sessionId = getSessionId();

      // ‚îÄ‚îÄ AUTO-RECONNECT EXCHANGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // On page load, reconnect exchanges via server-side cloud keys (never stores secrets locally)
      async function autoReconnectExchanges() {
        const token = localStorage.getItem('bastion_token') || sessionStorage.getItem('bastion_token');
        if (!token) return;
        try {
          console.log('[DASHBOARD] Loading exchanges from cloud (server-side)...');
          const res = await fetch('/api/auth/load-exchanges', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token })
          });
          const data = await res.json();
          if (data.success && data.loaded > 0) {
            console.log(`[DASHBOARD] ‚úì Cloud-loaded ${data.loaded} exchanges:`, data.exchanges);
            localStorage.setItem('bastion_connected_exchanges', JSON.stringify(data.exchanges || []));
          }
        } catch (e) {
          console.warn('[DASHBOARD] Cloud exchange load failed:', e);
        }
      }

      // ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const api = {
        getKlines: async (symbol, interval, limit = 200, signal) => {
          try {
            const res = await fetch(`/api/klines/${symbol || currentSymbol}?interval=${interval || currentTimeframe}&limit=${limit}`, { signal });
            if (!res.ok) throw new Error(`Klines ${res.status}`);
            return await res.json();
          } catch (e) {
            if (e.name === 'AbortError') return null;
            return { candles: [] };
          }
        },
        getPrice: async (symbol) => {
          try {
            const res = await fetch(`/api/price/${symbol || currentSymbol}`);
            if (!res.ok) throw new Error(`Price ${res.status}`);
            setConnected(true);
            return await res.json();
          } catch (e) { setConnected(false); return null; }
        },
        getPositions: async () => {
          try { const res = await fetch(`/api/positions/all?session_id=${sessionId}`); if (!res.ok) throw new Error(); return await res.json(); }
          catch (e) { return { positions: [] }; }
        },
        sendChat: async () => {
          const input = document.getElementById('chat-input');
          const val = input.value.trim(); if (!val) return;
          const box = document.getElementById('chat-messages');
          const now = new Date().toLocaleTimeString('en-US', { hour12: false });
          box.insertAdjacentHTML('beforeend', `<div class="flex gap-3 max-w-[80%] ml-auto flex-row-reverse msg-new"><div class="w-7 h-7 rounded-md bg-zinc-800 border border-zinc-700/60 flex items-center justify-center shrink-0 text-white"><iconify-icon icon="solar:user-circle-bold" class="text-sm"></iconify-icon></div><div class="flex flex-col gap-1 items-end"><div class="text-[10px] font-mono text-zinc-600">YOU &bull; ${now}</div><div class="bg-red-950/20 border border-red-900/20 p-3 rounded-tl-lg rounded-b-lg text-xs leading-relaxed text-zinc-200">${escapeHtml(val)}</div></div></div>`);
          input.value = ''; ui.scrollToBottom();
          const tid = 'typing-' + Date.now();
          box.insertAdjacentHTML('beforeend', `<div id="${tid}" class="flex gap-3 max-w-[90%] msg-new"><div class="w-7 h-7 rounded-md bg-red-950/40 border border-red-900/30 flex items-center justify-center shrink-0 text-red-500"><iconify-icon icon="solar:shield-bold" class="text-sm"></iconify-icon></div><div class="flex flex-col gap-1"><div class="text-[10px] font-mono text-zinc-600">BASTION &bull; analyzing...</div><div class="bg-[#0A0A0A] border border-zinc-800/60 p-3 rounded-tr-lg rounded-b-lg flex items-center gap-1.5"><span class="typing-dot w-1.5 h-1.5 bg-red-500 rounded-full inline-block"></span><span class="typing-dot w-1.5 h-1.5 bg-red-500 rounded-full inline-block"></span><span class="typing-dot w-1.5 h-1.5 bg-red-500 rounded-full inline-block"></span></div></div></div>`);
          ui.scrollToBottom();
          try {
            const res = await fetch('/api/neural/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query: val, symbol: currentSymbol, include_positions: true, session_id: sessionId, user_id: sessionId }) });
            const data = await res.json();
            const el = document.getElementById(tid); if (el) el.remove();
            const rt = new Date().toLocaleTimeString('en-US', { hour12: false });
            box.insertAdjacentHTML('beforeend', `<div class="flex gap-3 max-w-[90%] msg-new"><div class="w-7 h-7 rounded-md bg-red-950/40 border border-red-900/30 flex items-center justify-center shrink-0 text-red-500"><iconify-icon icon="solar:shield-bold" class="text-sm"></iconify-icon></div><div class="flex flex-col gap-1"><div class="text-[10px] font-mono text-zinc-600">BASTION &bull; ${rt}</div><div class="bg-[#0A0A0A] border border-zinc-800/60 p-3 rounded-tr-lg rounded-b-lg text-xs leading-relaxed text-zinc-300 bastion-response">${renderMarkdown(data.response || data.error || 'No response.')}</div></div></div>`);
          } catch (e) {
            const el = document.getElementById(tid); if (el) el.remove();
            box.insertAdjacentHTML('beforeend', `<div class="flex gap-3 max-w-[90%] msg-new"><div class="w-7 h-7 rounded-md bg-red-950/40 border border-red-900/30 flex items-center justify-center shrink-0 text-red-400"><iconify-icon icon="solar:danger-triangle-linear" class="text-sm"></iconify-icon></div><div class="flex flex-col gap-1"><div class="text-[10px] font-mono text-zinc-600">SYSTEM &bull; Error</div><div class="bg-red-950/10 border border-red-900/20 p-3 rounded-tr-lg rounded-b-lg text-xs text-red-400/80 space-y-1"><p class="font-medium">Neural engine unavailable</p><p class="text-[10px] text-red-500/60">The AI model may be offline or loading. Check GPU cluster status.</p></div></div></div>`);
          }
          ui.scrollToBottom();
        },
        generateReport: async () => {
          const btn = document.getElementById('btn-generate'); if (!btn) return;
          const orig = btn.innerHTML;
          btn.innerHTML = '<iconify-icon icon="svg-spinners:ring-resize" class="text-xs"></iconify-icon> GENERATING...'; btn.disabled = true;
          try {
            const res = await fetch(`/api/mcf/generate/institutional?symbol=${currentSymbol}`, { method: 'POST' });
            const data = await res.json();
            if (data.success && data.report) {
              const r = data.report, el = document.createElement('div');
              el.className = 'report-card p-3 border-b border-zinc-800/40 hover:bg-zinc-900/30 cursor-pointer transition-all';
              el.onclick = () => openReport(r.id);
              el.innerHTML = `<div class="flex justify-between items-start mb-1.5"><span class="text-[9px] font-mono ${biasClass(r.bias||'NEUTRAL')} px-1.5 py-0.5 rounded uppercase border ${biasBorder(r.bias||'NEUTRAL')} font-bold">${r.bias||'NEW'}</span><span class="text-[9px] font-mono text-zinc-600">Just now</span></div><h4 class="text-xs font-semibold text-zinc-300 mb-2 leading-tight">${escapeHtml(r.title||'Report')}</h4><div class="flex gap-1.5">${(r.tags||[currentSymbol.toLowerCase()]).map(t=>`<span class="text-[8px] font-mono text-zinc-600 border border-zinc-800/50 px-1 rounded">#${t}</span>`).join('')}</div>`;
              const list = document.getElementById('report-list');
              const ld = document.getElementById('reports-loading'); if (ld) ld.remove();
              list.prepend(el); ui.switchTab('reports');
              showToast('Report generated', 'success');
            } else { showToast('Report generation failed', 'warning'); }
          } catch (e) { showToast('Failed to generate report', 'warning'); }
          btn.innerHTML = orig; btn.disabled = false;
        },
        getReports: async (limit = 20) => {
          try { const res = await fetch(`/api/mcf/reports?limit=${limit}`); if (!res.ok) throw new Error(); return await res.json(); }
          catch (e) { return { reports: [] }; }
        },
        getReport: async (id) => {
          try { const res = await fetch(`/api/mcf/reports/${id}`); if (!res.ok) throw new Error(); return await res.json(); }
          catch (e) { return null; }
        },
        evaluatePosition: async (position) => {
          try {
            const sym = (position.symbol||'').replace(/-PERP$/i, '');
            // Use live WebSocket price if position current_price is stale (equals entry)
            let currentPrice = position.current_price || 0;
            if (currentPrice === position.entry_price && lastWsPrice > 0) {
              currentPrice = lastWsPrice;
            }
            console.log('[SHIELD] Evaluating', sym, 'dir:', position.direction, 'entry:', position.entry_price, 'current:', currentPrice);
            const res = await fetch('/api/risk/evaluate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ position: { symbol: sym, direction: (position.direction||'').toUpperCase(), entry_price: position.entry_price, current_price: currentPrice, position_size: position.size || 1, leverage: position.leverage || 1, stop_loss: position.stop_loss || position.stop || null, take_profits: position.take_profit ? [position.take_profit] : ((position.targets||[]).map(t=>t.price)) } }) });
            if (!res.ok) { console.error('[SHIELD] Evaluate response not OK:', res.status); throw new Error(); }
            const data = await res.json();
            console.log('[SHIELD] Evaluate result:', JSON.stringify(data.evaluation));
            return data;
          } catch (e) { console.error('[SHIELD] evaluatePosition error:', e); return null; }
        },
        getOIChanges: async () => {
          try { const res = await fetch('/api/oi-changes'); if (!res.ok) throw new Error(); return await res.json(); }
          catch (e) { return null; }
        },
        getWhales: async () => {
          try { const res = await fetch('/api/whales?min_value=1000000&limit=10'); if (!res.ok) throw new Error(); return await res.json(); }
          catch (e) { return null; }
        },
        scanSignals: async () => {
          try { const res = await fetch('/api/signals/scan', { method: 'POST' }); if (!res.ok) throw new Error(); return await res.json(); }
          catch (e) { return null; }
        },
        getLiquidations: async (symbol) => {
          try { const res = await fetch(`/api/liquidations/${symbol || currentSymbol}`); if (!res.ok) throw new Error(); return await res.json(); }
          catch (e) { return null; }
        }
      };

      // ‚îÄ‚îÄ CONNECTION STATUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function setConnected(alive) {
        if (alive === apiAlive) return;
        apiAlive = alive;
        const dot = document.getElementById('conn-dot');
        const label = document.getElementById('conn-label');
        if (alive) {
          dot.className = 'relative inline-flex rounded-full h-1.5 w-1.5 bg-green-500';
          dot.previousElementSibling.firstElementChild.className = 'animate-ping absolute inline-flex h-full w-full rounded-full bg-green-500 opacity-40';
          label.textContent = 'CONNECTED'; label.className = 'text-[8px] font-mono text-zinc-600 hidden md:inline';
        } else {
          dot.className = 'relative inline-flex rounded-full h-1.5 w-1.5 bg-red-500';
          dot.previousElementSibling.firstElementChild.className = 'animate-ping absolute inline-flex h-full w-full rounded-full bg-red-500 opacity-40';
          label.textContent = 'DISCONNECTED'; label.className = 'text-[8px] font-mono text-red-500 hidden md:inline';
        }
      }

      // ‚îÄ‚îÄ UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const tabMap = {
        positions: { view: 'view-positions', ind: 'ind-positions', btn: 'tab-positions', color: 'bg-red-600' },
        intel: { view: 'view-intel', ind: 'ind-intel', btn: 'tab-intel', color: 'bg-cyan-600' },
        reports: { view: 'view-reports', ind: 'ind-reports', btn: 'tab-reports', color: 'bg-purple-600' }
      };
      // Mobile chat helper ‚Äî separate from desktop chat overlay
      const mobileChat = {
        open: () => {
          document.getElementById('mobile-chat-expanded')?.classList.remove('hidden');
        },
        close: () => {
          document.getElementById('mobile-chat-expanded')?.classList.add('hidden');
          document.getElementById('mobile-chat-input')?.blur();
        },
        fill: (txt) => {
          const inp = document.getElementById('mobile-chat-input');
          if (inp) { inp.value = txt; inp.focus(); }
        },
        send: async () => {
          const inp = document.getElementById('mobile-chat-input');
          if (!inp || !inp.value.trim()) return;
          const val = inp.value.trim();
          inp.value = '';
          mobileChat.open();
          const msgs = document.getElementById('mobile-chat-messages');
          if (!msgs) return;
          // User message
          msgs.insertAdjacentHTML('beforeend', `<div class="flex gap-2 max-w-[95%] ml-auto flex-row-reverse"><div class="bg-red-950/20 border border-red-900/30 p-2.5 rounded-lg text-[11px] text-zinc-300 font-mono">${val.replace(/</g,'&lt;')}</div></div>`);
          msgs.scrollTop = msgs.scrollHeight;
          // Typing indicator
          const tid = 'mtyp-' + Date.now();
          msgs.insertAdjacentHTML('beforeend', `<div id="${tid}" class="flex gap-2"><div class="w-6 h-6 rounded-md bg-red-950/40 border border-red-900/30 flex items-center justify-center shrink-0 text-red-500"><iconify-icon icon="solar:shield-bold" class="text-xs"></iconify-icon></div><div class="bg-[#0A0A0A] border border-zinc-800/60 p-2.5 rounded-lg flex items-center gap-1.5"><span class="typing-dot w-1.5 h-1.5 bg-red-500 rounded-full inline-block"></span><span class="typing-dot w-1.5 h-1.5 bg-red-500 rounded-full inline-block"></span><span class="typing-dot w-1.5 h-1.5 bg-red-500 rounded-full inline-block"></span></div></div>`);
          msgs.scrollTop = msgs.scrollHeight;
          try {
            const res = await fetch('/api/neural/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query: val, symbol: window.currentSymbol || 'BTC', include_positions: true, session_id: window.sessionId || 'mobile', user_id: window.sessionId || 'mobile' }) });
            const data = await res.json();
            const el = document.getElementById(tid); if (el) el.remove();
            const resp = (typeof renderMarkdown === 'function') ? renderMarkdown(data.response || data.error || 'No response.') : (data.response || data.error || 'No response.');
            msgs.insertAdjacentHTML('beforeend', `<div class="flex gap-2 max-w-[95%]"><div class="w-6 h-6 rounded-md bg-red-950/40 border border-red-900/30 flex items-center justify-center shrink-0 text-red-500"><iconify-icon icon="solar:shield-bold" class="text-xs"></iconify-icon></div><div class="bg-[#0A0A0A] border border-zinc-800/60 p-2.5 rounded-lg text-[11px] leading-relaxed text-zinc-300 bastion-response">${resp}</div></div>`);
          } catch (e) {
            const el = document.getElementById(tid); if (el) el.remove();
            msgs.insertAdjacentHTML('beforeend', `<div class="flex gap-2 max-w-[95%]"><div class="w-6 h-6 rounded-md bg-red-950/40 border border-red-900/30 flex items-center justify-center shrink-0 text-red-400"><iconify-icon icon="solar:danger-triangle-linear" class="text-xs"></iconify-icon></div><div class="bg-red-950/10 border border-red-900/20 p-2.5 rounded-lg text-[11px] text-red-400/80">Neural engine unavailable. Check GPU status.</div></div>`);
          }
          msgs.scrollTop = msgs.scrollHeight;
        }
      };

      const ui = {
        switchTab: (tab) => {
          Object.entries(tabMap).forEach(([key, cfg]) => {
            const view = document.getElementById(cfg.view);
            const ind = document.getElementById(cfg.ind);
            const btn = document.getElementById(cfg.btn);
            if (key === tab) {
              view.classList.remove('hidden');
              ind.className = `absolute bottom-0 left-0 w-full h-0.5 ${cfg.color} transition-all`;
              btn.className = 'flex-1 relative text-[10px] font-mono font-bold text-white bg-zinc-900/30 transition-all hover:bg-zinc-800/50';
            } else {
              view.classList.add('hidden');
              ind.className = 'absolute bottom-0 left-0 w-full h-0.5 bg-transparent transition-all';
              btn.className = 'flex-1 relative text-[10px] font-mono font-bold text-zinc-500 transition-all hover:text-zinc-300 hover:bg-zinc-800/50';
            }
          });
        },
        toggleChat: (open) => {
          const backdrop = document.getElementById('chat-backdrop');
          const content = document.getElementById('chat-expanded-content');
          if (open) {
            backdrop.style.opacity = '1'; backdrop.style.pointerEvents = 'auto';
            content.classList.remove('h-0', 'opacity-0'); content.classList.add('h-auto', 'opacity-100');
            setTimeout(() => { document.getElementById('chat-input').focus(); ui.scrollToBottom(); }, 300);
          } else {
            backdrop.style.opacity = '0'; backdrop.style.pointerEvents = 'none';
            content.classList.add('h-0', 'opacity-0'); content.classList.remove('h-auto', 'opacity-100');
          }
        },
        toggleFab: () => {
          fabOpen = !fabOpen;
          const menu = document.getElementById('fab-menu');
          menu.style.opacity = fabOpen ? '1' : '0';
          menu.style.pointerEvents = fabOpen ? 'auto' : 'none';
          menu.style.transform = fabOpen ? 'translateY(0) scale(1)' : 'translateY(1rem) scale(0.95)';
        },
        toggleShield: async (active) => {
          shieldActive = active;
          localStorage.setItem('bastion_shield_lite', active);
          const container = document.getElementById('shield-container');
          const status = document.getElementById('shield-status');
          document.getElementById('shield-toggle').checked = active;
          if (active) {
            container.classList.add('shield-active', 'shield-pulse');
            status.textContent = 'ACTIVE ‚Äî Monitoring all positions...';
            status.className = 'text-[8px] text-red-500 font-mono';
            document.querySelectorAll('.pos-card').forEach((card, i) => { setTimeout(() => card.classList.add('shield-card-active'), i * 100); });
            showToast('BASTION Shield activated ‚Äî AI monitoring your positions', 'shield', 4000);
            runShieldEvaluation();
            if (shieldInterval) clearInterval(shieldInterval);
            shieldInterval = setInterval(runShieldEvaluation, 60000);
          } else {
            container.classList.remove('shield-active', 'shield-pulse');
            status.textContent = 'AI Risk Engine ‚Äî Inactive';
            status.className = 'text-[8px] text-zinc-600 font-mono';
            document.querySelectorAll('.pos-card').forEach(card => card.classList.remove('shield-card-active'));
            document.querySelectorAll('.shield-badge, .shield-analysis').forEach(el => el.remove());
            shieldResults = {};  // Clear cached results
            if (shieldInterval) clearInterval(shieldInterval); shieldInterval = null;
          }
        },
        scrollToBottom: () => { const box = document.getElementById('chat-messages'); if (box) box.scrollTop = box.scrollHeight; }
      };

      // ‚îÄ‚îÄ SYMBOL / TIMEFRAME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function switchSymbol(sym) {
        if (sym === currentSymbol && !isChartLoading) return;
        currentSymbol = sym;
        document.querySelectorAll('.sym-btn').forEach(btn => {
          if (btn.dataset.sym === sym) {
            btn.className = 'sym-btn sym-active flex items-center gap-1.5 px-3 py-1.5 rounded-md bg-red-600/10 border border-red-600/40 text-red-500 text-[10px] font-mono font-bold hover:bg-red-600/20 transition-all whitespace-nowrap';
            btn.innerHTML = '<iconify-icon icon="solar:star-bold" class="text-[9px]"></iconify-icon>' + btn.dataset.sym;
          } else {
            btn.className = 'sym-btn px-3 py-1.5 rounded-md hover:bg-zinc-800/70 text-zinc-500 hover:text-white text-[10px] font-mono font-medium transition-all whitespace-nowrap';
            btn.textContent = btn.dataset.sym;
          }
        });
        document.getElementById('ticker-symbol').textContent = sym + '-PERP';
        document.getElementById('chart-watermark').querySelector('span').textContent = sym;
        lastCandleData = null;
        lastWsPrice = 0;
        connectPriceWs(); // Reconnect WebSocket for new symbol
        await loadChart();
        updatePrice();
        loadLiquidations();
      }

      async function switchTimeframe(tf) {
        if (tf === currentTimeframe) return;
        currentTimeframe = tf;
        document.querySelectorAll('.tf-btn').forEach(btn => {
          if (btn.dataset.tf === tf) btn.className = 'tf-btn tf-active px-2.5 py-1 rounded-md bg-zinc-800/80 text-white text-[10px] font-mono font-bold transition-all border border-zinc-700/60';
          else btn.className = 'tf-btn px-2.5 py-1 rounded-md hover:bg-zinc-800/70 text-zinc-500 hover:text-zinc-300 text-[10px] font-mono transition-all';
        });
        lastCandleData = null;
        await loadChart();
      }

      // ‚îÄ‚îÄ CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function loadChart() {
        if (chartAbortController) chartAbortController.abort();
        chartAbortController = new AbortController();
        isChartLoading = true;
        document.getElementById('chart-loader').classList.remove('hidden');
        try {
          const data = await api.getKlines(currentSymbol, currentTimeframe, 200, chartAbortController.signal);
          if (!data) return;
          if (!data.candles || data.candles.length === 0) { candleSeries.setData([]); volumeSeries.setData([]); return; }
          const candles = data.candles.map(c => ({ time: c.time, open: c.open, high: c.high, low: c.low, close: c.close })).sort((a, b) => a.time - b.time).filter((c, i, arr) => i === 0 || c.time !== arr[i-1].time);
          const volumes = data.candles.map(c => ({ time: c.time, value: c.volume || 0, color: c.close >= c.open ? 'rgba(34,197,94,0.25)' : 'rgba(239,68,68,0.25)' })).sort((a, b) => a.time - b.time).filter((c, i, arr) => i === 0 || c.time !== arr[i-1].time);
          candleSeries.setData(candles);
          volumeSeries.setData(volumes);
          lastCandleData = candles[candles.length - 1];
          const last = candles[candles.length - 1];
          document.getElementById('ohlc-overlay').innerHTML = `<span class="text-[9px] font-mono bg-[#080808]/90 text-zinc-500 px-2 py-1 border border-zinc-800/60 rounded backdrop-blur-sm">O: ${fmt(last.open)} H: ${fmt(last.high)} L: ${fmt(last.low)} C: ${fmt(last.close)}</span>`;
          chartInstance.timeScale().fitContent();
        } catch (e) {
          if (e.name !== 'AbortError') console.error('[BASTION] Chart error:', e);
        } finally {
          isChartLoading = false;
          document.getElementById('chart-loader').classList.add('hidden');
        }
      }

      // ‚îÄ‚îÄ LIVE PRICE via Binance WebSocket ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let priceWs = null;
      let lastWsPrice = 0;
      let wsReconnectTimer = null;
      let wsRetryDelay = 1000;
      const binanceSymbolMap = { BTC: 'btcusdt', ETH: 'ethusdt', SOL: 'solusdt', XRP: 'xrpusdt', BNB: 'bnbusdt', AVAX: 'avaxusdt', LINK: 'linkusdt', ARB: 'arbusdt', DOGE: 'dogeusdt' };

      function connectPriceWs() {
        if (wsReconnectTimer) { clearTimeout(wsReconnectTimer); wsReconnectTimer = null; }
        if (priceWs) { try { priceWs.close(); } catch(e){} }
        const pair = binanceSymbolMap[currentSymbol] || (currentSymbol.toLowerCase() + 'usdt');
        const url = `wss://stream.binance.com:9443/ws/${pair}@aggTrade`;
        priceWs = new WebSocket(url);
        priceWs.onopen = () => { wsRetryDelay = 1000; }; // Reset backoff on success
        priceWs.onmessage = (event) => {
          const d = JSON.parse(event.data);
          const price = parseFloat(d.p);
          if (!price || price === lastWsPrice) return;
          const prevPrice = lastWsPrice;
          lastWsPrice = price;
          const priceEl = document.getElementById('ticker-price');
          priceEl.textContent = '$' + fmtPrice(price);
          // Flash effect on price change
          if (prevPrice > 0) {
            const ticker = document.getElementById('header-ticker');
            ticker.classList.remove('price-flash-up', 'price-flash-down');
            void ticker.offsetWidth; // force reflow
            ticker.classList.add(price > prevPrice ? 'price-flash-up' : 'price-flash-down');
          }
          if (lastCandleData && candleSeries && !isChartLoading) {
            const updated = {
              time: lastCandleData.time,
              open: lastCandleData.open,
              high: Math.max(lastCandleData.high, price),
              low: Math.min(lastCandleData.low, price),
              close: price
            };
            candleSeries.update(updated);
            lastCandleData = updated;
          }
        };
        priceWs.onclose = () => {
          wsReconnectTimer = setTimeout(connectPriceWs, wsRetryDelay);
          wsRetryDelay = Math.min(wsRetryDelay * 2, 30000); // Exponential backoff, max 30s
        };
        priceWs.onerror = () => { try { priceWs.close(); } catch(e){} };
      }

      // Fallback REST tick for 24h change (runs slower ‚Äî every 5s)
      async function liveTickUpdate() {
        if (isChartLoading) return;
        const data = await api.getPrice(currentSymbol);
        if (!data) return;
        const ch = data.change_24h || 0;
        const up = ch >= 0;
        const el = document.getElementById('ticker-change');
        el.className = `text-[9px] md:text-[10px] font-mono ${up ? 'text-green-500 bg-green-900/15' : 'text-red-500 bg-red-900/15'} px-1 md:px-1.5 py-0.5 rounded flex items-center gap-0.5`;
        el.innerHTML = `<iconify-icon icon="solar:arrow-right-${up?'up':'down'}-linear" class="text-[9px]"></iconify-icon>${Math.abs(ch).toFixed(1)}%`;
        // If WS is dead, fallback to REST price
        if (!priceWs || priceWs.readyState !== WebSocket.OPEN) {
          const price = Number(data.price);
          document.getElementById('ticker-price').textContent = '$' + fmtPrice(price);
          if (lastCandleData && candleSeries) {
            const updated = { time: lastCandleData.time, open: lastCandleData.open, high: Math.max(lastCandleData.high, price), low: Math.min(lastCandleData.low, price), close: price };
            candleSeries.update(updated);
            lastCandleData = updated;
          }
        }
      }

      async function updatePrice() {
        const data = await api.getPrice(currentSymbol);
        if (data && data.price) {
          document.getElementById('ticker-price').textContent = '$' + fmtPrice(data.price);
          const el = document.getElementById('ticker-change');
          const ch = data.change_24h || 0;
          const up = ch >= 0;
          el.className = `text-[9px] md:text-[10px] font-mono ${up ? 'text-green-500 bg-green-900/15' : 'text-red-500 bg-red-900/15'} px-1 md:px-1.5 py-0.5 rounded flex items-center gap-0.5`;
          el.innerHTML = `<iconify-icon icon="solar:arrow-right-${up?'up':'down'}-linear" class="text-[9px]"></iconify-icon>${Math.abs(ch).toFixed(1)}%`;
        }
      }

      // ‚îÄ‚îÄ POSITIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function loadPositions() {
        const data = await api.getPositions();
        const list = document.getElementById('positions-list');
        const ld = document.getElementById('positions-loading'); if (ld) ld.remove();
        const positions = data.positions || [];
        cachedPositions = positions;
        document.getElementById('pulse-positions').textContent = positions.length;
        document.querySelectorAll('.pulse-positions-dup').forEach(el => el.textContent = positions.length);

        if (positions.length === 0) {
          list.innerHTML = `<div class="p-8 text-center flex flex-col items-center gap-4">
            <div class="w-14 h-14 rounded-xl bg-zinc-900/50 border border-zinc-800/40 flex items-center justify-center">
              <iconify-icon icon="solar:shield-keyhole-linear" class="text-zinc-700 text-3xl"></iconify-icon>
            </div>
            <div>
              <p class="text-[12px] font-mono text-zinc-400 font-semibold">No Open Positions</p>
              <p class="text-[10px] font-mono text-zinc-600 mt-1.5 leading-relaxed max-w-[240px]">Connect your exchange via the <a href="/account" class="text-red-500 hover:text-red-400 underline underline-offset-2">Account</a> page to start monitoring with BASTION Shield.</p>
            </div>
            <a href="/account" class="flex items-center gap-2 px-4 py-2 bg-red-600/10 border border-red-600/30 rounded-md text-[10px] font-mono font-bold text-red-500 hover:bg-red-600/20 hover:border-red-600/50 transition-all">
              <iconify-icon icon="solar:link-circle-bold" class="text-sm"></iconify-icon>Connect Exchange
            </a>
          </div>`;
          document.getElementById('total-exposure').textContent = '$0.00';
          document.getElementById('total-pnl').textContent = '$0.00';
          updateRiskScore(0, 0);
          return;
        }

        let html = '', totalExp = 0, totalPnl = 0, maxLev = 0;
        positions.forEach((pos, idx) => {
          const dir = (pos.direction||'').toUpperCase();
          const isLong = dir === 'LONG';
          const entry = pos.entry_price || 0, current = pos.current_price || 0, size = pos.size || 0;
          const sizeUsd = pos.size_usd || (size * current);
          const pnl = pos.pnl != null ? pos.pnl : (isLong ? (current - entry) * size : (entry - current) * size);
          const pnlPct = entry > 0 ? ((isLong ? (current - entry) : (entry - current)) / entry * 100) : 0;
          const leverage = pos.leverage || 1;
          const sym = (pos.symbol||'').replace(/-PERP$/i, '');
          totalExp += Math.abs(sizeUsd); totalPnl += pnl;
          if (leverage > maxLev) maxLev = leverage;

          html += `<div class="pos-card p-3 border-b border-zinc-800/30 relative ${shieldActive ? 'shield-card-active' : ''}" data-symbol="${pos.symbol}" data-sym="${sym}" onclick="switchSymbol('${sym}')" style="${shieldActive ? 'animation-delay: ' + (idx * 0.3) + 's' : ''}">
            <div class="flex justify-between items-start mb-2">
              <div class="flex items-center gap-2">
                <span class="font-mono font-bold text-[13px] text-white">${sym}</span>
                <span class="text-[9px] ${isLong ? 'bg-green-900/15 text-green-500 border-green-900/20' : 'bg-red-900/15 text-red-500 border-red-900/20'} border px-1.5 py-0.5 rounded font-mono font-bold">${dir}</span>
                ${leverage > 1 ? `<span class="text-[9px] font-mono text-zinc-600">${leverage}x</span>` : ''}
              </div>
              <div class="text-right">
                <span class="font-mono text-sm ${pnl >= 0 ? 'text-green-500' : 'text-red-500'} font-bold block">${pnl >= 0 ? '+' : ''}$${Math.abs(pnl).toFixed(2)}</span>
                <span class="font-mono text-[9px] ${pnlPct >= 0 ? 'text-green-600' : 'text-red-600'}">${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%</span>
              </div>
            </div>
            <div class="flex justify-between items-center text-[10px] font-mono text-zinc-600">
              <span>Entry <span class="text-zinc-400">${fmt(entry)}</span></span>
              <span>Mark <span class="text-zinc-400">${fmt(current)}</span></span>
              <span>Size <span class="text-zinc-400">$${fmtPrice(sizeUsd)}</span></span>
            </div>
            ${pos.stop_loss || pos.take_profit || pos.liquidation_price ? `<div class="flex justify-between items-center text-[9px] font-mono text-zinc-700 mt-1.5 pt-1.5 border-t border-zinc-800/30">${pos.stop_loss ? `<span>SL <span class="text-red-500/80">${fmt(pos.stop_loss)}</span></span>` : '<span class="text-zinc-800">SL ‚Äî</span>'}${pos.take_profit ? `<span>TP <span class="text-green-500/80">${fmt(pos.take_profit)}</span></span>` : '<span class="text-zinc-800">TP ‚Äî</span>'}${pos.liquidation_price ? `<span>Liq <span class="text-red-700/70">${fmt(pos.liquidation_price)}</span></span>` : ''}</div>` : ''}
          </div>`;
        });
        list.innerHTML = html;

        document.getElementById('total-exposure').textContent = '$' + fmtPrice(totalExp);
        const pEl = document.getElementById('total-pnl');
        pEl.textContent = (totalPnl >= 0 ? '+' : '') + '$' + Math.abs(totalPnl).toFixed(2);
        pEl.className = `text-[11px] font-mono ${totalPnl >= 0 ? 'text-green-500' : 'text-red-500'} font-bold`;

        // Compute portfolio risk score (heuristic: leverage + drawdown + concentration)
        const avgLev = positions.reduce((s, p) => s + (p.leverage || 1), 0) / positions.length;
        const negPnlRatio = positions.filter(p => { const d = (p.direction||'').toUpperCase(); const pnl = d === 'LONG' ? (p.current_price - p.entry_price) : (p.entry_price - p.current_price); return pnl < 0; }).length / positions.length;
        const riskScore = Math.min(100, Math.round((avgLev / 50) * 30 + negPnlRatio * 40 + (maxLev / 125) * 30));
        updateRiskScore(riskScore, positions.length);

        // Re-apply cached shield results after cards re-render
        reapplyShieldResults();
      }

      function updateRiskScore(score, posCount) {
        const ring = document.getElementById('risk-ring');
        const val = document.getElementById('risk-value');
        const label = document.getElementById('risk-label');
        const circumference = 97.4;
        const offset = circumference - (score / 100) * circumference;
        ring.style.strokeDashoffset = offset;
        val.textContent = posCount > 0 ? score : '--';
        if (posCount === 0) {
          ring.style.stroke = '#27272a'; label.textContent = 'No positions';
        } else if (score <= 30) {
          ring.style.stroke = '#22c55e'; label.textContent = 'Low Risk';
          val.className = 'absolute inset-0 flex items-center justify-center text-[10px] font-mono font-bold text-green-500';
        } else if (score <= 60) {
          ring.style.stroke = '#eab308'; label.textContent = 'Moderate Risk';
          val.className = 'absolute inset-0 flex items-center justify-center text-[10px] font-mono font-bold text-amber-500';
        } else {
          ring.style.stroke = '#ef4444'; label.textContent = 'High Risk';
          val.className = 'absolute inset-0 flex items-center justify-center text-[10px] font-mono font-bold text-red-500';
        }
      }

      // ‚îÄ‚îÄ SHIELD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function mapActionToCSS(action) {
        const a = (action || 'HOLD').toUpperCase();
        if (a === 'HOLD') return 'hold';
        if (a.startsWith('EXIT') || a === 'EXIT_100_PERCENT_IMMEDIATELY') return 'exit';
        if (a.startsWith('TP') || a === 'TP_PARTIAL' || a === 'TP_FULL') return 'tp';
        if (a === 'REDUCE_SIZE') return 'reduce';
        if (a === 'MOVE_STOP_TO_BREAKEVEN' || a === 'TRAIL_STOP' || a === 'ADJUST_STOP') return 'adjust';
        return 'hold';
      }

      function actionDisplayName(action) {
        const map = {
          'HOLD': 'HOLD', 'EXIT_FULL': 'EXIT', 'EXIT_100_PERCENT_IMMEDIATELY': 'EXIT NOW',
          'TP_PARTIAL': 'TAKE PROFIT', 'TP_FULL': 'TAKE PROFIT (FULL)',
          'REDUCE_SIZE': 'REDUCE', 'MOVE_STOP_TO_BREAKEVEN': 'MOVE STOP ‚Üí BE',
          'TRAIL_STOP': 'TRAIL STOP', 'ADJUST_STOP': 'ADJUST STOP'
        };
        return map[(action||'').toUpperCase()] || action;
      }

      function actionIcon(cssClass) {
        const icons = {
          'hold': 'solar:shield-check-bold', 'exit': 'solar:danger-triangle-bold',
          'tp': 'solar:wallet-money-bold', 'reduce': 'solar:chart-square-bold',
          'adjust': 'solar:settings-bold'
        };
        return icons[cssClass] || 'solar:shield-check-bold';
      }

      function urgencyBorderColor(cssClass, urgency) {
        const u = (urgency || '').toLowerCase();
        if (u === 'critical' || u === 'high') return 'border-red-800/40';
        if (cssClass === 'exit') return 'border-red-800/30';
        if (cssClass === 'hold') return 'border-green-800/20';
        if (cssClass === 'tp') return 'border-green-800/20';
        return 'border-zinc-800/30';
      }

      // Render a cached shield result onto a position card
      function renderShieldOnCard(symbol, cached) {
        const card = document.querySelector(`[data-symbol="${symbol}"]`);
        if (!card || !cached) return;
        const old = card.querySelector('.shield-analysis'); if (old) old.remove();
        const ev = cached.evaluation;
        const action = (ev.action || 'HOLD').toUpperCase();
        const urgency = (ev.urgency || 'low').toLowerCase();
        const confidence = ev.confidence || ev.conviction || null;
        const reason = ev.reason || ev.rationale || 'Monitoring position...';
        const cssClass = mapActionToCSS(action);
        const displayAction = actionDisplayName(action);
        const icon = actionIcon(cssClass);
        const borderColor = urgencyBorderColor(cssClass, urgency);
        const isUrgent = urgency === 'high' || urgency === 'critical';
        const srcCount = (cached.data_sources || []).length;
        const scanTime = cached.scanTime || new Date().toLocaleTimeString('en-US', { hour12: false });

        const confPct = confidence ? (parseFloat(confidence)*100).toFixed(0) : null;
        const confColor = confPct >= 80 ? 'text-green-500' : confPct >= 60 ? 'text-amber-500' : 'text-zinc-500';

        card.insertAdjacentHTML('beforeend', `
          <div class="shield-analysis ${borderColor} ${isUrgent ? 'pulse-glow' : ''}">
            <div class="sa-header">
              <iconify-icon icon="${icon}" class="text-sm" style="color: ${cssClass === 'exit' ? '#ef4444' : cssClass === 'hold' ? '#22c55e' : cssClass === 'tp' ? '#22c55e' : '#3b82f6'}"></iconify-icon>
              <span class="sa-action-badge action-${cssClass}">${displayAction}</span>
              ${confPct ? `<span class="sa-confidence ${confColor}">${confPct}%</span>` : ''}
              ${isUrgent ? '<span class="text-[8px] bg-red-900/30 text-red-400 px-1.5 py-0.5 rounded border border-red-900/30 font-bold tracking-wider animate-pulse">‚ö† URGENT</span>' : ''}
            </div>
            <div class="sa-reason">${escapeHtml(reason)}</div>
            <div class="sa-sources">
              <iconify-icon icon="solar:shield-check-linear" class="text-[9px]"></iconify-icon>
              ${srcCount} source${srcCount !== 1 ? 's' : ''} ¬∑ v6 model ¬∑ ${scanTime}
            </div>
          </div>
        `);
      }

      // Re-apply all cached shield results (called after positions re-render)
      function reapplyShieldResults() {
        if (!shieldActive) return;
        for (const [symbol, cached] of Object.entries(shieldResults)) {
          renderShieldOnCard(symbol, cached);
        }
      }

      async function runShieldEvaluation() {
        if (!shieldActive || cachedPositions.length === 0) return;
        const status = document.getElementById('shield-status');
        status.textContent = 'SCANNING POSITIONS...';
        for (const pos of cachedPositions) {
          try {
            const result = await api.evaluatePosition(pos);
            if (result && result.evaluation) {
              const scanTime = new Date().toLocaleTimeString('en-US', { hour12: false });
              // Cache the result so it persists across position re-renders
              shieldResults[pos.symbol] = {
                evaluation: result.evaluation,
                data_sources: result.data_sources || [],
                scanTime: scanTime
              };
              renderShieldOnCard(pos.symbol, shieldResults[pos.symbol]);

              const ev = result.evaluation;
              const cssClass = mapActionToCSS((ev.action || 'HOLD').toUpperCase());
              const isUrgent = (ev.urgency || '').toLowerCase() === 'high' || (ev.urgency || '').toLowerCase() === 'critical';
              if (cssClass === 'exit' || isUrgent) {
                const sym = (pos.symbol || '').replace(/-PERP$/i, '');
                const displayAction = actionDisplayName((ev.action || 'HOLD').toUpperCase());
                const reason = ev.reason || ev.rationale || 'Review position';
                showToast(`‚ö† ${sym}: ${displayAction} ‚Äî ${reason.substring(0, 60)}`, 'shield', 8000);
              }
            } else {
              console.warn('[SHIELD] No evaluation result for', pos.symbol, result);
              // Show fallback when model is offline but data pipeline worked
              if (result && result.data_sources && result.data_sources.length > 0) {
                const card = document.querySelector(`[data-symbol="${pos.symbol}"]`);
                if (card && !card.querySelector('.shield-analysis')) {
                  card.insertAdjacentHTML('beforeend', `
                    <div class="shield-analysis border-amber-800/30">
                      <div class="sa-header">
                        <iconify-icon icon="solar:shield-warning-bold" class="text-sm text-amber-500"></iconify-icon>
                        <span class="sa-action-badge bg-amber-900/15 text-amber-500 border-amber-800/30">MODEL OFFLINE</span>
                      </div>
                      <div class="sa-reason">AI model unreachable ‚Äî ${result.data_sources.length} data sources collected. Start vLLM on GPU cluster to enable evaluations.</div>
                      <div class="sa-sources">
                        <iconify-icon icon="solar:database-linear" class="text-[9px]"></iconify-icon>
                        ${result.data_sources.length} sources ready ¬∑ awaiting model
                      </div>
                    </div>
                  `);
                }
              }
            }
          } catch (err) {
            console.error('[SHIELD] Evaluation error for', pos.symbol, err);
          }
        }
        const scannedCount = cachedPositions.length;
        const resultCount = Object.keys(shieldResults).length;
        status.textContent = `ACTIVE ‚Äî ${resultCount}/${scannedCount} scanned ¬∑ ${new Date().toLocaleTimeString('en-US', { hour12: false })}`;
      }

      // ‚îÄ‚îÄ AUTONOMOUS ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let engineRunning = false;
      let enginePollInterval = null;

      async function toggleEngine() {
        const btn = document.getElementById('engine-toggle-btn');
        const container = document.getElementById('engine-container');
        const status = document.getElementById('engine-status');

        if (!engineRunning) {
          // Start engine
          btn.textContent = '...';
          try {
            const res = await fetch(`/api/engine/start?session_id=${sessionId}`, { method: 'POST' });
            const data = await res.json();
            if (data.success) {
              engineRunning = true;
              btn.textContent = 'Stop';
              btn.className = 'px-2 py-0.5 text-[8px] font-mono font-bold uppercase rounded border border-amber-600/60 text-amber-400 bg-amber-900/10 hover:bg-amber-900/20 transition-all';
              container.classList.add('border-amber-800/30');
              status.textContent = 'ACTIVE ‚Äî Monitoring & managing positions';
              status.className = 'text-[8px] text-amber-500 font-mono';
              showToast('Risk Engine started ‚Äî autonomous TP/SL management active', 'shield', 5000);
              showExecControls(true);
              // Poll engine status every 15s
              if (enginePollInterval) clearInterval(enginePollInterval);
              enginePollInterval = setInterval(pollEngineStatus, 15000);
              pollEngineStatus();
            } else {
              btn.textContent = 'Start';
              showToast('Engine start failed: ' + (data.error || 'unknown'), 'error', 4000);
            }
          } catch (e) {
            btn.textContent = 'Start';
            showToast('Failed to start engine', 'error', 3000);
          }
        } else {
          // Stop engine
          btn.textContent = '...';
          try {
            const res = await fetch('/api/engine/stop', { method: 'POST' });
            const data = await res.json();
            engineRunning = false;
            btn.textContent = 'Start';
            btn.className = 'px-2 py-0.5 text-[8px] font-mono font-bold uppercase rounded border border-zinc-700 text-zinc-500 hover:text-amber-400 hover:border-amber-600/40 transition-all';
            container.classList.remove('border-amber-800/30');
            status.textContent = 'Autonomous TP/SL ‚Äî Off';
            status.className = 'text-[8px] text-zinc-600 font-mono';
            document.getElementById('engine-eval-count').textContent = '';
            if (enginePollInterval) { clearInterval(enginePollInterval); enginePollInterval = null; }
            showToast('Risk Engine stopped', 'info', 3000);
            showExecControls(false);
            engineArmed = false;
          } catch (e) {
            btn.textContent = 'Stop';
          }
        }
      }

      async function pollEngineStatus() {
        if (!engineRunning) return;
        try {
          const res = await fetch('/api/engine/status');
          const data = await res.json();
          const status = document.getElementById('engine-status');
          const evalCount = document.getElementById('engine-eval-count');

          if (data.running) {
            const tracked = data.positions_tracked || 0;
            const evals = data.total_evaluations || 0;
            const actions = data.total_actions_taken || 0;
            const urgBreak = data.urgency_breakdown || {};

            let urgText = Object.entries(urgBreak).map(([k, v]) => `${v}${k[0]}`).join(' ');
            status.textContent = `ACTIVE ‚Äî ${tracked} pos tracked | ${urgText || 'scanning'}`;
            evalCount.textContent = `${evals} evals`;

            // Update position cards with engine data if available
            if (data.positions && data.positions.length > 0) {
              for (const ep of data.positions) {
                const card = document.querySelector(`[data-symbol="${ep.symbol}-PERP"]`) ||
                             document.querySelector(`[data-symbol="${ep.symbol}USDT"]`) ||
                             document.querySelector(`[data-symbol="${ep.symbol}"]`);
                if (card) {
                  let ebadge = card.querySelector('.engine-badge');
                  if (!ebadge) {
                    card.insertAdjacentHTML('beforeend', `<div class="engine-badge mt-1 flex items-center gap-1.5 text-[8px] font-mono px-2 py-1 rounded border border-amber-900/20 bg-amber-950/10"></div>`);
                    ebadge = card.querySelector('.engine-badge');
                  }
                  const urgCls = ep.urgency === 'CRITICAL' ? 'text-red-400' :
                                 ep.urgency === 'HIGH' ? 'text-amber-400' :
                                 ep.urgency === 'MEDIUM' ? 'text-yellow-500' : 'text-zinc-500';
                  ebadge.innerHTML = `<iconify-icon icon="solar:cpu-bolt-bold" class="text-amber-600"></iconify-icon><span class="font-bold ${urgCls}">${ep.last_action}</span><span class="text-zinc-600">${ep.pnl_r >= 0 ? '+' : ''}${ep.pnl_r}R</span><span class="text-zinc-700">#${ep.eval_count}</span>`;
                }
              }
            }
            // Update execution stats if armed
            if (engineArmed && data.execution) {
              const ex = data.execution;
              document.getElementById('exec-stat-total').textContent = ex.total_executions || 0;
              const vol = ex.total_volume_usd || 0;
              document.getElementById('exec-stat-volume').textContent = vol >= 1000 ? '$' + (vol / 1000).toFixed(1) + 'K' : '$' + vol.toFixed(0);
              document.getElementById('exec-count').textContent = (ex.total_executions || 0) + ' exec';
              if (ex.kill_switch) {
                document.getElementById('arm-status').textContent = '‚ö†Ô∏è KILL SWITCH ACTIVE';
                document.getElementById('arm-status').className = 'text-[8px] text-red-500 font-mono font-bold';
              }
            }
          } else {
            engineRunning = false;
            document.getElementById('engine-toggle-btn').textContent = 'Start';
            status.textContent = 'Autonomous TP/SL ‚Äî Off';
            status.className = 'text-[8px] text-zinc-600 font-mono';
            showExecControls(false);
          }
        } catch (e) { /* silent */ }
      }

      // Check engine status on load
      async function checkEngineOnLoad() {
        try {
          const res = await fetch('/api/engine/status');
          const data = await res.json();
          if (data.running) {
            engineRunning = true;
            const btn = document.getElementById('engine-toggle-btn');
            const container = document.getElementById('engine-container');
            const status = document.getElementById('engine-status');
            btn.textContent = 'Stop';
            btn.className = 'px-2 py-0.5 text-[8px] font-mono font-bold uppercase rounded border border-amber-600/60 text-amber-400 bg-amber-900/10 hover:bg-amber-900/20 transition-all';
            container.classList.add('border-amber-800/30');
            status.textContent = 'ACTIVE ‚Äî Reconnected';
            status.className = 'text-[8px] text-amber-500 font-mono';
            showExecControls(true);
            enginePollInterval = setInterval(pollEngineStatus, 15000);
            pollEngineStatus();
            // Check if execution is armed
            try {
              const exRes = await fetch('/api/engine/execution-status');
              const exData = await exRes.json();
              if (exData.total_executions > 0 || exData.kill_switch === false) {
                // Execution might be armed ‚Äî check further
                if (exData.registered_contexts && exData.registered_contexts.length > 0) {
                  engineArmed = true;
                  document.getElementById('arm-btn').textContent = 'Disarm';
                  document.getElementById('arm-btn').className = 'px-2 py-0.5 text-[8px] font-mono font-bold uppercase rounded border border-emerald-600/60 text-emerald-400 bg-emerald-900/10 hover:bg-emerald-900/20 transition-all';
                  document.getElementById('arm-status').textContent = 'ARMED ‚Äî Reconnected';
                  document.getElementById('arm-status').className = 'text-[8px] text-emerald-500 font-mono';
                  document.getElementById('kill-switch-btn').classList.remove('hidden');
                  document.getElementById('exec-stats').classList.remove('hidden');
                  pollExecutionStatus();
                }
              }
            } catch (e2) { /* silent */ }
          }
        } catch (e) { /* engine not available */ }
      }

      // ‚îÄ‚îÄ EXECUTION ENGINE CONTROLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

      let engineArmed = false;

      function showExecControls(show) {
        const el = document.getElementById('exec-controls');
        if (el) el.classList.toggle('hidden', !show);
      }

      async function armEngine() {
        const btn = document.getElementById('arm-btn');
        if (!engineArmed) {
          btn.textContent = '...';
          try {
            const res = await fetch(`/api/engine/arm?session_id=${sessionId}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                auto_execute: true,
                confidence_threshold: 0.7,
              })
            });
            const data = await res.json();
            if (data.success) {
              engineArmed = true;
              btn.textContent = 'Disarm';
              btn.className = 'px-2 py-0.5 text-[8px] font-mono font-bold uppercase rounded border border-emerald-600/60 text-emerald-400 bg-emerald-900/10 hover:bg-emerald-900/20 transition-all';
              document.getElementById('arm-status').textContent = 'ARMED ‚Äî Live execution on ' + (data.write_exchanges || []).join(', ');
              document.getElementById('arm-status').className = 'text-[8px] text-emerald-500 font-mono';
              document.getElementById('arm-icon').className = 'text-emerald-400 text-sm';
              document.getElementById('arm-container').classList.add('border-emerald-800/30');
              document.getElementById('kill-switch-btn').classList.remove('hidden');
              document.getElementById('exec-stats').classList.remove('hidden');
              showToast('‚ö° Engine ARMED ‚Äî live execution enabled on ' + (data.write_exchanges || []).join(', '), 'shield', 6000);
              pollExecutionStatus();
            } else if (data.read_only_exchanges && data.read_only_exchanges.length > 0) {
              // Exchanges are in read-only mode ‚Äî auto-upgrade to write access
              btn.textContent = 'Upgrading...';
              showToast('Upgrading exchange to trade-enabled mode...', 'info', 3000);
              const token = localStorage.getItem('bastion_token') || sessionStorage.getItem('bastion_token');
              let upgraded = false;
              for (const exName of data.read_only_exchanges) {
                try {
                  // Upgrade via server-side cloud keys (no secrets in localStorage)
                  const upRes = await fetch('/api/auth/upgrade-exchange', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, exchange: exName })
                  });
                  const upData = await upRes.json();
                  if (upData.success) {
                    upgraded = true;
                  }
                } catch (ue) { console.warn('[ARM] Upgrade failed:', ue); }
              }
              if (upgraded) {
                // Retry arming after upgrade
                showToast('Exchange upgraded ‚Äî retrying arm...', 'info', 2000);
                setTimeout(() => armEngine(), 500);
                return;
              } else {
                btn.textContent = 'Arm';
                showToast('Could not upgrade exchange. Go to Account page to reconnect with trade-enabled API keys.', 'warning', 6000);
              }
            } else {
              btn.textContent = 'Arm';
              showToast(data.error || 'Failed to arm engine', 'warning', 5000);
            }
          } catch (e) {
            btn.textContent = 'Arm';
            showToast('Failed to arm engine ‚Äî check console', 'error', 3000);
            console.error('[ARM] Error:', e);
          }
        } else {
          // Disarm
          btn.textContent = '...';
          try {
            await fetch(`/api/engine/disarm?session_id=${sessionId}`, { method: 'POST' });
            engineArmed = false;
            btn.textContent = 'Arm';
            btn.className = 'px-2 py-0.5 text-[8px] font-mono font-bold uppercase rounded border border-zinc-700 text-zinc-500 hover:text-emerald-400 hover:border-emerald-600/40 transition-all';
            document.getElementById('arm-status').textContent = 'Advisory Only ‚Äî Not Armed';
            document.getElementById('arm-status').className = 'text-[8px] text-zinc-600 font-mono';
            document.getElementById('arm-icon').className = 'text-emerald-600 text-sm';
            document.getElementById('arm-container').classList.remove('border-emerald-800/30');
            document.getElementById('kill-switch-btn').classList.add('hidden');
            showToast('Engine disarmed ‚Äî advisory mode only', 'info', 3000);
          } catch (e) { btn.textContent = 'Disarm'; }
        }
      }

      async function killSwitch() {
        if (!confirm('‚ö†Ô∏è EMERGENCY STOP\n\nThis will immediately halt ALL trade execution.\nPositions will NOT be closed ‚Äî only new orders are blocked.\n\nActivate kill switch?')) return;
        try {
          await fetch('/api/engine/kill-switch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ activate: true })
          });
          engineArmed = false;
          document.getElementById('arm-btn').textContent = 'Arm';
          document.getElementById('arm-btn').className = 'px-2 py-0.5 text-[8px] font-mono font-bold uppercase rounded border border-zinc-700 text-zinc-500 hover:text-emerald-400 hover:border-emerald-600/40 transition-all';
          document.getElementById('arm-status').textContent = '‚ö†Ô∏è KILL SWITCH ACTIVE ‚Äî All execution halted';
          document.getElementById('arm-status').className = 'text-[8px] text-red-500 font-mono font-bold';
          document.getElementById('kill-switch-btn').textContent = '‚ö†Ô∏è KILL SWITCH ACTIVE';
          document.getElementById('kill-switch-btn').className = 'w-full py-1.5 text-[9px] font-mono font-bold uppercase rounded border border-red-600 text-red-400 bg-red-950/30 cursor-not-allowed tracking-wider';
          showToast('‚ö†Ô∏è KILL SWITCH ACTIVATED ‚Äî all execution halted', 'warning', 10000);
        } catch (e) { showToast('Kill switch failed', 'error'); }
      }

      async function pollExecutionStatus() {
        if (!engineArmed) return;
        try {
          const res = await fetch('/api/engine/execution-status');
          const data = await res.json();
          if (data.available !== false) {
            document.getElementById('exec-stat-total').textContent = data.total_executions || 0;
            const vol = data.total_volume_usd || 0;
            document.getElementById('exec-stat-volume').textContent = vol >= 1000 ? '$' + (vol / 1000).toFixed(1) + 'K' : '$' + vol.toFixed(0);
            document.getElementById('exec-stat-conf').textContent = (data.min_confidence || 0.7).toFixed(2);
            document.getElementById('exec-count').textContent = (data.total_executions || 0) + ' exec';
          }
        } catch (e) { /* silent */ }
      }

      // ‚îÄ‚îÄ INTEL: SENTIMENT CARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function updateSentimentCard(fgValue, fgLabel, btcFunding, usdtDom) {
        const fgVal = document.getElementById('sent-fg-val');
        const fgLbl = document.getElementById('sent-fg-label');
        const fundEl = document.getElementById('sent-funding');
        const usdtEl = document.getElementById('sent-usdt');
        if (fgVal && fgValue != null) {
          fgVal.textContent = fgValue;
          const fc = fgValue >= 60 ? 'text-green-500' : fgValue <= 40 ? 'text-red-500' : 'text-amber-500';
          fgVal.className = `text-lg font-mono font-bold ${fc}`;
        }
        if (fgLbl && fgLabel) {
          fgLbl.textContent = fgLabel;
          const lc = (fgValue >= 60) ? 'text-green-600' : (fgValue <= 40) ? 'text-red-600' : 'text-amber-600';
          fgLbl.className = `text-[8px] font-mono ${lc} mt-0.5`;
        }
        if (fundEl && btcFunding != null) {
          const pct = (Number(btcFunding) * 100);
          fundEl.textContent = (pct >= 0 ? '+' : '') + pct.toFixed(4) + '%';
          fundEl.className = `text-lg font-mono font-bold ${pct >= 0 ? 'text-green-500' : 'text-red-500'}`;
        }
        if (usdtEl && usdtDom != null) {
          usdtEl.textContent = Number(usdtDom).toFixed(2) + '%';
          usdtEl.className = 'text-lg font-mono font-bold text-zinc-300';
        }
      }

      // ‚îÄ‚îÄ INTEL: OI CHANGES (grid-cols-4 table) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function loadOIChanges() {
        const data = await api.getOIChanges();
        const list = document.getElementById('oi-list');
        if (!data || !data.success) { list.innerHTML = '<div class="p-3 text-center text-[10px] font-mono text-zinc-600">OI data unavailable</div>'; return; }
        const items = [...(data.increases || []).slice(0, 4), ...(data.decreases || []).slice(0, 4)].sort((a, b) => Math.abs(b.oi_change_pct || 0) - Math.abs(a.oi_change_pct || 0)).slice(0, 8);
        if (items.length === 0) { list.innerHTML = '<div class="p-3 text-center text-[10px] font-mono text-zinc-600">No significant OI changes</div>'; return; }
        let html = '';
        items.forEach(item => {
          const pct = item.oi_change_pct || 0;
          const up = pct >= 0;
          const sym = item.symbol || '??';
          const usdVal = item.oi_change_formatted || (item.oi_change_usd ? (item.oi_change_usd >= 1e9 ? '$' + (item.oi_change_usd / 1e9).toFixed(1) + 'B' : item.oi_change_usd >= 1e6 ? '$' + (item.oi_change_usd / 1e6).toFixed(1) + 'M' : '$' + (item.oi_change_usd / 1e3).toFixed(0) + 'K') : '--');
          const priceStr = item.price ? '$' + fmtPrice(item.price) : '--';
          html += `<div class="grid grid-cols-4 px-3 py-2 border-b border-zinc-800/20 intel-card cursor-pointer items-center" onclick="switchSymbol('${sym}')">
            <span class="font-mono font-bold text-[10px] text-white">${sym}</span>
            <span class="text-right text-[10px] font-mono font-medium ${up ? 'text-green-500' : 'text-red-500'}">${item.oi_change_pct_formatted || (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%'}</span>
            <span class="text-right text-[9px] font-mono text-zinc-500">${usdVal}</span>
            <span class="text-right text-[9px] font-mono text-zinc-600">${priceStr}</span>
          </div>`;
        });
        list.innerHTML = html;
      }

      // ‚îÄ‚îÄ INTEL: FUNDING TABLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function loadFundingTable() {
        const list = document.getElementById('funding-list');
        try {
          const res = await fetch('/api/funding');
          if (!res.ok) throw new Error();
          const data = await res.json();
          const rates = data.rates || data;
          const symbols = ['BTC', 'ETH', 'SOL', 'XRP', 'BNB', 'AVAX', 'DOGE', 'LINK', 'ARB'];
          let html = '';
          symbols.forEach(sym => {
            const rate = rates[sym] ?? rates[sym.toLowerCase()] ?? rates[sym + 'USDT'];
            if (rate == null) return;
            const pct = Number(rate) * 100;
            const annual = pct * 3 * 365; // 3 funding per day * 365
            const rateColor = pct >= 0 ? 'text-green-500' : 'text-red-500';
            const annColor = annual >= 0 ? 'text-green-600' : 'text-red-600';
            html += `<div class="grid grid-cols-3 px-3 py-2 border-b border-zinc-800/20 intel-card items-center">
              <span class="font-mono font-bold text-[10px] text-white">${sym}</span>
              <span class="text-right text-[10px] font-mono font-medium ${rateColor}">${(pct >= 0 ? '+' : '') + pct.toFixed(4)}%</span>
              <span class="text-right text-[9px] font-mono ${annColor}">${(annual >= 0 ? '+' : '') + annual.toFixed(1)}%</span>
            </div>`;
          });
          list.innerHTML = html || '<div class="p-3 text-center text-[10px] font-mono text-zinc-600">Funding data unavailable</div>';
        } catch (e) {
          list.innerHTML = '<div class="p-3 text-center text-[10px] font-mono text-zinc-600">Funding data unavailable</div>';
        }
      }

      // ‚îÄ‚îÄ INTEL: WHALES (grid-cols-4 table) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function loadWhales() {
        const data = await api.getWhales();
        const list = document.getElementById('whale-list');
        if (!data || !data.success || !data.transactions || data.transactions.length === 0) {
          list.innerHTML = '<div class="p-3 text-center text-[10px] font-mono text-zinc-600">No recent whale activity</div>'; return;
        }
        let html = '';
        data.transactions.slice(0, 8).forEach(tx => {
          const dir = tx.direction || 'TRANSFER';
          const dirColor = dir === 'DEPOSIT' ? 'text-green-500' : dir === 'WITHDRAWAL' ? 'text-red-500' : 'text-blue-400';
          const dirLabel = dir === 'DEPOSIT' ? 'IN' : dir === 'WITHDRAWAL' ? 'OUT' : 'XFER';
          const amtStr = tx.amount_usd >= 1e9 ? '$' + (tx.amount_usd / 1e9).toFixed(1) + 'B' : tx.amount_usd >= 1e6 ? '$' + (tx.amount_usd / 1e6).toFixed(1) + 'M' : '$' + (tx.amount_usd / 1e3).toFixed(0) + 'K';
          const ts = tx.timestamp ? timeAgo(tx.timestamp) : '--';
          html += `<div class="grid grid-cols-4 px-3 py-2 border-b border-zinc-800/20 intel-card items-center">
            <span class="font-mono font-bold text-[10px] text-white">${tx.symbol || '??'}</span>
            <span class="text-[9px] font-mono font-medium ${dirColor}">${dirLabel}</span>
            <span class="text-right text-[10px] font-mono text-zinc-300 font-medium">${amtStr}</span>
            <span class="text-right text-[8px] font-mono text-zinc-600">${ts}</span>
          </div>`;
        });
        list.innerHTML = html;
      }

      // ‚îÄ‚îÄ INTEL: LIQUIDATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function loadLiquidations() {
        const list = document.getElementById('liq-list');
        const symLabel = document.getElementById('liq-symbol-label');
        if (symLabel) symLabel.textContent = currentSymbol;
        try {
          const data = await api.getLiquidations(currentSymbol);
          if (!data) { list.innerHTML = '<div class="p-3 text-center text-[10px] font-mono text-zinc-600">Liquidation data unavailable</div>'; return; }
          // Handle various response formats
          const liqs = Array.isArray(data) ? data : data.liquidations || data.data || [];
          if (liqs.length === 0) {
            list.innerHTML = '<div class="p-4 text-center flex flex-col items-center gap-1.5"><iconify-icon icon="solar:fire-linear" class="text-zinc-700 text-lg"></iconify-icon><span class="text-[10px] font-mono text-zinc-600">No recent liquidations for ' + currentSymbol + '</span></div>';
            return;
          }
          // Aggregate: total long liqs, total short liqs, largest single
          let totalLong = 0, totalShort = 0, largest = 0, count = liqs.length;
          liqs.forEach(l => {
            const val = l.usd_value || l.value || l.amount_usd || l.quantity * (l.price || 0) || 0;
            const side = (l.side || l.direction || '').toUpperCase();
            if (side === 'BUY' || side === 'LONG') totalLong += val;
            else totalShort += val;
            if (val > largest) largest = val;
          });
          const fmtUsd = (v) => v >= 1e9 ? '$' + (v / 1e9).toFixed(2) + 'B' : v >= 1e6 ? '$' + (v / 1e6).toFixed(2) + 'M' : v >= 1e3 ? '$' + (v / 1e3).toFixed(0) + 'K' : '$' + v.toFixed(0);
          const total = totalLong + totalShort;
          const longPct = total > 0 ? Math.round((totalLong / total) * 100) : 50;
          const shortPct = 100 - longPct;
          list.innerHTML = `
            <div class="px-3 py-3 space-y-3">
              <div class="flex items-center gap-2">
                <div class="flex-1 h-2 rounded-full bg-zinc-800 overflow-hidden flex">
                  <div class="h-full bg-green-600/80 transition-all" style="width: ${longPct}%"></div>
                  <div class="h-full bg-red-600/80 transition-all" style="width: ${shortPct}%"></div>
                </div>
              </div>
              <div class="grid grid-cols-3 gap-2">
                <div class="bg-[#080808] border border-zinc-800/30 rounded-md p-2 text-center">
                  <div class="text-[8px] font-mono text-green-600 uppercase mb-0.5">Longs Liq'd</div>
                  <div class="text-[11px] font-mono font-bold text-green-500">${fmtUsd(totalLong)}</div>
                  <div class="text-[8px] font-mono text-zinc-600">${longPct}%</div>
                </div>
                <div class="bg-[#080808] border border-zinc-800/30 rounded-md p-2 text-center">
                  <div class="text-[8px] font-mono text-red-600 uppercase mb-0.5">Shorts Liq'd</div>
                  <div class="text-[11px] font-mono font-bold text-red-500">${fmtUsd(totalShort)}</div>
                  <div class="text-[8px] font-mono text-zinc-600">${shortPct}%</div>
                </div>
                <div class="bg-[#080808] border border-zinc-800/30 rounded-md p-2 text-center">
                  <div class="text-[8px] font-mono text-zinc-600 uppercase mb-0.5">Largest</div>
                  <div class="text-[11px] font-mono font-bold text-amber-500">${fmtUsd(largest)}</div>
                  <div class="text-[8px] font-mono text-zinc-600">${count} events</div>
                </div>
              </div>
            </div>`;
        } catch (e) {
          list.innerHTML = '<div class="p-3 text-center text-[10px] font-mono text-zinc-600">Liquidation data unavailable</div>';
        }
      }

      // ‚îÄ‚îÄ INTEL: SIGNALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function loadSignals() {
        const list = document.getElementById('signal-list');
        list.innerHTML = '<div class="p-4 text-center"><iconify-icon icon="svg-spinners:ring-resize" class="text-amber-500 text-sm"></iconify-icon><p class="text-[9px] font-mono text-zinc-600 mt-1">Running AI scan...</p></div>';
        const data = await api.scanSignals();
        if (!data || !data.success || !data.signals || data.signals.length === 0) {
          list.innerHTML = '<div class="p-3 text-center text-[10px] font-mono text-zinc-600">No high-confidence signals detected</div>'; return;
        }
        let html = '';
        data.signals.forEach(sig => {
          const isLong = (sig.direction || '').toUpperCase() === 'LONG';
          const conf = sig.confidence || 0;
          const confColor = conf >= 80 ? 'text-green-500 bg-green-900/15 border-green-900/20' : conf >= 70 ? 'text-amber-500 bg-amber-900/15 border-amber-900/20' : 'text-zinc-400 bg-zinc-800 border-zinc-700';
          html += `<div class="intel-card p-3 cursor-pointer" onclick="switchSymbol('${sig.symbol}')">
            <div class="flex items-center justify-between mb-1.5">
              <div class="flex items-center gap-2">
                <span class="font-mono font-bold text-[12px] text-white">${sig.symbol}</span>
                <span class="text-[9px] ${isLong ? 'bg-green-900/15 text-green-500 border-green-900/20' : 'bg-red-900/15 text-red-500 border-red-900/20'} border px-1.5 py-0.5 rounded font-mono font-bold">${(sig.direction || '').toUpperCase()}</span>
              </div>
              <span class="text-[9px] font-mono ${confColor} border px-1.5 py-0.5 rounded font-bold">${conf}%</span>
            </div>
            <div class="flex gap-3 text-[9px] font-mono text-zinc-600">
              <span>Entry <span class="text-zinc-400">${fmt(sig.entry)}</span></span>
              <span>TP <span class="text-green-600">${fmt(sig.target)}</span></span>
              <span>SL <span class="text-red-600">${fmt(sig.stop)}</span></span>
            </div>
            ${sig.reason ? `<p class="text-[9px] font-mono text-zinc-500 mt-1.5 truncate">${escapeHtml(sig.reason)}</p>` : ''}
          </div>`;
        });
        list.innerHTML = html;
        showToast(`${data.signals.length} signal${data.signals.length > 1 ? 's' : ''} detected`, 'success', 3000);
      }

      // ‚îÄ‚îÄ REPORTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function loadReports() {
        const data = await api.getReports(20);
        const list = document.getElementById('report-list');
        const ld = document.getElementById('reports-loading'); if (ld) ld.remove();
        const reports = data.reports || [];
        if (reports.length === 0) {
          list.innerHTML = `<div class="p-8 text-center flex flex-col items-center gap-4">
            <div class="w-14 h-14 rounded-xl bg-purple-950/30 border border-purple-900/20 flex items-center justify-center">
              <iconify-icon icon="solar:documents-minimalistic-linear" class="text-purple-700 text-3xl"></iconify-icon>
            </div>
            <div>
              <p class="text-[12px] font-mono text-zinc-400 font-semibold">No Reports Yet</p>
              <p class="text-[10px] font-mono text-zinc-600 mt-1.5 leading-relaxed max-w-[220px]">Generate an AI-powered MCF analysis report for any asset.</p>
            </div>
            <button onclick="api.generateReport()" class="flex items-center gap-2 px-4 py-2 bg-purple-900/15 border border-purple-900/30 rounded-md text-[10px] font-mono font-bold text-purple-400 hover:bg-purple-900/30 hover:border-purple-900/50 transition-all">
              <iconify-icon icon="solar:magic-stick-3-linear" class="text-sm"></iconify-icon>Generate First Report
            </button>
          </div>`;
          return;
        }
        let html = '';
        reports.forEach(r => {
          html += `<div onclick="openReport('${r.id}')" class="report-card p-3 border-b border-zinc-800/30 cursor-pointer transition-all"><div class="flex justify-between items-start mb-1.5"><span class="text-[9px] font-mono ${biasClass(r.bias)} px-1.5 py-0.5 rounded uppercase border ${biasBorder(r.bias)} font-bold">${r.bias || 'N/A'}</span><span class="text-[9px] font-mono text-zinc-600">${timeAgo(r.generated_at || r.timestamp)}</span></div><h4 class="text-xs font-semibold text-zinc-300 mb-2 leading-tight">${escapeHtml(r.title || 'Untitled')}</h4><div class="flex gap-1.5">${(r.tags || []).map(t => `<span class="text-[8px] font-mono text-zinc-600 border border-zinc-800/50 px-1 rounded">#${t}</span>`).join('')}</div></div>`;
        });
        list.innerHTML = html;
      }
      async function openReport(id) {
        const modal = document.getElementById('report-modal');
        const body = document.getElementById('modal-body');
        const titleBar = document.getElementById('modal-title-bar');
        modal.classList.remove('hidden');
        body.innerHTML = '<div class="p-6 text-center"><iconify-icon icon="svg-spinners:ring-resize" class="text-purple-500 text-xl"></iconify-icon></div>';
        const data = await api.getReport(id);
        if (!data || !data.report) { body.innerHTML = '<div class="p-6 text-center text-red-400 text-xs font-mono">Failed to load report.</div>'; return; }
        const r = data.report;
        const s = r.sections || {};
        titleBar.textContent = 'MCF / ' + (r.id || 'REPORT').substring(0, 12).toUpperCase();
        body.innerHTML = renderReportModal(r, s);
      }
      function renderReportModal(r, s) {
        let h = '';
        // Header: bias + type + title + time
        h += `<div class="flex flex-wrap gap-2 mb-4">
          <span class="px-2 py-0.5 ${biasClass(r.bias)} border ${biasBorder(r.bias)} text-[10px] font-mono uppercase font-bold rounded">${r.bias || 'N/A'}</span>
          <span class="px-2 py-0.5 bg-zinc-900 text-zinc-500 border border-zinc-800 text-[10px] font-mono uppercase rounded">${(r.type || 'Report').replace(/_/g, ' ')}</span>
          ${s.rating ? `<span class="px-2 py-0.5 ${s.rating.includes('BUY') ? 'bg-green-900/20 text-green-400 border-green-800/30' : s.rating.includes('SELL') ? 'bg-red-900/20 text-red-400 border-red-800/30' : 'bg-zinc-900 text-zinc-400 border-zinc-700'} border text-[10px] font-mono uppercase font-bold rounded">${escapeHtml(s.rating)}</span>` : ''}
        </div>`;
        h += `<h2 class="text-lg font-bold text-white mb-2 font-mono tracking-tight">${escapeHtml(r.title || 'Untitled')}</h2>`;
        h += `<div class="text-[10px] font-mono text-zinc-600 mb-5 border-b border-zinc-800/40 pb-4">Generated <span class="text-zinc-400">${timeAgo(r.generated_at || r.timestamp)}</span> &bull; ${(r.tags || []).map(t => '#' + t).join(' ')}</div>`;

        // Institutional: price + target + conviction
        if (s.current_price || s.target_price) {
          const up = s.upside_percent || 0;
          h += `<div class="flex flex-wrap gap-4 mb-5 p-3 bg-zinc-900/30 border border-zinc-800/40 rounded-lg">`;
          if (s.current_price) h += `<div><span class="text-[8px] font-mono text-zinc-500 uppercase block">Price</span><span class="text-sm font-mono font-bold text-white">$${fmtPrice(s.current_price)}</span></div>`;
          if (s.target_price) h += `<div><span class="text-[8px] font-mono text-zinc-500 uppercase block">Target</span><span class="text-sm font-mono font-bold ${up >= 0 ? 'text-green-400' : 'text-red-400'}">$${fmtPrice(s.target_price)}</span></div>`;
          if (up) h += `<div><span class="text-[8px] font-mono text-zinc-500 uppercase block">${up >= 0 ? 'Upside' : 'Downside'}</span><span class="text-sm font-mono font-bold ${up >= 0 ? 'text-green-400' : 'text-red-400'}">${up >= 0 ? '+' : ''}${up.toFixed(1)}%</span></div>`;
          if (s.conviction) h += `<div><span class="text-[8px] font-mono text-zinc-500 uppercase block">Conviction</span><span class="text-sm font-mono font-bold text-white">${s.conviction}%</span></div>`;
          if (s.horizon) h += `<div><span class="text-[8px] font-mono text-zinc-500 uppercase block">Horizon</span><span class="text-sm font-mono font-bold text-zinc-300">${escapeHtml(s.horizon)}</span></div>`;
          h += `</div>`;
        }

        // Thesis
        if (s.thesis) {
          h += `<div class="mb-5"><h3 class="text-[10px] font-mono font-bold text-white uppercase tracking-widest border-l-2 border-green-500 pl-2 mb-2">Investment Thesis</h3>
            <p class="text-[12px] leading-6 text-zinc-300 pl-3 border-l border-green-500/20">${escapeHtml(s.thesis)}</p></div>`;
        }

        // Key Drivers
        if (s.key_drivers && s.key_drivers.length > 0) {
          h += `<div class="mb-5"><h3 class="text-[10px] font-mono font-bold text-white uppercase tracking-widest border-l-2 border-cyan-500 pl-2 mb-2">Key Drivers</h3><div class="space-y-2">`;
          s.key_drivers.forEach((d, i) => {
            h += `<div class="flex items-start gap-2"><span class="w-4 h-4 bg-zinc-900 border border-zinc-800 rounded-sm flex items-center justify-center text-[8px] font-mono text-zinc-500 font-bold shrink-0 mt-0.5">${i+1}</span><p class="text-[12px] text-zinc-300 leading-relaxed">${escapeHtml(d.text || d)}</p></div>`;
          });
          h += `</div></div>`;
        }

        // Risk Factors
        if (s.risks && s.risks.length > 0) {
          h += `<div class="mb-5"><h3 class="text-[10px] font-mono font-bold text-white uppercase tracking-widest border-l-2 border-red-600 pl-2 mb-2">Risk Factors</h3><div class="space-y-1.5">`;
          s.risks.forEach(risk => {
            const sev = (risk.severity || 'LOW').toUpperCase();
            const sc = sev === 'HIGH' ? 'bg-red-900/30 text-red-400 border-red-700/40' : sev === 'MEDIUM' ? 'bg-yellow-900/20 text-yellow-400 border-yellow-700/30' : 'bg-zinc-900/30 text-zinc-400 border-zinc-700';
            h += `<div class="flex items-start gap-2 pl-2 border-l border-red-800/30"><span class="text-[8px] font-mono px-1 py-0.5 ${sc} rounded border font-bold shrink-0">${sev}</span><p class="text-[12px] text-zinc-300 leading-relaxed">${escapeHtml(risk.text || risk)}</p></div>`;
          });
          h += `</div></div>`;
        }

        // Valuation Scenarios
        if (s.valuation_scenarios) {
          const vs = s.valuation_scenarios;
          h += `<div class="mb-5"><h3 class="text-[10px] font-mono font-bold text-white uppercase tracking-widest border-l-2 border-yellow-500 pl-2 mb-2">Valuation Scenarios</h3><div class="grid grid-cols-3 gap-2">`;
          ['bear', 'base', 'bull'].forEach(k => {
            if (!vs[k]) return;
            const v = vs[k]; const cl = k === 'bear' ? 'border-red-800/30 text-red-400' : k === 'bull' ? 'border-green-800/30 text-green-400' : 'border-yellow-800/30 text-yellow-400';
            h += `<div class="p-2 bg-zinc-900/30 border ${cl} rounded-md"><div class="text-[8px] font-mono text-zinc-500 uppercase mb-1">${k}</div><div class="text-sm font-mono font-bold">$${fmtPrice(v.price || v.target || 0)}</div>${v.probability ? `<div class="text-[8px] font-mono text-zinc-500">${v.probability}% prob</div>` : ''}</div>`;
          });
          h += `</div></div>`;
        }

        // Trade Structures
        if (s.trade_structures && s.trade_structures.length > 0) {
          h += `<div class="mb-5"><h3 class="text-[10px] font-mono font-bold text-white uppercase tracking-widest border-l-2 border-indigo-500 pl-2 mb-2">Trade Structures</h3><div class="space-y-2">`;
          s.trade_structures.forEach(t => {
            const dc = t.direction === 'LONG' ? 'text-green-500' : 'text-red-500';
            h += `<div class="p-2 bg-zinc-900/20 border border-zinc-800/40 rounded-md flex flex-wrap gap-3 text-[10px] font-mono">
              <span class="font-bold ${dc}">${escapeHtml(t.direction || '')}</span>
              <span class="text-zinc-400">Entry: <span class="text-white">${t.entry || '--'}</span></span>
              <span class="text-zinc-400">Target: <span class="text-green-400">${t.target || '--'}</span></span>
              <span class="text-zinc-400">Stop: <span class="text-red-400">${t.stop || '--'}</span></span>
              ${t.risk_reward ? `<span class="text-zinc-400">R:R <span class="text-white">${t.risk_reward}</span></span>` : ''}
            </div>`;
          });
          h += `</div></div>`;
        }

        // Catalysts
        if (s.catalysts && s.catalysts.length > 0) {
          h += `<div class="mb-5"><h3 class="text-[10px] font-mono font-bold text-white uppercase tracking-widest border-l-2 border-purple-500 pl-2 mb-2">Catalysts</h3><div class="space-y-1.5">`;
          s.catalysts.forEach(c => {
            h += `<div class="flex items-start gap-2 text-[12px] text-zinc-300"><iconify-icon icon="solar:bolt-circle-linear" class="text-purple-400 text-xs mt-0.5 shrink-0"></iconify-icon><span>${escapeHtml(c.text || c)}</span></div>`;
          });
          h += `</div></div>`;
        }

        // Summary (fallback or supplementary)
        if (r.summary) {
          h += `<div class="mb-5"><h3 class="text-[10px] font-mono font-bold text-white uppercase tracking-widest border-l-2 border-zinc-500 pl-2 mb-2">Summary</h3>
            <div class="text-[12px] leading-6 text-zinc-300 bastion-response">${renderMarkdown(r.summary)}</div></div>`;
        }

        // Fallback: if no sections rendered anything useful, show raw content or message
        if (!s.thesis && !s.key_drivers && !s.risks && !s.current_price && !r.summary) {
          h += `<div class="text-[12px] leading-6 text-zinc-300 bastion-response">${renderMarkdown(r.content || 'Report data unavailable.')}</div>`;
        }

        return h;
      }

      // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
      function fmt(n) { return n == null ? '--' : Number(n).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 }); }
      function fmtPrice(n) { return n == null ? '0.00' : n >= 1000 ? Number(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : Number(n).toFixed(2); }
      function biasClass(b) { b = (b || '').toUpperCase(); return b === 'BULLISH' ? 'bg-green-900/15 text-green-500' : b === 'BEARISH' ? 'bg-red-900/15 text-red-500' : 'bg-amber-900/15 text-amber-500'; }
      function biasBorder(b) { b = (b || '').toUpperCase(); return b === 'BULLISH' ? 'border-green-900/20' : b === 'BEARISH' ? 'border-red-900/20' : 'border-amber-900/20'; }
      function timeAgo(ts) { if (!ts) return ''; const m = Math.floor((Date.now() - new Date(ts).getTime()) / 60000); if (m < 1) return 'Just now'; if (m < 60) return m + 'm ago'; const h = Math.floor(m / 60); if (h < 24) return h + 'h ago'; return Math.floor(h / 24) + 'd ago'; }
      function renderMarkdown(md) {
        if (!md) return '';
        let h = escapeHtml(md);
        h = h.replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre class="bg-zinc-900/50 border border-zinc-800/40 rounded-md p-3 my-3 overflow-x-auto text-[11px] font-mono text-zinc-300"><code>$2</code></pre>');
        h = h.replace(/`([^`]+)`/g, '<code class="bg-zinc-800/60 text-red-400 px-1 py-0.5 rounded text-[11px] font-mono">$1</code>');
        h = h.replace(/\*\*(.+?)\*\*/g, '<strong class="text-white font-medium">$1</strong>');
        h = h.replace(/^### (.+)$/gm, '<h4 class="text-white font-mono text-xs uppercase tracking-wide font-bold mt-4 mb-2">$1</h4>');
        h = h.replace(/^## (.+)$/gm, '<h3 class="text-white font-mono text-sm uppercase tracking-wide font-bold mt-4 mb-2">$1</h3>');
        h = h.replace(/^# (.+)$/gm, '<h2 class="text-white font-mono text-base uppercase tracking-wide font-bold mt-4 mb-2">$1</h2>');
        h = h.replace(/^[\-\*] (.+)$/gm, '<li class="ml-4 list-disc text-zinc-300">$1</li>');
        h = h.replace(/^(\d+)\. (.+)$/gm, '<li class="ml-4 list-decimal text-zinc-300">$2</li>');
        h = h.replace(/\|(.+)\|/g, (match) => { const cells = match.split('|').filter(c => c.trim()); if (cells.every(c => c.trim().match(/^[\-:]+$/))) return ''; return '<div class="flex gap-4 text-[10px] font-mono border-b border-zinc-800/40 py-1">' + cells.map(c => `<span class="flex-1">${c.trim()}</span>`).join('') + '</div>'; });
        h = h.replace(/\n\n/g, '</p><p class="mt-2">');
        h = h.replace(/\n/g, '<br>');
        return '<p>' + h + '</p>';
      }

      // ‚îÄ‚îÄ CHAT HISTORY PERSISTENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function loadChatHistory() {
        try {
          const res = await fetch(`/api/neural/chat/history?session_id=${sessionId}&limit=50`);
          const data = await res.json();
          if (!data.success || !data.messages || data.messages.length === 0) return;
          const box = document.getElementById('chat-messages');
          if (!box) return;
          // Clear any default welcome message
          const existing = box.querySelectorAll('.msg-new');
          // Render historical messages
          for (const msg of data.messages) {
            const t = new Date(msg.created_at).toLocaleTimeString('en-US', { hour12: false });
            if (msg.role === 'user') {
              box.insertAdjacentHTML('beforeend', `<div class="flex gap-3 max-w-[80%] ml-auto flex-row-reverse msg-new"><div class="w-7 h-7 rounded-md bg-zinc-800 border border-zinc-700/60 flex items-center justify-center shrink-0 text-white"><iconify-icon icon="solar:user-circle-bold" class="text-sm"></iconify-icon></div><div class="flex flex-col gap-1 items-end"><div class="text-[10px] font-mono text-zinc-600">YOU &bull; ${t}</div><div class="bg-red-950/20 border border-red-900/20 p-3 rounded-tl-lg rounded-b-lg text-xs leading-relaxed text-zinc-200">${escapeHtml(msg.content)}</div></div></div>`);
            } else if (msg.role === 'assistant') {
              box.insertAdjacentHTML('beforeend', `<div class="flex gap-3 max-w-[90%] msg-new"><div class="w-7 h-7 rounded-md bg-red-950/40 border border-red-900/30 flex items-center justify-center shrink-0 text-red-500"><iconify-icon icon="solar:shield-bold" class="text-sm"></iconify-icon></div><div class="flex flex-col gap-1"><div class="text-[10px] font-mono text-zinc-600">BASTION &bull; ${t}</div><div class="bg-[#0A0A0A] border border-zinc-800/60 p-3 rounded-tr-lg rounded-b-lg text-xs leading-relaxed text-zinc-300 bastion-response">${renderMarkdown(msg.content)}</div></div></div>`);
            }
          }
          ui.scrollToBottom();
          console.log(`[CHAT] Loaded ${data.messages.length} messages from history`);
        } catch (e) {
          console.log('[CHAT] No history available:', e.message);
        }
      }

      // ‚îÄ‚îÄ MARKET PULSE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function loadMarketPulse() {
        try {
          const [fgRes, fundingRes, usdtRes] = await Promise.allSettled([
            fetch('/api/fear-greed').then(r => r.json()),
            fetch('/api/funding').then(r => r.json()),
            fetch('/api/usdt-dominance').then(r => r.json())
          ]);
          let _fgVal = null, _fgLabel = null, _btcFunding = null, _usdtDom = null;
          if (fgRes.status === 'fulfilled' && fgRes.value) {
            const fg = fgRes.value;
            const val = fg.value ?? fg.index ?? '--';
            const label = fg.label || fg.classification || '--';
            _fgVal = val; _fgLabel = label;
            const lc = val >= 60 ? 'bg-green-900/20 text-green-500' : val <= 40 ? 'bg-red-900/20 text-red-500' : 'bg-amber-900/20 text-amber-500';
            document.getElementById('pulse-fg').textContent = val;
            document.getElementById('pulse-fg-label').textContent = label;
            document.getElementById('pulse-fg-label').className = `text-[8px] px-1 rounded ${lc}`;
            document.querySelectorAll('.pulse-fg-dup').forEach(el => el.textContent = val);
            document.querySelectorAll('.pulse-fg-label-dup').forEach(el => { el.textContent = label; el.className = `pulse-fg-label-dup text-[8px] px-1 rounded ${lc}`; });
          }
          if (fundingRes.status === 'fulfilled' && fundingRes.value) {
            const fd = fundingRes.value; const rates = fd.rates || fd;
            const fmtR = (r) => { if (r == null) return '--'; const p = (Number(r) * 100); return (p >= 0 ? '+' : '') + p.toFixed(4) + '%'; };
            const cR = (r) => { if (r == null) return 'text-zinc-400'; return Number(r) >= 0 ? 'text-green-500' : 'text-red-500'; };
            const btc = rates.BTC ?? rates.btc ?? rates.BTCUSDT; const eth = rates.ETH ?? rates.eth ?? rates.ETHUSDT; const sol = rates.SOL ?? rates.sol ?? rates.SOLUSDT;
            _btcFunding = btc;
            const bEl = document.getElementById('pulse-funding'); bEl.textContent = fmtR(btc); bEl.className = `font-bold text-[10px] font-mono ${cR(btc)}`;
            document.querySelectorAll('.pulse-funding-dup').forEach(el => { el.textContent = fmtR(btc); el.className = `pulse-funding-dup font-bold text-[10px] font-mono ${cR(btc)}`; });
            const eEl = document.getElementById('pulse-eth-funding'); eEl.textContent = fmtR(eth); eEl.className = `font-bold text-[10px] font-mono ${cR(eth)}`;
            document.querySelectorAll('.pulse-eth-funding-dup').forEach(el => { el.textContent = fmtR(eth); el.className = `pulse-eth-funding-dup font-bold text-[10px] font-mono ${cR(eth)}`; });
            const sEl = document.getElementById('pulse-sol-funding'); sEl.textContent = fmtR(sol); sEl.className = `font-bold text-[10px] font-mono ${cR(sol)}`;
            document.querySelectorAll('.pulse-sol-funding-dup').forEach(el => { el.textContent = fmtR(sol); el.className = `pulse-sol-funding-dup font-bold text-[10px] font-mono ${cR(sol)}`; });
          }
          if (usdtRes.status === 'fulfilled' && usdtRes.value) {
            const ud = usdtRes.value; const dom = ud.dominance ?? ud.value ?? ud.usdt_dominance;
            _usdtDom = dom;
            const s = dom != null ? Number(dom).toFixed(2) + '%' : '--';
            document.getElementById('pulse-usdt').textContent = s;
            document.querySelectorAll('.pulse-usdt-dup').forEach(el => el.textContent = s);
          }
          // Feed sentiment card in Intel tab
          updateSentimentCard(_fgVal, _fgLabel, _btcFunding, _usdtDom);
        } catch (e) {}
      }

      // ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const toastCooldown = {};
      function showToast(message, type = 'info', duration = 6000) {
        const key = message.substring(0, 30);
        if (toastCooldown[key]) return;
        toastCooldown[key] = true; setTimeout(() => delete toastCooldown[key], 60000);
        const container = document.getElementById('toast-container'); if (!container) return;
        const icons = { info: 'solar:info-circle-bold', warning: 'solar:danger-triangle-bold', success: 'solar:check-circle-bold', shield: 'solar:shield-bold' };
        const colors = { info: 'border-blue-800/30 bg-blue-950/40', warning: 'border-amber-800/30 bg-amber-950/40', success: 'border-green-800/30 bg-green-950/40', shield: 'border-red-800/30 bg-red-950/40' };
        const ic = { info: 'text-blue-400', warning: 'text-amber-400', success: 'text-green-400', shield: 'text-red-400' };
        const el = document.createElement('div');
        el.className = `toast-in pointer-events-auto flex items-start gap-3 px-4 py-3 border ${colors[type]} rounded-lg backdrop-blur-md shadow-xl`;
        el.innerHTML = `<iconify-icon icon="${icons[type]}" class="${ic[type]} text-base mt-0.5 shrink-0"></iconify-icon><div class="flex-1"><p class="text-[11px] font-mono text-zinc-200 leading-relaxed">${escapeHtml(message)}</p></div><button onclick="this.parentElement.classList.replace('toast-in','toast-out');setTimeout(()=>this.parentElement.remove(),300)" class="text-zinc-600 hover:text-zinc-300 shrink-0 mt-0.5"><iconify-icon icon="solar:close-circle-linear" class="text-sm"></iconify-icon></button>`;
        container.appendChild(el);
        setTimeout(() => { if (el.parentNode) { el.classList.replace('toast-in', 'toast-out'); setTimeout(() => el.remove(), 300); } }, duration);
      }

      // ‚îÄ‚îÄ GLOBALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      window.fillPrompt = (txt) => { document.getElementById('chat-input').value = txt; ui.toggleChat(true); };
      window.ui = ui; window.api = api; window.showToast = showToast;
      window.switchSymbol = switchSymbol; window.switchTimeframe = switchTimeframe;
      window.openReport = openReport; window.loadSignals = loadSignals;
      window.loadLiquidations = loadLiquidations; window.loadFundingTable = loadFundingTable;
      window.toggleEngine = toggleEngine; window.pollEngineStatus = pollEngineStatus;
      window.armEngine = armEngine; window.killSwitch = killSwitch; window.showExecControls = showExecControls;

      // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function initApp() {
        try {
          const container = document.getElementById('tv-chart');
          const rect = container.getBoundingClientRect();
          chartInstance = LightweightCharts.createChart(container, {
            width: rect.width || 800, height: rect.height || 500,
            layout: { background: { color: '#080808' }, textColor: '#52525b', fontFamily: "'JetBrains Mono', monospace", fontSize: 10 },
            grid: { vertLines: { color: '#18181b' }, horzLines: { color: '#18181b' } },
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal, vertLine: { color: 'rgba(220,38,38,0.15)', width: 1, style: LightweightCharts.LineStyle.Dashed }, horzLine: { color: 'rgba(220,38,38,0.15)', width: 1, style: LightweightCharts.LineStyle.Dashed } },
            rightPriceScale: { borderColor: '#1c1c1e', scaleMargins: { top: 0.05, bottom: 0.15 } },
            timeScale: { borderColor: '#1c1c1e', timeVisible: true, secondsVisible: false },
            handleScroll: { vertTouchDrag: false },
          });
          setTimeout(() => { container.querySelectorAll('a').forEach(a => a.style.display = 'none'); }, 100);
          new MutationObserver(() => { container.querySelectorAll('a').forEach(a => a.style.display = 'none'); }).observe(container, { childList: true, subtree: true });
          candleSeries = chartInstance.addCandlestickSeries({ upColor: '#22c55e', downColor: '#ef4444', borderVisible: false, wickUpColor: '#22c55e', wickDownColor: '#ef4444' });
          volumeSeries = chartInstance.addHistogramSeries({ priceFormat: { type: 'volume' }, priceScaleId: 'vol' });
          chartInstance.priceScale('vol').applyOptions({ scaleMargins: { top: 0.85, bottom: 0 }, drawTicks: false, borderVisible: false });
          new ResizeObserver(entries => { for (const entry of entries) { const cr = entry.contentRect; if (cr.width > 0 && cr.height > 0) chartInstance.applyOptions({ width: cr.width, height: cr.height }); } }).observe(container);
          chartInstance.subscribeCrosshairMove(param => {
            if (param.seriesData && param.seriesData.get(candleSeries)) {
              const d = param.seriesData.get(candleSeries);
              document.getElementById('ohlc-overlay').innerHTML = `<span class="text-[9px] font-mono bg-[#080808]/90 text-zinc-500 px-2 py-1 border border-zinc-800/60 rounded backdrop-blur-sm">O: ${fmt(d.open)} H: ${fmt(d.high)} L: ${fmt(d.low)} C: ${fmt(d.close)}</span>`;
            }
          });

          // Auto-reconnect exchanges from localStorage (in case backend restarted)
          await autoReconnectExchanges();

          // Load all data
          await loadChart();
          updatePrice();
          loadPositions();
          loadReports();
          loadMarketPulse();
          loadOIChanges();
          loadWhales();
          loadFundingTable();
          loadLiquidations();
          loadChatHistory();

          // Restore shield
          if (shieldActive) { document.getElementById('shield-toggle').checked = true; ui.toggleShield(true); }

          // Check autonomous engine status
          checkEngineOnLoad();

          // Intervals
          connectPriceWs(); // Binance WebSocket for instant price updates
          liveTickInterval = setInterval(liveTickUpdate, 5000); // REST fallback every 5s (for 24h change)
          positionsInterval = setInterval(loadPositions, 30000);
          setInterval(loadMarketPulse, 60000);
          setInterval(loadOIChanges, 120000);
          setInterval(loadWhales, 90000);
          setInterval(loadFundingTable, 120000);
          setInterval(loadLiquidations, 60000);

          // Reload full chart data periodically (every 60s) to sync candle history
          setInterval(() => { if (!isChartLoading) loadChart(); }, 60000);

          // Close FAB on click outside
          document.addEventListener('click', (e) => {
            if (fabOpen && !e.target.closest('#fab-menu') && !e.target.closest('#fab-btn')) {
              ui.toggleFab();
            }
          });

          // Keyboard shortcuts
          document.addEventListener('keydown', (e) => {
            // Escape = close modals/chat
            if (e.key === 'Escape') {
              document.getElementById('report-modal').classList.add('hidden');
              ui.toggleChat(false);
              if (fabOpen) ui.toggleFab();
              return;
            }
            // Don't intercept if typing in input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            // 1/2/3 = switch tabs
            if (e.key === '1') { ui.switchTab('positions'); e.preventDefault(); }
            if (e.key === '2') { ui.switchTab('intel'); e.preventDefault(); }
            if (e.key === '3') { ui.switchTab('reports'); e.preventDefault(); }
            // / = focus chat
            if (e.key === '/') { ui.toggleChat(true); e.preventDefault(); }
            // S = toggle shield
            if (e.key === 's' || e.key === 'S') {
              const toggle = document.getElementById('shield-toggle');
              toggle.checked = !toggle.checked;
              ui.toggleShield(toggle.checked);
              e.preventDefault();
            }
          });

          // Dismiss splash screen
          const splash = document.getElementById('splash');
          if (splash) { splash.classList.add('fade-out'); setTimeout(() => splash.remove(), 600); }

          setTimeout(() => showToast('BASTION Lite online ‚Äî neural engine ready', 'shield', 4000), 1200);
        } catch (e) {
          console.error('[BASTION] Init error:', e);
          document.title = 'ERROR: ' + e.message;
          const splash = document.getElementById('splash');
          if (splash) { splash.classList.add('fade-out'); setTimeout(() => splash.remove(), 600); }
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        requestAnimationFrame(() => requestAnimationFrame(initApp));
      });
    </script>
</body></html>
