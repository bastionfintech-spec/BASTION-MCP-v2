<html lang="en" class="bg-[#050505] scroll-smooth"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BASTION - Institutional Research Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="/settings.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@300;400;500;700&display=swap');
      body { font-family: 'Inter', sans-serif; }
      .font-mono { font-family: 'JetBrains Mono', monospace; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .bg-grid {
        background-size: 40px 40px;
        background-image: linear-gradient(to right, #27272a 1px, transparent 1px),
        linear-gradient(to bottom, #27272a 1px, transparent 1px);
      }
      .custom-scroll::-webkit-scrollbar { width: 4px; }
      .custom-scroll::-webkit-scrollbar-track { background: #09090b; }
      .custom-scroll::-webkit-scrollbar-thumb { background: #27272a; border-radius: 2px; }
      .custom-scroll::-webkit-scrollbar-thumb:hover { background: #3f3f46; }
      .report-item.active { background: #0a0a0a; border-left-color: #16a34a; }
      .report-item:not(.active) { border-left-color: transparent; }
      .report-item:not(.active):hover { border-left-color: #3f3f46; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
      .fade-in { animation: fadeIn 0.3s ease-out; }
      @keyframes pulse-slow { 0%,100% { opacity: 0.4; } 50% { opacity: 1; } }
      .pulse-slow { animation: pulse-slow 3s ease-in-out infinite; }
    </style>
  </head>
  <body class="text-zinc-400 h-screen flex flex-col selection:bg-green-500/30 selection:text-green-200 bg-[#050505] overflow-hidden">
    <!-- Header / Control Bar -->
    <header class="relative z-50 h-16 border-b border-zinc-800 bg-[#050505] flex items-center justify-between shrink-0">
      <div class="flex items-center h-full pl-6 pr-8 border-r border-zinc-800 bg-[#050505]">
        <a href="/" class="flex items-center gap-3 group">
          <iconify-icon icon="solar:shield-bold" class="text-red-600 text-2xl group-hover:scale-110 transition-transform"></iconify-icon>
          <span class="text-xl tracking-tighter text-white font-mono group-hover:text-red-600 transition-colors font-semibold">BASTION</span>
        </a>
        <div class="hidden lg:flex items-center ml-6 px-3 py-1 border border-zinc-800 bg-zinc-900/30 backdrop-blur-sm rounded-sm gap-2">
          <span class="text-[10px] font-mono text-zinc-600 leading-none">[</span>
          <span class="relative flex h-1.5 w-1.5">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-500 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-green-500"></span>
          </span>
          <span class="text-[9px] font-mono text-zinc-500 uppercase tracking-widest">ENV: LIVE</span>
          <span class="text-[10px] font-mono text-zinc-600 leading-none">]</span>
        </div>
      </div>

      <nav class="hidden lg:flex items-center h-full flex-1 justify-center">
        <div class="flex h-full items-center border-x border-zinc-800/50">
          <a href="/" class="flex items-center px-6 h-full text-[10px] font-mono uppercase tracking-widest text-zinc-400 hover:text-white hover:bg-zinc-900/50 transition-colors border-r border-zinc-800/50">Risk Engine</a>
          <a href="/research" class="flex items-center px-6 h-full text-[10px] font-mono uppercase tracking-widest text-white bg-zinc-900/50 border-r border-zinc-800/50 relative">
            Research
            <div class="absolute bottom-0 left-0 w-full h-[2px] bg-green-500"></div>
          </a>
          <a href="/visualizations" class="flex items-center text-[10px] uppercase hover:text-white hover:bg-zinc-900/50 transition-colors text-zinc-400 tracking-widest font-mono h-full border-zinc-800/50 border-r pr-6 pl-6">GRAPHS</a>
        </div>
      </nav>

      <div class="hidden md:flex items-center h-full border-l border-zinc-800 bg-[#050505]">
        <button id="latestNoteBtn" class="hidden xl:flex gap-3 hover:border-zinc-600 hover:bg-zinc-900/50 group transition-all cursor-pointer bg-zinc-900/30 border-zinc-800/50 border rounded-sm mr-4 pt-1.5 pr-3 pb-1.5 pl-6 items-center">
          <div class="relative flex h-2 w-2">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-500 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-2 w-2 bg-green-600"></span>
          </div>
          <div class="flex flex-col items-start">
            <span class="text-[8px] font-mono uppercase text-zinc-500 leading-none mb-0.5">Latest Note</span>
            <span id="latestNoteSymbol" class="text-[10px] font-mono font-bold text-zinc-300 group-hover:text-white leading-none">---</span>
            <div class="w-full h-0.5 bg-zinc-800 mt-1 rounded-full overflow-hidden">
              <div id="latestNoteBar" class="h-full bg-green-500 w-[0%] rounded-[1px]"></div>
            </div>
          </div>
          <span class="ml-2 text-[9px] font-mono text-zinc-700 border border-zinc-800 rounded px-1 group-hover:border-zinc-600 transition-colors">R</span>
        </button>
        <a href="/" class="h-full px-8 bg-zinc-900 text-zinc-400 hover:text-white text-[10px] font-mono uppercase tracking-widest hover:bg-zinc-800 transition-all flex items-center gap-2 border-r border-zinc-800">
          <iconify-icon icon="solar:arrow-left-linear" width="14"></iconify-icon>
          DASHBOARD
        </a>
      </div>
    </header>

    <!-- Subheader Bar -->
    <div class="h-[50px] border-b border-zinc-800 bg-[#050505] flex items-center px-6 gap-6 shrink-0 relative z-20">
      <div class="flex items-center gap-2 w-1/4">
        <iconify-icon icon="solar:documents-linear" class="text-green-500"></iconify-icon>
        <span class="text-xs font-mono font-semibold text-white tracking-wider uppercase">INSTITUTIONAL RESEARCH</span>
        <span id="reportCountBadge" class="text-[9px] font-mono text-zinc-500 bg-zinc-900 border border-zinc-800 px-1.5 rounded">0</span>
      </div>
      <div class="flex-1 max-w-2xl relative">
        <iconify-icon icon="solar:magnifer-linear" class="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500"></iconify-icon>
        <input id="globalSearch" type="text" placeholder="Search tickers, tags, report types..." class="w-full bg-[#0a0a0a] border border-zinc-800 h-8 pl-9 pr-4 text-xs font-mono text-white focus:outline-none focus:border-green-500 focus:ring-1 focus:ring-green-500 placeholder-zinc-600 transition-all">
        <div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1">
          <span class="bg-zinc-900 border border-zinc-800 text-[9px] px-1 text-zinc-500 font-mono rounded">/</span>
        </div>
      </div>
      <div class="flex items-center gap-2 ml-auto">
        <button onclick="filterByType(null)" class="filter-btn active-filter px-3 py-1 bg-zinc-900/50 border border-green-900/30 text-green-500 hover:bg-green-900/20 text-[10px] font-mono uppercase tracking-wide transition-colors">All</button>
        <button onclick="filterByType('market_structure')" class="filter-btn px-3 py-1 bg-zinc-900/50 border border-zinc-800 hover:border-zinc-700 text-zinc-400 hover:text-white text-[10px] font-mono uppercase tracking-wide transition-colors">Market</button>
        <button onclick="filterByType('whale_intelligence')" class="filter-btn px-3 py-1 bg-zinc-900/50 border border-zinc-800 hover:border-zinc-700 text-zinc-400 hover:text-white text-[10px] font-mono uppercase tracking-wide transition-colors">Whale</button>
        <button onclick="filterByType('cycle_position')" class="filter-btn px-3 py-1 bg-zinc-900/50 border border-zinc-800 hover:border-zinc-700 text-zinc-400 hover:text-white text-[10px] font-mono uppercase tracking-wide transition-colors">Cycle</button>
        <button onclick="filterByType('options_flow')" class="filter-btn px-3 py-1 bg-zinc-900/50 border border-zinc-800 hover:border-zinc-700 text-zinc-400 hover:text-white text-[10px] font-mono uppercase tracking-wide transition-colors">Options</button>
        <button onclick="generateNewReport()" class="px-3 py-1 bg-red-600/20 border border-red-600/50 hover:bg-red-600/30 text-red-400 hover:text-red-300 text-[10px] font-mono uppercase tracking-wide transition-colors flex items-center gap-1">
          <iconify-icon icon="solar:bolt-linear" width="12"></iconify-icon> Generate
        </button>
      </div>
    </div>

    <!-- Main Layout Grid -->
    <main class="flex-1 grid grid-cols-12 min-h-0 bg-[#050505] relative z-0">
      <div class="absolute inset-0 pointer-events-none opacity-[0.02] bg-grid z-0"></div>

      <!-- LEFT COLUMN: Report List (25%) -->
      <aside class="col-span-3 overflow-y-auto custom-scroll flex flex-col bg-[#050505] z-10 border-zinc-800 border-r">
        <div class="sticky top-0 bg-[#050505] z-20 px-4 py-3 border-b border-zinc-800 flex flex-col gap-3">
          <div class="flex justify-between items-center">
            <span class="text-[10px] font-mono text-zinc-500 uppercase tracking-widest font-bold">Research Nav</span>
            <button onclick="refreshReports()" title="Refresh">
              <iconify-icon icon="solar:refresh-circle-linear" class="text-zinc-500 hover:text-white cursor-pointer transition-colors"></iconify-icon>
            </button>
          </div>
          <div class="relative">
            <iconify-icon icon="solar:magnifer-linear" class="absolute left-2 top-1/2 -translate-y-1/2 text-zinc-500 text-xs"></iconify-icon>
            <input id="sideSearch" type="text" placeholder="Filter reports..." class="w-full bg-zinc-900/50 border border-zinc-800 h-7 pl-7 pr-2 text-[10px] font-mono text-zinc-300 focus:outline-none focus:border-green-500 rounded-sm" oninput="filterReportList()">
          </div>
        </div>
        <div class="p-4 space-y-4">
          <!-- Bias Filters -->
          <div>
            <h3 class="text-[9px] font-mono text-zinc-600 uppercase tracking-widest mb-2 font-bold">Bias Filter</h3>
            <div class="flex gap-1.5">
              <button onclick="filterByBias(null)" class="bias-btn text-[9px] font-mono px-2 py-0.5 border rounded-sm bg-zinc-900/50 border-green-900/30 text-green-500">ALL</button>
              <button onclick="filterByBias('BULLISH')" class="bias-btn text-[9px] font-mono px-2 py-0.5 border rounded-sm border-zinc-800 text-zinc-500 hover:text-green-400 hover:border-green-800">BULL</button>
              <button onclick="filterByBias('BEARISH')" class="bias-btn text-[9px] font-mono px-2 py-0.5 border rounded-sm border-zinc-800 text-zinc-500 hover:text-red-400 hover:border-red-800">BEAR</button>
              <button onclick="filterByBias('NEUTRAL')" class="bias-btn text-[9px] font-mono px-2 py-0.5 border rounded-sm border-zinc-800 text-zinc-500 hover:text-zinc-300 hover:border-zinc-600">NEUTRAL</button>
            </div>
          </div>
          <!-- Report Results -->
          <div>
            <h3 class="text-[9px] font-mono text-zinc-600 uppercase tracking-widest mb-2 font-bold">
              Results (<span id="filteredCount">0</span>)
            </h3>
            <div id="reportList" class="space-y-px border border-zinc-800 rounded-sm overflow-hidden">
              <!-- Loading State -->
              <div id="reportListLoading" class="py-8 text-center">
                <iconify-icon icon="solar:refresh-circle-linear" class="text-zinc-600 text-xl animate-spin"></iconify-icon>
                <div class="text-[10px] font-mono text-zinc-600 mt-2">Loading reports...</div>
              </div>
            </div>
          </div>
          <!-- MCF Status -->
          <div id="mcfStatusPanel" class="mt-4">
            <h3 class="text-[9px] font-mono text-zinc-600 uppercase tracking-widest mb-2 font-bold">System Status</h3>
            <div id="mcfStatus" class="text-[9px] font-mono text-zinc-600 space-y-1">
              <div class="flex items-center gap-2"><span class="w-1.5 h-1.5 rounded-full bg-zinc-700"></span> Checking...</div>
            </div>
          </div>
        </div>
      </aside>

      <!-- CENTER COLUMN: Detail View (50%) -->
      <section id="detailSection" class="col-span-6 border-r border-zinc-800 overflow-y-auto custom-scroll bg-[#050505] flex flex-col z-10">
        <!-- Empty State -->
        <div id="emptyState" class="flex-1 flex items-center justify-center">
          <div class="text-center max-w-sm">
            <iconify-icon icon="solar:documents-linear" class="text-zinc-700 text-5xl mb-4"></iconify-icon>
            <h2 class="text-lg font-mono font-bold text-zinc-500 mb-2">No Report Selected</h2>
            <p class="text-[11px] font-mono text-zinc-600 leading-relaxed">Select a report from the left panel to view institutional-grade analysis powered by BASTION AI.</p>
            <button onclick="generateNewReport()" class="mt-4 px-4 py-2 bg-red-600/20 border border-red-600/40 text-red-400 text-[10px] font-mono uppercase tracking-wide hover:bg-red-600/30 transition-colors">
              <iconify-icon icon="solar:bolt-linear" class="mr-1"></iconify-icon> Generate Fresh Report
            </button>
          </div>
        </div>

        <!-- Report Detail (hidden initially) -->
        <div id="reportDetail" class="hidden">
          <!-- Detail Header -->
          <div class="bg-[#050505] border-zinc-800 border-b pt-6 pr-6 pb-6 pl-6 relative">
            <div class="flex gap-6 pt-7 pb-8 items-center">
              <div class="absolute top-6 right-6 pointer-events-none select-none opacity-40">
                <div class="flex items-center gap-2 border border-zinc-800/50 bg-zinc-900/20 px-3 py-1.5 rounded-sm">
                  <iconify-icon icon="solar:shield-bold" class="text-zinc-600"></iconify-icon>
                  <span class="text-[10px] font-mono font-bold uppercase tracking-[0.2em] text-zinc-500">MCF Labs / Research Desk</span>
                </div>
              </div>
              <h1 id="detailSymbol" class="text-3xl font-bold font-mono text-white tracking-tight">---</h1>
              <div id="detailBiasBadge" class="px-3 py-1 text-xs font-mono font-medium uppercase tracking-wider rounded-sm">---</div>
              <div class="flex items-center gap-5 border-l border-zinc-800 pl-6">
                <div class="flex flex-col gap-0.5">
                  <span class="text-[9px] font-mono text-zinc-500 uppercase tracking-wider">Price</span>
                  <span id="detailPrice" class="text-lg font-mono font-bold text-white leading-none">---</span>
                </div>
                <div class="flex flex-col gap-0.5 pl-5 border-l border-zinc-800/50">
                  <span class="text-[9px] font-mono text-zinc-500 uppercase tracking-wider">Type</span>
                  <span id="detailType" class="text-sm font-mono font-bold text-zinc-300 leading-none">---</span>
                </div>
                <div class="flex flex-col gap-0.5 pl-5 border-l border-zinc-800/50">
                  <span class="text-[9px] font-mono text-zinc-500 uppercase tracking-wider">Sources</span>
                  <span id="detailSources" class="text-sm font-mono font-bold text-zinc-300 leading-none">---</span>
                </div>
              </div>
              <div class="ml-auto flex flex-col gap-1 w-48">
                <div class="flex justify-between text-[9px] font-mono text-zinc-500 uppercase">
                  <span>Conviction</span>
                  <span id="detailConfPct">---</span>
                </div>
                <div class="w-full h-2 bg-zinc-900 rounded-full overflow-hidden border border-zinc-800">
                  <div id="detailConfBar" class="h-full bg-[#15803d] w-[0%] rounded-[1px] transition-all duration-500"></div>
                </div>
              </div>
            </div>
            <!-- Metadata Row -->
            <div class="flex items-center gap-4 text-[10px] font-mono text-zinc-400 mb-4 pb-4 border-b border-zinc-800/50">
              <span class="font-semibold text-white">By BASTION AI</span>
              <span class="text-zinc-600">|</span>
              <span id="detailDesk">Desk: ---</span>
              <span class="text-zinc-600">|</span>
              <span id="detailPublished">Published: ---</span>
              <span class="text-zinc-600">|</span>
              <span id="detailReportId" class="bg-zinc-900 px-1.5 py-0.5 rounded text-zinc-300">---</span>
              <span class="ml-auto flex items-center gap-2 text-zinc-500">
                <iconify-icon icon="solar:shield-check-linear"></iconify-icon>
                AI Generated
              </span>
            </div>
            <!-- Tags -->
            <div id="detailTags" class="flex items-center gap-2 text-[10px] font-mono"></div>
          </div>

          <!-- Content Body -->
          <div class="p-6 bg-[#050505] space-y-10 fade-in">
            <!-- AI Badge -->
            <div class="flex items-center gap-3 bg-zinc-900/20 border border-zinc-800/60 p-2 rounded-sm max-w-fit">
              <div class="flex items-center gap-1.5 px-2 py-0.5 bg-indigo-500/10 text-indigo-400 border border-indigo-500/20 rounded text-[9px] font-mono uppercase tracking-wider font-bold">
                <iconify-icon icon="solar:magic-stick-3-linear"></iconify-icon>
                AI Generated
              </div>
              <span class="text-[10px] font-mono text-zinc-500">Confidence: <span id="detailConfText" class="text-white">---</span></span>
              <span class="w-px h-3 bg-zinc-800"></span>
              <div class="flex gap-2 text-[10px] font-mono text-zinc-400">
                <span id="detailSourceCount" class="hover:text-white cursor-pointer underline decoration-zinc-700">Sources (0)</span>
              </div>
            </div>

            <!-- Main Grid -->
            <div class="grid grid-cols-2 gap-8">
              <!-- Left: Narrative -->
              <div class="space-y-6">
                <!-- Thesis / Summary -->
                <div>
                  <h3 class="text-xs font-mono font-extrabold text-white uppercase tracking-widest border-l-2 border-green-500 pl-3 mb-4 [text-shadow:_0_0_10px_rgba(255,255,255,0.3)]">Thesis</h3>
                  <p id="detailSummary" class="text-sm leading-8 text-zinc-300 font-light">---</p>
                </div>

                <!-- IROS Analysis -->
                <div id="irosSection" class="hidden">
                  <h3 class="text-xs font-mono font-extrabold text-white uppercase tracking-widest border-l-2 border-indigo-500 pl-3 mb-4 [text-shadow:_0_0_10px_rgba(255,255,255,0.3)]">
                    <iconify-icon icon="solar:bolt-linear" class="text-indigo-400 mr-1"></iconify-icon>
                    BASTION AI Analysis
                  </h3>
                  <div id="irosContent" class="text-sm leading-8 text-zinc-300 font-light whitespace-pre-line"></div>
                </div>

                <!-- Key Drivers / Indicators -->
                <div id="driversSection">
                  <h3 class="text-xs font-mono font-extrabold text-white uppercase tracking-widest border-l-2 border-zinc-700 pl-3 mb-4 [text-shadow:_0_0_10px_rgba(255,255,255,0.3)]">Key Data</h3>
                  <ul id="detailDrivers" class="space-y-3 leading-7"></ul>
                </div>

                <!-- Risk Factors -->
                <div id="risksSection" class="hidden">
                  <h3 class="text-xs font-mono font-extrabold text-white uppercase tracking-widest border-l-2 border-red-600 pl-3 mb-4 [text-shadow:_0_0_10px_rgba(255,255,255,0.3)]">Risks</h3>
                  <ul id="detailRisks" class="space-y-3 leading-7"></ul>
                </div>
              </div>

              <!-- Right: Data Visuals -->
              <div class="space-y-6">
                <!-- Metrics Tiles -->
                <div id="metricsTiles" class="grid grid-cols-2 gap-3"></div>

                <!-- Whale Positions Table (for whale reports) -->
                <div id="whaleTable" class="hidden border border-zinc-800 bg-[#080808] p-3">
                  <div class="text-[9px] font-mono text-zinc-500 uppercase mb-2 font-bold">Top Whale Positions</div>
                  <div id="whaleTableBody" class="space-y-1"></div>
                </div>

                <!-- Valuation Scenarios (for market structure) -->
                <div id="scenarioSection" class="hidden border border-zinc-800 bg-[#080808] p-3">
                  <div class="text-[9px] font-mono text-zinc-500 uppercase mb-2 font-bold">Key Levels</div>
                  <div id="scenarioGrid" class="grid grid-cols-3 gap-px bg-zinc-800 border border-zinc-800"></div>
                  <div id="scenarioNote" class="mt-2 text-[9px] text-zinc-500 font-mono leading-tight"></div>
                </div>

                <!-- Cycle Indicators (for cycle reports) -->
                <div id="cycleSection" class="hidden">
                  <div class="text-[9px] font-mono text-zinc-500 uppercase mb-2 font-bold">Cycle Indicators</div>
                  <div id="cycleIndicators" class="space-y-3"></div>
                </div>
              </div>
            </div>

            <!-- Trade Structures (for market structure reports) -->
            <div id="tradeSection" class="hidden">
              <h3 class="text-xs font-mono font-extrabold text-white uppercase tracking-widest border-l-2 border-cyan-500 pl-3 mb-4 flex items-center justify-between [text-shadow:_0_0_10px_rgba(255,255,255,0.3)]">
                Tactical Trade Structure
                <span class="ml-auto flex items-center gap-2 text-[9px] text-zinc-400 font-normal">
                  <span class="bg-zinc-900 border border-zinc-800 px-1.5 py-0.5 rounded text-zinc-500">AUTO</span>
                  Execution via <span class="text-zinc-300 font-mono">BASTION_V6</span>
                </span>
              </h3>
              <div class="border border-zinc-800 rounded-sm overflow-hidden font-mono text-[10px]">
                <div class="grid grid-cols-6 bg-zinc-900 border-b-2 border-zinc-700 p-2 text-zinc-500 uppercase tracking-wider font-bold text-[9px]">
                  <span>Bias</span><span>Entry Zone</span><span>Target 1</span><span>Stop Loss</span><span>R:R</span><span class="text-right">Invalidation</span>
                </div>
                <div id="tradeRow" class="grid grid-cols-6 bg-[#050505] border-b border-zinc-800/50 p-2 items-center"></div>
              </div>
            </div>

            <!-- Raw Data Section -->
            <div class="pt-4 border-t border-zinc-800">
              <div class="flex gap-4 mb-3">
                <button onclick="toggleRawData()" class="text-[10px] font-mono text-zinc-500 hover:text-zinc-300 pb-0.5">
                  <iconify-icon icon="solar:code-linear" class="mr-1"></iconify-icon> View Raw JSON
                </button>
              </div>
              <pre id="rawDataPanel" class="hidden bg-[#080808] border border-zinc-800 p-4 text-[9px] font-mono text-zinc-500 overflow-auto max-h-96 rounded-sm"></pre>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT COLUMN: Sidebar (25%) -->
      <aside class="col-span-3 custom-scroll overflow-y-auto flex flex-col bg-[#050505] z-10 border-zinc-800 border-l pt-6 pr-6 pb-6 pl-6">
        <div class="flex flex-col h-full bg-[#050505]">
          <!-- Status Panel -->
          <div class="p-5 border-b-4 border-zinc-900 bg-[#080808]">
            <div class="flex justify-between items-center mb-4">
              <span class="text-[10px] font-mono font-bold text-zinc-500 uppercase tracking-widest">Report State</span>
              <span id="reportStateBadge" class="px-2 py-0.5 bg-zinc-900/20 border border-zinc-700/30 text-zinc-500 text-[10px] font-mono uppercase rounded-full">No Selection</span>
            </div>
            <div class="space-y-2">
              <label class="flex items-center gap-2 text-[10px] font-mono text-zinc-400 group">
                <div id="checkData" class="w-3 h-3 border border-zinc-700 rounded-sm flex items-center justify-center text-zinc-600"></div>
                <span>Live Data Fetched</span>
              </label>
              <label class="flex items-center gap-2 text-[10px] font-mono text-zinc-400 group">
                <div id="checkIros" class="w-3 h-3 border border-zinc-700 rounded-sm flex items-center justify-center text-zinc-600"></div>
                <span>IROS AI Analysis</span>
              </label>
              <label class="flex items-center gap-2 text-[10px] font-mono text-zinc-400 group">
                <div id="checkStored" class="w-3 h-3 border border-zinc-700 rounded-sm flex items-center justify-center text-zinc-600"></div>
                <span>Stored & Published</span>
              </label>
            </div>
          </div>

          <!-- Activity Timeline -->
          <div class="flex-1 overflow-y-auto custom-scroll pt-5 pr-5 pb-5 pl-5 space-y-6">
            <div class="text-[10px] font-mono font-bold text-zinc-500 uppercase tracking-widest mb-3">Activity</div>
            <div id="activityTimeline" class="relative pl-4 border-l border-zinc-800 space-y-6">
              <div class="relative">
                <div class="absolute -left-[25px] top-0 w-5 h-5 bg-[#050505] border border-zinc-700 rounded-full flex items-center justify-center text-zinc-500">
                  <iconify-icon icon="solar:clock-circle-linear" class="text-[10px]"></iconify-icon>
                </div>
                <div class="flex flex-col gap-0.5">
                  <span class="text-[10px] font-mono text-zinc-500">Waiting for selection...</span>
                </div>
              </div>
            </div>

            <!-- Quick Generate Buttons -->
            <div class="mt-6">
              <div class="text-[10px] font-mono font-bold text-zinc-500 uppercase tracking-widest mb-3">Quick Generate</div>
              <div class="space-y-2">
                <button onclick="generateReport('market_structure', 'BTC')" class="w-full text-left px-3 py-2 bg-zinc-900/30 border border-zinc-800 hover:border-zinc-600 rounded-sm text-[10px] font-mono text-zinc-400 hover:text-white transition-colors flex items-center gap-2">
                  <iconify-icon icon="solar:chart-2-linear" class="text-green-500"></iconify-icon> BTC Market Structure
                </button>
                <button onclick="generateReport('market_structure', 'ETH')" class="w-full text-left px-3 py-2 bg-zinc-900/30 border border-zinc-800 hover:border-zinc-600 rounded-sm text-[10px] font-mono text-zinc-400 hover:text-white transition-colors flex items-center gap-2">
                  <iconify-icon icon="solar:chart-2-linear" class="text-blue-500"></iconify-icon> ETH Market Structure
                </button>
                <button onclick="generateReport('market_structure', 'SOL')" class="w-full text-left px-3 py-2 bg-zinc-900/30 border border-zinc-800 hover:border-zinc-600 rounded-sm text-[10px] font-mono text-zinc-400 hover:text-white transition-colors flex items-center gap-2">
                  <iconify-icon icon="solar:chart-2-linear" class="text-purple-500"></iconify-icon> SOL Market Structure
                </button>
                <button onclick="generateReport('whale_intelligence', 'BTC')" class="w-full text-left px-3 py-2 bg-zinc-900/30 border border-zinc-800 hover:border-zinc-600 rounded-sm text-[10px] font-mono text-zinc-400 hover:text-white transition-colors flex items-center gap-2">
                  <iconify-icon icon="solar:eye-linear" class="text-cyan-500"></iconify-icon> BTC Whale Intel
                </button>
                <button onclick="generateReport('cycle_position')" class="w-full text-left px-3 py-2 bg-zinc-900/30 border border-zinc-800 hover:border-zinc-600 rounded-sm text-[10px] font-mono text-zinc-400 hover:text-white transition-colors flex items-center gap-2">
                  <iconify-icon icon="solar:graph-up-linear" class="text-yellow-500"></iconify-icon> Cycle Position
                </button>
              </div>
            </div>
          </div>
        </div>
      </aside>
    </main>

    <script>
    // =========================================================================
    // BASTION RESEARCH TERMINAL - Live API Integration
    // =========================================================================

    const API_BASE = window.location.origin;
    let allReports = [];
    let currentReport = null;
    let activeTypeFilter = null;
    let activeBiasFilter = null;

    // =========================================================================
    // INITIALIZATION
    // =========================================================================

    document.addEventListener('DOMContentLoaded', async () => {
      await loadReports();
      await loadMCFStatus();
      setupKeyboardShortcuts();
      // Auto-refresh every 2 minutes
      setInterval(loadReports, 120000);
    });

    // =========================================================================
    // DATA FETCHING
    // =========================================================================

    async function loadReports() {
      try {
        const params = new URLSearchParams({ limit: '100' });
        if (activeTypeFilter) params.set('type', activeTypeFilter);
        if (activeBiasFilter) params.set('bias', activeBiasFilter);

        const res = await fetch(`${API_BASE}/api/mcf/reports?${params}`);
        const data = await res.json();

        if (data.success && data.reports) {
          allReports = data.reports;
          renderReportList(allReports);
          document.getElementById('reportCountBadge').textContent = allReports.length;

          // Update Latest Note button
          if (allReports.length > 0) {
            const latest = allReports[0];
            const symbol = extractSymbol(latest);
            document.getElementById('latestNoteSymbol').textContent = symbol;
            const confPct = latest.confidence === 'HIGH' ? 85 : latest.confidence === 'MEDIUM' ? 60 : 35;
            document.getElementById('latestNoteBar').style.width = confPct + '%';
          }
        } else {
          renderEmptyList(data.error || 'No reports found');
        }
      } catch (e) {
        console.error('[Research] Load error:', e);
        renderEmptyList('Failed to connect to API');
      }
    }

    async function loadReportDetail(reportId) {
      try {
        const res = await fetch(`${API_BASE}/api/mcf/reports/${reportId}`);
        const data = await res.json();

        if (data.success && data.report) {
          currentReport = data.report;
          renderDetail(data.report);
          highlightActiveReport(reportId);
        } else {
          console.error('[Research] Report not found:', reportId);
        }
      } catch (e) {
        console.error('[Research] Detail load error:', e);
      }
    }

    async function loadMCFStatus() {
      try {
        const res = await fetch(`${API_BASE}/api/mcf/status`);
        const data = await res.json();
        if (data.success) {
          renderMCFStatus(data.status);
        }
      } catch (e) {
        console.warn('[Research] Status check failed');
      }
    }

    async function generateReport(type, symbol = 'BTC') {
      const btn = event?.target;
      if (btn) {
        btn.disabled = true;
        const orig = btn.innerHTML;
        btn.innerHTML = '<iconify-icon icon="solar:refresh-circle-linear" class="animate-spin mr-1"></iconify-icon> Generating...';
      }

      try {
        const res = await fetch(`${API_BASE}/api/mcf/generate/${type}?symbol=${symbol}`, { method: 'POST' });
        const data = await res.json();

        if (data.success && data.report) {
          // Reload list and show new report
          await loadReports();
          renderDetail(data.report);
          currentReport = data.report;
          highlightActiveReport(data.report.id);
          addActivity('Report Generated', `${type} for ${symbol}`, 'green');
        } else {
          addActivity('Generation Failed', data.error || 'Unknown error', 'red');
        }
      } catch (e) {
        addActivity('Generation Error', e.message, 'red');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = btn.getAttribute('data-orig') || 'Generate';
        }
      }
    }

    function generateNewReport() {
      generateReport('market_structure', 'BTC');
    }

    async function refreshReports() {
      const icon = document.querySelector('[icon="solar:refresh-circle-linear"]');
      if (icon) icon.classList.add('animate-spin');
      await loadReports();
      setTimeout(() => { if (icon) icon.classList.remove('animate-spin'); }, 1000);
    }

    // =========================================================================
    // RENDERING - REPORT LIST
    // =========================================================================

    function renderReportList(reports) {
      const container = document.getElementById('reportList');
      document.getElementById('filteredCount').textContent = reports.length;

      if (reports.length === 0) {
        container.innerHTML = `
          <div class="py-6 text-center text-[10px] font-mono text-zinc-600">
            No reports found. Generate one from the sidebar.
          </div>`;
        return;
      }

      container.innerHTML = reports.map((r, i) => {
        const symbol = extractSymbol(r);
        const biasColor = getBiasColor(r.bias);
        const biasLabel = getBiasLabel(r.bias);
        const timeStr = formatTime(r.generated_at);
        const typeIcon = getTypeIcon(r.type);
        const active = currentReport && currentReport.id === r.id;

        return `
          <div class="report-item ${active ? 'active bg-[#0a0a0a]' : 'bg-[#050505]'} border-l-[3px] ${active ? 'border-l-green-600' : 'border-l-transparent hover:border-l-zinc-700'} py-2 px-3 cursor-pointer border-t border-zinc-800/50 group transition-colors"
               onclick="loadReportDetail('${r.id}')" data-id="${r.id}">
            <div class="flex justify-between items-start mb-0.5">
              <span class="text-xs font-bold font-mono ${active ? biasColor : 'text-zinc-300 group-hover:text-white'}">
                ${typeIcon} ${symbol}
              </span>
              <span class="text-[9px] font-mono ${biasColor} font-bold">${biasLabel}</span>
            </div>
            <div class="flex justify-between items-end">
              <span class="text-[9px] font-mono text-zinc-500 truncate max-w-[70%]">${r.title}</span>
              <span class="text-[9px] font-mono text-zinc-600">${timeStr}</span>
            </div>
          </div>`;
      }).join('');
    }

    function renderEmptyList(msg) {
      document.getElementById('reportList').innerHTML = `
        <div class="py-6 text-center text-[10px] font-mono text-zinc-600">${msg}</div>`;
      document.getElementById('filteredCount').textContent = '0';
    }

    function highlightActiveReport(id) {
      document.querySelectorAll('.report-item').forEach(el => {
        const isActive = el.dataset.id === id;
        el.classList.toggle('active', isActive);
        el.classList.toggle('bg-[#0a0a0a]', isActive);
        el.classList.toggle('bg-[#050505]', !isActive);
        if (isActive) {
          el.classList.remove('border-l-transparent');
          el.classList.add('border-l-green-600');
        } else {
          el.classList.add('border-l-transparent');
          el.classList.remove('border-l-green-600');
        }
      });
    }

    // =========================================================================
    // RENDERING - REPORT DETAIL
    // =========================================================================

    function renderDetail(r) {
      // Show detail, hide empty state
      document.getElementById('emptyState').classList.add('hidden');
      document.getElementById('reportDetail').classList.remove('hidden');

      const symbol = extractSymbol(r);
      const sections = r.sections || {};

      // Header
      document.getElementById('detailSymbol').textContent = symbol;
      setBiasBadge(document.getElementById('detailBiasBadge'), r.bias);

      // Price
      const price = sections.key_levels?.current_price;
      document.getElementById('detailPrice').textContent = price ? '$' + formatNumber(price) : '---';

      // Type
      const typeLabels = {
        market_structure: 'Market Structure',
        whale_intelligence: 'Whale Intel',
        options_flow: 'Options Flow',
        cycle_position: 'Cycle Position',
        funding_arbitrage: 'Funding Arb',
        liquidation_cascade: 'Liquidation'
      };
      document.getElementById('detailType').textContent = typeLabels[r.type] || r.type;

      // Sources
      document.getElementById('detailSources').textContent = (r.data_sources || []).length;
      document.getElementById('detailSourceCount').textContent = `Sources (${(r.data_sources || []).length})`;

      // Confidence
      const confPct = r.confidence === 'HIGH' ? 85 : r.confidence === 'MEDIUM' ? 60 : 35;
      document.getElementById('detailConfPct').textContent = confPct + '%';
      document.getElementById('detailConfBar').style.width = confPct + '%';
      document.getElementById('detailConfText').textContent = r.confidence;

      // Metadata
      document.getElementById('detailDesk').textContent = `Type: ${typeLabels[r.type] || r.type}`;
      document.getElementById('detailPublished').textContent = `Published: ${formatDateTime(r.generated_at)}`;
      document.getElementById('detailReportId').textContent = r.id;

      // Tags
      const tagsEl = document.getElementById('detailTags');
      tagsEl.innerHTML = (r.tags || []).map(t =>
        `<span class="px-2 py-0.5 bg-zinc-900/50 border border-zinc-800 text-[9px] font-mono text-zinc-400 rounded-sm">${t}</span>`
      ).join('');

      // Summary / Thesis
      document.getElementById('detailSummary').textContent = r.summary || 'No summary available.';

      // IROS Analysis
      const irosSection = document.getElementById('irosSection');
      if (sections.iros_analysis) {
        irosSection.classList.remove('hidden');
        document.getElementById('irosContent').textContent = sections.iros_analysis;
      } else {
        irosSection.classList.add('hidden');
      }

      // Type-specific rendering
      if (r.type === 'market_structure') {
        renderMarketStructure(r);
      } else if (r.type === 'whale_intelligence') {
        renderWhaleIntelligence(r);
      } else if (r.type === 'cycle_position') {
        renderCyclePosition(r);
      } else {
        renderGenericReport(r);
      }

      // Update sidebar state
      updateSidebarState(r);

      // Raw data
      document.getElementById('rawDataPanel').textContent = JSON.stringify(r, null, 2);
      document.getElementById('rawDataPanel').classList.add('hidden');

      // Scroll to top
      document.getElementById('detailSection').scrollTop = 0;
    }

    // =========================================================================
    // TYPE-SPECIFIC RENDERERS
    // =========================================================================

    function renderMarketStructure(r) {
      const s = r.sections || {};

      // Metrics tiles
      const tiles = [];
      if (s.derivatives?.open_interest) {
        tiles.push({
          label: 'Open Interest',
          value: '$' + formatLargeNumber(s.derivatives.open_interest.value),
          sub: s.derivatives.open_interest.change_percent_24h ? `${s.derivatives.open_interest.change_percent_24h > 0 ? '+' : ''}${s.derivatives.open_interest.change_percent_24h.toFixed(1)}% 24h` : '',
          source: 'Coinglass'
        });
      }
      if (s.derivatives?.funding_rate) {
        const rate = s.derivatives.funding_rate.rate || s.derivatives.funding_rate.avg_rate || 0;
        tiles.push({
          label: 'Funding Rate',
          value: (rate * 100).toFixed(4) + '%',
          sub: rate > 0.01 ? 'Overheated' : rate < -0.01 ? 'Bearish' : 'Neutral',
          source: 'Coinglass'
        });
      }
      if (s.derivatives?.long_short_ratio) {
        tiles.push({
          label: 'Long/Short Ratio',
          value: typeof s.derivatives.long_short_ratio === 'number' ? s.derivatives.long_short_ratio.toFixed(2) : String(s.derivatives.long_short_ratio),
          sub: s.derivatives.long_short_ratio > 1 ? 'Longs Dominant' : 'Shorts Dominant',
          source: 'Coinglass'
        });
      }
      if (s.whale_positioning) {
        tiles.push({
          label: 'Whale Net Bias',
          value: s.whale_positioning.net_bias || 'N/A',
          sub: `${s.whale_positioning.position_count || 0} positions`,
          source: 'Hyperliquid'
        });
      }
      renderMetricsTiles(tiles);

      // Key drivers from data
      const drivers = [];
      if (s.whale_positioning?.total_long_usd) {
        drivers.push(`Whale Longs: $${formatLargeNumber(s.whale_positioning.total_long_usd)} | Shorts: $${formatLargeNumber(s.whale_positioning.total_short_usd)}`);
      }
      if (s.key_levels?.max_pain && s.key_levels.max_pain > 0) {
        drivers.push(`Options Max Pain: $${formatNumber(s.key_levels.max_pain)}`);
      }
      if (s.key_levels?.resistance?.length) {
        s.key_levels.resistance.forEach(l => {
          if (l.price > 0) drivers.push(`Resistance: $${formatNumber(l.price)} (${l.reason})`);
        });
      }
      if (s.key_levels?.support?.length) {
        s.key_levels.support.forEach(l => {
          if (l.price > 0) drivers.push(`Support: $${formatNumber(l.price)} (${l.reason})`);
        });
      }
      renderDrivers(drivers);

      // Risks
      const risks = [];
      if (s.key_levels?.liquidation_clusters) {
        const lc = s.key_levels.liquidation_clusters;
        if (lc.longs_at_risk?.price) risks.push(`Long liquidations cluster near $${formatNumber(lc.longs_at_risk.price)}`);
        if (lc.shorts_at_risk?.price) risks.push(`Short liquidations cluster near $${formatNumber(lc.shorts_at_risk.price)}`);
      }
      if (risks.length > 0) {
        document.getElementById('risksSection').classList.remove('hidden');
        renderRisks(risks);
      } else {
        document.getElementById('risksSection').classList.add('hidden');
      }

      // Key Levels (scenario section)
      if (s.key_levels) {
        document.getElementById('scenarioSection').classList.remove('hidden');
        const grid = document.getElementById('scenarioGrid');
        const levels = [];
        if (s.key_levels.support?.length && s.key_levels.support[0].price > 0) {
          levels.push({ label: 'SUPPORT', price: s.key_levels.support[0].price, color: 'text-green-500', reason: s.key_levels.support[0].reason });
        }
        levels.push({ label: 'CURRENT', price: s.key_levels.current_price, color: 'text-white', reason: 'Spot Price' });
        if (s.key_levels.resistance?.length && s.key_levels.resistance[0].price > 0) {
          levels.push({ label: 'RESISTANCE', price: s.key_levels.resistance[0].price, color: 'text-red-500', reason: s.key_levels.resistance[0].reason });
        }
        grid.innerHTML = levels.map(l => `
          <div class="bg-[#0c0c0c] p-2 text-center flex flex-col gap-1">
            <span class="text-[8px] font-mono text-zinc-500 uppercase tracking-wider">${l.label}</span>
            <span class="text-sm font-mono font-bold ${l.color} leading-none">$${formatNumber(l.price)}</span>
            <span class="text-[7px] font-mono text-zinc-600">${l.reason}</span>
          </div>`).join('');
      } else {
        document.getElementById('scenarioSection').classList.add('hidden');
      }

      // Trade scenario
      if (s.trade_scenario) {
        document.getElementById('tradeSection').classList.remove('hidden');
        const ts = s.trade_scenario;
        const entryStr = ts.entry_zone ? `$${formatNumber(ts.entry_zone[0])} - $${formatNumber(ts.entry_zone[1])}` : '---';
        const targetStr = ts.targets?.length && ts.targets[0] > 0 ? `$${formatNumber(ts.targets[0])}` : '---';
        const biasColor = ts.bias === 'LONG' ? 'text-green-500' : ts.bias === 'SHORT' ? 'text-red-500' : 'text-zinc-400';

        document.getElementById('tradeRow').innerHTML = `
          <span class="${biasColor} font-bold flex items-center gap-1.5">
            <span class="w-1 h-3 ${ts.bias === 'LONG' ? 'bg-green-500' : 'bg-red-500'}"></span>
            ${ts.bias || 'N/A'}
          </span>
          <span class="text-zinc-300">${entryStr}</span>
          <span class="${ts.bias === 'LONG' ? 'text-green-500' : 'text-red-500'}">${targetStr}</span>
          <span class="text-red-500">$${formatNumber(ts.stop_loss)}</span>
          <span class="text-zinc-400">${ts.risk_reward ? ts.risk_reward.toFixed(1) + ':1' : '---'}</span>
          <span class="text-right text-zinc-500 text-[9px]">${ts.invalidation || '---'}</span>`;
      } else {
        document.getElementById('tradeSection').classList.add('hidden');
      }

      // Hide whale & cycle sections
      document.getElementById('whaleTable').classList.add('hidden');
      document.getElementById('cycleSection').classList.add('hidden');
    }

    function renderWhaleIntelligence(r) {
      const s = r.sections || {};

      // Metrics
      const tiles = [];
      if (s.aggregate) {
        tiles.push({ label: 'Net Exposure', value: '$' + formatLargeNumber(Math.abs((s.aggregate.total_long_usd || 0) - (s.aggregate.total_short_usd || 0))), sub: s.aggregate.net_bias || '', source: 'Hyperliquid' });
        tiles.push({ label: 'Total Positions', value: String(s.aggregate.position_count || 0), sub: `L: $${formatLargeNumber(s.aggregate.total_long_usd || 0)}`, source: 'Hyperliquid' });
      }
      if (s.exchange_flows) {
        tiles.push({ label: 'Exchange Flow', value: s.exchange_flows.net_direction || 'N/A', sub: s.exchange_flows.period || '', source: 'Whale Alert' });
      }
      renderMetricsTiles(tiles);

      // Whale positions table
      if (s.top_positions?.length) {
        document.getElementById('whaleTable').classList.remove('hidden');
        const tbody = document.getElementById('whaleTableBody');
        tbody.innerHTML = s.top_positions.slice(0, 10).map((p, i) => {
          const sideColor = p.side === 'LONG' ? 'text-green-500' : 'text-red-500';
          const pnlColor = (p.pnl_usd || 0) >= 0 ? 'text-green-400' : 'text-red-400';
          return `
            <div class="grid grid-cols-5 gap-2 py-1 border-b border-zinc-800/30 text-[9px] font-mono items-center">
              <span class="${sideColor} font-bold">#${p.rank} ${p.side}</span>
              <span class="text-zinc-300">$${formatLargeNumber(p.size_usd)}</span>
              <span class="text-zinc-400">${p.leverage || '?'}x</span>
              <span class="text-zinc-400">$${formatNumber(p.entry_price)}</span>
              <span class="${pnlColor}">${(p.pnl_usd || 0) >= 0 ? '+' : ''}$${formatLargeNumber(Math.abs(p.pnl_usd || 0))}</span>
            </div>`;
        }).join('');
      } else {
        document.getElementById('whaleTable').classList.add('hidden');
      }

      // Drivers
      const drivers = [];
      if (s.aggregate?.net_bias) drivers.push(`Net whale bias: ${s.aggregate.net_bias}`);
      if (s.aggregate?.avg_leverage) drivers.push(`Average leverage: ${s.aggregate.avg_leverage.toFixed(1)}x`);
      if (s.pnl_analysis?.total_unrealized_pnl) drivers.push(`Total unrealized PnL: $${formatLargeNumber(s.pnl_analysis.total_unrealized_pnl)}`);
      renderDrivers(drivers);

      document.getElementById('risksSection').classList.add('hidden');
      document.getElementById('scenarioSection').classList.add('hidden');
      document.getElementById('tradeSection').classList.add('hidden');
      document.getElementById('cycleSection').classList.add('hidden');
    }

    function renderCyclePosition(r) {
      const s = r.sections || {};

      // Cycle indicators
      if (s.indicators) {
        document.getElementById('cycleSection').classList.remove('hidden');
        const container = document.getElementById('cycleIndicators');
        const indicators = [];

        if (s.indicators.bubble_index) {
          indicators.push({ name: 'Bubble Index', value: s.indicators.bubble_index.value?.toFixed(2) || '0', interpretation: s.indicators.bubble_index.interpretation, color: getInterpColor(s.indicators.bubble_index.interpretation) });
        }
        if (s.indicators.ahr999) {
          indicators.push({ name: 'AHR999', value: s.indicators.ahr999.value?.toFixed(4) || '0', interpretation: s.indicators.ahr999.interpretation, color: getInterpColor(s.indicators.ahr999.interpretation) });
        }
        if (s.indicators.puell_multiple) {
          indicators.push({ name: 'Puell Multiple', value: s.indicators.puell_multiple.value?.toFixed(4) || '0', interpretation: s.indicators.puell_multiple.interpretation, color: getInterpColor(s.indicators.puell_multiple.interpretation) });
        }

        container.innerHTML = indicators.map(ind => `
          <div class="bg-[#080808] border border-zinc-800 p-3 rounded-sm">
            <div class="flex justify-between items-center mb-2">
              <span class="text-[9px] font-mono text-zinc-500 uppercase">${ind.name}</span>
              <span class="text-[9px] font-mono px-1.5 py-0.5 rounded border ${ind.color}">${ind.interpretation}</span>
            </div>
            <div class="text-lg font-mono font-bold text-white">${ind.value}</div>
          </div>`).join('');
      } else {
        document.getElementById('cycleSection').classList.add('hidden');
      }

      // Weighted assessment
      const tiles = [];
      if (s.weighted_assessment) {
        tiles.push({ label: 'Cycle Phase', value: s.weighted_assessment.phase || 'N/A', sub: `Score: ${s.weighted_assessment.score || 0}`, source: 'BASTION' });
        tiles.push({ label: 'Recommendation', value: s.weighted_assessment.recommendation ? s.weighted_assessment.recommendation.substring(0, 30) : 'N/A', sub: '', source: 'BASTION' });
      }
      renderMetricsTiles(tiles);

      // Drivers
      const drivers = [];
      if (s.weighted_assessment?.recommendation) drivers.push(s.weighted_assessment.recommendation);
      if (s.fear_greed) drivers.push(`Fear & Greed Index: ${s.fear_greed.value} (${s.fear_greed.classification})`);
      renderDrivers(drivers);

      document.getElementById('risksSection').classList.add('hidden');
      document.getElementById('scenarioSection').classList.add('hidden');
      document.getElementById('tradeSection').classList.add('hidden');
      document.getElementById('whaleTable').classList.add('hidden');
    }

    function renderGenericReport(r) {
      const tiles = [];
      renderMetricsTiles(tiles);
      renderDrivers([r.summary || 'No details available.']);
      document.getElementById('risksSection').classList.add('hidden');
      document.getElementById('scenarioSection').classList.add('hidden');
      document.getElementById('tradeSection').classList.add('hidden');
      document.getElementById('whaleTable').classList.add('hidden');
      document.getElementById('cycleSection').classList.add('hidden');
    }

    // =========================================================================
    // RENDERING HELPERS
    // =========================================================================

    function renderMetricsTiles(tiles) {
      const container = document.getElementById('metricsTiles');
      if (!tiles.length) {
        container.innerHTML = '<div class="col-span-2 text-[10px] font-mono text-zinc-600 text-center py-4">No metrics available</div>';
        return;
      }
      container.innerHTML = tiles.map(t => `
        <div class="bg-[#080808] border border-zinc-800 p-3">
          <div class="text-[9px] font-mono text-zinc-500 uppercase mb-1">${t.label}</div>
          <div class="text-sm font-mono font-bold text-white">${t.value}
            ${t.sub ? `<span class="text-[9px] text-zinc-500 font-normal ml-1">${t.sub}</span>` : ''}
          </div>
          <div class="text-[9px] text-zinc-600 mt-1 font-mono">Source: ${t.source}</div>
        </div>`).join('');
    }

    function renderDrivers(items) {
      const ul = document.getElementById('detailDrivers');
      if (!items.length) {
        ul.innerHTML = '<li class="text-[10px] font-mono text-zinc-600">No data points available.</li>';
        return;
      }
      ul.innerHTML = items.map(d => `
        <li class="group">
          <div class="flex items-start gap-3 text-sm text-zinc-300 mb-1">
            <span class="mt-2 w-1 h-1 bg-green-600 rounded-full shrink-0"></span>
            <span>${escapeHtml(d)}</span>
          </div>
        </li>`).join('');
    }

    function renderRisks(items) {
      const ul = document.getElementById('detailRisks');
      ul.innerHTML = items.map(r => `
        <li class="flex items-start gap-3 text-sm text-zinc-300">
          <span class="mt-2 w-1 h-1 bg-red-800 rounded-full shrink-0"></span>
          <span>${escapeHtml(r)}</span>
        </li>`).join('');
    }

    function renderMCFStatus(status) {
      const el = document.getElementById('mcfStatus');
      const items = [
        { label: 'Storage', ok: status.storage_initialized },
        { label: 'Generator', ok: status.generator_initialized },
        { label: 'IROS AI', ok: status.iros_enabled },
        { label: 'Coinglass', ok: status.coinglass_available },
        { label: 'Helsinki', ok: status.helsinki_available }
      ];
      el.innerHTML = items.map(i => `
        <div class="flex items-center gap-2">
          <span class="w-1.5 h-1.5 rounded-full ${i.ok ? 'bg-green-500' : 'bg-red-500'}"></span>
          <span class="${i.ok ? 'text-zinc-400' : 'text-zinc-600'}">${i.label}</span>
        </div>`).join('');
    }

    function updateSidebarState(r) {
      const badge = document.getElementById('reportStateBadge');
      badge.textContent = 'Published';
      badge.className = 'px-2 py-0.5 bg-green-900/20 border border-green-500/30 text-green-500 text-[10px] font-mono uppercase rounded-full';

      // Checkmarks
      const hasData = (r.data_sources || []).length > 0;
      const hasIros = r.sections?.iros_analysis != null;

      setCheck('checkData', hasData);
      setCheck('checkIros', hasIros);
      setCheck('checkStored', true);

      // Activity
      addActivity('Report Loaded', `${r.id}`, 'green');
      if (hasIros) addActivity('IROS Analysis', 'AI-powered insights included', 'indigo');
    }

    function setCheck(id, checked) {
      const el = document.getElementById(id);
      if (checked) {
        el.className = 'w-3 h-3 border border-green-500 bg-green-500/20 rounded-sm flex items-center justify-center text-green-500';
        el.innerHTML = '<iconify-icon icon="solar:check-bold" class="text-[8px]"></iconify-icon>';
      } else {
        el.className = 'w-3 h-3 border border-zinc-700 rounded-sm flex items-center justify-center text-zinc-600';
        el.innerHTML = '';
      }
    }

    function addActivity(title, detail, color = 'zinc') {
      const timeline = document.getElementById('activityTimeline');
      const colors = { green: 'border-green-500/30 text-green-500', red: 'border-red-500/30 text-red-500', indigo: 'border-indigo-500/30 text-indigo-400', zinc: 'border-zinc-700 text-zinc-400' };
      const borderColor = colors[color] || colors.zinc;
      const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      const node = document.createElement('div');
      node.className = 'relative fade-in';
      node.innerHTML = `
        <div class="absolute -left-[25px] top-0 w-5 h-5 bg-[#050505] border ${borderColor.split(' ')[0]} rounded-full flex items-center justify-center ${borderColor.split(' ')[1]}">
          <iconify-icon icon="solar:bolt-linear" class="text-[10px]"></iconify-icon>
        </div>
        <div class="flex flex-col gap-0.5">
          <span class="text-[10px] font-mono ${borderColor.split(' ')[1]} font-bold">${escapeHtml(title)}</span>
          <div class="flex items-center gap-2 text-[9px] font-mono text-zinc-400">
            <span class="text-zinc-500">${now}</span>
            <span>&#8226;</span>
            <span>${escapeHtml(detail)}</span>
          </div>
        </div>`;

      timeline.insertBefore(node, timeline.firstChild);
      // Keep max 10 items
      while (timeline.children.length > 10) {
        timeline.removeChild(timeline.lastChild);
      }
    }

    // =========================================================================
    // FILTERING
    // =========================================================================

    function filterByType(type) {
      activeTypeFilter = type;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active-filter', 'border-green-900/30', 'text-green-500');
        btn.classList.add('border-zinc-800', 'text-zinc-400');
      });
      const activeBtn = event?.target;
      if (activeBtn) {
        activeBtn.classList.add('active-filter', 'border-green-900/30', 'text-green-500');
        activeBtn.classList.remove('border-zinc-800', 'text-zinc-400');
      }
      loadReports();
    }

    function filterByBias(bias) {
      activeBiasFilter = bias;
      document.querySelectorAll('.bias-btn').forEach(btn => {
        btn.classList.remove('border-green-900/30', 'text-green-500');
        btn.classList.add('border-zinc-800', 'text-zinc-500');
      });
      const activeBtn = event?.target;
      if (activeBtn) {
        activeBtn.classList.add('border-green-900/30', 'text-green-500');
        activeBtn.classList.remove('border-zinc-800', 'text-zinc-500');
      }
      loadReports();
    }

    function filterReportList() {
      const query = document.getElementById('sideSearch').value.toLowerCase().trim();
      if (!query) {
        renderReportList(allReports);
        return;
      }
      const filtered = allReports.filter(r =>
        r.title.toLowerCase().includes(query) ||
        r.id.toLowerCase().includes(query) ||
        (r.tags || []).some(t => t.toLowerCase().includes(query)) ||
        (r.summary || '').toLowerCase().includes(query)
      );
      renderReportList(filtered);
    }

    // =========================================================================
    // KEYBOARD SHORTCUTS
    // =========================================================================

    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // "/" to focus search
        if (e.key === '/' && !e.ctrlKey && !e.metaKey) {
          const active = document.activeElement;
          if (active.tagName !== 'INPUT' && active.tagName !== 'TEXTAREA') {
            e.preventDefault();
            document.getElementById('globalSearch').focus();
          }
        }
        // "R" to go to latest
        if (e.key === 'r' && !e.ctrlKey && !e.metaKey) {
          const active = document.activeElement;
          if (active.tagName !== 'INPUT' && active.tagName !== 'TEXTAREA') {
            if (allReports.length > 0) {
              loadReportDetail(allReports[0].id);
            }
          }
        }
        // Escape to clear search
        if (e.key === 'Escape') {
          document.getElementById('globalSearch').value = '';
          document.getElementById('sideSearch').value = '';
          document.getElementById('globalSearch').blur();
          renderReportList(allReports);
        }
      });

      // Global search
      document.getElementById('globalSearch').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        if (!query) {
          renderReportList(allReports);
          return;
        }
        const filtered = allReports.filter(r =>
          r.title.toLowerCase().includes(query) ||
          r.id.toLowerCase().includes(query) ||
          (r.tags || []).some(t => t.toLowerCase().includes(query)) ||
          r.type.toLowerCase().includes(query) ||
          (r.summary || '').toLowerCase().includes(query)
        );
        renderReportList(filtered);
      });
    }

    function toggleRawData() {
      const panel = document.getElementById('rawDataPanel');
      panel.classList.toggle('hidden');
    }

    // =========================================================================
    // UTILITY FUNCTIONS
    // =========================================================================

    function extractSymbol(r) {
      // Try to extract from ID (e.g., "MS-BTC-20260206-00" -> "BTC")
      const parts = (r.id || '').split('-');
      if (parts.length >= 2) {
        const sym = parts[1];
        if (sym.length <= 5 && sym === sym.toUpperCase()) return sym + '-PERP';
      }
      // Try from tags
      const symbolTags = (r.tags || []).filter(t => ['btc','eth','sol','bnb','xrp','avax','link','arb','op','doge','ada','dot','atom'].includes(t.toLowerCase()));
      if (symbolTags.length) return symbolTags[0].toUpperCase() + '-PERP';
      // Fallback from title
      const match = r.title?.match(/^(BTC|ETH|SOL|BNB|XRP|AVAX|LINK|ARB|OP|DOGE|ADA|DOT|ATOM)/i);
      if (match) return match[1].toUpperCase() + '-PERP';
      // Cycle reports
      if (r.type === 'cycle_position') return 'BTC-CYCLE';
      return r.type?.toUpperCase() || 'REPORT';
    }

    function getBiasColor(bias) {
      if (bias === 'BULLISH') return 'text-green-500';
      if (bias === 'BEARISH') return 'text-red-500';
      return 'text-zinc-400';
    }

    function getBiasLabel(bias) {
      if (bias === 'BULLISH') return 'BULL';
      if (bias === 'BEARISH') return 'BEAR';
      return 'NEUTRAL';
    }

    function setBiasBadge(el, bias) {
      if (bias === 'BULLISH') {
        el.className = 'px-3 py-1 bg-[#101e15] border border-[#1a3820] text-[#4ade80] text-xs font-mono font-medium uppercase tracking-wider rounded-sm';
        el.textContent = 'Bullish';
      } else if (bias === 'BEARISH') {
        el.className = 'px-3 py-1 bg-[#1e1010] border border-[#381a1a] text-[#f87171] text-xs font-mono font-medium uppercase tracking-wider rounded-sm';
        el.textContent = 'Bearish';
      } else {
        el.className = 'px-3 py-1 bg-zinc-900 border border-zinc-700 text-zinc-400 text-xs font-mono font-medium uppercase tracking-wider rounded-sm';
        el.textContent = 'Neutral';
      }
    }

    function getTypeIcon(type) {
      const icons = {
        market_structure: '&#x1F4CA;',
        whale_intelligence: '&#x1F433;',
        options_flow: '&#x1F4B0;',
        cycle_position: '&#x1F504;',
        funding_arbitrage: '&#x26A1;',
        liquidation_cascade: '&#x1F4A5;'
      };
      return icons[type] || '&#x1F4C4;';
    }

    function getInterpColor(interp) {
      const colors = {
        STRONG_BUY: 'border-green-500/30 text-green-500 bg-green-900/10',
        BUY: 'border-green-700/30 text-green-400 bg-green-900/10',
        FAIR: 'border-zinc-700 text-zinc-400 bg-zinc-900/10',
        UNDERVALUED: 'border-green-500/30 text-green-500 bg-green-900/10',
        OVERVALUED: 'border-red-500/30 text-red-500 bg-red-900/10',
        SELL: 'border-red-700/30 text-red-400 bg-red-900/10',
        STRONG_SELL: 'border-red-500/30 text-red-500 bg-red-900/10'
      };
      return colors[interp] || 'border-zinc-700 text-zinc-400 bg-zinc-900/10';
    }

    function formatNumber(n) {
      if (n == null || isNaN(n)) return '---';
      return Number(n).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    }

    function formatLargeNumber(n) {
      if (n == null || isNaN(n)) return '---';
      n = Number(n);
      if (Math.abs(n) >= 1e9) return (n / 1e9).toFixed(2) + 'B';
      if (Math.abs(n) >= 1e6) return (n / 1e6).toFixed(1) + 'M';
      if (Math.abs(n) >= 1e3) return (n / 1e3).toFixed(1) + 'K';
      return n.toFixed(0);
    }

    function formatTime(iso) {
      try {
        const d = new Date(iso);
        const now = new Date();
        const diffMs = now - d;
        const diffH = diffMs / 3600000;
        if (diffH < 1) return Math.floor(diffMs / 60000) + 'm ago';
        if (diffH < 24) return Math.floor(diffH) + 'h ago';
        if (diffH < 48) return 'YESTERDAY';
        return Math.floor(diffH / 24) + 'D AGO';
      } catch (e) { return '---'; }
    }

    function formatDateTime(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      } catch (e) { return '---'; }
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }
    </script>
</body></html>
