<html lang="en" class="bg-[#050505] scroll-smooth antialiased"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BASTION - Research Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=JetBrains+Mono:wght@400;500;700&display=swap');
      body { font-family: 'Inter', sans-serif; }
      .font-mono { font-family: 'JetBrains Mono', monospace; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .tactical-grid {
        background-size: 40px 40px;
        background-image:
          linear-gradient(to right, rgba(220, 38, 38, 0.07) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(220, 38, 38, 0.07) 1px, transparent 1px);
        mask-image: radial-gradient(ellipse at center top, black 40%, transparent 80%);
        -webkit-mask-image: radial-gradient(ellipse at center top, black 40%, transparent 80%);
        pointer-events: none;
        z-index: 1;
      }
      .scanlines {
        background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.3));
        background-size: 100% 3px;
        pointer-events: none;
        z-index: 50;
        opacity: 0.3;
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'crimson': {
                400: '#F87171', 500: '#EF4444', 600: '#DC2626', 700: '#B91C1C', 900: '#7F1D1D', 950: '#450A0A'
              },
              'zinc': {
                850: '#1f1f22', 900: '#18181b', 950: '#09090b',
              }
            }
          }
        }
      };
    </script>
</head>
<body class="text-zinc-400 min-h-screen flex flex-col selection:bg-crimson-600 selection:text-white bg-[#050505] overflow-x-auto font-sans">
    <!-- CRIMSON ENERGY BEAM -->
    <div class="fixed top-0 left-1/2 -translate-x-1/2 w-[1200px] h-[600px] bg-gradient-to-b from-purple-600/20 via-crimson-900/10 to-transparent blur-[100px] rounded-full pointer-events-none z-0 mix-blend-screen opacity-80"></div>
    <div class="fixed top-[-100px] left-1/2 -translate-x-1/2 w-[600px] h-[300px] bg-purple-500/15 blur-[80px] rounded-full pointer-events-none z-0 mix-blend-screen"></div>

    <!-- Tactical Grid Overlay -->
    <div class="fixed inset-0 tactical-grid pointer-events-none z-0"></div>

    <!-- Scanlines Overlay -->
    <div class="fixed inset-0 pointer-events-none z-50 scanlines mix-blend-overlay"></div>

    <main class="flex-1 flex flex-col min-h-screen font-sans z-10 relative">
      <div class="w-full h-full bg-[#0A0A0A] border-t border-zinc-800 relative flex-1 flex flex-col">
        <!-- Scanline overlay -->
        <div class="absolute inset-0 pointer-events-none z-50 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.1)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] bg-[length:100%_2px,3px_100%] bg-repeat opacity-20 mix-blend-overlay"></div>

        <!-- TERMINAL TOP BAR -->
        <div class="bg-zinc-900/90 border-b border-zinc-800 p-2 flex items-center justify-between gap-4 text-[10px] font-mono select-none relative z-20 border-l-2 border-purple-600">
          <!-- Left -->
          <div class="flex items-center gap-6">
            <a href="/" class="flex items-center gap-2 font-bold text-white tracking-tighter text-sm hover:text-crimson-500 transition-colors">
              <iconify-icon icon="solar:shield-bold" class="text-crimson-600"></iconify-icon>
              BASTION
            </a>
            <div class="flex items-center gap-2 px-3 py-1 bg-purple-950/30 border border-purple-900/50 rounded text-purple-400 shadow-[0_0_15px_rgba(168,85,247,0.25)]">
              <iconify-icon icon="solar:document-text-bold" class="text-lg"></iconify-icon>
              RESEARCH TERMINAL
            </div>
          </div>

          <!-- Center - Navigation -->
          <div class="flex items-center gap-1 border border-zinc-800 rounded bg-zinc-900/50">
            <a href="/" class="px-4 py-1.5 text-zinc-400 hover:text-white hover:bg-zinc-800/50 transition-all rounded-l">
              <iconify-icon icon="solar:chart-bold" class="mr-1"></iconify-icon>TERMINAL
            </a>
            <a href="/visualizations" class="px-4 py-1.5 text-zinc-400 hover:text-white hover:bg-zinc-800/50 transition-all">
              <iconify-icon icon="solar:graph-new-bold" class="mr-1"></iconify-icon>3D VIZ
            </a>
            <div class="px-4 py-1.5 text-white bg-purple-600/20 border-l border-r border-purple-600/50">
              <iconify-icon icon="solar:document-text-bold" class="mr-1"></iconify-icon>RESEARCH
            </div>
            <a href="/account" class="px-4 py-1.5 text-zinc-400 hover:text-white hover:bg-zinc-800/50 transition-all rounded-r">
              <iconify-icon icon="solar:user-circle-bold" class="mr-1"></iconify-icon>ACCOUNT
            </a>
          </div>

          <!-- Right -->
          <div class="flex items-center gap-4">
            <div class="text-zinc-500" id="current-time">--:--:-- UTC</div>
          </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="flex-1 flex overflow-hidden">
          <!-- SIDEBAR - REPORT CATEGORIES -->
          <div class="w-64 bg-[#0B0B0B] border-r border-zinc-800 flex flex-col">
            <div class="p-3 border-b border-zinc-800">
              <div class="relative">
                <iconify-icon icon="solar:magnifer-linear" class="absolute left-3 top-2.5 text-zinc-600"></iconify-icon>
                <input type="text" placeholder="Search reports..." class="w-full bg-zinc-900 border border-zinc-800 text-[11px] text-white pl-9 pr-3 py-2 focus:border-purple-600 focus:outline-none placeholder-zinc-600 font-mono rounded">
              </div>
            </div>
            
            <div class="flex-1 overflow-y-auto no-scrollbar p-2">
              <div class="text-[9px] text-zinc-600 uppercase tracking-wider px-2 mb-2">Categories</div>
              
              <button data-filter-type="" class="w-full text-left px-3 py-2 rounded text-[11px] bg-purple-600/20 text-purple-400 border border-purple-600/30 mb-1 flex items-center gap-2">
                <iconify-icon icon="solar:fire-bold"></iconify-icon>
                All Reports
                <span class="ml-auto text-[9px] bg-purple-600 text-white px-1.5 py-0.5 rounded" id="count-all">--</span>
              </button>
              
              <button data-filter-type="market_structure" class="w-full text-left px-3 py-2 rounded text-[11px] text-zinc-400 hover:bg-zinc-800/50 hover:text-white transition-colors mb-1 flex items-center gap-2">
                <iconify-icon icon="solar:chart-bold"></iconify-icon>
                Market Structure
                <span class="ml-auto text-[9px] text-zinc-600" id="count-market">--</span>
              </button>
              
              <button data-filter-type="on_chain_intel" class="w-full text-left px-3 py-2 rounded text-[11px] text-zinc-400 hover:bg-zinc-800/50 hover:text-white transition-colors mb-1 flex items-center gap-2">
                <iconify-icon icon="solar:database-bold"></iconify-icon>
                On-Chain Intel
                <span class="ml-auto text-[9px] text-zinc-600" id="count-onchain">--</span>
              </button>
              
              <button data-filter-type="whale_intelligence" class="w-full text-left px-3 py-2 rounded text-[11px] text-zinc-400 hover:bg-zinc-800/50 hover:text-white transition-colors mb-1 flex items-center gap-2">
                <iconify-icon icon="solar:graph-up-bold"></iconify-icon>
                Whale Intel
                <span class="ml-auto text-[9px] text-zinc-600" id="count-whale">--</span>
              </button>
              
              <button data-filter-type="options_flow" class="w-full text-left px-3 py-2 rounded text-[11px] text-zinc-400 hover:bg-zinc-800/50 hover:text-white transition-colors mb-1 flex items-center gap-2">
                <iconify-icon icon="solar:graph-new-bold"></iconify-icon>
                Options Flow
                <span class="ml-auto text-[9px] text-zinc-600" id="count-options">--</span>
              </button>
              
              <button data-filter-type="cycle_position" class="w-full text-left px-3 py-2 rounded text-[11px] text-zinc-400 hover:bg-zinc-800/50 hover:text-white transition-colors mb-1 flex items-center gap-2">
                <iconify-icon icon="solar:globe-bold"></iconify-icon>
                Cycle Position
                <span class="ml-auto text-[9px] text-zinc-600" id="count-cycle">--</span>
              </button>
              
              <button onclick="currentFilter.saved=true; currentFilter.type=null; applyFilters();" class="w-full text-left px-3 py-2 rounded text-[11px] text-zinc-400 hover:bg-zinc-800/50 hover:text-white transition-colors mb-1 flex items-center gap-2">
                <iconify-icon icon="solar:star-bold"></iconify-icon>
                Saved Reports
                <span class="ml-auto text-[9px] text-zinc-600" id="count-saved">0</span>
              </button>
              
              <div class="text-[9px] text-zinc-600 uppercase tracking-wider px-2 mb-2 mt-4">Filters</div>
              
              <div class="px-2">
                <div class="text-[10px] text-zinc-500 mb-1">Time Range</div>
                <select class="w-full bg-zinc-900 border border-zinc-800 text-[10px] text-white px-2 py-1.5 rounded focus:outline-none focus:border-purple-600">
                  <option>Last 24 Hours</option>
                  <option>Last 7 Days</option>
                  <option>Last 30 Days</option>
                  <option>All Time</option>
                </select>
              </div>
              
              <div class="px-2 mt-3">
                <div class="text-[10px] text-zinc-500 mb-1">Asset</div>
                <select id="asset-filter" class="w-full bg-zinc-900 border border-zinc-800 text-[10px] text-white px-2 py-1.5 rounded focus:outline-none focus:border-purple-600">
                  <option value="">All Assets</option>
                  <option value="BTC">BTC</option>
                  <option value="ETH">ETH</option>
                  <option value="SOL">SOL</option>
                  <option value="BNB">BNB</option>
                  <option value="XRP">XRP</option>
                  <option value="AVAX">AVAX</option>
                  <option value="LINK">LINK</option>
                  <option value="ARB">ARB</option>
                  <option value="OP">OP</option>
                </select>
              </div>
              
              <div class="px-2 mt-3">
                <div class="text-[10px] text-zinc-500 mb-1">Sentiment</div>
                <div class="flex gap-1">
                  <button data-filter-bias="BULLISH" class="flex-1 px-2 py-1 text-[9px] bg-zinc-800 text-green-400 border border-zinc-700 rounded hover:bg-green-900/50 transition-colors">BULLISH</button>
                  <button data-filter-bias="NEUTRAL" class="flex-1 px-2 py-1 text-[9px] bg-zinc-800 text-amber-400 border border-zinc-700 rounded hover:bg-amber-900/50 transition-colors">NEUTRAL</button>
                  <button data-filter-bias="BEARISH" class="flex-1 px-2 py-1 text-[9px] bg-zinc-800 text-red-400 border border-zinc-700 rounded hover:bg-red-900/50 transition-colors">BEARISH</button>
                </div>
              </div>
            </div>
          </div>

          <!-- MAIN REPORT LIST -->
          <div class="flex-1 flex flex-col bg-[#090909] overflow-hidden">
            <div class="p-3 border-b border-zinc-800 flex justify-between items-center">
              <div class="text-[11px] text-white font-bold">
                <span class="text-purple-400">24</span> Research Reports
              </div>
              <div class="flex items-center gap-2">
                <button class="px-3 py-1 text-[10px] bg-zinc-800 text-zinc-400 rounded hover:bg-zinc-700 transition-colors">
                  <iconify-icon icon="solar:sort-from-top-to-bottom-linear" class="mr-1"></iconify-icon>Latest
                </button>
                <button class="px-3 py-1 text-[10px] bg-zinc-800 text-zinc-400 rounded hover:bg-zinc-700 transition-colors">
                  <iconify-icon icon="solar:fire-linear" class="mr-1"></iconify-icon>Trending
                </button>
              </div>
            </div>
            
            <div id="reports-list" class="flex-1 overflow-y-auto no-scrollbar p-3 space-y-3">
              <!-- Reports will be loaded here -->
              <div class="text-center py-8 text-zinc-600">
                <iconify-icon icon="solar:cloud-download-bold" class="text-3xl mb-2"></iconify-icon>
                <div class="text-[11px]">Loading reports...</div>
              </div>
            </div>
          </div>

          <!-- REPORT DETAIL PANEL -->
          <div id="report-detail" class="w-[500px] bg-[#0B0B0B] border-l border-zinc-800 flex flex-col hidden">
            <div class="p-3 border-b border-zinc-800 flex justify-between items-center">
              <div class="text-[11px] text-purple-400 font-bold">REPORT DETAILS</div>
              <button id="close-detail" class="text-zinc-500 hover:text-white transition-colors">
                <iconify-icon icon="solar:close-circle-linear"></iconify-icon>
              </button>
            </div>
            <div id="report-content" class="flex-1 overflow-y-auto no-scrollbar p-4">
              <!-- Report content loads here -->
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      const API_BASE = window.location.origin;
      let allReports = [];
      let currentFilter = { type: null, symbol: null, bias: null };
      let savedReports = JSON.parse(localStorage.getItem('savedReports') || '[]');
      
      // Update time
      function updateTime() {
        const now = new Date();
        document.getElementById('current-time').textContent = now.toUTCString().slice(17, 25) + ' UTC';
      }
      setInterval(updateTime, 1000);
      updateTime();

      // Map API report to display format
      function mapReport(r) {
        const biasColors = { 'BULLISH': 'green', 'BEARISH': 'red', 'NEUTRAL': 'amber' };
        const typeNames = {
          'market_structure': 'Market Analysis',
          'whale_intelligence': 'Whale Intel',
          'options_flow': 'Options Flow',
          'on_chain_intel': 'On-Chain Intel',
          'cycle_position': 'Cycle Position'
        };
        
        // Calculate time ago
        const created = new Date(r.generated_at);
        const now = new Date();
        const diffMs = now - created;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHrs = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        let timeAgo = diffMins < 60 ? `${diffMins}m ago` : diffHrs < 24 ? `${diffHrs}h ago` : `${diffDays}d ago`;
        
        // Extract assets from tags
        const assets = (r.tags || []).filter(t => ['btc', 'eth', 'sol', 'bnb', 'xrp', 'avax', 'link', 'arb', 'op'].includes(t.toLowerCase())).map(t => t.toUpperCase());
        
        return {
          id: r.id,
          title: r.title,
          summary: r.summary || 'Analysis pending...',
          category: typeNames[r.type] || r.type,
          sentiment: r.bias || 'NEUTRAL',
          sentimentColor: biasColors[r.bias] || 'amber',
          confidence: r.confidence || 'MEDIUM',
          timeAgo: timeAgo,
          author: 'MCF Research',
          assets: assets.length > 0 ? assets : ['CRYPTO'],
          readTime: '5 min read',
          sections: r.sections || {},
          tags: r.tags || [],
          rawType: r.type
        };
      }

      // Render reports list
      function renderReports(reports) {
        const container = document.getElementById('reports-list');
        
        if (reports.length === 0) {
          container.innerHTML = `
            <div class="text-center py-12 text-zinc-600">
              <iconify-icon icon="solar:document-text-bold" class="text-4xl mb-3 text-zinc-700"></iconify-icon>
              <div class="text-[12px] mb-1">No reports found</div>
              <div class="text-[10px]">Reports will appear here once generated</div>
            </div>
          `;
          return;
        }
        
        // Update count
        document.querySelector('.text-purple-400.font-bold span, [class*="text-purple-400"]').closest('div').innerHTML = `<span class="text-purple-400">${reports.length}</span> Research Reports`;
        
        container.innerHTML = reports.map(report => `
          <div class="bg-[#0D0D0D] border border-zinc-800/50 rounded-lg p-4 hover:border-purple-600/50 hover:bg-[#0f0f0f] transition-all cursor-pointer group" onclick="showReportDetail('${report.id}')">
            <div class="flex justify-between items-start mb-2">
              <div class="flex items-center gap-2">
                <span class="text-[8px] bg-purple-900/50 text-purple-400 px-1.5 py-0.5 rounded">${report.category}</span>
                <span class="text-[8px] ${report.sentimentColor === 'green' ? 'bg-green-900/50 text-green-400' : report.sentimentColor === 'red' ? 'bg-red-900/50 text-red-400' : 'bg-amber-900/50 text-amber-400'} px-1.5 py-0.5 rounded">${report.sentiment}</span>
              </div>
              <span class="text-[9px] text-zinc-600">${report.timeAgo}</span>
            </div>
            <h3 class="text-[13px] text-white font-bold mb-2 group-hover:text-purple-400 transition-colors">${report.title}</h3>
            <p class="text-[10px] text-zinc-500 leading-relaxed mb-3 line-clamp-2">${report.summary}</p>
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-2">
                ${report.assets.slice(0, 3).map(a => `<span class="text-[8px] bg-zinc-800 text-zinc-400 px-1.5 py-0.5 rounded">${a}</span>`).join('')}
              </div>
              <div class="flex items-center gap-3 text-[9px] text-zinc-600">
                <span><iconify-icon icon="solar:clock-circle-linear" class="mr-1"></iconify-icon>${report.readTime}</span>
                <span class="${report.sentimentColor === 'green' ? 'text-green-400' : report.sentimentColor === 'red' ? 'text-red-400' : 'text-amber-400'}">${report.confidence} CONFIDENCE</span>
              </div>
            </div>
          </div>
        `).join('');
      }

      // Show report detail
      function showReportDetail(id) {
        const report = allReports.find(r => r.id === id);
        if (!report) return;
        
        const detailPanel = document.getElementById('report-detail');
        const content = document.getElementById('report-content');
        const isSaved = savedReports.includes(id);
        
        // Build sections HTML
        let sectionsHTML = '';
        if (report.sections) {
          if (report.sections.key_takeaways) {
            const takeaways = Array.isArray(report.sections.key_takeaways) ? report.sections.key_takeaways : [report.sections.key_takeaways];
            sectionsHTML += `
              <div class="bg-zinc-900/50 border border-zinc-800 rounded p-3">
                <div class="text-[10px] text-purple-400 font-bold mb-2">KEY TAKEAWAYS</div>
                <ul class="space-y-1 text-[10px] text-zinc-400">
                  ${takeaways.map(t => `<li>• ${t}</li>`).join('')}
                </ul>
              </div>
            `;
          }
          if (report.sections.trading_implication) {
            sectionsHTML += `
              <div class="${report.sentimentColor === 'green' ? 'bg-green-900/20 border-green-800/50' : report.sentimentColor === 'red' ? 'bg-red-900/20 border-red-800/50' : 'bg-amber-900/20 border-amber-800/50'} border rounded p-3">
                <div class="text-[10px] ${report.sentimentColor === 'green' ? 'text-green-400' : report.sentimentColor === 'red' ? 'text-red-400' : 'text-amber-400'} font-bold mb-2">TRADING IMPLICATION</div>
                <p class="text-[10px] text-zinc-400">${report.sections.trading_implication}</p>
              </div>
            `;
          }
          if (report.sections.iros_analysis) {
            sectionsHTML += `
              <div class="bg-purple-900/20 border border-purple-800/50 rounded p-3">
                <div class="text-[10px] text-purple-400 font-bold mb-2">IROS ANALYSIS</div>
                <p class="text-[10px] text-zinc-400 whitespace-pre-wrap">${report.sections.iros_analysis}</p>
              </div>
            `;
          }
        }
        
        if (!sectionsHTML) {
          sectionsHTML = `
            <div class="bg-zinc-900/50 border border-zinc-800 rounded p-3">
              <div class="text-[10px] text-purple-400 font-bold mb-2">KEY TAKEAWAYS</div>
              <ul class="space-y-1 text-[10px] text-zinc-400">
                <li>• Primary thesis: ${report.sentiment.toLowerCase()} bias for short-term</li>
                <li>• Confidence level: ${report.confidence}</li>
                <li>• Assets covered: ${report.assets.join(', ')}</li>
              </ul>
            </div>
            <div class="${report.sentimentColor === 'green' ? 'bg-green-900/20 border-green-800/50' : report.sentimentColor === 'red' ? 'bg-red-900/20 border-red-800/50' : 'bg-amber-900/20 border-amber-800/50'} border rounded p-3">
              <div class="text-[10px] ${report.sentimentColor === 'green' ? 'text-green-400' : report.sentimentColor === 'red' ? 'text-red-400' : 'text-amber-400'} font-bold mb-2">TRADING IMPLICATION</div>
              <p class="text-[10px] text-zinc-400">
                ${report.sentiment === 'BULLISH' ? 'Consider accumulation on dips. Watch for confirmation above key resistance.' : 
                  report.sentiment === 'BEARISH' ? 'Exercise caution. Consider reducing exposure or hedging positions.' :
                  'Wait for clearer directional signal before making major position changes.'}
              </p>
            </div>
          `;
        }
        
        content.innerHTML = `
          <div class="mb-4">
            <div class="flex items-center gap-2 mb-3">
              <span class="text-[8px] bg-purple-900/50 text-purple-400 px-1.5 py-0.5 rounded">${report.category}</span>
              <span class="text-[8px] ${report.sentimentColor === 'green' ? 'bg-green-900/50 text-green-400' : report.sentimentColor === 'red' ? 'bg-red-900/50 text-red-400' : 'bg-amber-900/50 text-amber-400'} px-1.5 py-0.5 rounded">${report.sentiment}</span>
              <span class="text-[8px] text-zinc-600">${report.timeAgo}</span>
            </div>
            <h2 class="text-[16px] text-white font-bold mb-3">${report.title}</h2>
            <div class="flex items-center gap-4 text-[10px] text-zinc-500 mb-4 pb-4 border-b border-zinc-800">
              <span><iconify-icon icon="solar:user-circle-linear" class="mr-1"></iconify-icon>${report.author}</span>
              <span><iconify-icon icon="solar:clock-circle-linear" class="mr-1"></iconify-icon>${report.readTime}</span>
              <span class="${report.sentimentColor === 'green' ? 'text-green-400' : report.sentimentColor === 'red' ? 'text-red-400' : 'text-amber-400'}">${report.confidence} CONFIDENCE</span>
            </div>
          </div>
          
          <div class="text-[11px] text-zinc-300 leading-relaxed space-y-4">
            <p>${report.summary}</p>
            ${sectionsHTML}
          </div>
          
          <div class="mt-6 pt-4 border-t border-zinc-800 flex gap-2">
            <button onclick="toggleSaveReport('${report.id}')" class="flex-1 ${isSaved ? 'bg-green-600 hover:bg-green-700' : 'bg-purple-600 hover:bg-purple-700'} text-white text-[10px] font-bold py-2 rounded transition-colors">
              <iconify-icon icon="${isSaved ? 'solar:bookmark-bold' : 'solar:bookmark-linear'}" class="mr-1"></iconify-icon>${isSaved ? 'Saved' : 'Save Report'}
            </button>
            <button onclick="shareReport('${report.id}')" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-white text-[10px] py-2 rounded transition-colors">
              <iconify-icon icon="solar:share-linear" class="mr-1"></iconify-icon>Share
            </button>
          </div>
        `;
        
        detailPanel.classList.remove('hidden');
      }

      // Save/unsave report
      function toggleSaveReport(id) {
        const idx = savedReports.indexOf(id);
        if (idx > -1) {
          savedReports.splice(idx, 1);
        } else {
          savedReports.push(id);
        }
        localStorage.setItem('savedReports', JSON.stringify(savedReports));
        showReportDetail(id); // Refresh detail view
        updateSavedCount();
      }
      
      // Share report
      function shareReport(id) {
        const report = allReports.find(r => r.id === id);
        if (!report) return;
        
        const shareText = `${report.title}\n\n${report.summary}\n\nBias: ${report.sentiment} | Confidence: ${report.confidence}\n\nvia BASTION Research Terminal`;
        
        if (navigator.share) {
          navigator.share({ title: report.title, text: shareText, url: window.location.href });
        } else {
          navigator.clipboard.writeText(shareText).then(() => {
            alert('Report copied to clipboard!');
          });
        }
      }
      
      // Update saved count in sidebar
      function updateSavedCount() {
        const savedBtn = document.querySelector('[onclick*="filterSaved"]') || document.querySelectorAll('.flex.items-center.gap-2')[5];
        if (savedBtn) {
          const countSpan = savedBtn.querySelector('.ml-auto');
          if (countSpan) countSpan.textContent = savedReports.length;
        }
      }

      // Filter reports
      function applyFilters() {
        let filtered = [...allReports];
        
        if (currentFilter.type) {
          filtered = filtered.filter(r => r.rawType === currentFilter.type);
        }
        if (currentFilter.symbol) {
          filtered = filtered.filter(r => r.assets.includes(currentFilter.symbol.toUpperCase()));
        }
        if (currentFilter.bias) {
          filtered = filtered.filter(r => r.sentiment === currentFilter.bias);
        }
        if (currentFilter.saved) {
          filtered = filtered.filter(r => savedReports.includes(r.id));
        }
        
        renderReports(filtered);
      }
      
      // Setup filter buttons
      function setupFilters() {
        // Category buttons
        document.querySelectorAll('[data-filter-type]').forEach(btn => {
          btn.addEventListener('click', () => {
            currentFilter.type = btn.dataset.filterType || null;
            currentFilter.saved = false;
            applyFilters();
            // Update active state
            document.querySelectorAll('[data-filter-type]').forEach(b => b.classList.remove('bg-purple-600/20', 'text-purple-400', 'border-purple-600/30'));
            btn.classList.add('bg-purple-600/20', 'text-purple-400', 'border-purple-600/30');
          });
        });
        
        // Asset filter
        document.getElementById('asset-filter')?.addEventListener('change', (e) => {
          currentFilter.symbol = e.target.value || null;
          applyFilters();
        });
        
        // Bias filter buttons
        document.querySelectorAll('[data-filter-bias]').forEach(btn => {
          btn.addEventListener('click', () => {
            const newBias = btn.dataset.filterBias;
            currentFilter.bias = currentFilter.bias === newBias ? null : newBias;
            applyFilters();
            // Update active state
            document.querySelectorAll('[data-filter-bias]').forEach(b => {
              b.classList.remove('bg-green-900/50', 'bg-red-900/50', 'bg-amber-900/50');
              b.classList.add('bg-zinc-800');
            });
            if (currentFilter.bias) {
              btn.classList.remove('bg-zinc-800');
              btn.classList.add(newBias === 'BULLISH' ? 'bg-green-900/50' : newBias === 'BEARISH' ? 'bg-red-900/50' : 'bg-amber-900/50');
            }
          });
        });
      }

      // Close detail panel
      document.getElementById('close-detail').addEventListener('click', () => {
        document.getElementById('report-detail').classList.add('hidden');
      });

      // Load reports from MCF API
      async function loadReports() {
        const container = document.getElementById('reports-list');
        container.innerHTML = `
          <div class="text-center py-8 text-zinc-600">
            <iconify-icon icon="solar:refresh-bold" class="text-3xl mb-2 animate-spin"></iconify-icon>
            <div class="text-[11px]">Loading reports...</div>
          </div>
        `;
        
        try {
          const res = await fetch(`${API_BASE}/api/mcf/reports?limit=100`);
          if (res.ok) {
            const data = await res.json();
            if (data.success && data.reports && data.reports.length > 0) {
              allReports = data.reports.map(mapReport);
              renderReports(allReports);
              updateCategoryCounts();
              console.log(`[RESEARCH] Loaded ${allReports.length} reports`);
            } else {
              renderReports([]);
            }
          } else {
            throw new Error('API error');
          }
        } catch (e) {
          console.error('[RESEARCH] Failed to load reports:', e);
          container.innerHTML = `
            <div class="text-center py-12 text-zinc-600">
              <iconify-icon icon="solar:danger-triangle-bold" class="text-4xl mb-3 text-red-500/50"></iconify-icon>
              <div class="text-[12px] mb-1">Failed to load reports</div>
              <div class="text-[10px] mb-3">Check API connection</div>
              <button onclick="loadReports()" class="px-4 py-1.5 text-[10px] bg-purple-600 text-white rounded hover:bg-purple-700">Retry</button>
            </div>
          `;
        }
      }
      
      // Update category counts in sidebar
      function updateCategoryCounts() {
        const el = (id) => document.getElementById(id);
        if (el('count-all')) el('count-all').textContent = allReports.length;
        if (el('count-market')) el('count-market').textContent = allReports.filter(r => r.rawType === 'market_structure').length;
        if (el('count-onchain')) el('count-onchain').textContent = allReports.filter(r => r.rawType === 'on_chain_intel').length;
        if (el('count-whale')) el('count-whale').textContent = allReports.filter(r => r.rawType === 'whale_intelligence').length;
        if (el('count-options')) el('count-options').textContent = allReports.filter(r => r.rawType === 'options_flow').length;
        if (el('count-cycle')) el('count-cycle').textContent = allReports.filter(r => r.rawType === 'cycle_position').length;
        if (el('count-saved')) el('count-saved').textContent = savedReports.length;
      }

      // Search functionality
      document.querySelector('input[placeholder="Search reports..."]')?.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        if (!query) {
          renderReports(allReports);
          return;
        }
        const filtered = allReports.filter(r => 
          r.title.toLowerCase().includes(query) || 
          r.summary.toLowerCase().includes(query) ||
          r.assets.some(a => a.toLowerCase().includes(query))
        );
        renderReports(filtered);
      });

      // Initialize
      loadReports();
      setupFilters();
      
      // Auto-refresh every 5 minutes
      setInterval(loadReports, 300000);
    </script>
</body>
</html>


