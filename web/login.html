<!DOCTYPE html>
<html lang="en" class="bg-[#050505] antialiased selection:bg-[#DC2626] selection:text-white">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BASTION - Secure Access</title>
    <link rel="icon" type="image/png" href="/static/bastion-logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap');
      body { font-family: 'Inter', sans-serif; }
      .font-mono { font-family: 'JetBrains Mono', monospace; }
      
      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: #050505; }
      ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #DC2626; }

      /* Tactical Grid Background */
      .tactical-grid {
        background-size: 50px 50px;
        background-image:
          linear-gradient(to right, rgba(39, 39, 42, 0.3) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(39, 39, 42, 0.3) 1px, transparent 1px);
        mask-image: radial-gradient(ellipse at center top, black 40%, transparent 80%);
        pointer-events: none;
      }

      /* Scanline Animation */
      .scanline {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100px;
        background: linear-gradient(to bottom, transparent, rgba(220, 38, 38, 0.05), transparent);
        animation: scan 8s linear infinite;
        pointer-events: none;
        z-index: 5;
      }
      @keyframes scan {
        0% { transform: translateY(-100%); }
        100% { transform: translateY(100vh); }
      }

      /* Custom Inputs Auto-fill fix */
      input:-webkit-autofill,
      input:-webkit-autofill:hover, 
      input:-webkit-autofill:focus, 
      input:-webkit-autofill:active{
        -webkit-box-shadow: 0 0 0 30px #18181b inset !important;
        -webkit-text-fill-color: white !important;
        transition: background-color 5000s ease-in-out 0s;
      }
    </style>
</head>
<body class="min-h-screen flex flex-col relative overflow-hidden text-zinc-400">
    
    <!-- Background Effects -->
    <div class="fixed inset-0 tactical-grid z-0"></div>
    <div class="scanline"></div>

    <!-- Navigation -->
    <nav class="relative z-50 h-16 border-b border-[#27272a] bg-[#050505]/80 backdrop-blur-md flex items-center justify-between px-6 lg:px-10">
      <a href="/" class="flex items-center gap-3">
        <img src="/static/bastion-logo.png" alt="BASTION" class="w-7 h-7">
        <span class="text-white font-bold tracking-tight text-lg uppercase font-mono">Bastion</span>
      </a>

      <div class="hidden md:flex items-center gap-4 text-[10px] font-mono tracking-widest text-zinc-500">
        <span class="flex items-center gap-2 text-[#DC2626]">
          <span class="relative flex h-1.5 w-1.5">
            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-[#DC2626] opacity-75"></span>
            <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-[#DC2626]"></span>
          </span>
          SYSTEM_ARMED
        </span>
        <span class="text-zinc-700">//</span>
        <span>SECURE_CONNECTION</span>
      </div>

      <a href="/frontend" class="text-[10px] font-bold uppercase tracking-widest text-zinc-400 hover:text-white border border-[#27272a] hover:border-[#DC2626] bg-zinc-900/50 px-4 py-2 transition-all flex items-center gap-2 group">
        Terminal Access
        <iconify-icon icon="solar:arrow-right-linear" class="group-hover:translate-x-0.5 transition-transform"></iconify-icon>
      </a>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 flex items-center justify-center relative z-10 px-4 py-12">
      
      <!-- Auth Card -->
      <div class="w-full max-w-[420px] bg-[#0D0D0D] border-y border-r border-[#27272a] border-l-2 border-l-[#DC2626] shadow-[0_0_60px_rgba(220,38,38,0.15)] relative p-8 md:p-10 flex flex-col gap-6">
        
        <!-- Header -->
        <div class="space-y-2">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-1.5 h-1.5 bg-[#DC2626]"></div>
            <span class="text-[10px] font-mono font-bold tracking-[0.2em] text-[#DC2626] uppercase">Secure_Access</span>
          </div>
          <h1 class="text-3xl font-bold text-white uppercase tracking-tight font-mono">Access Terminal</h1>
          <p class="text-xs text-zinc-500 font-mono leading-relaxed">Identity verification required to access command center.</p>
        </div>

        <!-- Tab Switcher -->
        <div class="grid grid-cols-3 p-1 bg-[#121214] border border-[#27272a]">
          <button onclick="switchTab('login')" id="tab-login" class="text-xs font-bold uppercase tracking-wider py-2.5 transition-all text-white bg-[#1f1f22] shadow-sm border border-[#27272a]">Login</button>
          <button onclick="switchTab('register')" id="tab-register" class="text-xs font-bold uppercase tracking-wider py-2.5 transition-all text-zinc-500 hover:text-zinc-300">Register</button>
          <button onclick="switchTab('reset')" id="tab-reset" class="text-xs font-bold uppercase tracking-wider py-2.5 transition-all text-zinc-500 hover:text-zinc-300">Reset</button>
        </div>

        <!-- LOGIN FORM -->
        <form id="login-form" class="flex flex-col gap-5" onsubmit="handleLogin(event)">
          <div class="space-y-4">
            <div class="relative group">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-zinc-500 group-focus-within:text-[#DC2626] transition-colors">
                <iconify-icon icon="solar:letter-linear" width="18"></iconify-icon>
              </div>
              <input type="email" id="login-email" placeholder="OPERATOR EMAIL" class="w-full bg-[#18181b] border border-[#3f3f46] text-white text-sm placeholder:text-zinc-600 focus:outline-none focus:border-[#DC2626] focus:ring-1 focus:ring-[#DC2626] pl-10 pr-4 py-3 transition-all font-mono placeholder:tracking-wider">
            </div>

            <div class="relative group">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-zinc-500 group-focus-within:text-[#DC2626] transition-colors">
                <iconify-icon icon="solar:lock-password-linear" width="18"></iconify-icon>
              </div>
              <input type="password" id="login-password" placeholder="PASSWORD" class="w-full bg-[#18181b] border border-[#3f3f46] text-white text-sm placeholder:text-zinc-600 focus:outline-none focus:border-[#DC2626] focus:ring-1 focus:ring-[#DC2626] pl-10 pr-10 py-3 transition-all font-mono placeholder:tracking-wider">
              <button type="button" onclick="togglePassword('login-password', 'login-eye')" class="absolute inset-y-0 right-0 pr-3 flex items-center text-zinc-500 hover:text-white cursor-pointer transition-colors">
                <iconify-icon id="login-eye" icon="solar:eye-closed-linear" width="18"></iconify-icon>
              </button>
            </div>
          </div>

          <!-- 2FA Input (hidden by default, shown when required) -->
          <div id="2fa-input-section" class="hidden">
            <div class="relative group">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-zinc-500 group-focus-within:text-[#DC2626] transition-colors">
                <iconify-icon icon="solar:shield-keyhole-linear" width="18"></iconify-icon>
              </div>
              <input type="text" id="login-2fa-code" placeholder="6-DIGIT 2FA CODE" maxlength="6" pattern="[0-9]{6}" class="w-full bg-[#18181b] border border-amber-600/50 text-white text-sm placeholder:text-zinc-600 focus:outline-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500 pl-10 pr-4 py-3 transition-all font-mono placeholder:tracking-wider tracking-[0.5em] text-center" autocomplete="one-time-code">
            </div>
            <p class="text-[10px] text-amber-500/80 mt-2 font-mono flex items-center gap-1">
              <iconify-icon icon="solar:shield-check-bold" width="12"></iconify-icon>
              Enter the code from your authenticator app
            </p>
          </div>

          <div class="flex items-center justify-between">
            <label class="flex items-center gap-2 cursor-pointer group">
              <div class="relative flex items-center">
                <input type="checkbox" id="remember-device" class="peer h-4 w-4 appearance-none border border-[#3f3f46] bg-[#18181b] checked:bg-[#DC2626] checked:border-[#DC2626] transition-all cursor-pointer">
                <iconify-icon icon="solar:check-read-linear" class="absolute left-0.5 text-white opacity-0 peer-checked:opacity-100 text-[10px] pointer-events-none"></iconify-icon>
              </div>
              <span class="text-xs text-zinc-500 group-hover:text-zinc-400 font-mono">REMEMBER DEVICE</span>
            </label>
            <a href="#" onclick="switchTab('reset')" class="text-xs text-[#DC2626] hover:text-red-400 font-mono hover:underline">FORGOT PASSWORD?</a>
          </div>

          <!-- Status Message -->
          <div id="login-status" class="hidden text-xs font-mono p-3 border"></div>

          <button type="submit" class="w-full bg-[#DC2626] hover:bg-red-700 text-white font-bold uppercase tracking-widest text-xs py-3.5 border border-transparent transition-all shadow-[0_0_20px_rgba(220,38,38,0.3)] hover:shadow-[0_0_30px_rgba(220,38,38,0.5)] flex items-center justify-center gap-2 group">
            <span id="login-btn-text">Authenticate</span>
            <iconify-icon id="login-btn-icon" icon="solar:arrow-right-linear" width="16" class="group-hover:translate-x-1 transition-transform"></iconify-icon>
          </button>

          <div class="text-center mt-4">
            <a href="/frontend" class="text-xs text-zinc-500 hover:text-white font-mono uppercase tracking-wide group flex items-center justify-center gap-1 transition-colors">
              Continue as Guest 
              <iconify-icon icon="solar:arrow-right-linear" class="group-hover:translate-x-1 transition-transform"></iconify-icon>
            </a>
          </div>
        </form>

        <!-- REGISTER FORM -->
        <form id="register-form" class="hidden flex flex-col gap-5" onsubmit="handleRegister(event)">
          <div class="space-y-4">
            <div class="relative group">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-zinc-500 group-focus-within:text-[#DC2626] transition-colors">
                <iconify-icon icon="solar:user-circle-linear" width="18"></iconify-icon>
              </div>
              <input type="text" id="reg-username" placeholder="OPERATOR ID" class="w-full bg-[#18181b] border border-[#3f3f46] text-white text-sm placeholder:text-zinc-600 focus:outline-none focus:border-[#DC2626] focus:ring-1 focus:ring-[#DC2626] pl-10 pr-4 py-3 transition-all font-mono placeholder:tracking-wider">
            </div>

            <div class="relative group">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-zinc-500 group-focus-within:text-[#DC2626] transition-colors">
                <iconify-icon icon="solar:letter-linear" width="18"></iconify-icon>
              </div>
              <input type="email" id="reg-email" placeholder="CONTACT EMAIL" class="w-full bg-[#18181b] border border-[#3f3f46] text-white text-sm placeholder:text-zinc-600 focus:outline-none focus:border-[#DC2626] focus:ring-1 focus:ring-[#DC2626] pl-10 pr-4 py-3 transition-all font-mono placeholder:tracking-wider">
            </div>

            <div class="relative group">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-zinc-500 group-focus-within:text-[#DC2626] transition-colors">
                <iconify-icon icon="solar:lock-password-linear" width="18"></iconify-icon>
              </div>
              <input type="password" id="reg-password" placeholder="SET PASSPHRASE" class="w-full bg-[#18181b] border border-[#3f3f46] text-white text-sm placeholder:text-zinc-600 focus:outline-none focus:border-[#DC2626] focus:ring-1 focus:ring-[#DC2626] pl-10 pr-10 py-3 transition-all font-mono placeholder:tracking-wider" oninput="checkStrength(this.value)">
              <button type="button" onclick="togglePassword('reg-password', 'reg-eye')" class="absolute inset-y-0 right-0 pr-3 flex items-center text-zinc-500 hover:text-white cursor-pointer transition-colors">
                <iconify-icon id="reg-eye" icon="solar:eye-closed-linear" width="18"></iconify-icon>
              </button>
            </div>
            
            <!-- Password Strength -->
            <div class="flex gap-1 h-1 w-full opacity-50">
              <div id="strength-1" class="h-full w-1/4 bg-zinc-800 transition-colors duration-300"></div>
              <div id="strength-2" class="h-full w-1/4 bg-zinc-800 transition-colors duration-300"></div>
              <div id="strength-3" class="h-full w-1/4 bg-zinc-800 transition-colors duration-300"></div>
              <div id="strength-4" class="h-full w-1/4 bg-zinc-800 transition-colors duration-300"></div>
            </div>

            <div class="relative group">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-zinc-500 group-focus-within:text-[#DC2626] transition-colors">
                <iconify-icon icon="solar:shield-check-linear" width="18"></iconify-icon>
              </div>
              <input type="password" id="reg-confirm" placeholder="CONFIRM PASSPHRASE" class="w-full bg-[#18181b] border border-[#3f3f46] text-white text-sm placeholder:text-zinc-600 focus:outline-none focus:border-[#DC2626] focus:ring-1 focus:ring-[#DC2626] pl-10 pr-4 py-3 transition-all font-mono placeholder:tracking-wider">
            </div>
          </div>

          <label class="flex items-start gap-2 cursor-pointer group mt-1">
            <div class="relative flex items-center mt-0.5">
              <input type="checkbox" id="accept-terms" class="peer h-4 w-4 appearance-none border border-[#3f3f46] bg-[#18181b] checked:bg-[#DC2626] checked:border-[#DC2626] transition-all cursor-pointer">
              <iconify-icon icon="solar:check-read-linear" class="absolute left-0.5 text-white opacity-0 peer-checked:opacity-100 text-[10px] pointer-events-none"></iconify-icon>
            </div>
            <span class="text-xs text-zinc-500 group-hover:text-zinc-400 font-mono leading-tight">I ACCEPT THE <a href="#" class="text-[#DC2626] underline underline-offset-2">TERMS OF SERVICE</a> AND RISK DISCLOSURE.</span>
          </label>

          <!-- Status Message -->
          <div id="register-status" class="hidden text-xs font-mono p-3 border"></div>

          <button type="submit" class="w-full bg-[#DC2626] hover:bg-red-700 text-white font-bold uppercase tracking-widest text-xs py-3.5 border border-transparent transition-all shadow-[0_0_20px_rgba(220,38,38,0.3)] hover:shadow-[0_0_30px_rgba(220,38,38,0.5)] flex items-center justify-center gap-2 group mt-2">
            <span id="register-btn-text">Create Account</span>
            <iconify-icon id="register-btn-icon" icon="solar:user-plus-linear" width="16" class="group-hover:translate-x-1 transition-transform"></iconify-icon>
          </button>
        </form>

        <!-- PASSWORD RESET FORM -->
        <form id="reset-form" class="hidden flex flex-col gap-5" onsubmit="handleResetRequest(event)">
          <div class="space-y-3">
            <p class="text-xs text-zinc-500 font-mono leading-relaxed">Enter your email to receive a password reset token.</p>
            <div class="relative group">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-zinc-500 group-focus-within:text-[#DC2626] transition-colors">
                <iconify-icon icon="solar:letter-linear" width="18"></iconify-icon>
              </div>
              <input type="email" id="reset-email" placeholder="OPERATOR EMAIL" class="w-full bg-[#18181b] border border-[#3f3f46] text-white text-sm placeholder:text-zinc-600 focus:outline-none focus:border-[#DC2626] focus:ring-1 focus:ring-[#DC2626] pl-10 pr-4 py-3 transition-all font-mono placeholder:tracking-wider">
            </div>
          </div>

          <div id="reset-status" class="hidden text-xs font-mono p-3 border"></div>

          <button type="submit" id="reset-request-btn" class="w-full bg-[#DC2626] hover:bg-red-700 text-white font-bold uppercase tracking-widest text-xs py-3.5 border border-transparent transition-all shadow-[0_0_20px_rgba(220,38,38,0.3)] hover:shadow-[0_0_30px_rgba(220,38,38,0.5)] flex items-center justify-center gap-2 group">
            <span>Request Reset Token</span>
            <iconify-icon icon="solar:key-linear" width="16" class="group-hover:translate-x-1 transition-transform"></iconify-icon>
          </button>

          <!-- Step 2: Enter token + new password (shown after request) -->
          <div id="reset-step2" class="hidden space-y-4 border-t border-zinc-800 pt-4 mt-2">
            <p class="text-xs text-zinc-500 font-mono leading-relaxed">Enter your reset token and new password.</p>
            <div class="relative group">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-zinc-500 group-focus-within:text-[#DC2626] transition-colors">
                <iconify-icon icon="solar:key-linear" width="18"></iconify-icon>
              </div>
              <input type="text" id="reset-token" placeholder="RESET TOKEN" class="w-full bg-[#18181b] border border-[#3f3f46] text-white text-sm placeholder:text-zinc-600 focus:outline-none focus:border-[#DC2626] focus:ring-1 focus:ring-[#DC2626] pl-10 pr-4 py-3 transition-all font-mono placeholder:tracking-wider">
            </div>
            <div class="relative group">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-zinc-500 group-focus-within:text-[#DC2626] transition-colors">
                <iconify-icon icon="solar:lock-password-linear" width="18"></iconify-icon>
              </div>
              <input type="password" id="reset-new-password" placeholder="NEW PASSWORD" class="w-full bg-[#18181b] border border-[#3f3f46] text-white text-sm placeholder:text-zinc-600 focus:outline-none focus:border-[#DC2626] focus:ring-1 focus:ring-[#DC2626] pl-10 pr-4 py-3 transition-all font-mono placeholder:tracking-wider">
            </div>
            <button type="button" onclick="handlePasswordReset()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold uppercase tracking-widest text-xs py-3.5 border border-transparent transition-all flex items-center justify-center gap-2 group">
              <span>Reset Password</span>
              <iconify-icon icon="solar:shield-check-linear" width="16" class="group-hover:scale-110 transition-transform"></iconify-icon>
            </button>
          </div>
        </form>

      </div>
    </main>

    <!-- Footer -->
    <footer class="relative z-10 border-t border-[#27272a] bg-[#050505] py-6 text-center">
      <div class="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-8 text-[10px] font-mono uppercase tracking-widest text-zinc-600">
        <span class="hover:text-zinc-400 transition-colors cursor-default">Bastion v2.0</span>
        <span class="hidden md:block w-px h-3 bg-zinc-800"></span>
        <span class="flex items-center gap-2">
          <iconify-icon icon="solar:lock-keyhole-minimalistic-bold" class="text-zinc-500"></iconify-icon>
          Encrypted 256-bit
        </span>
        <span class="hidden md:block w-px h-3 bg-zinc-800"></span>
        <span>Â© 2026 BASTION</span>
      </div>
    </footer>

    <script>
      // Production console silencer
      (function() {
        const noop = function() {};
        if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
          console.log = noop; console.debug = noop; console.info = noop; console.warn = noop;
        }
      })();

      function switchTab(tab) {
        const forms = { login: 'login-form', register: 'register-form', reset: 'reset-form' };
        const btns = { login: 'tab-login', register: 'tab-register', reset: 'tab-reset' };

        // Hide all forms, deactivate all buttons
        Object.values(forms).forEach(id => document.getElementById(id)?.classList.add('hidden'));
        Object.values(btns).forEach(id => {
          const b = document.getElementById(id);
          if (b) { b.classList.remove('text-white', 'bg-[#1f1f22]', 'border', 'border-[#27272a]', 'shadow-sm'); b.classList.add('text-zinc-500'); }
        });

        // Activate selected
        document.getElementById(forms[tab])?.classList.remove('hidden');
        const activeBtn = document.getElementById(btns[tab]);
        if (activeBtn) { activeBtn.classList.add('text-white', 'bg-[#1f1f22]', 'border', 'border-[#27272a]', 'shadow-sm'); activeBtn.classList.remove('text-zinc-500'); }
      }

      // Password Reset
      async function handleResetRequest(e) {
        e.preventDefault();
        const email = document.getElementById('reset-email').value.trim();
        const status = document.getElementById('reset-status');
        if (!email) { showStatus(status, 'Email required', 'error'); return; }

        try {
          const resp = await fetch('/api/auth/forgot-password', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email })
          });
          const data = await resp.json();

          if (data.success) {
            showStatus(status, 'Reset token generated! Check below.', 'success');
            document.getElementById('reset-step2').classList.remove('hidden');
            if (data.reset_token) {
              document.getElementById('reset-token').value = data.reset_token;
            }
          } else {
            showStatus(status, data.detail || 'Request failed', 'error');
          }
        } catch(err) {
          showStatus(status, 'Network error', 'error');
        }
      }

      async function handlePasswordReset() {
        const token = document.getElementById('reset-token').value.trim();
        const newPw = document.getElementById('reset-new-password').value;
        const status = document.getElementById('reset-status');

        if (!token || !newPw) { showStatus(status, 'Token and new password required', 'error'); return; }
        if (newPw.length < 8) { showStatus(status, 'Password must be at least 8 characters', 'error'); return; }

        try {
          const resp = await fetch('/api/auth/reset-password', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ token, new_password: newPw })
          });
          const data = await resp.json();

          if (data.success) {
            showStatus(status, 'Password reset! Redirecting to login...', 'success');
            setTimeout(() => switchTab('login'), 2000);
          } else {
            showStatus(status, data.detail || 'Reset failed', 'error');
          }
        } catch(err) {
          showStatus(status, 'Network error', 'error');
        }
      }

      function showStatus(el, msg, type) {
        el.classList.remove('hidden');
        el.className = 'text-xs font-mono p-3 border ' + (type === 'error' ? 'border-red-800 bg-red-950/50 text-red-400' : 'border-green-800 bg-green-950/50 text-green-400');
        el.textContent = msg;
      }

      function togglePassword(inputId, iconId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);
        
        if (input.type === 'password') {
          input.type = 'text';
          icon.setAttribute('icon', 'solar:eye-bold');
          icon.classList.add('text-white');
        } else {
          input.type = 'password';
          icon.setAttribute('icon', 'solar:eye-closed-linear');
          icon.classList.remove('text-white');
        }
      }

      function checkStrength(val) {
        const bars = [
          document.getElementById('strength-1'),
          document.getElementById('strength-2'),
          document.getElementById('strength-3'),
          document.getElementById('strength-4')
        ];
        
        // Reset
        bars.forEach(bar => {
          bar.className = 'h-full w-1/4 bg-zinc-800 transition-colors duration-300';
        });

        if(val.length > 0) bars[0].className = 'h-full w-1/4 bg-red-800 transition-colors duration-300';
        if(val.length > 4) bars[1].className = 'h-full w-1/4 bg-red-600 transition-colors duration-300';
        if(val.length > 8) bars[2].className = 'h-full w-1/4 bg-red-500 transition-colors duration-300';
        if(val.length > 12) bars[3].className = 'h-full w-1/4 bg-[#DC2626] shadow-[0_0_10px_#DC2626] transition-colors duration-300';
      }

      function showStatus(elementId, message, isError = false) {
        const status = document.getElementById(elementId);
        status.classList.remove('hidden');
        status.textContent = message;
        if (isError) {
          status.classList.add('text-red-500', 'border-red-900', 'bg-red-900/10');
          status.classList.remove('text-green-500', 'border-green-900', 'bg-green-900/10');
        } else {
          status.classList.add('text-green-500', 'border-green-900', 'bg-green-900/10');
          status.classList.remove('text-red-500', 'border-red-900', 'bg-red-900/10');
        }
      }

      // Track if 2FA is pending
      let pending2FA = { email: null, password: null };

      async function handleLogin(event) {
        event.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const remember = document.getElementById('remember-device').checked;
        const totpCode = document.getElementById('login-2fa-code').value;

        if (!email || !password) {
          showStatus('login-status', 'Please enter email and password', true);
          return;
        }

        // If 2FA is showing and no code entered
        const is2FAVisible = !document.getElementById('2fa-input-section').classList.contains('hidden');
        if (is2FAVisible && !totpCode) {
          showStatus('login-status', 'Please enter your 2FA code', true);
          document.getElementById('login-2fa-code').focus();
          return;
        }

        // Show loading state
        document.getElementById('login-btn-text').textContent = 'AUTHENTICATING...';
        document.getElementById('login-btn-icon').setAttribute('icon', 'solar:refresh-circle-linear');
        document.getElementById('login-btn-icon').classList.add('animate-spin');

        try {
          const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              email, 
              password,
              totp_code: totpCode || undefined
            })
          });
          
          const data = await res.json();
          
          // Check if 2FA is required
          if (data.requires_2fa) {
            // Show 2FA input
            document.getElementById('2fa-input-section').classList.remove('hidden');
            document.getElementById('login-2fa-code').focus();
            showStatus('login-status', '2FA verification required', false);
            pending2FA = { email, password };
            resetLoginBtn();
            document.getElementById('login-btn-text').textContent = 'Verify 2FA';
            return;
          }
          
          if (data.success && data.token) {
            // Check if this is a different user than previously logged in
            // If so, clear personalization data to prevent cross-user data leakage
            const previousUser = localStorage.getItem('bastion_user');
            if (previousUser) {
              try {
                const prevUserData = JSON.parse(previousUser);
                if (prevUserData.id !== data.user.id) {
                  console.log('[AUTH] Different user logging in, clearing personalization data');
                  // Clear user-specific personalization data
                  localStorage.removeItem('cornerGif');
                  localStorage.removeItem('cornerGifSettings');
                  localStorage.removeItem('userAvatar');
                  localStorage.removeItem('profile');
                  localStorage.removeItem('bastionAppearance');
                  localStorage.removeItem('riskSettings');
                  localStorage.removeItem('alertSettings');
                  localStorage.removeItem('2fa_enabled');
                  localStorage.removeItem('bastion_connected_exchanges');
                }
              } catch (e) {
                // If parsing fails, clear everything to be safe
                console.log('[AUTH] Could not parse previous user, clearing data');
                localStorage.clear();
              }
            }
            
            // Store session
            const storage = remember ? localStorage : sessionStorage;
            storage.setItem('bastion_token', data.token);
            storage.setItem('bastion_user', JSON.stringify(data.user));
            
            showStatus('login-status', 'Loading your data...', false);
            
            // Reset 2FA state
            document.getElementById('2fa-input-section').classList.add('hidden');
            document.getElementById('login-2fa-code').value = '';
            pending2FA = { email: null, password: null };
            
            // Load exchanges from cloud BEFORE redirecting
            try {
              const cloudRes = await fetch('/api/auth/load-exchanges', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: data.token })
              });
              const cloudData = await cloudRes.json();
              
              if (cloudData.success && cloudData.exchanges) {
                // Store only exchange NAMES (never secrets) for UI indicator
                localStorage.setItem('bastion_connected_exchanges', JSON.stringify(cloudData.exchanges));
                console.log('[LOGIN] Pre-loaded', cloudData.exchanges.length, 'exchanges from cloud (names only)');
              }
            } catch (e) {
              console.log('[LOGIN] Could not pre-load exchanges:', e);
            }
            
            showStatus('login-status', 'Redirecting to terminal...', false);
            
            setTimeout(() => {
              window.location.href = '/frontend';
            }, 500);
          } else {
            showStatus('login-status', data.detail || 'Authentication failed', true);
            resetLoginBtn();
          }
        } catch (e) {
          console.error('Login error:', e);
          showStatus('login-status', 'Connection error - please try again', true);
          resetLoginBtn();
        }
      }
      
      function resetLoginBtn() {
        document.getElementById('login-btn-text').textContent = 'Authenticate';
        document.getElementById('login-btn-icon').setAttribute('icon', 'solar:arrow-right-linear');
        document.getElementById('login-btn-icon').classList.remove('animate-spin');
      }
      
      function resetRegisterBtn() {
        document.getElementById('register-btn-text').textContent = 'Create Account';
        document.getElementById('register-btn-icon').setAttribute('icon', 'solar:user-plus-linear');
        document.getElementById('register-btn-icon').classList.remove('animate-spin');
      }

      async function handleRegister(event) {
        event.preventDefault();
        const username = document.getElementById('reg-username').value;
        const email = document.getElementById('reg-email').value;
        const password = document.getElementById('reg-password').value;
        const confirm = document.getElementById('reg-confirm').value;
        const terms = document.getElementById('accept-terms').checked;

        if (!username || !email || !password) {
          showStatus('register-status', 'Please fill in all fields', true);
          return;
        }
        
        if (password.length < 8) {
          showStatus('register-status', 'Password must be at least 8 characters', true);
          return;
        }

        if (password !== confirm) {
          showStatus('register-status', 'Passwords do not match', true);
          return;
        }

        if (!terms) {
          showStatus('register-status', 'Please accept the terms of service', true);
          return;
        }

        // Show loading state
        document.getElementById('register-btn-text').textContent = 'CREATING ACCOUNT...';
        document.getElementById('register-btn-icon').setAttribute('icon', 'solar:refresh-circle-linear');
        document.getElementById('register-btn-icon').classList.add('animate-spin');

        try {
          const res = await fetch('/api/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, display_name: username })
          });
          
          const data = await res.json();
          
          if (data.success && data.token) {
            // New user - clear any previous user's personalization data
            console.log('[AUTH] New user registration, clearing any old personalization data');
            localStorage.removeItem('cornerGif');
            localStorage.removeItem('cornerGifSettings');
            localStorage.removeItem('userAvatar');
            localStorage.removeItem('profile');
            localStorage.removeItem('bastionAppearance');
            localStorage.removeItem('riskSettings');
            localStorage.removeItem('alertSettings');
            localStorage.removeItem('2fa_enabled');
            localStorage.removeItem('bastion_connected_exchanges');
            
            // Store session
            localStorage.setItem('bastion_token', data.token);
            localStorage.setItem('bastion_user', JSON.stringify(data.user));
            
            showStatus('register-status', 'Account created! Setting up your agent...', false);

            setTimeout(() => {
              window.location.href = '/account?tab=api-keys&onboarding=1';
            }, 1000);
          } else {
            showStatus('register-status', data.detail || 'Registration failed', true);
            resetRegisterBtn();
          }
        } catch (e) {
          console.error('Register error:', e);
          showStatus('register-status', 'Connection error - please try again', true);
          resetRegisterBtn();
        }
      }

    </script>
</body>
</html>

