<!--
  BASTION — Agent Activity Timeline Section
  Insert this between the "Recent API Calls" section and the "Webhook Management" section in usage.html.
  Also add the <script> block at the bottom (inside the existing IIFE or after it).
-->

<!-- ═══════════════════════════════════════════════════════════════════════════
     HTML SECTION — paste after the Recent Calls </section> closing tag (~line 358)
     ═══════════════════════════════════════════════════════════════════════════ -->

<section class="container mx-auto px-6 md:px-12 pb-8" id="activity-timeline-section">
  <div class="border border-zinc-800 bg-zinc-950 sys-reveal sys-rise">

    <!-- Header -->
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between p-6 border-b border-zinc-800 gap-4">
      <div class="flex items-center gap-3">
        <iconify-icon icon="solar:history-linear" width="18" class="text-red-600"></iconify-icon>
        <h3 class="text-xs font-mono uppercase tracking-widest text-zinc-400">Agent Activity Timeline</h3>
        <span id="activity-live-dot" class="relative flex h-1.5 w-1.5 ml-1">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-600 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-red-600"></span>
        </span>
      </div>
      <div class="flex items-center gap-3">
        <span id="activity-count-label" class="text-[10px] font-mono text-zinc-700">0 EVENTS</span>
        <div class="flex items-center gap-1.5 px-2.5 py-1 border border-zinc-800 bg-zinc-900/50 text-[9px] font-mono text-zinc-600">
          <iconify-icon icon="solar:refresh-circle-linear" width="10"></iconify-icon>
          AUTO: 30S
        </div>
      </div>
    </div>

    <!-- Filters + Search -->
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between px-6 py-4 border-b border-zinc-800/50 gap-3">
      <!-- Category Filters -->
      <div class="flex flex-wrap items-center gap-2">
        <button onclick="setActivityFilter('all')" data-filter="all"
          class="activity-filter-btn active px-3 py-1.5 border text-[10px] font-mono uppercase tracking-widest transition-all border-red-600/50 bg-red-600/10 text-red-400">
          All
        </button>
        <button onclick="setActivityFilter('core_ai')" data-filter="core_ai"
          class="activity-filter-btn px-3 py-1.5 border text-[10px] font-mono uppercase tracking-widest transition-all border-zinc-800 bg-zinc-900/30 text-zinc-500 hover:text-zinc-300 hover:border-zinc-700">
          <iconify-icon icon="solar:brain-linear" width="10" class="mr-1"></iconify-icon>Core AI
        </button>
        <button onclick="setActivityFilter('market_data')" data-filter="market_data"
          class="activity-filter-btn px-3 py-1.5 border text-[10px] font-mono uppercase tracking-widest transition-all border-zinc-800 bg-zinc-900/30 text-zinc-500 hover:text-zinc-300 hover:border-zinc-700">
          <iconify-icon icon="solar:chart-2-linear" width="10" class="mr-1"></iconify-icon>Market Data
        </button>
        <button onclick="setActivityFilter('derivatives')" data-filter="derivatives"
          class="activity-filter-btn px-3 py-1.5 border text-[10px] font-mono uppercase tracking-widest transition-all border-zinc-800 bg-zinc-900/30 text-zinc-500 hover:text-zinc-300 hover:border-zinc-700">
          <iconify-icon icon="solar:graph-new-linear" width="10" class="mr-1"></iconify-icon>Derivatives
        </button>
        <button onclick="setActivityFilter('on_chain')" data-filter="on_chain"
          class="activity-filter-btn px-3 py-1.5 border text-[10px] font-mono uppercase tracking-widest transition-all border-zinc-800 bg-zinc-900/30 text-zinc-500 hover:text-zinc-300 hover:border-zinc-700">
          <iconify-icon icon="solar:link-minimalistic-2-linear" width="10" class="mr-1"></iconify-icon>On-Chain
        </button>
      </div>
      <!-- Search -->
      <div class="relative w-full md:w-64">
        <iconify-icon icon="solar:magnifer-linear" width="14" class="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-700"></iconify-icon>
        <input type="text" id="activity-search" placeholder="Filter by tool name..."
          oninput="filterActivityBySearch(this.value)"
          class="w-full bg-zinc-900 border border-zinc-800 text-white text-[11px] font-mono pl-9 pr-4 py-2 placeholder:text-zinc-700 focus:outline-none focus:border-red-600/50 transition-colors">
      </div>
    </div>

    <!-- Timeline Container -->
    <div id="activity-timeline" class="divide-y divide-zinc-800/30 max-h-[600px] overflow-y-auto no-scrollbar">
      <div class="px-6 py-12 text-center">
        <iconify-icon icon="solar:history-linear" width="32" class="text-zinc-800 mb-3"></iconify-icon>
        <div class="text-xs font-mono text-zinc-600">Loading activity...</div>
      </div>
    </div>

    <!-- Load More -->
    <div class="p-4 border-t border-zinc-800/50 text-center">
      <button onclick="loadMoreActivity()" id="activity-load-more-btn"
        class="inline-flex items-center gap-2 px-6 py-2 border border-zinc-800 bg-zinc-900/50 text-[10px] font-mono uppercase tracking-widest text-zinc-500 hover:text-white hover:border-zinc-700 transition-all">
        <iconify-icon icon="solar:alt-arrow-down-linear" width="12"></iconify-icon>
        Load More
      </button>
      <span id="activity-load-status" class="hidden text-[10px] font-mono text-zinc-700 ml-3"></span>
    </div>

  </div>
</section>


<!-- ═══════════════════════════════════════════════════════════════════════════
     JAVASCRIPT — paste inside the existing <script> IIFE, before the closing })();
     Or add as a separate <script> block after the main one.
     ═══════════════════════════════════════════════════════════════════════════ -->

<script>
(function() {
  'use strict';

  // ─── Activity Timeline State ───
  let activityData = [];
  let activityOffset = 0;
  const ACTIVITY_PAGE_SIZE = 25;
  let activityFilter = 'all';
  let activitySearchTerm = '';
  let activityRefreshTimer = null;

  // ─── Category Mapping ───
  const CATEGORY_MAP = {
    // Core AI
    'risk_evaluate': 'core_ai', 'neural_chat': 'core_ai', 'risk_intelligence': 'core_ai',
    'bastion_chat': 'core_ai', 'ai_evaluate': 'core_ai', 'model_query': 'core_ai',
    // Market Data
    'get_price': 'market_data', 'get_candles': 'market_data', 'get_orderbook': 'market_data',
    'get_ticker': 'market_data', 'get_trades': 'market_data', 'market_overview': 'market_data',
    'get_funding_rate': 'market_data', 'get_market_data': 'market_data', 'screener': 'market_data',
    // Derivatives
    'get_positions': 'derivatives', 'get_leverage': 'derivatives', 'get_margin': 'derivatives',
    'set_leverage': 'derivatives', 'place_order': 'derivatives', 'cancel_order': 'derivatives',
    'get_open_orders': 'derivatives', 'get_balance': 'derivatives',
    // On-Chain
    'get_gas': 'on_chain', 'get_whale_txns': 'on_chain', 'get_token_info': 'on_chain',
    'get_wallet_balance': 'on_chain', 'on_chain_analysis': 'on_chain', 'dex_volume': 'on_chain',
  };

  // ─── Category Icons ───
  const CATEGORY_ICONS = {
    'core_ai':     { icon: 'solar:brain-linear',                  color: 'text-purple-400' },
    'market_data': { icon: 'solar:chart-2-linear',                color: 'text-blue-400' },
    'derivatives': { icon: 'solar:graph-new-linear',              color: 'text-yellow-400' },
    'on_chain':    { icon: 'solar:link-minimalistic-2-linear',    color: 'text-emerald-400' },
    'unknown':     { icon: 'solar:widget-linear',                 color: 'text-zinc-500' },
  };

  // ─── Relative Time ───
  function relativeTime(ts) {
    const now = Date.now();
    const diff = now - new Date(ts).getTime();
    const secs = Math.floor(diff / 1000);
    if (secs < 5) return 'just now';
    if (secs < 60) return secs + 's ago';
    const mins = Math.floor(secs / 60);
    if (mins < 60) return mins + 'm ago';
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + 'h ago';
    const days = Math.floor(hrs / 24);
    return days + 'd ago';
  }

  // ─── Categorize Tool ───
  function categorize(toolName) {
    if (!toolName) return 'unknown';
    const key = toolName.toLowerCase().replace(/[^a-z0-9_]/g, '_');
    if (CATEGORY_MAP[key]) return CATEGORY_MAP[key];
    // Fuzzy fallback
    for (const [pattern, cat] of Object.entries(CATEGORY_MAP)) {
      if (key.includes(pattern) || pattern.includes(key)) return cat;
    }
    // Keyword fallback
    if (/risk|chat|ai|model|neural|evaluate/.test(key)) return 'core_ai';
    if (/price|candle|ticker|orderbook|market|fund|screen/.test(key)) return 'market_data';
    if (/position|leverage|margin|order|balance/.test(key)) return 'derivatives';
    if (/gas|whale|token|wallet|chain|dex/.test(key)) return 'on_chain';
    return 'unknown';
  }

  // ─── Render Single Entry ───
  function renderActivityEntry(entry, idx) {
    const tool = entry.tool || entry.endpoint || 'unknown';
    const cat = categorize(tool);
    const catInfo = CATEGORY_ICONS[cat] || CATEGORY_ICONS['unknown'];
    const isErr = (entry.status || entry.status_code || 200) >= 400;
    const latency = entry.latency_ms != null ? entry.latency_ms : null;
    const timestamp = entry.timestamp || new Date().toISOString();
    const entryId = 'activity-entry-' + idx;
    const detailId = 'activity-detail-' + idx;

    return `
      <div class="group hover:bg-zinc-900/30 transition-colors" data-category="${cat}" data-tool="${_escHtml(tool.toLowerCase())}">
        <!-- Main Row -->
        <div class="flex items-center gap-4 px-6 py-3 cursor-pointer" onclick="toggleActivityDetail('${detailId}', '${entryId}')">
          <!-- Timeline dot + icon -->
          <div class="flex items-center gap-3 shrink-0 w-24 md:w-32">
            <div class="relative">
              <div class="w-8 h-8 border border-zinc-800 bg-zinc-900/80 flex items-center justify-center group-hover:border-zinc-700 transition-colors">
                <iconify-icon icon="${catInfo.icon}" width="14" class="${catInfo.color}"></iconify-icon>
              </div>
              ${isErr ? '<div class="absolute -top-0.5 -right-0.5 w-2 h-2 bg-red-500 rounded-full border border-zinc-950"></div>' : ''}
            </div>
            <span class="text-[10px] font-mono text-zinc-600 whitespace-nowrap">${relativeTime(timestamp)}</span>
          </div>

          <!-- Tool Name -->
          <div class="flex-1 min-w-0">
            <span class="text-[11px] font-mono text-zinc-300 group-hover:text-white transition-colors truncate block">${_escHtml(tool)}</span>
            <span class="text-[9px] font-mono text-zinc-700 uppercase tracking-widest">${cat.replace('_', ' ')}</span>
          </div>

          <!-- Latency -->
          <div class="shrink-0 text-right w-16 md:w-20">
            ${latency != null ? `
              <span class="text-[11px] font-mono ${latency > 3000 ? 'text-red-400' : latency > 1000 ? 'text-yellow-400' : 'text-zinc-400'}">${latency.toLocaleString()}ms</span>
            ` : `
              <span class="text-[10px] font-mono text-zinc-700">--</span>
            `}
          </div>

          <!-- Status Badge -->
          <div class="shrink-0 w-16 text-right">
            <span class="inline-flex items-center gap-1 px-2 py-0.5 text-[9px] font-mono uppercase
              ${isErr
                ? 'text-red-400 bg-red-600/10 border border-red-600/20'
                : 'text-green-400 bg-green-600/10 border border-green-600/20'}">
              <span class="w-1 h-1 rounded-full ${isErr ? 'bg-red-400' : 'bg-green-400'}"></span>
              ${isErr ? 'ERR' : 'OK'}
            </span>
          </div>

          <!-- Expand Arrow -->
          <div class="shrink-0 w-5 text-center">
            <iconify-icon id="${entryId}" icon="solar:alt-arrow-down-linear" width="12"
              class="text-zinc-700 group-hover:text-zinc-500 transition-all duration-200"></iconify-icon>
          </div>
        </div>

        <!-- Expandable Detail -->
        <div id="${detailId}" class="hidden px-6 pb-4">
          <div class="ml-11 md:ml-[8.5rem] border border-zinc-800 bg-zinc-900/60 p-4">
            <div class="flex items-center justify-between mb-3">
              <span class="text-[9px] font-mono uppercase tracking-widest text-zinc-600">Response Detail</span>
              <span class="text-[9px] font-mono text-zinc-700">${new Date(timestamp).toLocaleString()}</span>
            </div>
            <pre class="text-[10px] font-mono text-zinc-400 leading-relaxed overflow-x-auto no-scrollbar max-h-48 overflow-y-auto">${_escHtml(
              entry.response
                ? (typeof entry.response === 'string' ? entry.response : JSON.stringify(entry.response, null, 2))
                : entry.detail
                  ? (typeof entry.detail === 'string' ? entry.detail : JSON.stringify(entry.detail, null, 2))
                  : JSON.stringify(entry, null, 2)
            )}</pre>
            ${entry.error ? `
              <div class="mt-3 p-2 border border-red-600/20 bg-red-600/5">
                <span class="text-[9px] font-mono uppercase tracking-widest text-red-500 block mb-1">Error</span>
                <span class="text-[10px] font-mono text-red-400">${_escHtml(entry.error)}</span>
              </div>
            ` : ''}
          </div>
        </div>
      </div>`;
  }

  // ─── Render Timeline ───
  function renderTimeline(entries, append) {
    const container = document.getElementById('activity-timeline');
    if (!container) return;

    // Filter by category
    let filtered = entries;
    if (activityFilter !== 'all') {
      filtered = entries.filter(e => categorize(e.tool || e.endpoint || '') === activityFilter);
    }

    // Filter by search
    if (activitySearchTerm) {
      const term = activitySearchTerm.toLowerCase();
      filtered = filtered.filter(e => (e.tool || e.endpoint || '').toLowerCase().includes(term));
    }

    if (!filtered.length && !append) {
      container.innerHTML = `
        <div class="px-6 py-12 text-center">
          <iconify-icon icon="solar:ghost-linear" width="32" class="text-zinc-800 mb-3"></iconify-icon>
          <div class="text-xs font-mono text-zinc-600">No activity events found</div>
          <div class="text-[10px] font-mono text-zinc-700 mt-1">${activityFilter !== 'all' ? 'Try a different filter' : 'Events will appear as API calls are made'}</div>
        </div>`;
      return;
    }

    const html = filtered.map((entry, i) => {
      const globalIdx = append ? (activityOffset - ACTIVITY_PAGE_SIZE + i) : i;
      return renderActivityEntry(entry, globalIdx);
    }).join('');

    if (append) {
      container.insertAdjacentHTML('beforeend', html);
    } else {
      container.innerHTML = html;
    }

    // Update count
    const countLabel = document.getElementById('activity-count-label');
    if (countLabel) {
      const total = activityData.length;
      countLabel.textContent = total + ' EVENT' + (total !== 1 ? 'S' : '');
    }
  }

  // ─── Fetch Activity ───
  async function fetchActivity(append) {
    try {
      const params = new URLSearchParams({
        limit: ACTIVITY_PAGE_SIZE,
        offset: append ? activityOffset : 0
      });

      const resp = await fetch('/api/usage/activity?' + params.toString(), { credentials: 'include' });
      if (!resp.ok) throw new Error('Failed to fetch activity');
      const data = await resp.json();
      const events = data.events || data.activity || data || [];

      if (append) {
        activityData = activityData.concat(events);
        activityOffset += events.length;
      } else {
        activityData = events;
        activityOffset = events.length;
      }

      renderTimeline(append ? events : activityData, append);

      // Hide Load More if no more data
      const loadBtn = document.getElementById('activity-load-more-btn');
      const loadStatus = document.getElementById('activity-load-status');
      if (events.length < ACTIVITY_PAGE_SIZE) {
        if (loadBtn) loadBtn.classList.add('opacity-30', 'pointer-events-none');
        if (loadStatus) {
          loadStatus.classList.remove('hidden');
          loadStatus.textContent = 'All events loaded';
        }
      } else {
        if (loadBtn) loadBtn.classList.remove('opacity-30', 'pointer-events-none');
        if (loadStatus) loadStatus.classList.add('hidden');
      }
    } catch (e) {
      const container = document.getElementById('activity-timeline');
      if (container && !append) {
        container.innerHTML = `
          <div class="px-6 py-12 text-center">
            <iconify-icon icon="solar:danger-triangle-linear" width="32" class="text-zinc-800 mb-3"></iconify-icon>
            <div class="text-xs font-mono text-zinc-600">Failed to load activity</div>
            <div class="text-[10px] font-mono text-zinc-700 mt-1">${_escHtml(e.message)}</div>
          </div>`;
      }
    }
  }

  // ─── Toggle Detail ───
  window.toggleActivityDetail = function(detailId, arrowId) {
    const detail = document.getElementById(detailId);
    const arrow = document.getElementById(arrowId);
    if (!detail) return;

    const isHidden = detail.classList.contains('hidden');
    detail.classList.toggle('hidden');

    if (arrow) {
      arrow.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
    }
  };

  // ─── Filter by Category ───
  window.setActivityFilter = function(filter) {
    activityFilter = filter;

    // Update button styles
    document.querySelectorAll('.activity-filter-btn').forEach(btn => {
      const isActive = btn.getAttribute('data-filter') === filter;
      if (isActive) {
        btn.classList.remove('border-zinc-800', 'bg-zinc-900/30', 'text-zinc-500');
        btn.classList.add('border-red-600/50', 'bg-red-600/10', 'text-red-400');
      } else {
        btn.classList.add('border-zinc-800', 'bg-zinc-900/30', 'text-zinc-500');
        btn.classList.remove('border-red-600/50', 'bg-red-600/10', 'text-red-400');
      }
    });

    renderTimeline(activityData, false);
  };

  // ─── Search Filter ───
  window.filterActivityBySearch = function(term) {
    activitySearchTerm = term.trim();
    renderTimeline(activityData, false);
  };

  // ─── Load More ───
  window.loadMoreActivity = function() {
    fetchActivity(true);
  };

  // ─── HTML Escape (local copy for this scope) ───
  function _escHtml(str) {
    const div = document.createElement('div');
    div.textContent = str || '';
    return div.innerHTML;
  }

  // ─── Auto-Refresh (30s) ───
  function startActivityAutoRefresh() {
    if (activityRefreshTimer) clearInterval(activityRefreshTimer);
    activityRefreshTimer = setInterval(() => {
      fetchActivity(false);
    }, 30000);
  }

  // ─── Init: Hook into existing dashboard init ───
  // Wait for DOM, then check if dashboard is visible and start fetching
  const _origRefreshAll = window.refreshAll;
  if (_origRefreshAll) {
    window.refreshAll = async function() {
      await _origRefreshAll();
      await fetchActivity(false);
    };
  }

  // Also start standalone if dashboard is already loaded
  document.addEventListener('DOMContentLoaded', function() {
    // Observe the dashboard div — start fetching when it becomes visible
    const dashboard = document.getElementById('dashboard');
    if (dashboard) {
      const mo = new MutationObserver(() => {
        if (!dashboard.classList.contains('hidden')) {
          fetchActivity(false);
          startActivityAutoRefresh();
          mo.disconnect();
        }
      });
      mo.observe(dashboard, { attributes: true, attributeFilter: ['class'] });

      // If already visible
      if (!dashboard.classList.contains('hidden')) {
        fetchActivity(false);
        startActivityAutoRefresh();
      }
    }
  });

})();
</script>
