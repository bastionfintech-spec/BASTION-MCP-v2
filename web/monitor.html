<!DOCTYPE html>
<html lang="en" class="bg-[#0a0a0a] antialiased">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="description" content="BASTION PULSE ‚Äî Real-time global markets intelligence">
  <meta name="theme-color" content="#0a0a0a">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='80'>üõ°Ô∏è</text></svg>">
  <title>BASTION // PULSE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            crimson: { 400: '#f87171', 500: '#ef4444', 600: '#dc2626', 700: '#b91c1c', 800: '#991b1b', 900: '#7f1d1d', 950: '#450a0a' }
          }
        }
      }
    }
  </script>
  <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500;700&display=swap');
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { background: #0a0a0a; min-height: 100%; }
    body { font-family: 'JetBrains Mono', 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace; font-size: 12px; line-height: 1.5; background: #0a0a0a; min-height: 100vh; }
    .font-mono { font-family: 'JetBrains Mono', 'SF Mono', 'Monaco', monospace; }
    .font-sans { font-family: 'Inter', sans-serif; }

    /* ‚îÄ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ‚îÄ */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #2a2a2a; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #444; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* ‚îÄ‚îÄ‚îÄ Grid / Scanline ‚îÄ‚îÄ‚îÄ */
    .bg-grid { background-size: 40px 40px; background-image: linear-gradient(to right, rgba(42,42,42,0.25) 1px, transparent 1px), linear-gradient(to bottom, rgba(42,42,42,0.25) 1px, transparent 1px); }
    .scanline { background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.12) 50%, rgba(0,0,0,0.12)); background-size: 100% 4px; pointer-events: none; }

    /* ‚îÄ‚îÄ‚îÄ Marquee Ticker ‚îÄ‚îÄ‚îÄ */
    @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
    .animate-marquee { animation: marquee 45s linear infinite; }
    .animate-marquee:hover { animation-play-state: paused; }

    /* ‚îÄ‚îÄ‚îÄ Animations ‚îÄ‚îÄ‚îÄ */
    @keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .fade-up { animation: fadeUp 0.4s ease-out forwards; }
    @keyframes pulseGlow { 0%,100% { box-shadow: 0 0 6px rgba(68,255,136,0.15); } 50% { box-shadow: 0 0 12px rgba(68,255,136,0.35); } }
    .pulse-glow { animation: pulseGlow 2s ease-in-out infinite; }

    /* ‚îÄ‚îÄ‚îÄ Splash ‚îÄ‚îÄ‚îÄ */
    .splash-screen { position: fixed; inset: 0; z-index: 9999; background: #0a0a0a; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease, visibility 0.5s ease; }
    .splash-screen.fade-out { opacity: 0; visibility: hidden; }
    @keyframes shieldBoot { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    .splash-icon { animation: shieldBoot 0.6s ease-out forwards; }
    @keyframes loadingBar { 0% { width: 0%; } 100% { width: 100%; } }
    .splash-bar { height: 2px; background: #44ff88; animation: loadingBar 1.8s ease-out forwards; border-radius: 1px; }

    /* ‚îÄ‚îÄ‚îÄ Panel Cards ‚Äî matches World Monitor ‚îÄ‚îÄ‚îÄ */
    .monitor-panel {
      background: #141414; border: 1px solid #2a2a2a; border-radius: 0;
      display: flex; flex-direction: column; overflow: hidden;
      transition: transform 0.15s, box-shadow 0.15s; position: relative;
    }
    .monitor-panel:hover { border-color: #444; box-shadow: 0 2px 12px rgba(0,0,0,0.3); }
    .monitor-panel.priority { border-left: 2px solid #44ff88; }
    .panel-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 6px 10px; height: 40px; border-bottom: 1px solid #2a2a2a;
      background: rgba(255,255,255,0.03);
    }
    .panel-title {
      font-size: 11px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 1px; color: #e8e8e8;
      display: flex; align-items: center; gap: 6px;
    }
    .panel-badge {
      font-size: 9px; padding: 2px 6px; border-radius: 3px; border: 1px solid;
      font-weight: 500;
    }
    .panel-body {
      flex: 1; overflow-y: auto; padding: 8px; min-height: 120px;
      scrollbar-width: thin; scrollbar-color: #2a2a2a transparent;
    }
    .panel-body::-webkit-scrollbar { width: 4px; }
    .panel-body::-webkit-scrollbar-track { background: transparent; }
    .panel-body::-webkit-scrollbar-thumb { background: #2a2a2a; border-radius: 2px; }

    /* ‚îÄ‚îÄ‚îÄ Market Items ‚îÄ‚îÄ‚îÄ */
    .market-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 5px 8px; transition: background 0.15s;
    }
    .market-row:hover { background: rgba(255,255,255,0.03); }
    .market-row + .market-row { border-top: 1px solid #1a1a1a; }

    /* ‚îÄ‚îÄ‚îÄ Sparkline SVG ‚îÄ‚îÄ‚îÄ */
    .mini-sparkline { vertical-align: middle; margin-right: 6px; }

    /* ‚îÄ‚îÄ‚îÄ Heatmap ‚îÄ‚îÄ‚îÄ */
    .heatmap-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 4px; }
    .heatmap-cell {
      padding: 8px 6px; border-radius: 2px; text-align: center;
      transition: all 0.15s;
    }
    .heatmap-cell:hover { transform: scale(1.04); box-shadow: 0 0 12px rgba(255,255,255,0.04); }
    .hm-strong-up { background: rgba(68,255,136,0.18); border: 1px solid rgba(68,255,136,0.25); }
    .hm-up { background: rgba(68,255,136,0.10); border: 1px solid rgba(68,255,136,0.15); }
    .hm-slight-up { background: rgba(68,255,136,0.05); border: 1px solid rgba(68,255,136,0.08); }
    .hm-neutral { background: rgba(136,136,136,0.08); border: 1px solid rgba(136,136,136,0.12); }
    .hm-slight-down { background: rgba(255,68,68,0.05); border: 1px solid rgba(255,68,68,0.08); }
    .hm-down { background: rgba(255,68,68,0.10); border: 1px solid rgba(255,68,68,0.15); }
    .hm-strong-down { background: rgba(255,68,68,0.18); border: 1px solid rgba(255,68,68,0.25); }

    /* ‚îÄ‚îÄ‚îÄ Macro Signals / Radar ‚îÄ‚îÄ‚îÄ */
    .signal-card {
      background: rgba(255,255,255,0.02); border: 1px solid #2a2a2a; border-radius: 2px;
      padding: 8px 10px; transition: all 0.2s;
    }
    .signal-card:hover { border-color: #444; background: rgba(255,255,255,0.04); }
    .signal-badge { font-size: 9px; font-weight: 600; padding: 1px 6px; border-radius: 2px; text-transform: uppercase; letter-spacing: 0.05em; }
    .badge-bullish { background: rgba(68,255,136,0.12); color: #44ff88; }
    .badge-bearish { background: rgba(255,68,68,0.12); color: #ff4444; }
    .badge-neutral { background: rgba(136,136,136,0.12); color: #888; }
    .verdict-buy { background: linear-gradient(135deg, rgba(68,255,136,0.08), rgba(68,255,136,0.02)); border: 1px solid rgba(68,255,136,0.2); border-radius: 2px; }
    .verdict-cash { background: linear-gradient(135deg, rgba(255,68,68,0.08), rgba(255,68,68,0.02)); border: 1px solid rgba(255,68,68,0.2); border-radius: 2px; }

    /* ‚îÄ‚îÄ‚îÄ ETF Flows ‚îÄ‚îÄ‚îÄ */
    .etf-table { width: 100%; border-collapse: collapse; font-size: 11px; }
    .etf-table th { text-align: left; padding: 4px 6px; font-size: 9px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #2a2a2a; background: rgba(255,255,255,0.02); }
    .etf-table td { padding: 4px 6px; border-bottom: 1px solid #1a1a1a; }
    .etf-table tr:hover td { background: rgba(255,255,255,0.02); }
    .flow-inflow { color: #44ff88; }
    .flow-outflow { color: #ff4444; }
    .flow-neutral { color: #888; }

    /* ‚îÄ‚îÄ‚îÄ Stablecoins ‚îÄ‚îÄ‚îÄ */
    .peg-on { color: #44ff88; }
    .peg-slight { color: #ffaa00; }
    .peg-off { color: #ff4444; }
    .health-good { background: rgba(68,255,136,0.06); border: 1px solid rgba(68,255,136,0.15); }
    .health-caution { background: rgba(255,170,0,0.06); border: 1px solid rgba(255,170,0,0.15); }
    .health-warning { background: rgba(255,68,68,0.06); border: 1px solid rgba(255,68,68,0.15); }

    /* ‚îÄ‚îÄ‚îÄ RSS / News Items ‚îÄ‚îÄ‚îÄ */
    .news-item {
      padding: 6px 8px; transition: background 0.15s;
      border-bottom: 1px solid #1a1a1a;
    }
    .news-item:hover { background: rgba(255,255,255,0.02); }
    .news-item:last-child { border-bottom: none; }
    .news-source { font-size: 8px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
    .news-title { font-size: 11px; color: #e8e8e8; line-height: 1.4; }
    .news-title a { color: #e8e8e8; text-decoration: none; transition: color 0.15s; }
    .news-title a:hover { color: #44ff88; }
    .news-time { font-size: 9px; color: #555; }

    /* ‚îÄ‚îÄ‚îÄ Economic Data ‚îÄ‚îÄ‚îÄ */
    .econ-row { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; padding: 6px 0; border-bottom: 1px solid #1a1a1a; align-items: center; }
    .econ-row:last-child { border-bottom: none; }

    /* ‚îÄ‚îÄ‚îÄ Polymarket Predictions ‚îÄ‚îÄ‚îÄ */
    .prediction-row { padding: 6px 8px; border-bottom: 1px solid #1a1a1a; transition: background 0.15s; }
    .prediction-row:hover { background: rgba(255,255,255,0.02); }
    .prediction-row:last-child { border-bottom: none; }
    .prediction-bar { height: 4px; border-radius: 2px; background: #1a1a1a; overflow: hidden; }
    .prediction-fill { height: 100%; border-radius: 2px; transition: width 0.3s ease; background: linear-gradient(90deg, #3b82f6, #60a5fa); }

    /* ‚îÄ‚îÄ‚îÄ Globe / Map ‚îÄ‚îÄ‚îÄ */
    #globe-container { width: 100%; height: 100%; min-height: 300px; }
    .map-marker { width: 8px; height: 8px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3); cursor: pointer; transition: transform 0.2s; }
    .map-marker:hover { transform: scale(1.6); }
    .maplibregl-popup-content { background: #141414 !important; border: 1px solid #2a2a2a !important; border-radius: 0 !important; padding: 0 !important; box-shadow: 0 8px 24px rgba(0,0,0,0.5) !important; }
    .maplibregl-popup-tip { border-top-color: #141414 !important; }

    /* ‚îÄ‚îÄ‚îÄ Settings Modal ‚îÄ‚îÄ‚îÄ */
    .settings-overlay { position: fixed; inset: 0; background: rgba(10,10,10,0.85); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
    .settings-overlay.active { display: flex; }
    .settings-modal { background: #141414; border: 1px solid #2a2a2a; border-radius: 0; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 60px rgba(0,0,0,0.6); }

    /* ‚îÄ‚îÄ‚îÄ Loading Skeleton ‚îÄ‚îÄ‚îÄ */
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    .skeleton { background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 1px; }

    /* ‚îÄ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ‚îÄ */
    @media (max-width: 767px) {
      .panel-grid { grid-template-columns: 1fr !important; }
      .heatmap-grid { grid-template-columns: repeat(3, 1fr); }
    }

    /* ‚îÄ‚îÄ‚îÄ Panel Toggle Checkbox ‚îÄ‚îÄ‚îÄ */
    .panel-toggle input[type="checkbox"] { accent-color: #44ff88; }

    /* ‚îÄ‚îÄ‚îÄ Map Controls ‚îÄ‚îÄ‚îÄ */
    .time-btn {
      font-size: 9px; padding: 2px 6px; border: 1px solid #2a2a2a; color: #888;
      background: rgba(20,20,20,0.8); cursor: pointer; transition: all 0.15s;
    }
    .time-btn:hover { border-color: #444; color: #ccc; }
    .time-btn.active { background: #44ff88; color: #0a0a0a; border-color: #44ff88; font-weight: bold; }
    .layer-btn {
      font-size: 8px; padding: 2px 6px; border: 1px solid #2a2a2a; color: #555;
      background: rgba(20,20,20,0.8); cursor: pointer; transition: all 0.15s; letter-spacing: 0.5px;
    }
    .layer-btn:hover { border-color: #444; color: #ccc; }
    .layer-btn.active { color: #44ff88; border-color: #44ff88; }

    /* ‚îÄ‚îÄ‚îÄ Status badges (live/cached) ‚îÄ‚îÄ‚îÄ */
    .status-live { font-size: 9px; padding: 1px 6px; border: 1px solid rgba(68,255,136,0.3); color: #44ff88; border-radius: 2px; background: rgba(68,255,136,0.08); }
    .status-cached { font-size: 9px; padding: 1px 6px; border: 1px solid rgba(255,170,0,0.3); color: #ffaa00; border-radius: 2px; background: rgba(255,170,0,0.08); }
  </style>
</head>
<body class="bg-[#0a0a0a] text-[#ccc] min-h-screen flex flex-col selection:bg-[#44ff88]/20 selection:text-white relative overflow-x-hidden" style="background:#0a0a0a;">

  <!-- Loading Splash -->
  <div id="splash" class="splash-screen">
    <div class="splash-icon flex items-center gap-3 mb-6">
      <iconify-icon icon="solar:shield-bold" class="text-[#44ff88] text-4xl"></iconify-icon>
      <div>
        <div class="text-xl font-bold text-white tracking-[2px] uppercase">BASTION</div>
        <div class="text-[8px] text-[#888] uppercase tracking-[0.3em]">PULSE</div>
      </div>
    </div>
    <div class="w-48 bg-[#1a1a1a] rounded-full overflow-hidden"><div class="splash-bar"></div></div>
    <div class="mt-4 text-[9px] text-[#555] tracking-widest uppercase">Connecting to global markets...</div>
  </div>

  <!-- Background Overlays (subtle) -->
  <div class="absolute inset-0 pointer-events-none opacity-[0.015] bg-grid z-0"></div>

  <!-- ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê -->
  <header style="height:40px; background:#141414; border-bottom:1px solid #2a2a2a;" class="flex items-center justify-between shrink-0 px-3 md:px-4 relative z-40">
    <div class="flex items-center gap-2 md:gap-3">
      <a href="/" class="flex items-center gap-1.5 md:gap-2 group cursor-pointer no-underline">
        <iconify-icon icon="solar:shield-bold" class="text-[#44ff88] text-lg group-hover:scale-110 transition-transform"></iconify-icon>
        <span class="text-[14px] font-bold tracking-[2px] text-white uppercase">BASTION</span>
      </a>
      <span class="text-[9px] opacity-50 ml-1">PULSE</span>
      <!-- LIVE indicator -->
      <div class="hidden md:flex items-center ml-2 gap-1.5">
        <span class="relative flex h-1.5 w-1.5">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-[#44ff88] opacity-40"></span>
          <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-[#44ff88]"></span>
        </span>
        <span class="text-[9px] text-[#888] uppercase tracking-widest">LIVE</span>
      </div>
    </div>
    <!-- Nav -->
    <nav class="hidden md:flex items-center gap-5 text-[10px] uppercase tracking-widest">
      <a href="/lite" class="text-[#888] hover:text-white transition-colors">Dashboard</a>
      <a href="/monitor" class="text-[#44ff88] font-bold">Pulse</a>
      <a href="/research" class="text-[#888] hover:text-white transition-colors">Research</a>
      <a href="/account" class="text-[#888] hover:text-white transition-colors">Account</a>
    </nav>
    <!-- Right actions -->
    <div class="flex items-center gap-2 md:gap-3">
      <button onclick="toggleSettings()" class="w-7 h-7 flex items-center justify-center border border-[#2a2a2a] hover:border-[#444] transition-colors" title="Panel Settings">
        <iconify-icon icon="solar:settings-linear" class="text-[#888] hover:text-white text-sm"></iconify-icon>
      </button>
      <button onclick="refreshAll()" class="w-7 h-7 flex items-center justify-center border border-[#2a2a2a] hover:border-[#444] transition-colors" title="Refresh All">
        <iconify-icon icon="solar:refresh-linear" class="text-[#888] hover:text-white text-sm"></iconify-icon>
      </button>
      <span id="lastUpdate" class="hidden md:inline text-[9px] text-[#555]"></span>
      <button class="md:hidden text-[#888] hover:text-white p-1" onclick="document.getElementById('mobile-nav').classList.toggle('hidden')">
        <iconify-icon icon="solar:hamburger-menu-linear" width="20"></iconify-icon>
      </button>
    </div>
  </header>

  <!-- Mobile Nav -->
  <div id="mobile-nav" class="hidden md:hidden absolute top-10 left-0 right-0 z-50 bg-[#111] border-b border-[#2a2a2a] px-4 py-3 space-y-1">
    <a href="/lite" class="flex items-center gap-3 px-3 py-2.5 hover:bg-[#1a1a1a] text-xs text-[#888] hover:text-white transition-all">
      <iconify-icon icon="solar:shield-bold" class="text-sm"></iconify-icon>Dashboard
    </a>
    <a href="/monitor" class="flex items-center gap-3 px-3 py-2.5 bg-[#44ff88]/5 border border-[#44ff88]/15 text-xs text-white">
      <iconify-icon icon="solar:chart-2-bold" class="text-[#44ff88] text-sm"></iconify-icon>Pulse
      <span class="ml-auto text-[8px] text-[#44ff88] font-bold">ACTIVE</span>
    </a>
    <a href="/research" class="flex items-center gap-3 px-3 py-2.5 hover:bg-[#1a1a1a] text-xs text-[#888] hover:text-white transition-all">
      <iconify-icon icon="solar:document-text-linear" class="text-sm"></iconify-icon>Research
    </a>
    <a href="/account" class="flex items-center gap-3 px-3 py-2.5 hover:bg-[#1a1a1a] text-xs text-[#888] hover:text-white transition-all">
      <iconify-icon icon="solar:user-circle-linear" class="text-sm"></iconify-icon>Account
    </a>
  </div>

  <!-- ‚ïê‚ïê‚ïê MARKET PULSE TICKER ‚ïê‚ïê‚ïê -->
  <div style="height:28px; background:#111; border-bottom:1px solid #1a1a1a;" class="flex items-center shrink-0 relative z-30 overflow-hidden">
    <div class="flex items-center gap-1 px-2 shrink-0 border-r border-[#2a2a2a]">
      <iconify-icon icon="solar:pulse-2-bold" class="text-[#44ff88] text-[10px]"></iconify-icon>
      <span class="text-[8px] font-bold text-[#555] uppercase tracking-[1px]">PULSE</span>
    </div>
    <div class="flex-1 overflow-hidden relative">
      <div id="ticker-strip" class="flex items-center gap-6 px-4 whitespace-nowrap animate-marquee">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê MAP SECTION (full width, top) ‚ïê‚ïê‚ïê -->
  <section id="map-section" class="relative z-10 shrink-0" style="height:50vh; min-height:300px; max-height:500px; border-bottom:1px solid #2a2a2a; background:#020a08;">
    <div id="globe-container" style="width:100%; height:100%;"></div>

    <!-- Top-left: Title + Time range -->
    <div style="position:absolute; top:8px; left:8px; z-index:20; display:flex; flex-direction:column; gap:6px;">
      <div style="display:flex; align-items:center; gap:8px;">
        <span class="text-[11px] font-semibold text-white uppercase tracking-[1px]" style="background:#141414; border:1px solid #2a2a2a; padding:4px 10px;">
          <iconify-icon icon="solar:earth-bold" class="text-[#44ff88] text-xs"></iconify-icon> GLOBAL SITUATION
        </span>
        <span id="utc-clock" class="text-[10px] text-[#888]" style="background:rgba(20,20,20,0.8); border:1px solid #2a2a2a; padding:3px 8px;">--:--:-- UTC</span>
        <span class="status-live pulse-glow">LIVE</span>
      </div>
      <!-- Time range selector -->
      <div style="display:flex; align-items:center; gap:4px;">
        <span class="text-[8px] text-[#555] uppercase tracking-[1px]">TIME RANGE</span>
        <button onclick="setTimeRange('1h')" class="time-btn active" data-range="1h">1H</button>
        <button onclick="setTimeRange('6h')" class="time-btn" data-range="6h">6H</button>
        <button onclick="setTimeRange('24h')" class="time-btn" data-range="24h">24H</button>
        <button onclick="setTimeRange('48h')" class="time-btn" data-range="48h">48H</button>
        <button onclick="setTimeRange('7d')" class="time-btn" data-range="7d">7D</button>
        <button onclick="setTimeRange('all')" class="time-btn" data-range="all">ALL</button>
      </div>
    </div>

    <!-- Bottom-left: Layer toggles -->
    <div id="layer-toggles" style="position:absolute; bottom:32px; left:8px; z-index:20; display:flex; flex-wrap:wrap; gap:3px; max-width:320px;">
      <button onclick="toggleLayer('exchanges')" class="layer-btn active" data-layer="exchanges">EXCHANGES</button>
      <button onclick="toggleLayer('banks')" class="layer-btn active" data-layer="banks">CENTRAL BANKS</button>
      <button onclick="toggleLayer('centers')" class="layer-btn active" data-layer="centers">FIN. CENTERS</button>
      <button onclick="toggleLayer('cables')" class="layer-btn active" data-layer="cables">CABLES</button>
      <button onclick="toggleLayer('pipelines')" class="layer-btn active" data-layer="pipelines">PIPELINES</button>
      <button onclick="toggleLayer('waterways')" class="layer-btn active" data-layer="waterways">WATERWAYS</button>
    </div>

    <!-- Bottom-center: Legend -->
    <div style="position:absolute; bottom:8px; left:50%; transform:translateX(-50%); z-index:20; display:flex; align-items:center; gap:12px; padding:4px 14px; background:rgba(20,20,20,0.85); border:1px solid #2a2a2a;">
      <span style="display:flex;align-items:center;gap:4px;"><span style="width:8px;height:8px;border-radius:50%;background:#ff4444;display:inline-block;"></span><span class="text-[8px] text-[#888]">MEGA EXCHANGE</span></span>
      <span style="display:flex;align-items:center;gap:4px;"><span style="width:6px;height:6px;border-radius:50%;background:#ff8800;display:inline-block;"></span><span class="text-[8px] text-[#888]">MAJOR</span></span>
      <span style="display:flex;align-items:center;gap:4px;"><span style="width:6px;height:6px;border-radius:50%;background:#3b82f6;display:inline-block;"></span><span class="text-[8px] text-[#888]">CENTRAL BANK</span></span>
      <span style="display:flex;align-items:center;gap:4px;"><span style="width:6px;height:6px;border-radius:50%;background:#a855f7;display:inline-block;"></span><span class="text-[8px] text-[#888]">FIN. CENTER</span></span>
      <span style="display:flex;align-items:center;gap:4px;"><span style="width:14px;height:2px;border-top:2px dashed #3b82f6;display:inline-block;"></span><span class="text-[8px] text-[#888]">CABLE</span></span>
      <span style="display:flex;align-items:center;gap:4px;"><span style="width:14px;height:2px;background:#ff8800;display:inline-block;"></span><span class="text-[8px] text-[#888]">PIPELINE</span></span>
      <span style="display:flex;align-items:center;gap:4px;"><span style="width:8px;height:8px;border-radius:50%;border:2px solid #3b82f6;display:inline-block;"></span><span class="text-[8px] text-[#888]">WATERWAY</span></span>
    </div>
  </section>

  <!-- ‚ïê‚ïê‚ïê MAIN PANEL GRID ‚ïê‚ïê‚ïê -->
  <main class="flex-1 relative z-10" style="padding:4px; background:#0a0a0a;">
    <div id="panel-grid" class="panel-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); grid-auto-rows:minmax(180px, 320px); gap:4px; min-height:100%;">

      <!-- Panel: Live Markets -->
      <div id="panel-markets" class="monitor-panel priority" data-panel="markets" style="order:5">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:chart-bold" class="text-[#44ff88] text-xs"></iconify-icon> Live Markets</span>
          <span class="status-live pulse-glow">LIVE</span>
        </div>
        <div class="panel-body" id="markets-body">
          <div class="space-y-2"><div class="skeleton h-5 w-full"></div><div class="skeleton h-5 w-4/5"></div><div class="skeleton h-5 w-full"></div><div class="skeleton h-5 w-3/5"></div><div class="skeleton h-5 w-full"></div></div>
        </div>
      </div>

      <!-- Panel: Crypto -->
      <div id="panel-crypto" class="monitor-panel priority" data-panel="crypto" style="order:6">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:bitcoin-circle-bold" class="text-[#ffaa00] text-xs"></iconify-icon> Crypto & Digital Assets</span>
          <span class="status-live">LIVE</span>
        </div>
        <div class="panel-body" id="crypto-body">
          <div class="space-y-2"><div class="skeleton h-5 w-full"></div><div class="skeleton h-5 w-4/5"></div><div class="skeleton h-5 w-full"></div><div class="skeleton h-5 w-3/5"></div></div>
        </div>
      </div>

      <!-- Panel: Sector Heatmap -->
      <div id="panel-heatmap" class="monitor-panel priority" data-panel="heatmap" style="order:7">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:graph-up-bold" class="text-[#e8e8e8] text-xs"></iconify-icon> Sector Heatmap</span>
          <span class="status-live">LIVE</span>
        </div>
        <div class="panel-body" id="heatmap-body">
          <div class="heatmap-grid"><div class="skeleton h-14 w-full"></div><div class="skeleton h-14 w-full"></div><div class="skeleton h-14 w-full"></div><div class="skeleton h-14 w-full"></div></div>
        </div>
      </div>

      <!-- Panel: Commodities -->
      <div id="panel-commodities" class="monitor-panel" data-panel="commodities" style="order:8">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:fire-bold" class="text-[#ffaa00] text-xs"></iconify-icon> Commodities & Futures</span>
          <span class="status-live">LIVE</span>
        </div>
        <div class="panel-body" id="commodities-body">
          <div class="space-y-2"><div class="skeleton h-5 w-full"></div><div class="skeleton h-5 w-4/5"></div><div class="skeleton h-5 w-full"></div></div>
        </div>
      </div>

      <!-- Panel: Market Radar (Macro Signals) -->
      <div id="panel-radar" class="monitor-panel priority" data-panel="macro-signals" style="order:9;">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:radar-2-bold" class="text-[#ff4444] text-xs"></iconify-icon> Market Radar</span>
          <span class="status-live">LIVE</span>
        </div>
        <div class="panel-body" id="radar-body">
          <div class="space-y-2"><div class="skeleton h-12 w-full"></div><div class="skeleton h-8 w-full"></div><div class="skeleton h-8 w-full"></div></div>
        </div>
      </div>

      <!-- Panel: Economic Data (FRED) -->
      <div id="panel-economic" class="monitor-panel" data-panel="economic" style="order:10">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:buildings-bold" class="text-[#3b82f6] text-xs"></iconify-icon> Economic Data</span>
          <span class="status-cached">FRED</span>
        </div>
        <div class="panel-body" id="economic-body">
          <div class="space-y-2"><div class="skeleton h-5 w-full"></div><div class="skeleton h-5 w-4/5"></div><div class="skeleton h-5 w-full"></div></div>
        </div>
      </div>

      <!-- Panel: BTC ETF Tracker -->
      <div id="panel-etf" class="monitor-panel" data-panel="etf-flows" style="order:11;">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:wallet-bold" class="text-[#ff8800] text-xs"></iconify-icon> BTC ETF Tracker</span>
          <span class="status-live">LIVE</span>
        </div>
        <div class="panel-body" id="etf-body">
          <div class="space-y-2"><div class="skeleton h-5 w-full"></div><div class="skeleton h-5 w-4/5"></div><div class="skeleton h-5 w-full"></div></div>
        </div>
      </div>

      <!-- Panel: Stablecoins -->
      <div id="panel-stablecoins" class="monitor-panel" data-panel="stablecoins" style="order:12">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:shield-check-bold" class="text-[#44ff88] text-xs"></iconify-icon> Stablecoins</span>
          <span class="status-live">LIVE</span>
        </div>
        <div class="panel-body" id="stablecoins-body">
          <div class="space-y-2"><div class="skeleton h-5 w-full"></div><div class="skeleton h-5 w-4/5"></div><div class="skeleton h-5 w-full"></div></div>
        </div>
      </div>

      <!-- Panel: Market Headlines -->
      <div id="panel-headlines" class="monitor-panel priority" data-panel="live-news" style="order:1;">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:document-text-bold" class="text-[#e8e8e8] text-xs"></iconify-icon> Market Headlines</span>
          <span class="status-live">LIVE</span>
        </div>
        <div class="panel-body" id="headlines-body">
          <div class="space-y-2"><div class="skeleton h-8 w-full"></div><div class="skeleton h-8 w-full"></div><div class="skeleton h-8 w-full"></div></div>
        </div>
      </div>

      <!-- Panel: Predictions (Polymarket) -->
      <div id="panel-predictions" class="monitor-panel" data-panel="polymarket" style="order:13;">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:target-bold" class="text-[#a855f7] text-xs"></iconify-icon> Predictions</span>
          <span class="status-live">LIVE</span>
        </div>
        <div class="panel-body" id="predictions-body">
          <div class="space-y-2"><div class="skeleton h-8 w-full"></div><div class="skeleton h-8 w-full"></div><div class="skeleton h-8 w-full"></div></div>
        </div>
      </div>

      <!-- Panel: Forex News -->
      <div id="panel-forex" class="monitor-panel" data-panel="forex" style="order:14">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:dollar-bold" class="text-[#44ff88] text-xs"></iconify-icon> Forex & Currencies</span>
          <span class="status-cached">RSS</span>
        </div>
        <div class="panel-body" id="forex-body">
          <div class="space-y-2"><div class="skeleton h-8 w-full"></div><div class="skeleton h-8 w-full"></div></div>
        </div>
      </div>

      <!-- Panel: Bonds / Fixed Income -->
      <div id="panel-bonds" class="monitor-panel" data-panel="bonds" style="order:15">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:safe-square-bold" class="text-[#3b82f6] text-xs"></iconify-icon> Fixed Income</span>
          <span class="status-cached">RSS</span>
        </div>
        <div class="panel-body" id="bonds-body">
          <div class="space-y-2"><div class="skeleton h-8 w-full"></div><div class="skeleton h-8 w-full"></div></div>
        </div>
      </div>

      <!-- Panel: Central Bank Watch -->
      <div id="panel-centralbanks" class="monitor-panel" data-panel="centralbanks" style="order:16">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:buildings-2-bold" class="text-[#3b82f6] text-xs"></iconify-icon> Central Bank Watch</span>
          <span class="status-cached">RSS</span>
        </div>
        <div class="panel-body" id="centralbanks-body">
          <div class="space-y-2"><div class="skeleton h-8 w-full"></div><div class="skeleton h-8 w-full"></div></div>
        </div>
      </div>

      <!-- Panel: Crypto News -->
      <div id="panel-cryptonews" class="monitor-panel" data-panel="crypto-news" style="order:17">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:link-bold" class="text-[#ffaa00] text-xs"></iconify-icon> Crypto News</span>
          <span class="status-cached">RSS</span>
        </div>
        <div class="panel-body" id="cryptonews-body">
          <div class="space-y-2"><div class="skeleton h-8 w-full"></div><div class="skeleton h-8 w-full"></div></div>
        </div>
      </div>

      <!-- Panel: Commodities News -->
      <div id="panel-comnews" class="monitor-panel" data-panel="commodities-news" style="order:18">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:gas-station-bold" class="text-[#ffaa00] text-xs"></iconify-icon> Commodities News</span>
          <span class="status-cached">RSS</span>
        </div>
        <div class="panel-body" id="comnews-body">
          <div class="space-y-2"><div class="skeleton h-8 w-full"></div><div class="skeleton h-8 w-full"></div></div>
        </div>
      </div>

      <!-- Panel: IPO / Earnings / M&A -->
      <div id="panel-ipo" class="monitor-panel" data-panel="ipo" style="order:19">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:hand-money-bold" class="text-[#ff8800] text-xs"></iconify-icon> IPOs, Earnings & M&A</span>
          <span class="status-cached">RSS</span>
        </div>
        <div class="panel-body" id="ipo-body">
          <div class="space-y-2"><div class="skeleton h-8 w-full"></div><div class="skeleton h-8 w-full"></div></div>
        </div>
      </div>

      <!-- Panel: Economic News -->
      <div id="panel-econnews" class="monitor-panel" data-panel="economic-news" style="order:20">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:chart-square-bold" class="text-[#3b82f6] text-xs"></iconify-icon> Economic News</span>
          <span class="status-cached">RSS</span>
        </div>
        <div class="panel-body" id="econnews-body">
          <div class="space-y-2"><div class="skeleton h-8 w-full"></div><div class="skeleton h-8 w-full"></div></div>
        </div>
      </div>

      <!-- Panel: Markets News -->
      <div id="panel-marketnews" class="monitor-panel" data-panel="markets-news" style="order:4">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:sort-from-top-to-bottom-bold" class="text-[#888] text-xs"></iconify-icon> Markets News</span>
          <span class="status-cached">RSS</span>
        </div>
        <div class="panel-body" id="marketnews-body">
          <div class="space-y-2"><div class="skeleton h-8 w-full"></div><div class="skeleton h-8 w-full"></div></div>
        </div>
      </div>

      <!-- Panel: Live News Streams -->
      <div id="panel-livenews" class="monitor-panel priority" data-panel="live-news-streams" style="order:2;">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:tv-bold" class="text-[#ff4444] text-xs"></iconify-icon> Live News</span>
          <span class="status-live pulse-glow">LIVE</span>
        </div>
        <div class="panel-body p-0" id="livenews-body" style="padding:0; display:flex; flex-direction:column; overflow:hidden;">
          <div class="flex flex-wrap gap-1 p-2 border-b border-[#2a2a2a]" id="livenews-tabs" style="flex-shrink:0;"></div>
          <div id="livenews-player" style="flex:1; min-height:0; background:#000; overflow:hidden;"></div>
        </div>
      </div>

      <!-- Panel: Live Webcams -->
      <div id="panel-webcams" class="monitor-panel" data-panel="webcams" style="order:3;">
        <div class="panel-header">
          <span class="panel-title"><iconify-icon icon="solar:videocamera-bold" class="text-[#888] text-xs"></iconify-icon> Live Webcams</span>
          <span class="status-live">LIVE</span>
        </div>
        <div class="panel-body p-0" id="webcams-body" style="padding:0; display:flex; flex-direction:column; overflow:hidden;">
          <div class="flex flex-wrap gap-1 p-2 border-b border-[#2a2a2a]" id="webcams-tabs" style="flex-shrink:0;"></div>
          <div id="webcams-player" style="flex:1; min-height:0; background:#000; overflow:hidden;"></div>
        </div>
      </div>

    </div>
  </main>

  <!-- ‚ïê‚ïê‚ïê SETTINGS MODAL ‚ïê‚ïê‚ïê -->
  <div id="settings-overlay" class="settings-overlay" onclick="if(event.target===this)toggleSettings()">
    <div class="settings-modal">
      <div class="flex items-center justify-between px-4 py-3 border-b border-[#2a2a2a]" style="background:rgba(255,255,255,0.03);">
        <div class="flex items-center gap-2">
          <iconify-icon icon="solar:settings-bold" class="text-[#44ff88] text-sm"></iconify-icon>
          <span class="text-xs uppercase tracking-widest text-white font-semibold">Panel Settings</span>
        </div>
        <button onclick="toggleSettings()" class="text-[#888] hover:text-white transition-colors"><iconify-icon icon="solar:close-circle-linear" class="text-lg"></iconify-icon></button>
      </div>
      <div id="settings-list" class="p-4 space-y-1">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     JAVASCRIPT ‚Äî All data fetching, rendering, and state management
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// ‚îÄ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ
// Proxy through our own backend to bypass CORS (World Monitor only allows origin: worldmonitor.app)
const API = '/wm-proxy';
const REFRESH_MS = 180000; // 3 min
const TICKER_REFRESH_MS = 60000; // 1 min

// ‚îÄ‚îÄ‚îÄ Panel visibility (persisted to localStorage) ‚îÄ‚îÄ‚îÄ
const DEFAULT_PANELS = {
  'markets': true, 'crypto': true, 'heatmap': true, 'commodities': true,
  'macro-signals': true, 'economic': true, 'etf-flows': true, 'stablecoins': true,
  'live-news': true, 'polymarket': true, 'forex': true, 'bonds': true,
  'centralbanks': true, 'crypto-news': true, 'commodities-news': true,
  'ipo': true, 'economic-news': true, 'markets-news': true, 'map': true,
  'live-news-streams': true, 'webcams': true
};

let panelState = { ...DEFAULT_PANELS };
try {
  const saved = localStorage.getItem('bastion_monitor_panels');
  if (saved) panelState = { ...DEFAULT_PANELS, ...JSON.parse(saved) };
} catch(e) {}

function savePanelState() {
  try { localStorage.setItem('bastion_monitor_panels', JSON.stringify(panelState)); } catch(e) {}
}

// ‚îÄ‚îÄ‚îÄ Utility Functions ‚îÄ‚îÄ‚îÄ
function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatPrice(price) {
  if (price == null) return '--';
  if (Math.abs(price) >= 10000) return price.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
  if (Math.abs(price) >= 100) return price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  if (Math.abs(price) >= 1) return price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  return price.toLocaleString('en-US', { minimumFractionDigits: 4, maximumFractionDigits: 4 });
}

function formatChange(change) {
  if (change == null) return '--';
  const sign = change >= 0 ? '+' : '';
  return `${sign}${change.toFixed(2)}%`;
}

function formatVolume(v) {
  if (v == null) return '--';
  if (Math.abs(v) >= 1e12) return `$${(v/1e12).toFixed(1)}T`;
  if (Math.abs(v) >= 1e9) return `$${(v/1e9).toFixed(1)}B`;
  if (Math.abs(v) >= 1e6) return `$${(v/1e6).toFixed(1)}M`;
  if (Math.abs(v) >= 1e3) return `$${(v/1e3).toFixed(0)}K`;
  return '$' + v.toLocaleString();
}

function formatLargeNum(v) {
  if (v >= 1e12) return `$${(v/1e12).toFixed(1)}T`;
  if (v >= 1e9) return `$${(v/1e9).toFixed(1)}B`;
  if (v >= 1e6) return `$${(v/1e6).toFixed(0)}M`;
  return '$' + v.toLocaleString();
}

function changeClass(val) {
  if (val == null) return 'text-[#888]';
  return val >= 0 ? 'text-[#44ff88]' : 'text-[#ff4444]';
}

function timeAgo(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  const now = Date.now();
  const diff = now - d.getTime();
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return `${Math.floor(diff/60000)}m ago`;
  if (diff < 86400000) return `${Math.floor(diff/3600000)}h ago`;
  return `${Math.floor(diff/86400000)}d ago`;
}

// ‚îÄ‚îÄ‚îÄ SVG Sparkline Generator ‚îÄ‚îÄ‚îÄ
function sparkline(data, change, w = 50, h = 16) {
  if (!data || data.length < 2) return '';
  const min = Math.min(...data);
  const max = Math.max(...data);
  const range = max - min || 1;
  const color = change != null && change >= 0 ? '#44ff88' : '#ff4444';
  const points = data.map((v, i) => {
    const x = (i / (data.length - 1)) * w;
    const y = h - ((v - min) / range) * (h - 2) - 1;
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  }).join(' ');
  return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" class="mini-sparkline"><polyline points="${points}" fill="none" stroke="${color}" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
}

// ‚îÄ‚îÄ‚îÄ Donut Gauge SVG (for Fear & Greed) ‚îÄ‚îÄ‚îÄ
function donutGauge(value, size = 48) {
  if (value == null) return '<span class="text-[#888] text-xs font-mono">N/A</span>';
  const v = Math.max(0, Math.min(100, value));
  const r = (size - 6) / 2;
  const circ = 2 * Math.PI * r;
  const offset = circ - (v / 100) * circ;
  let color = '#f44336';
  if (v >= 75) color = '#4caf50';
  else if (v >= 50) color = '#ff9800';
  else if (v >= 25) color = '#ff5722';
  return `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}"><circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="5"/><circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="${color}" stroke-width="5" stroke-dasharray="${circ}" stroke-dashoffset="${offset}" stroke-linecap="round" transform="rotate(-90 ${size/2} ${size/2})"/><text x="${size/2}" y="${size/2 + 4}" text-anchor="middle" fill="${color}" font-size="12" font-weight="bold" font-family="JetBrains Mono,monospace">${v}</text></svg>`;
}

function getHeatmapClass(change) {
  if (change == null) return 'hm-neutral';
  if (change >= 2) return 'hm-strong-up';
  if (change >= 0.5) return 'hm-up';
  if (change >= 0) return 'hm-slight-up';
  if (change >= -0.5) return 'hm-slight-down';
  if (change >= -2) return 'hm-down';
  return 'hm-strong-down';
}

function statusBadgeClass(status) {
  const s = (status || '').toUpperCase();
  if (['BULLISH','RISK-ON','GROWING','PROFITABLE','ALIGNED','NORMAL','EXTREME GREED','GREED'].includes(s)) return 'badge-bullish';
  if (['BEARISH','DEFENSIVE','DECLINING','SQUEEZE','PASSIVE GAP','EXTREME FEAR','FEAR'].includes(s)) return 'badge-bearish';
  return 'badge-neutral';
}

function formatNum(v, suffix = '%') {
  if (v == null) return 'N/A';
  const sign = v > 0 ? '+' : '';
  return `${sign}${v.toFixed(1)}${suffix}`;
}

// ‚îÄ‚îÄ‚îÄ Panel Visibility ‚îÄ‚îÄ‚îÄ
function applyPanelVisibility() {
  document.querySelectorAll('.monitor-panel').forEach(el => {
    const key = el.dataset.panel;
    if (key) el.style.display = panelState[key] ? '' : 'none';
  });
  // Map section is separate from grid
  const mapSection = document.getElementById('map-section');
  if (mapSection) mapSection.style.display = panelState['map'] ? '' : 'none';
}

function toggleSettings() {
  const overlay = document.getElementById('settings-overlay');
  overlay.classList.toggle('active');
  if (overlay.classList.contains('active')) renderSettingsList();
}

function renderSettingsList() {
  const panelNames = {
    'markets': 'Live Markets', 'crypto': 'Crypto & Digital Assets', 'heatmap': 'Sector Heatmap',
    'commodities': 'Commodities & Futures', 'macro-signals': 'Market Radar', 'economic': 'Economic Data',
    'etf-flows': 'BTC ETF Tracker', 'stablecoins': 'Stablecoins', 'live-news': 'Market Headlines',
    'polymarket': 'Predictions', 'forex': 'Forex & Currencies', 'bonds': 'Fixed Income',
    'centralbanks': 'Central Bank Watch', 'crypto-news': 'Crypto News', 'commodities-news': 'Commodities News',
    'ipo': 'IPOs, Earnings & M&A', 'economic-news': 'Economic News', 'markets-news': 'Markets News', 'map': 'Global Markets Map',
    'live-news-streams': 'Live News Streams', 'webcams': 'Live Webcams'
  };
  const container = document.getElementById('settings-list');
  container.innerHTML = Object.entries(panelNames).map(([key, name]) => `
    <label class="panel-toggle flex items-center gap-3 px-3 py-2 hover:bg-[#1a1a1a] cursor-pointer">
      <input type="checkbox" ${panelState[key] ? 'checked' : ''} onchange="panelState['${key}']=this.checked;savePanelState();applyPanelVisibility()">
      <span class="text-[11px] font-mono text-[#ccc]">${escapeHtml(name)}</span>
    </label>
  `).join('');
}

// ‚ïê‚ïê‚ïê DATA FETCHING ‚ïê‚ïê‚ïê

// Helper: fetch with timeout
async function fetchJSON(url, timeoutMs = 15000) {
  const ctrl = new AbortController();
  const timer = setTimeout(() => ctrl.abort(), timeoutMs);
  try {
    const res = await fetch(url, { signal: ctrl.signal });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  } finally { clearTimeout(timer); }
}

// Helper: fetch Yahoo Finance and unwrap chart envelope
async function fetchYahoo(symbol) {
  const raw = await fetchJSON(`${API}/api/yahoo-finance?symbol=${encodeURIComponent(symbol)}`);
  const result = raw?.chart?.result?.[0];
  if (!result?.meta) return null;
  const meta = result.meta;
  const price = meta.regularMarketPrice;
  const prevClose = meta.chartPreviousClose || meta.previousClose || price;
  const changePercent = prevClose ? ((price - prevClose) / prevClose) * 100 : 0;
  const closes = result.indicators?.quote?.[0]?.close;
  const sparklineData = closes ? closes.filter(v => v != null) : [];
  return {
    price,
    regularMarketPrice: price,
    changePercent,
    regularMarketChangePercent: changePercent,
    sparkline: sparklineData,
    high: meta.regularMarketDayHigh,
    low: meta.regularMarketDayLow,
    volume: meta.regularMarketVolume,
    name: meta.longName || meta.shortName || symbol,
    symbol: meta.symbol || symbol,
  };
}

// Helper: fetch RSS feeds and parse XML
async function fetchRSS(feeds) {
  const results = [];
  const promises = feeds.map(async feed => {
    try {
      const url = `${API}${feed.url}`;
      const ctrl = new AbortController();
      const timer = setTimeout(() => ctrl.abort(), 20000);
      const res = await fetch(url, { signal: ctrl.signal });
      clearTimeout(timer);
      if (!res.ok) return;
      const text = await res.text();
      // Try JSON first (some proxies return parsed JSON)
      try {
        const json = JSON.parse(text);
        if (json && json.items) {
          json.items.slice(0, 6).forEach(item => {
            results.push({ source: feed.name, title: item.title || '', link: item.link || '#', pubDate: item.pubDate || item.isoDate || '' });
          });
          return;
        }
      } catch(e) { /* Not JSON, parse as XML */ }
      // Parse XML RSS/Atom
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/xml');
      // RSS format
      let items = doc.querySelectorAll('item');
      if (items.length === 0) items = doc.querySelectorAll('entry'); // Atom format
      items.forEach((item, i) => {
        if (i >= 6) return;
        const title = item.querySelector('title')?.textContent || '';
        const link = item.querySelector('link')?.textContent || item.querySelector('link')?.getAttribute('href') || '#';
        const pubDate = item.querySelector('pubDate')?.textContent || item.querySelector('published')?.textContent || item.querySelector('updated')?.textContent || '';
        if (title) results.push({ source: feed.name, title, link, pubDate });
      });
    } catch(e) { /* skip failed feed */ }
  });
  await Promise.allSettled(promises);
  results.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
  return results.slice(0, 30);
}

// ‚îÄ‚îÄ‚îÄ RSS Feed Definitions ‚îÄ‚îÄ‚îÄ
const FEEDS = {
  markets: [
    { name: 'CNBC', url: '/api/rss-proxy?url=' + encodeURIComponent('https://www.cnbc.com/id/100003114/device/rss/rss.html') },
    { name: 'MarketWatch', url: '/api/rss-proxy?url=' + encodeURIComponent('https://news.google.com/rss/search?q=site:marketwatch.com+markets+when:1d&hl=en-US&gl=US&ceid=US:en') },
    { name: 'Yahoo Finance', url: '/api/rss-proxy?url=' + encodeURIComponent('https://finance.yahoo.com/rss/topstories') },
    { name: 'Seeking Alpha', url: '/api/rss-proxy?url=' + encodeURIComponent('https://seekingalpha.com/market_currents.xml') },
    { name: 'Reuters', url: '/api/rss-proxy?url=' + encodeURIComponent('https://news.google.com/rss/search?q=site:reuters.com+markets+stocks+when:1d&hl=en-US&gl=US&ceid=US:en') },
    { name: 'Bloomberg', url: '/api/rss-proxy?url=' + encodeURIComponent('https://news.google.com/rss/search?q=site:bloomberg.com+markets+when:1d&hl=en-US&gl=US&ceid=US:en') },
  ],
  forex: [
    { name: 'Forex News', url: '/api/rss-proxy?url=' + encodeURIComponent('https://news.google.com/rss/search?q=("forex"+OR+"currency"+OR+"FX+market")+trading+when:1d&hl=en-US&gl=US&ceid=US:en') },
    { name: 'Dollar Watch', url: '/api/rss-proxy?url=' + encodeURIComponent('https://news.google.com/rss/search?q=("dollar+index"+OR+DXY+OR+"US+dollar"+OR+"euro+dollar")+when:2d&hl=en-US&gl=US&ceid=US:en') },
  ],
  bonds: [
    { name: 'Bond Market', url: '/api/rss-proxy?url=' + encodeURIComponent('https://news.google.com/rss/search?q=("bond+market"+OR+"treasury+yields"+OR+"bond+yields")+when:2d&hl=en-US&gl=US&ceid=US:en') },
    { name: 'Treasury', url: '/api/rss-proxy?url=' + encodeURIComponent('https://news.google.com/rss/search?q=("US+Treasury"+OR+"Treasury+auction"+OR+"10-year+yield")+when:2d&hl=en-US&gl=US&ceid=US:en') },
  ],
  centralbanks: [
    { name: 'Fed', url: '/api/rss-proxy?url=' + encodeURIComponent('https://www.federalreserve.gov/feeds/press_all.xml') },
    { name: 'ECB Watch', url: '/api/rss-proxy?url=' + encodeURIComponent('https://news.google.com/rss/search?q=("European+Central+Bank"+OR+ECB)+monetary+policy+when:3d&hl=en-US&gl=US&ceid=US:en') },
    { name: 'Global CB', url: '/api/rss-proxy?url=' + encodeURIComponent('https://news.google.com/rss/search?q=("rate+hike"+OR+"rate+cut"+OR+"interest+rate+decision")+central+bank+when:3d&hl=en-US&gl=US&ceid=US:en') },
  ],
  crypto: [
    { name: 'CoinDesk', url: '/api/rss-proxy?url=' + encodeURIComponent('https://www.coindesk.com/arc/outboundfeeds/rss/') },
    { name: 'Cointelegraph', url: '/api/rss-proxy?url=' + encodeURIComponent('https://cointelegraph.com/rss') },
    { name: 'Crypto', url: '/api/rss-proxy?url=' + encodeURIComponent('https://news.google.com/rss/search?q=(bitcoin+OR+ethereum+OR+crypto)+when:1d&hl=en-US&gl=US&ceid=US:en') },
  ],
  commodities: [
    { name: 'Oil & Gas', url: '/api/rss-proxy?url=' + encodeURIComponent('https://news.google.com/rss/search?q=(oil+price+OR+OPEC+OR+"crude+oil"+OR+WTI+OR+Brent)+when:1d&hl=en-US&gl=US&ceid=US:en') },
    { name: 'Gold', url: '/api/rss-proxy?url=' + encodeURIComponent('https://news.google.com/rss/search?q=(gold+price+OR+silver+price+OR+copper+OR+"precious+metals")+when:2d&hl=en-US&gl=US&ceid=US:en') },
  ],
  ipo: [
    { name: 'IPO', url: '/api/rss-proxy?url=' + encodeURIComponent('https://news.google.com/rss/search?q=(IPO+OR+"initial+public+offering"+OR+SPAC)+when:3d&hl=en-US&gl=US&ceid=US:en') },
    { name: 'Earnings', url: '/api/rss-proxy?url=' + encodeURIComponent('https://news.google.com/rss/search?q=("earnings+report"+OR+"quarterly+earnings"+OR+"revenue+beat")+when:2d&hl=en-US&gl=US&ceid=US:en') },
    { name: 'M&A', url: '/api/rss-proxy?url=' + encodeURIComponent('https://news.google.com/rss/search?q=("merger"+OR+"acquisition"+OR+"takeover+bid")+billion+when:3d&hl=en-US&gl=US&ceid=US:en') },
  ],
  economic: [
    { name: 'Economic', url: '/api/rss-proxy?url=' + encodeURIComponent('https://news.google.com/rss/search?q=(CPI+OR+inflation+OR+GDP+OR+"jobs+report"+OR+PMI)+when:2d&hl=en-US&gl=US&ceid=US:en') },
    { name: 'Trade', url: '/api/rss-proxy?url=' + encodeURIComponent('https://news.google.com/rss/search?q=(tariff+OR+"trade+war"+OR+"trade+deficit")+when:2d&hl=en-US&gl=US&ceid=US:en') },
  ],
  marketsNews: [
    { name: 'Investing.com', url: '/api/rss-proxy?url=' + encodeURIComponent('https://news.google.com/rss/search?q=site:investing.com+markets+when:1d&hl=en-US&gl=US&ceid=US:en') },
    { name: 'Nikkei', url: '/api/rss-proxy?url=' + encodeURIComponent('https://news.google.com/rss/search?q=site:asia.nikkei.com+markets+when:3d&hl=en-US&gl=US&ceid=US:en') },
  ],
};

// ‚îÄ‚îÄ‚îÄ Render helpers for RSS news panels ‚îÄ‚îÄ‚îÄ
function renderNewsList(items, noDataMsg) {
  if (!items || items.length === 0) return `<div class="text-center text-[#888] text-xs py-4">${noDataMsg || 'No headlines in this time range'}</div>`;
  return items.map(item => `
    <div class="news-item">
      <div class="flex items-center gap-2 mb-1">
        <span class="news-source">${escapeHtml(item.source)}</span>
        <span class="news-time">${timeAgo(item.pubDate)}</span>
      </div>
      <div class="news-title"><a href="${escapeHtml(item.link)}" target="_blank" rel="noopener">${escapeHtml(item.title)}</a></div>
    </div>
  `).join('');
}

// ‚ïê‚ïê‚ïê PANEL RENDERERS ‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ‚îÄ 1. Live Markets ‚îÄ‚îÄ‚îÄ
async function loadMarkets() {
  const el = document.getElementById('markets-body');
  try {
    // Fetch indices
    const indices = [
      { symbol: '^GSPC', name: 'S&P 500', display: 'SPX' },
      { symbol: '^DJI', name: 'Dow Jones', display: 'DOW' },
      { symbol: '^IXIC', name: 'NASDAQ', display: 'NDX' },
      { symbol: '^VIX', name: 'VIX', display: 'VIX' },
    ];
    const stocks = [
      { symbol: 'AAPL', name: 'Apple' }, { symbol: 'MSFT', name: 'Microsoft' },
      { symbol: 'NVDA', name: 'NVIDIA' }, { symbol: 'GOOGL', name: 'Alphabet' },
      { symbol: 'AMZN', name: 'Amazon' }, { symbol: 'META', name: 'Meta' },
      { symbol: 'TSLA', name: 'Tesla' },
    ];

    // Fetch all indices via Yahoo Finance
    const indexResults = await Promise.allSettled(
      indices.map(idx => fetchYahoo(idx.symbol))
    );

    // Fetch stocks via Yahoo Finance
    const stockResults = await Promise.allSettled(
      stocks.map(s => fetchYahoo(s.symbol))
    );

    let html = '';

    // Render indices
    indices.forEach((idx, i) => {
      const res = indexResults[i];
      if (res.status === 'fulfilled' && res.value) {
        const d = res.value;
        const price = d.regularMarketPrice ?? d.price ?? null;
        const change = d.regularMarketChangePercent ?? d.changePercent ?? d.change ?? null;
        const spk = d.sparkline || [];
        html += `<div class="market-row">
          <div class="flex items-center gap-2">
            <span class="text-[11px] font-mono font-bold text-white">${escapeHtml(idx.display)}</span>
            <span class="text-[9px] text-[#888]">${escapeHtml(idx.name)}</span>
          </div>
          <div class="flex items-center gap-2">
            ${sparkline(spk, change)}
            <span class="text-[11px] font-mono text-[#ccc]">${formatPrice(price)}</span>
            <span class="text-[10px] font-mono ${changeClass(change)} min-w-[52px] text-right">${formatChange(change)}</span>
          </div>
        </div>`;
      }
    });

    // Divider
    if (html && stockResults.length) html += '<div class="border-t border-[#2a2a2a] my-1"></div>';

    // Render stocks
    stocks.forEach((s, i) => {
      const res = stockResults[i];
      if (res.status === 'fulfilled' && res.value) {
        const d = res.value;
        const price = d.regularMarketPrice ?? d.price ?? null;
        const change = d.regularMarketChangePercent ?? d.changePercent ?? null;
        const spk = d.sparkline || [];
        html += `<div class="market-row">
          <div class="flex items-center gap-2">
            <span class="text-[11px] font-semibold text-[#e8e8e8]">${escapeHtml(s.symbol)}</span>
          </div>
          <div class="flex items-center gap-2">
            ${sparkline(spk, change)}
            <span class="text-[11px] text-[#ccc]">${formatPrice(price)}</span>
            <span class="text-[10px] ${changeClass(change)} min-w-[52px] text-right">${formatChange(change)}</span>
          </div>
        </div>`;
      }
    });

    el.innerHTML = html || '<div class="text-center text-[#888] text-xs py-4">No market data</div>';
  } catch(e) {
    el.innerHTML = `<div class="text-center text-[#ff4444] opacity-60 text-xs py-4">Failed to load market data</div>`;
  }
}

// ‚îÄ‚îÄ‚îÄ 2. Crypto ‚îÄ‚îÄ‚îÄ
async function loadCrypto() {
  const el = document.getElementById('crypto-body');
  try {
    const data = await fetchJSON(`${API}/api/coingecko?endpoint=markets&ids=bitcoin,ethereum,solana,ripple,dogecoin&vs_currency=usd&sparkline=true`);
    if (!data || !Array.isArray(data) || data.length === 0) throw new Error('No data');
    el.innerHTML = data.map(coin => {
      const spk = coin.sparkline_in_7d?.price || [];
      const change = coin.price_change_percentage_24h;
      return `<div class="market-row">
        <div class="flex items-center gap-2">
          <img src="${escapeHtml(coin.image)}" alt="" width="16" height="16" class="rounded-full" onerror="this.style.display='none'">
          <span class="text-[11px] font-mono font-bold text-white">${escapeHtml(coin.name)}</span>
          <span class="text-[9px] text-[#888] uppercase">${escapeHtml(coin.symbol)}</span>
        </div>
        <div class="flex items-center gap-2">
          ${sparkline(spk.slice(-30), change)}
          <span class="text-[11px] font-mono text-[#ccc]">$${coin.current_price?.toLocaleString() || '--'}</span>
          <span class="text-[10px] font-mono ${changeClass(change)} min-w-[52px] text-right">${formatChange(change)}</span>
        </div>
      </div>`;
    }).join('');
  } catch(e) {
    el.innerHTML = '<div class="text-center text-[#ff4444] opacity-60 text-xs py-4">Failed to load crypto data</div>';
  }
}

// ‚îÄ‚îÄ‚îÄ 3. Sector Heatmap ‚îÄ‚îÄ‚îÄ
async function loadHeatmap() {
  const el = document.getElementById('heatmap-body');
  const sectors = [
    { symbol: 'XLK', name: 'Tech' }, { symbol: 'XLF', name: 'Finance' },
    { symbol: 'XLE', name: 'Energy' }, { symbol: 'XLV', name: 'Health' },
    { symbol: 'XLY', name: 'Cons Disc' }, { symbol: 'XLI', name: 'Industrial' },
    { symbol: 'XLP', name: 'Cons Stpl' }, { symbol: 'XLU', name: 'Utilities' },
    { symbol: 'XLB', name: 'Materials' }, { symbol: 'XLRE', name: 'Real Est' },
    { symbol: 'XLC', name: 'Comms' },
  ];
  try {
    const results = await Promise.allSettled(
      sectors.map(s => fetchYahoo(s.symbol))
    );
    let html = '<div class="heatmap-grid">';
    sectors.forEach((s, i) => {
      const res = results[i];
      let change = null;
      if (res.status === 'fulfilled' && res.value) {
        change = res.value.changePercent ?? null;
      }
      html += `<div class="heatmap-cell ${getHeatmapClass(change)}">
        <div class="text-[9px] font-mono font-semibold text-[#e8e8e8]">${escapeHtml(s.name)}</div>
        <div class="text-[10px] font-mono font-bold ${changeClass(change)}">${formatChange(change)}</div>
        <div class="text-[7px] font-mono text-[#888] mt-0.5">${escapeHtml(s.symbol)}</div>
      </div>`;
    });
    html += '</div>';
    el.innerHTML = html;
  } catch(e) {
    el.innerHTML = '<div class="text-center text-[#ff4444] opacity-60 text-xs py-4">Failed to load sector data</div>';
  }
}

// ‚îÄ‚îÄ‚îÄ 4. Commodities ‚îÄ‚îÄ‚îÄ
async function loadCommodities() {
  const el = document.getElementById('commodities-body');
  const items = [
    { symbol: 'GC=F', name: 'Gold', display: 'GOLD' },
    { symbol: 'CL=F', name: 'Crude Oil', display: 'WTI' },
    { symbol: 'NG=F', name: 'Natural Gas', display: 'NATGAS' },
    { symbol: 'SI=F', name: 'Silver', display: 'SILVER' },
    { symbol: 'HG=F', name: 'Copper', display: 'COPPER' },
  ];
  try {
    const results = await Promise.allSettled(
      items.map(c => fetchYahoo(c.symbol))
    );
    let html = '';
    items.forEach((c, i) => {
      const res = results[i];
      if (res.status === 'fulfilled' && res.value) {
        const d = res.value;
        const price = d.price ?? null;
        const change = d.changePercent ?? null;
        const spk = d.sparkline || [];
        html += `<div class="market-row">
          <div class="flex items-center gap-2">
            <span class="text-[11px] font-bold text-[#ffaa00]">${escapeHtml(c.display)}</span>
            <span class="text-[9px] text-[#888]">${escapeHtml(c.name)}</span>
          </div>
          <div class="flex items-center gap-2">
            ${sparkline(spk, change, 60, 18)}
            <span class="text-[11px] font-mono text-[#ccc]">${formatPrice(price)}</span>
            <span class="text-[10px] font-mono ${changeClass(change)} min-w-[52px] text-right">${formatChange(change)}</span>
          </div>
        </div>`;
      }
    });
    el.innerHTML = html || '<div class="text-center text-[#888] text-xs py-4">No commodity data</div>';
  } catch(e) {
    el.innerHTML = '<div class="text-center text-[#ff4444] opacity-60 text-xs py-4">Failed to load commodities</div>';
  }
}

// ‚îÄ‚îÄ‚îÄ 5. Market Radar (Macro Signals) ‚îÄ‚îÄ‚îÄ
async function loadRadar() {
  const el = document.getElementById('radar-body');
  try {
    const data = await fetchJSON(`${API}/api/macro-signals`);
    if (!data || data.unavailable) throw new Error('Unavailable');
    const s = data.signals;
    const verdictClass = data.verdict === 'BUY' ? 'verdict-buy' : data.verdict === 'CASH' ? 'verdict-cash' : 'bg-[#1a1a1a] border border-[#2a2a2a]';

    function signalCard(name, status, value, detail, link) {
      const bc = statusBadgeClass(status);
      return `<div class="signal-card">
        <div class="flex items-center justify-between mb-1">
          ${link ? `<a href="${escapeHtml(link)}" target="_blank" rel="noopener" class="text-[10px] font-mono text-[#ccc] hover:text-[#44ff88] transition-colors">${escapeHtml(name)}</a>` : `<span class="text-[10px] font-mono text-[#ccc]">${escapeHtml(name)}</span>`}
          <span class="signal-badge ${bc}">${escapeHtml(status)}</span>
        </div>
        ${value ? `<div class="text-[11px] font-mono text-[#ccc]">${value}</div>` : ''}
        ${detail ? `<div class="text-[8px] font-mono text-[#888] mt-0.5">${escapeHtml(detail)}</div>` : ''}
      </div>`;
    }

    let html = `
      <div class="${verdictClass} rounded-sm p-3 mb-3 text-center">
        <div class="text-[8px] font-mono text-[#888] uppercase tracking-widest mb-1">Overall Verdict</div>
        <div class="text-xl font-bold ${data.verdict === 'BUY' ? 'text-[#44ff88]' : 'text-[#ff4444]'}">${escapeHtml(data.verdict)}</div>
        <div class="text-[10px] font-mono text-[#888] mt-1">${data.bullishCount}/${data.totalCount} bullish signals</div>
      </div>
      <div class="grid grid-cols-2 gap-2">
        ${signalCard('Liquidity', s.liquidity.status, formatNum(s.liquidity.value), 'JPY 30d ROC', 'https://www.tradingview.com/symbols/JPYUSD/')}
        ${signalCard('Flow', s.flowStructure.status, `BTC ${formatNum(s.flowStructure.btcReturn5)} / QQQ ${formatNum(s.flowStructure.qqqReturn5)}`, '5d returns', null)}
        ${signalCard('Regime', s.macroRegime.status, `QQQ ${formatNum(s.macroRegime.qqqRoc20)} / XLP ${formatNum(s.macroRegime.xlpRoc20)}`, '20d ROC', 'https://www.tradingview.com/symbols/QQQ/')}
        ${signalCard('BTC Trend', s.technicalTrend.status, `$${s.technicalTrend.btcPrice?.toLocaleString() ?? 'N/A'}`, `SMA50: $${s.technicalTrend.sma50?.toLocaleString() ?? '-'} | Mayer: ${s.technicalTrend.mayerMultiple ?? '-'}`, 'https://www.tradingview.com/symbols/BTCUSD/')}
        ${signalCard('Hash Rate', s.hashRate.status, formatNum(s.hashRate.change30d), '30d change', 'https://mempool.space/mining')}
        ${signalCard('Mining', s.miningCost.status, '', 'Hashprice model', null)}
      </div>
      <div class="signal-card mt-2">
        <div class="flex items-center justify-between mb-1">
          <span class="text-[10px] font-mono text-[#ccc]">Fear & Greed</span>
          <span class="signal-badge ${statusBadgeClass(s.fearGreed.status)}">${escapeHtml(s.fearGreed.status)}</span>
        </div>
        <div class="flex items-center gap-3">
          ${donutGauge(s.fearGreed.value)}
          <a href="https://alternative.me/crypto/fear-and-greed-index/" target="_blank" rel="noopener" class="text-[8px] font-mono text-[#888] hover:text-[#ccc]">alternative.me</a>
        </div>
      </div>
    `;
    el.innerHTML = html;
  } catch(e) {
    el.innerHTML = '<div class="text-center text-[#ff4444] opacity-60 text-xs py-4">Market radar unavailable</div>';
  }
}

// ‚îÄ‚îÄ‚îÄ 6. Economic Data (FRED) ‚îÄ‚îÄ‚îÄ
async function loadEconomic() {
  const el = document.getElementById('economic-body');
  const series = [
    { id: 'CPIAUCSL', name: 'CPI (Inflation)', unit: '' },
    { id: 'GDP', name: 'GDP', unit: 'B' },
    { id: 'UNRATE', name: 'Unemployment', unit: '%' },
    { id: 'M2SL', name: 'M2 Money Supply', unit: 'B' },
    { id: 'FEDFUNDS', name: 'Fed Funds Rate', unit: '%' },
    { id: 'T10Y2Y', name: '10Y-2Y Spread', unit: '' },
  ];
  try {
    const results = await Promise.allSettled(
      series.map(s => fetchJSON(`${API}/api/fred-data?series_id=${s.id}`))
    );
    let html = '';
    series.forEach((s, i) => {
      const res = results[i];
      if (res.status === 'fulfilled' && res.value) {
        const d = res.value;
        // FRED returns { observations: [...] } ‚Äî get latest non-"." value
        let val = '--', date = '';
        if (d.observations && Array.isArray(d.observations)) {
          // observations are in reverse chronological order or need sorting
          const obs = d.observations.filter(o => o.value && o.value !== '.');
          if (obs.length > 0) {
            // Sort by date descending to get latest
            obs.sort((a, b) => new Date(b.date) - new Date(a.date));
            val = parseFloat(obs[0].value).toLocaleString(undefined, {maximumFractionDigits: 2});
            date = obs[0].date;
          }
        } else {
          val = d.value ?? d.latestValue ?? '--';
          date = d.date || d.latestDate || '';
        }
        html += `<div class="econ-row">
          <div>
            <div class="text-[10px] font-mono text-[#ccc]">${escapeHtml(s.name)}</div>
            <div class="text-[8px] font-mono text-[#555]">${escapeHtml(s.id)}</div>
          </div>
          <div class="text-[12px] font-mono font-bold text-white">${val}${s.unit}</div>
          <div class="text-[8px] font-mono text-[#888]">${date ? new Date(date).toLocaleDateString() : ''}</div>
        </div>`;
      }
    });
    el.innerHTML = html || '<div class="text-center text-[#888] text-xs py-4">No economic data</div>';
  } catch(e) {
    el.innerHTML = '<div class="text-center text-[#ff4444] opacity-60 text-xs py-4">Failed to load FRED data</div>';
  }
}

// ‚îÄ‚îÄ‚îÄ 7. BTC ETF Tracker ‚îÄ‚îÄ‚îÄ
async function loadETF() {
  const el = document.getElementById('etf-body');
  try {
    const data = await fetchJSON(`${API}/api/etf-flows`);
    if (!data || data.unavailable || !data.etfs?.length) throw new Error('Unavailable');
    const s = data.summary;
    const dirClass = s.netDirection?.includes('INFLOW') ? 'text-[#44ff88]' : s.netDirection?.includes('OUTFLOW') ? 'text-[#ff4444]' : 'text-[#888]';

    let html = `
      <div class="flex items-center justify-between p-2 mb-2 bg-[#1a1a1a] border border-[#2a2a2a]">
        <div class="text-center">
          <div class="text-[8px] font-mono text-[#888] uppercase">Net</div>
          <div class="text-[11px] font-mono font-bold ${dirClass}">${escapeHtml(s.netDirection || '--')}</div>
        </div>
        <div class="text-center">
          <div class="text-[8px] font-mono text-[#888] uppercase">Est. Flow</div>
          <div class="text-[11px] font-mono text-[#ccc]">${formatVolume(Math.abs(s.totalEstFlow || 0))}</div>
        </div>
        <div class="text-center">
          <div class="text-[8px] font-mono text-[#888] uppercase">ETFs</div>
          <div class="text-[11px] font-mono text-[#ccc]">${s.inflowCount || 0}‚Üë ${s.outflowCount || 0}‚Üì</div>
        </div>
      </div>
      <table class="etf-table">
        <thead><tr><th>Ticker</th><th>Issuer</th><th>Flow</th><th>Vol</th><th>Chg</th></tr></thead>
        <tbody>
    `;
    data.etfs.forEach(etf => {
      const fc = etf.direction === 'inflow' ? 'flow-inflow' : etf.direction === 'outflow' ? 'flow-outflow' : 'flow-neutral';
      html += `<tr>
        <td class="text-[#e8e8e8] font-semibold">${escapeHtml(etf.ticker)}</td>
        <td class="text-[#888] text-[9px]">${escapeHtml(etf.issuer)}</td>
        <td class="${fc}">${etf.direction === 'inflow' ? '+' : etf.direction === 'outflow' ? '-' : ''}${formatVolume(Math.abs(etf.estFlow || 0))}</td>
        <td class="text-[#888]">${formatVolume(etf.volume || 0)}</td>
        <td class="${etf.priceChange >= 0 ? 'text-[#44ff88]' : 'text-[#ff4444]'}">${etf.priceChange > 0 ? '+' : ''}${(etf.priceChange||0).toFixed(2)}%</td>
      </tr>`;
    });
    html += '</tbody></table>';
    el.innerHTML = html;
  } catch(e) {
    el.innerHTML = '<div class="text-center text-[#ff4444] opacity-60 text-xs py-4">ETF data unavailable</div>';
  }
}

// ‚îÄ‚îÄ‚îÄ 8. Stablecoins ‚îÄ‚îÄ‚îÄ
async function loadStablecoins() {
  const el = document.getElementById('stablecoins-body');
  try {
    const data = await fetchJSON(`${API}/api/stablecoin-markets`);
    if (!data || data.unavailable || !data.stablecoins?.length) throw new Error('Unavailable');
    const s = data.summary;
    const hc = s.healthStatus === 'HEALTHY' ? 'health-good' : s.healthStatus === 'CAUTION' ? 'health-caution' : 'health-warning';

    let html = `
      <div class="${hc} rounded-sm p-2 mb-2 flex items-center justify-between">
        <span class="text-[10px] font-bold ${s.healthStatus === 'HEALTHY' ? 'text-[#44ff88]' : 'text-[#ffaa00]'}">${escapeHtml(s.healthStatus)}</span>
        <span class="text-[9px] font-mono text-[#888]">MCap: ${formatLargeNum(s.totalMarketCap)} | Vol: ${formatLargeNum(s.totalVolume24h)}</span>
      </div>
    `;
    data.stablecoins.forEach(c => {
      const pc = c.pegStatus === 'ON PEG' ? 'peg-on' : c.pegStatus === 'SLIGHT DEPEG' ? 'peg-slight' : 'peg-off';
      html += `<div class="market-row">
        <div class="flex items-center gap-2">
          <span class="text-[11px] font-mono font-bold text-[#e8e8e8]">${escapeHtml(c.symbol)}</span>
          <span class="text-[9px] text-[#888]">${escapeHtml(c.name)}</span>
        </div>
        <div class="flex items-center gap-3">
          <span class="text-[11px] font-mono text-[#ccc]">$${c.price?.toFixed(4) || '--'}</span>
          <span class="text-[9px] font-mono ${pc}">${escapeHtml(c.pegStatus)}</span>
          <span class="text-[8px] font-mono text-[#888]">${formatLargeNum(c.marketCap)}</span>
        </div>
      </div>`;
    });
    el.innerHTML = html;
  } catch(e) {
    el.innerHTML = '<div class="text-center text-[#ff4444] opacity-60 text-xs py-4">Stablecoin data unavailable</div>';
  }
}

// ‚îÄ‚îÄ‚îÄ 9. Market Headlines (RSS) ‚îÄ‚îÄ‚îÄ
async function loadHeadlines() {
  const el = document.getElementById('headlines-body');
  try {
    const items = await fetchRSS(FEEDS.markets);
    _newsCache['headlines'] = { items, bodyId: 'headlines-body' };
    el.innerHTML = renderNewsList(filterByTimeRange(items));
  } catch(e) {
    el.innerHTML = '<div class="text-center text-[#ff4444] opacity-60 text-xs py-4">Headlines unavailable</div>';
  }
}

// ‚îÄ‚îÄ‚îÄ 10. Predictions (Polymarket) ‚îÄ‚îÄ‚îÄ
async function loadPredictions() {
  const el = document.getElementById('predictions-body');
  try {
    const data = await fetchJSON(`${API}/api/polymarket?closed=false&order=volume&ascending=false&limit=15`);
    if (!data || !Array.isArray(data) || data.length === 0) throw new Error('No data');
    el.innerHTML = data.map(market => {
      const prob = market.outcomePrices ? JSON.parse(market.outcomePrices)[0] : (market.bestBid || 0.5);
      const probPct = (parseFloat(prob) * 100).toFixed(0);
      const vol = market.volume ? formatVolume(parseFloat(market.volume)) : '--';
      return `<div class="prediction-row">
        <div class="text-[11px] text-[#ccc] leading-tight mb-1">${escapeHtml(market.question || market.title || '')}</div>
        <div class="flex items-center gap-2 mb-1">
          <div class="prediction-bar flex-1">
            <div class="prediction-fill" style="width:${probPct}%"></div>
          </div>
          <span class="text-[11px] font-mono font-bold text-white min-w-[36px] text-right">${probPct}%</span>
        </div>
        <div class="text-[8px] font-mono text-[#888]">Vol: ${vol}</div>
      </div>`;
    }).join('');
  } catch(e) {
    el.innerHTML = '<div class="text-center text-[#ff4444] opacity-60 text-xs py-4">Predictions unavailable</div>';
  }
}

// ‚îÄ‚îÄ‚îÄ 11-17. RSS News Panels ‚îÄ‚îÄ‚îÄ
async function loadRSSPanel(feedKey, bodyId) {
  const el = document.getElementById(bodyId);
  if (!el) return;
  try {
    const items = await fetchRSS(FEEDS[feedKey]);
    _newsCache[feedKey] = { items, bodyId };
    el.innerHTML = renderNewsList(filterByTimeRange(items));
  } catch(e) {
    el.innerHTML = '<div class="text-center text-[#ff4444] opacity-60 text-xs py-4">Feed unavailable</div>';
  }
}

// ‚îÄ‚îÄ‚îÄ Market Pulse Ticker ‚îÄ‚îÄ‚îÄ
async function loadTicker() {
  const strip = document.getElementById('ticker-strip');
  const tickerItems = [
    { symbol: '^GSPC', display: 'SPX' }, { symbol: '^DJI', display: 'DOW' },
    { symbol: '^IXIC', display: 'NDX' }, { symbol: '^VIX', display: 'VIX' },
  ];
  const cryptoTicker = [
    { id: 'bitcoin', display: 'BTC' }, { id: 'ethereum', display: 'ETH' },
  ];
  const commodTicker = [
    { symbol: 'GC=F', display: 'GOLD' }, { symbol: 'CL=F', display: 'OIL' },
  ];

  let items = [];

  // Fetch indices
  const idxResults = await Promise.allSettled(
    tickerItems.map(t => fetchYahoo(t.symbol))
  );
  tickerItems.forEach((t, i) => {
    const r = idxResults[i];
    if (r.status === 'fulfilled' && r.value) {
      items.push({ display: t.display, price: r.value.price, change: r.value.changePercent });
    }
  });

  // Fetch crypto
  try {
    const cData = await fetchJSON(`${API}/api/coingecko?endpoint=markets&ids=bitcoin,ethereum&vs_currency=usd`);
    if (Array.isArray(cData)) {
      cData.forEach((c, i) => {
        items.push({ display: cryptoTicker[i]?.display || c.symbol?.toUpperCase(), price: c.current_price, change: c.price_change_percentage_24h });
      });
    }
  } catch(e) {}

  // Fetch commodities
  const comResults = await Promise.allSettled(
    commodTicker.map(c => fetchYahoo(c.symbol))
  );
  commodTicker.forEach((c, i) => {
    const r = comResults[i];
    if (r.status === 'fulfilled' && r.value) {
      items.push({ display: c.display, price: r.value.price, change: r.value.changePercent });
    }
  });

  if (items.length === 0) return;

  function renderTickerItem(item) {
    const cc = item.change != null && item.change >= 0 ? 'text-[#44ff88]' : 'text-[#ff4444]';
    return `<span class="flex items-center gap-2 text-[10px] font-mono">
      <span class="text-[#888]">${escapeHtml(item.display)}</span>
      <span class="text-[#ccc] font-bold">${formatPrice(item.price)}</span>
      <span class="${cc} text-[9px] bg-[#1a1a1a] px-1 py-0.5">${formatChange(item.change)}</span>
    </span><span class="text-[#333]">|</span>`;
  }

  const tickerHTML = items.map(renderTickerItem).join('');
  strip.innerHTML = tickerHTML + tickerHTML; // Duplicate for seamless loop
}

// ‚ïê‚ïê‚ïê MAPLIBRE GLOBE (full-width top section) ‚ïê‚ïê‚ïê
let mapInstance = null;
async function loadGlobe() {
  const container = document.getElementById('globe-container');
  if (!container) return;

  // Load MapLibre CSS & JS dynamically
  if (!window.maplibregl) {
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css';
    document.head.appendChild(link);

    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  if (mapInstance) { mapInstance.remove(); mapInstance = null; }

  mapInstance = new maplibregl.Map({
    container: 'globe-container',
    style: {
      version: 8,
      sources: {
        'carto-dark': {
          type: 'raster',
          tiles: [
            'https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png',
            'https://b.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png',
            'https://c.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png'
          ],
          tileSize: 256,
          attribution: '&copy; CARTO &copy; OSM'
        }
      },
      layers: [{ id: 'carto', type: 'raster', source: 'carto-dark' }],
      glyphs: 'https://cdn.protomaps.com/fonts/pbf/{fontstack}/{range}.pbf'
    },
    center: [10, 30], zoom: 2.2, minZoom: 1, maxZoom: 8,
    attributionControl: false,
  });

  mapInstance.addControl(new maplibregl.NavigationControl({ showCompass: false }), 'top-right');

  mapInstance.on('load', () => {
    // Stock Exchanges
    const exchanges = [
      { name: 'NYSE', lat: 40.7069, lon: -74.0113, tier: 'mega' },
      { name: 'NASDAQ', lat: 40.7568, lon: -73.986, tier: 'mega' },
      { name: 'SSE', lat: 31.2333, lon: 121.4865, tier: 'mega' },
      { name: 'Euronext', lat: 52.3465, lon: 4.879, tier: 'mega' },
      { name: 'JPX', lat: 35.6803, lon: 139.7717, tier: 'mega' },
      { name: 'HKEX', lat: 22.2832, lon: 114.1569, tier: 'major' },
      { name: 'LSE', lat: 51.5155, lon: -0.0922, tier: 'major' },
      { name: 'NSE', lat: 19.0557, lon: 72.8525, tier: 'major' },
      { name: 'TSX', lat: 43.6489, lon: -79.3818, tier: 'major' },
      { name: 'KRX', lat: 37.523, lon: 126.9258, tier: 'major' },
      { name: 'ASX', lat: -33.8672, lon: 151.2067, tier: 'major' },
      { name: 'Xetra', lat: 50.111, lon: 8.6804, tier: 'major' },
      { name: 'B3', lat: -23.5486, lon: -46.6341, tier: 'regional' },
      { name: 'JSE', lat: -26.1088, lon: 28.0318, tier: 'regional' },
      { name: 'SGX', lat: 1.2794, lon: 103.8498, tier: 'regional' },
      { name: 'Tadawul', lat: 24.7103, lon: 46.677, tier: 'regional' },
      { name: 'IDX', lat: -6.2293, lon: 106.813, tier: 'regional' },
      { name: 'BMV', lat: 19.4345, lon: -99.1424, tier: 'regional' },
      { name: 'MOEX', lat: 55.7539, lon: 37.6084, tier: 'regional' },
      { name: 'TASE', lat: 32.0669, lon: 34.7856, tier: 'regional' },
    ];

    const centralBanks = [
      { name: 'Fed', lat: 38.8928, lon: -77.0455 },
      { name: 'ECB', lat: 50.1096, lon: 8.7033 },
      { name: 'BoJ', lat: 35.6867, lon: 139.7635 },
      { name: 'BoE', lat: 51.5142, lon: -0.0882 },
      { name: 'PBoC', lat: 39.9064, lon: 116.4038 },
      { name: 'SNB', lat: 46.9482, lon: 7.4476 },
      { name: 'RBA', lat: -33.8627, lon: 151.2111 },
      { name: 'BoC', lat: 45.423, lon: -75.701 },
      { name: 'RBI', lat: 18.9323, lon: 72.8338 },
      { name: 'SAMA', lat: 24.6938, lon: 46.685 },
      { name: 'BIS', lat: 47.5585, lon: 7.5866 },
    ];

    const financialCenters = [
      { name: 'New York', lat: 40.758, lon: -74.0001 },
      { name: 'London', lat: 51.5128, lon: -0.0908 },
      { name: 'Singapore', lat: 1.2833, lon: 103.85 },
      { name: 'Hong Kong', lat: 22.283, lon: 114.153 },
      { name: 'Tokyo', lat: 35.6762, lon: 139.6503 },
      { name: 'Shanghai', lat: 31.2304, lon: 121.4737 },
      { name: 'Chicago', lat: 41.8825, lon: -87.6328 },
      { name: 'Zurich', lat: 47.3686, lon: 8.5391 },
      { name: 'Dubai', lat: 25.2134, lon: 55.2825 },
      { name: 'Sydney', lat: -33.8688, lon: 151.2093 },
      { name: 'Mumbai', lat: 19.076, lon: 72.8777 },
      { name: 'Toronto', lat: 43.6532, lon: -79.3832 },
    ];

    // ‚îÄ‚îÄ‚îÄ All markers as GeoJSON layers (no DOM markers = no floating/flying) ‚îÄ‚îÄ‚îÄ
    const allPoints = [];
    exchanges.forEach(ex => {
      allPoints.push({ type:'Feature', geometry:{ type:'Point', coordinates:[ex.lon,ex.lat] },
        properties:{ name:ex.name, cat:'exchange', tier:ex.tier, label:ex.name }
      });
    });
    centralBanks.forEach(cb => {
      allPoints.push({ type:'Feature', geometry:{ type:'Point', coordinates:[cb.lon,cb.lat] },
        properties:{ name:cb.name, cat:'bank', label:cb.name }
      });
    });
    financialCenters.forEach(fc => {
      allPoints.push({ type:'Feature', geometry:{ type:'Point', coordinates:[fc.lon,fc.lat] },
        properties:{ name:fc.name, cat:'center', label:fc.name }
      });
    });

    mapInstance.addSource('markers', { type:'geojson', data:{ type:'FeatureCollection', features:allPoints } });

    // Exchange circles (tiered sizes)
    mapInstance.addLayer({ id:'exchanges-mega', type:'circle', source:'markers',
      filter:['all',['==','cat','exchange'],['==','tier','mega']],
      paint:{ 'circle-radius':6, 'circle-color':'#ff4444', 'circle-stroke-width':1, 'circle-stroke-color':'rgba(255,255,255,0.4)' }
    });
    mapInstance.addLayer({ id:'exchanges-major', type:'circle', source:'markers',
      filter:['all',['==','cat','exchange'],['==','tier','major']],
      paint:{ 'circle-radius':4.5, 'circle-color':'#ff8800', 'circle-stroke-width':1, 'circle-stroke-color':'rgba(255,255,255,0.3)' }
    });
    mapInstance.addLayer({ id:'exchanges-regional', type:'circle', source:'markers',
      filter:['all',['==','cat','exchange'],['==','tier','regional']],
      paint:{ 'circle-radius':3, 'circle-color':'#ffaa00', 'circle-stroke-width':1, 'circle-stroke-color':'rgba(255,255,255,0.2)' }
    });
    // Central banks (blue squares via circle)
    mapInstance.addLayer({ id:'banks', type:'circle', source:'markers',
      filter:['==','cat','bank'],
      paint:{ 'circle-radius':4, 'circle-color':'#3b82f6', 'circle-stroke-width':1, 'circle-stroke-color':'rgba(255,255,255,0.3)' }
    });
    // Financial centers (purple dots)
    mapInstance.addLayer({ id:'centers', type:'circle', source:'markers',
      filter:['==','cat','center'],
      paint:{ 'circle-radius':3, 'circle-color':'#a855f7', 'circle-stroke-width':1, 'circle-stroke-color':'rgba(255,255,255,0.2)' }
    });

    // Popup on click for any marker
    const markerLayers = ['exchanges-mega','exchanges-major','exchanges-regional','banks','centers'];
    markerLayers.forEach(layerId => {
      mapInstance.on('click', layerId, (e) => {
        const props = e.features[0].properties;
        const catLabels = { exchange:'Stock Exchange', bank:'Central Bank', center:'Financial Center' };
        new maplibregl.Popup({ closeButton:false, offset:8 })
          .setLngLat(e.lngLat)
          .setHTML(`<div style="font-family:JetBrains Mono,monospace;font-size:11px;color:#fff;background:#141414;padding:4px 8px;border:1px solid #2a2a2a;"><strong>${props.name}</strong><br><span style="color:#888;font-size:9px;">${catLabels[props.cat]||''}</span></div>`)
          .addTo(mapInstance);
      });
      mapInstance.on('mouseenter', layerId, () => { mapInstance.getCanvas().style.cursor = 'pointer'; });
      mapInstance.on('mouseleave', layerId, () => { mapInstance.getCanvas().style.cursor = ''; });
    });

    // ‚îÄ‚îÄ‚îÄ Undersea Cables (GeoJSON lines) ‚îÄ‚îÄ‚îÄ
    const cables = [
      { name:'MAREA', pts:[[-73,39],[-30,42],[-9,37]], cap:'200T' },
      { name:'Grace Hopper', pts:[[-74,40],[-30,44],[-6,53],[-9,37]], cap:'340T' },
      { name:'Havfrue', pts:[[-74,40.5],[-30,55],[5,58],[12,56]], cap:'108T' },
      { name:'FASTER', pts:[[-122,37],[-155,22],[139,35]], cap:'60T' },
      { name:'Southern Cross', pts:[[151,-34],[-175,-40],[-122,34]], cap:'72T' },
      { name:'Curie', pts:[[-122.4,37.8],[-90,10],[-77,-12]], cap:'72T' },
      { name:'SEA-ME-WE 6', pts:[[103.8,1.3],[80,6],[55,24],[43,12],[32.5,30],[12.5,42],[-9,38]], cap:'100T' },
      { name:'FLAG', pts:[[0,51],[-6,36],[32.5,30],[55,24],[73,15],[103.8,1.3],[139.7,35.7]], cap:'10T' },
      { name:'2Africa', pts:[[0,51],[-9,38],[-17,15],[4,6],[18,-34],[55,-20],[55,24],[32.5,30]], cap:'180T' },
      { name:'WACS', pts:[[18,-34],[12,-6],[4,6],[-17,15],[-6,36],[0,51]], cap:'14.5T' },
      { name:'EASSy', pts:[[18,-34],[32,-26],[40,-15],[44,-12],[50,-20],[55,24]], cap:'10T' },
      { name:'SAm-1', pts:[[-43,-23],[-55,-35],[-70,-33],[-77,-12]], cap:'2T' },
      { name:'EllaLink', pts:[[-9,38],[-25,20],[-35,-5]], cap:'72T' },
      { name:'APG', pts:[[139.7,35.7],[121.5,25],[114,22.3],[103.8,1.3]], cap:'54T' },
      { name:'Indigo', pts:[[103.8,1.3],[115,-8],[151,-34]], cap:'36T' },
      { name:'SJC', pts:[[103.8,1.3],[114,22.3],[139.7,35.7],[-122,34]], cap:'28T' },
      { name:'FARICE', pts:[[-22,64],[-7,62],[-6,53]], cap:'5T' },
      { name:'Falcon', pts:[[55,24],[56,25],[51.5,26],[48,29]], cap:'5T' },
    ];
    const cableGeoJSON = { type:'FeatureCollection', features: cables.map(c => ({
      type:'Feature', properties:{ name:c.name, cap:c.cap },
      geometry:{ type:'LineString', coordinates:c.pts }
    }))};
    mapInstance.addSource('cables', { type:'geojson', data:cableGeoJSON });
    mapInstance.addLayer({ id:'cables-line', type:'line', source:'cables',
      paint:{ 'line-color':'#3b82f6', 'line-width':1.5, 'line-opacity':0.5, 'line-dasharray':[4,2] }
    });

    // ‚îÄ‚îÄ‚îÄ Oil & Gas Pipelines ‚îÄ‚îÄ‚îÄ
    const pipelines = [
      { name:'Keystone', pts:[[-104.05,50.95],[-97,41.2],[-95,29.8]], type:'oil' },
      { name:'Colonial', pts:[[-87.5,30.4],[-84.4,33.75],[-77,38.9],[-74,40.7]], type:'oil' },
      { name:'Druzhba', pts:[[68,60],[50,54],[37,52],[24,52],[14,50]], type:'oil' },
      { name:'BTC', pts:[[50,40],[44,41],[36,37]], type:'oil' },
      { name:'East-West', pts:[[50,26],[42,24],[39,24]], type:'oil' },
      { name:'ESPO', pts:[[115,48],[125,44],[131.9,43]], type:'oil' },
      { name:'Trans Mountain', pts:[[-114.1,51],[-121,49.3],[-123,49.3]], type:'oil' },
      { name:'TurkStream', pts:[[41.6,44.6],[31,42],[29,41]], type:'gas' },
      { name:'Yamal-Europe', pts:[[73,61],[60,55],[40,52],[24,52],[14,52]], type:'gas' },
      { name:'TAP', pts:[[20,40],[17,41],[14,42]], type:'gas' },
      { name:'TANAP', pts:[[43,40],[36,39],[29,41]], type:'gas' },
      { name:'Langeled', pts:[[2,61],[1,58],[1,53]], type:'gas' },
      { name:'Dolphin', pts:[[52,25],[54,24],[55,25]], type:'gas' },
      { name:'Power of Siberia', pts:[[115,48],[128,50],[135,48]], type:'gas' },
      { name:'TransMed', pts:[[3,37],[10,37],[10,42]], type:'gas' },
    ];
    const pipeGeoJSON = { type:'FeatureCollection', features: pipelines.map(p => ({
      type:'Feature', properties:{ name:p.name, type:p.type },
      geometry:{ type:'LineString', coordinates:p.pts }
    }))};
    mapInstance.addSource('pipelines', { type:'geojson', data:pipeGeoJSON });
    mapInstance.addLayer({ id:'pipes-oil', type:'line', source:'pipelines',
      filter:['==',['get','type'],'oil'],
      paint:{ 'line-color':'#ff8800', 'line-width':1.5, 'line-opacity':0.4 }
    });
    mapInstance.addLayer({ id:'pipes-gas', type:'line', source:'pipelines',
      filter:['==',['get','type'],'gas'],
      paint:{ 'line-color':'#ffaa00', 'line-width':1.2, 'line-opacity':0.35 }
    });

    // ‚îÄ‚îÄ‚îÄ Strategic Waterways (GeoJSON) ‚îÄ‚îÄ‚îÄ
    const waterways = [
      { name:'TAIWAN STRAIT', lat:24.0, lon:119.5 }, { name:'MALACCA STRAIT', lat:2.5, lon:101.5 },
      { name:'STRAIT OF HORMUZ', lat:26.5, lon:56.5 }, { name:'BOSPHORUS', lat:41.1, lon:29.0 },
      { name:'SUEZ CANAL', lat:30.5, lon:32.3 }, { name:'PANAMA CANAL', lat:9.1, lon:-79.7 },
      { name:'GIBRALTAR', lat:35.9, lon:-5.6 }, { name:'BAB EL-MANDEB', lat:12.5, lon:43.3 },
      { name:'DARDANELLES', lat:40.2, lon:26.4 },
    ];
    mapInstance.addSource('waterways', { type:'geojson', data:{ type:'FeatureCollection',
      features: waterways.map(w => ({ type:'Feature', geometry:{ type:'Point', coordinates:[w.lon,w.lat] }, properties:{ name:w.name } }))
    }});
    mapInstance.addLayer({ id:'waterways-glow', type:'circle', source:'waterways',
      paint:{ 'circle-radius':8, 'circle-color':'rgba(59,130,246,0.15)', 'circle-blur':1 }
    });
    mapInstance.addLayer({ id:'waterways-dot', type:'circle', source:'waterways',
      paint:{ 'circle-radius':5, 'circle-color':'rgba(59,130,246,0.5)', 'circle-stroke-width':2, 'circle-stroke-color':'#3b82f6' }
    });
    mapInstance.on('click', 'waterways-dot', (e) => {
      const props = e.features[0].properties;
      new maplibregl.Popup({ closeButton:false, offset:8 })
        .setLngLat(e.lngLat)
        .setHTML(`<div style="font-family:JetBrains Mono,monospace;font-size:11px;color:#fff;background:#141414;padding:4px 8px;border:1px solid #3b82f6;"><strong>${props.name}</strong><br><span style="color:#3b82f6;font-size:9px;">Strategic Waterway</span></div>`)
        .addTo(mapInstance);
    });
    mapInstance.on('mouseenter', 'waterways-dot', () => { mapInstance.getCanvas().style.cursor = 'pointer'; });
    mapInstance.on('mouseleave', 'waterways-dot', () => { mapInstance.getCanvas().style.cursor = ''; });

    // Cable hover popup
    mapInstance.on('mouseenter', 'cables-line', (e) => {
      mapInstance.getCanvas().style.cursor = 'pointer';
      const props = e.features[0].properties;
      new maplibregl.Popup({ closeButton:false, closeOnClick:true, offset:8 })
        .setLngLat(e.lngLat)
        .setHTML(`<div style="font-family:JetBrains Mono,monospace;font-size:11px;color:#fff;background:#141414;padding:4px 8px;border:1px solid #3b82f6;"><strong>${props.name}</strong><br><span style="color:#3b82f6;font-size:9px;">Undersea Cable ¬∑ ${props.cap}bps</span></div>`)
        .addTo(mapInstance);
    });
    mapInstance.on('mouseleave', 'cables-line', () => { mapInstance.getCanvas().style.cursor = ''; });
  });
}

// ‚ïê‚ïê‚ïê MAP CONTROLS ‚ïê‚ïê‚ïê
// UTC Clock
function updateUTCClock() {
  const el = document.getElementById('utc-clock');
  if (el) el.textContent = new Date().toISOString().slice(11,19) + ' UTC';
}
setInterval(updateUTCClock, 1000);

// Layer toggle
const layerState = { exchanges:true, banks:true, centers:true, cables:true, pipelines:true, waterways:true };
const layerMap = {
  exchanges: ['exchanges-mega','exchanges-major','exchanges-regional'],
  banks: ['banks'],
  centers: ['centers'],
  cables: ['cables-line'],
  pipelines: ['pipes-oil','pipes-gas'],
  waterways: ['waterways-glow','waterways-dot'],
};
function toggleLayer(key) {
  layerState[key] = !layerState[key];
  const vis = layerState[key] ? 'visible' : 'none';
  if (mapInstance) {
    (layerMap[key]||[]).forEach(id => {
      try { mapInstance.setLayoutProperty(id, 'visibility', vis); } catch(e) {}
    });
  }
  // Update button
  const btn = document.querySelector(`.layer-btn[data-layer="${key}"]`);
  if (btn) btn.classList.toggle('active', layerState[key]);
}

// Time range (filters news freshness)
let currentTimeRange = '24h';
const _newsCache = {}; // { panelKey: [items...] }

function getTimeRangeMs(range) {
  switch(range) {
    case '1h': return 3600000;
    case '6h': return 3600000 * 6;
    case '24h': return 86400000;
    case '48h': return 86400000 * 2;
    case '7d': return 86400000 * 7;
    case 'all': return Infinity;
    default: return 86400000;
  }
}

function filterByTimeRange(items) {
  if (currentTimeRange === 'all' || !items) return items;
  const cutoff = Date.now() - getTimeRangeMs(currentTimeRange);
  return items.filter(item => {
    if (!item.pubDate) return true; // keep items with no date
    const d = new Date(item.pubDate).getTime();
    return isNaN(d) || d >= cutoff;
  });
}

function setTimeRange(range) {
  currentTimeRange = range;
  document.querySelectorAll('.time-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.range === range);
  });
  // Re-render all cached news panels with new filter
  Object.keys(_newsCache).forEach(key => {
    const { items, bodyId } = _newsCache[key];
    const el = document.getElementById(bodyId);
    if (el && items) {
      const filtered = filterByTimeRange(items);
      el.innerHTML = renderNewsList(filtered);
    }
  });
}

// ‚ïê‚ïê‚ïê LIVE NEWS STREAMS ‚ïê‚ïê‚ïê
const NEWS_CHANNELS = [
  { id:'bloomberg', name:'Bloomberg', fallback:'iEpJwprxDdk' },
  { id:'sky', name:'SkyNews', fallback:'YDvsBbKfLPA' },
  { id:'cnbc', name:'CNBC', fallback:'9NyxcX3rhQs' },
  { id:'dw', name:'DW News', fallback:'LuKwFajn37U' },
  { id:'france24', name:'France24', fallback:'Ap-UM1O9RBU' },
  { id:'euronews', name:'Euronews', fallback:'pykpO5kQJ98' },
  { id:'aljazeera', name:'AlJazeera', fallback:'gCNeDWCI0vo' },
  { id:'alarabiya', name:'AlArabiya', fallback:'n7eQejkXbnM' },
];
let activeNewsChannel = 'bloomberg';

function initLiveNews() {
  const tabs = document.getElementById('livenews-tabs');
  if (!tabs) return;
  tabs.innerHTML = NEWS_CHANNELS.map(ch => `
    <button onclick="switchNewsChannel('${ch.id}')" id="news-tab-${ch.id}"
      class="text-[9px] px-2 py-1 border transition-colors ${ch.id === activeNewsChannel ? 'border-[#44ff88] text-[#44ff88] bg-[#44ff88]/5' : 'border-[#2a2a2a] text-[#888] hover:text-white hover:border-[#444]'}"
    >${ch.name}</button>
  `).join('');
  switchNewsChannel(activeNewsChannel);
}

function switchNewsChannel(id) {
  activeNewsChannel = id;
  const ch = NEWS_CHANNELS.find(c => c.id === id);
  if (!ch) return;
  const player = document.getElementById('livenews-player');
  if (player) {
    player.innerHTML = `<iframe src="https://www.youtube.com/embed/${ch.fallback}?autoplay=1&mute=1&rel=0" style="width:100%;height:100%;border:0;" allow="autoplay;encrypted-media" allowfullscreen></iframe>`;
  }
  // Update tabs
  document.querySelectorAll('[id^="news-tab-"]').forEach(btn => {
    const isActive = btn.id === `news-tab-${id}`;
    btn.className = `text-[9px] px-2 py-1 border transition-colors ${isActive ? 'border-[#44ff88] text-[#44ff88] bg-[#44ff88]/5' : 'border-[#2a2a2a] text-[#888] hover:text-white hover:border-[#444]'}`;
  });
}

// ‚ïê‚ïê‚ïê LIVE WEBCAMS ‚ïê‚ïê‚ïê
const WEBCAMS = [
  { id:'jerusalem', name:'Jerusalem', fallback:'UyduhBUpO7Q', region:'MIDEAST' },
  { id:'tehran', name:'Tehran', fallback:'-zGuR1qVKrU', region:'MIDEAST' },
  { id:'kyiv', name:'Kyiv', fallback:'-Q7FuPINDjA', region:'EUROPE' },
  { id:'odessa', name:'Odessa', fallback:'e2gC37ILQmk', region:'EUROPE' },
  { id:'london', name:'London', fallback:'Lxqcg1qt0XU', region:'EUROPE' },
  { id:'paris', name:'Paris', fallback:'OzYp4NRZlwQ', region:'EUROPE' },
  { id:'dc', name:'Washington DC', fallback:'1wV9lLe14aU', region:'AMERICAS' },
  { id:'nyc', name:'New York', fallback:'4qyZLflp-sI', region:'AMERICAS' },
  { id:'taipei', name:'Taipei', fallback:'z_fY1pj1VBw', region:'ASIA' },
  { id:'tokyo', name:'Tokyo', fallback:'4pu9sF5Qssw', region:'ASIA' },
  { id:'shanghai', name:'Shanghai', fallback:'76EwqI5XZIc', region:'ASIA' },
  { id:'seoul', name:'Seoul', fallback:'-JhoMGoAfFc', region:'ASIA' },
];
let activeWebcam = 'jerusalem';

function initWebcams() {
  const tabs = document.getElementById('webcams-tabs');
  if (!tabs) return;
  tabs.innerHTML = WEBCAMS.map(w => `
    <button onclick="switchWebcam('${w.id}')" id="cam-tab-${w.id}"
      class="text-[9px] px-2 py-1 border transition-colors ${w.id === activeWebcam ? 'border-[#44ff88] text-[#44ff88] bg-[#44ff88]/5' : 'border-[#2a2a2a] text-[#888] hover:text-white hover:border-[#444]'}"
    >${w.name}</button>
  `).join('');
  switchWebcam(activeWebcam);
}

function switchWebcam(id) {
  activeWebcam = id;
  const w = WEBCAMS.find(c => c.id === id);
  if (!w) return;
  const player = document.getElementById('webcams-player');
  if (player) {
    player.innerHTML = `<iframe src="https://www.youtube.com/embed/${w.fallback}?autoplay=1&mute=1&rel=0" style="width:100%;height:100%;border:0;" allow="autoplay;encrypted-media" allowfullscreen></iframe>`;
  }
  document.querySelectorAll('[id^="cam-tab-"]').forEach(btn => {
    const isActive = btn.id === `cam-tab-${id}`;
    btn.className = `text-[9px] px-2 py-1 border transition-colors ${isActive ? 'border-[#44ff88] text-[#44ff88] bg-[#44ff88]/5' : 'border-[#2a2a2a] text-[#888] hover:text-white hover:border-[#444]'}`;
  });
}

// ‚ïê‚ïê‚ïê ORCHESTRATOR ‚ïê‚ïê‚ïê
function updateTimestamp() {
  const el = document.getElementById('lastUpdate');
  if (el) el.textContent = 'Updated ' + new Date().toLocaleTimeString();
}

async function loadAllPanels() {
  updateTimestamp();
  // Fire all fetches in parallel
  const tasks = [
    loadMarkets(),
    loadCrypto(),
    loadHeatmap(),
    loadCommodities(),
    loadRadar(),
    loadEconomic(),
    loadETF(),
    loadStablecoins(),
    loadHeadlines(),
    loadPredictions(),
    loadRSSPanel('forex', 'forex-body'),
    loadRSSPanel('bonds', 'bonds-body'),
    loadRSSPanel('centralbanks', 'centralbanks-body'),
    loadRSSPanel('crypto', 'cryptonews-body'),
    loadRSSPanel('commodities', 'comnews-body'),
    loadRSSPanel('ipo', 'ipo-body'),
    loadRSSPanel('economic', 'econnews-body'),
    loadRSSPanel('marketsNews', 'marketnews-body'),
  ];
  await Promise.allSettled(tasks);
}

function refreshAll() {
  // Re-skeleton all panels briefly
  document.querySelectorAll('.panel-body').forEach(el => {
    if (!el.id.includes('globe')) {
      el.innerHTML = '<div class="space-y-2"><div class="skeleton h-5 w-full"></div><div class="skeleton h-5 w-4/5"></div><div class="skeleton h-5 w-full"></div></div>';
    }
  });
  loadAllPanels();
}

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', async () => {
  applyPanelVisibility();

  // Dismiss splash
  setTimeout(() => {
    const splash = document.getElementById('splash');
    if (splash) { splash.classList.add('fade-out'); setTimeout(() => splash.remove(), 600); }
  }, 1800);

  // Load ticker first (fast)
  loadTicker();

  // Start UTC clock
  updateUTCClock();

  // Load globe immediately (top section, visible first)
  loadGlobe();

  // Init live news and webcam panels
  initLiveNews();
  initWebcams();

  // Load all panels
  await loadAllPanels();

  // Auto-refresh
  setInterval(() => loadAllPanels(), REFRESH_MS);
  setInterval(() => loadTicker(), TICKER_REFRESH_MS);
});
</script>
</body>
</html>
