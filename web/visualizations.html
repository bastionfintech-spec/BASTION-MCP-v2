<html lang="en" class="bg-[#050505] scroll-smooth antialiased"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BASTION - 3D Intelligence Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=JetBrains+Mono:wght@400;500;700&display=swap');
      body { font-family: 'Inter', sans-serif; }
      .font-mono { font-family: 'JetBrains Mono', monospace; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .tactical-grid {
        background-size: 40px 40px;
        background-image:
          linear-gradient(to right, rgba(220, 38, 38, 0.07) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(220, 38, 38, 0.07) 1px, transparent 1px);
        mask-image: radial-gradient(ellipse at center top, black 40%, transparent 80%);
        -webkit-mask-image: radial-gradient(ellipse at center top, black 40%, transparent 80%);
        pointer-events: none;
        z-index: 1;
      }
      .scanlines {
        background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.3));
        background-size: 100% 3px;
        pointer-events: none;
        z-index: 50;
        opacity: 0.3;
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'crimson': {
                400: '#F87171',
                500: '#EF4444',
                600: '#DC2626',
                700: '#B91C1C',
                900: '#7F1D1D',
                950: '#450A0A'
              },
              'zinc': {
                850: '#1f1f22',
                900: '#18181b',
                950: '#09090b',
              }
            }
          }
        }
      };
    </script>
</head>
<body class="text-zinc-400 min-h-screen flex flex-col selection:bg-crimson-600 selection:text-white bg-[#050505] overflow-x-auto font-sans">
    <!-- CRIMSON ENERGY BEAM -->
    <div class="fixed top-0 left-1/2 -translate-x-1/2 w-[1200px] h-[600px] bg-gradient-to-b from-crimson-600/25 via-crimson-900/10 to-transparent blur-[100px] rounded-full pointer-events-none z-0 mix-blend-screen opacity-80"></div>
    <div class="fixed top-[-100px] left-1/2 -translate-x-1/2 w-[600px] h-[300px] bg-crimson-500/20 blur-[80px] rounded-full pointer-events-none z-0 mix-blend-screen"></div>

    <!-- Tactical Grid Overlay -->
    <div class="fixed inset-0 tactical-grid pointer-events-none z-0"></div>

    <!-- Scanlines Overlay -->
    <div class="fixed inset-0 pointer-events-none z-50 scanlines mix-blend-overlay"></div>

    <main class="flex-1 flex flex-col min-h-screen font-sans z-10 relative">
      <div class="w-full h-full bg-[#0A0A0A] border-t border-zinc-800 relative flex-1 flex flex-col">
        <!-- Scanline overlay -->
        <div class="absolute inset-0 pointer-events-none z-50 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.1)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] bg-[length:100%_2px,3px_100%] bg-repeat opacity-20 mix-blend-overlay"></div>

        <!-- TERMINAL TOP BAR -->
        <div class="bg-zinc-900/90 border-b border-zinc-800 p-2 flex items-center justify-between gap-4 text-[10px] font-mono select-none relative z-20 border-l-2 border-crimson-600">
          <!-- Left -->
          <div class="flex items-center gap-6">
            <a href="/" class="flex items-center gap-2 font-bold text-white tracking-tighter text-sm hover:text-crimson-500 transition-colors">
              <iconify-icon icon="solar:shield-bold" class="text-crimson-600"></iconify-icon>
              BASTION
            </a>
            <div class="flex items-center gap-2 px-3 py-1 bg-green-950/30 border border-green-900/50 rounded text-green-400 shadow-[0_0_15px_rgba(34,197,94,0.25)] animate-[pulse_3s_infinite]">
              <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
              LIVE
            </div>
            <div class="flex items-center gap-2 text-crimson-500 font-bold">
              <iconify-icon icon="solar:graph-new-bold" class="text-lg"></iconify-icon>
              3D INTELLIGENCE LAB
            </div>
          </div>

          <!-- Center - Navigation -->
          <div class="flex items-center gap-1 border border-zinc-800 rounded bg-zinc-900/50">
            <a href="/" class="px-4 py-1.5 text-zinc-400 hover:text-white hover:bg-zinc-800/50 transition-all rounded-l">
              <iconify-icon icon="solar:chart-bold" class="mr-1"></iconify-icon>TERMINAL
            </a>
            <div class="px-4 py-1.5 text-white bg-crimson-600/20 border-l border-r border-crimson-600/50">
              <iconify-icon icon="solar:graph-new-bold" class="mr-1"></iconify-icon>3D VIZ
            </div>
            <a href="/research" class="px-4 py-1.5 text-zinc-400 hover:text-white hover:bg-zinc-800/50 transition-all">
              <iconify-icon icon="solar:document-text-bold" class="mr-1"></iconify-icon>RESEARCH
            </a>
            <a href="/account" class="px-4 py-1.5 text-zinc-400 hover:text-white hover:bg-zinc-800/50 transition-all rounded-r">
              <iconify-icon icon="solar:user-circle-bold" class="mr-1"></iconify-icon>ACCOUNT
            </a>
          </div>

          <!-- Right -->
          <div class="flex items-center gap-6">
            <div class="flex items-center gap-2 text-zinc-400">
              <iconify-icon icon="solar:server-bold" class="text-green-500"></iconify-icon>
              HELSINKI VM
            </div>
            <div class="flex items-center gap-2 text-green-400 font-mono text-[10px] px-2 py-0.5 bg-green-900/30 border border-green-800/50 rounded">
              <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.8)]"></span>
              LIVE
            </div>
            <div id="clock" class="text-zinc-400 font-mono text-[10px]">--:--:-- UTC</div>
          </div>
        </div>

        <!-- CONTROLS BAR -->
        <div class="bg-zinc-900/50 border-b border-zinc-800 p-2 flex items-center gap-6 text-[10px] font-mono relative z-20">
          <div class="flex items-center gap-2">
            <span class="text-zinc-500 uppercase tracking-wider">Symbol</span>
            <select id="symbolSelect" class="bg-zinc-800 border border-zinc-700 text-white px-3 py-1 rounded text-[10px] font-mono focus:border-crimson-600 focus:outline-none">
              <option value="BTC">BTC</option>
              <option value="ETH">ETH</option>
              <option value="SOL">SOL</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-zinc-500 uppercase tracking-wider">Refresh</span>
            <select id="refreshSelect" class="bg-zinc-800 border border-zinc-700 text-white px-3 py-1 rounded text-[10px] font-mono focus:border-crimson-600 focus:outline-none">
              <option value="30">30s</option>
              <option value="60" selected>1m</option>
              <option value="300">5m</option>
              <option value="0">Manual</option>
            </select>
          </div>
          <button onclick="refreshAll()" class="px-4 py-1 bg-crimson-600 hover:bg-crimson-700 text-white rounded font-bold tracking-wider transition-all shadow-[0_0_15px_rgba(220,38,38,0.3)] hover:shadow-[0_0_20px_rgba(220,38,38,0.5)]">
            <iconify-icon icon="solar:refresh-bold" class="mr-1"></iconify-icon>REFRESH ALL
          </button>
          <div class="ml-auto flex items-center gap-4">
            <div class="flex items-center gap-2 px-3 py-1 bg-zinc-800/50 border border-zinc-700 rounded">
              <span class="text-zinc-500">OI:</span>
              <span id="statOI" class="text-white font-bold">$9.4B</span>
            </div>
            <div class="flex items-center gap-2 px-3 py-1 bg-zinc-800/50 border border-zinc-700 rounded">
              <span class="text-zinc-500">24h Liq:</span>
              <span id="statLiq" class="text-crimson-500 font-bold">$145M</span>
            </div>
            <div class="flex items-center gap-2 px-3 py-1 bg-zinc-800/50 border border-zinc-700 rounded">
              <span class="text-zinc-500">Funding:</span>
              <span id="statFunding" class="text-green-500 font-bold">+0.012%</span>
            </div>
          </div>
        </div>

        <!-- VISUALIZATION GRID -->
        <div class="flex-1 p-3 grid grid-cols-3 gap-3 relative z-10 overflow-auto">
          <!-- Row 1 -->
          <!-- Liquidation Topology -->
          <div class="bg-[#0B0B0B] border border-zinc-800 rounded overflow-hidden">
            <div class="p-2 border-b border-zinc-800 flex justify-between items-center text-[10px] font-mono bg-zinc-900/30 border-l-2 border-crimson-600">
              <span class="text-zinc-400 font-bold tracking-wider">LIQUIDATION TOPOLOGY</span>
              <span id="liqBadge" class="text-amber-500 text-[8px]">LOADING</span>
            </div>
            <div id="liqTopology" class="h-[300px]"></div>
          </div>

          <!-- Funding Surface -->
          <div class="bg-[#0B0B0B] border border-zinc-800 rounded overflow-hidden">
            <div class="p-2 border-b border-zinc-800 flex justify-between items-center text-[10px] font-mono bg-zinc-900/30 border-l-2 border-green-600">
              <span class="text-zinc-400 font-bold tracking-wider">FUNDING RATE SURFACE</span>
              <span id="fundBadge" class="text-amber-500 text-[8px]">LOADING</span>
            </div>
            <div id="fundingSurface" class="h-[300px]"></div>
          </div>

          <!-- OI Momentum -->
          <div class="bg-[#0B0B0B] border border-zinc-800 rounded overflow-hidden">
            <div class="p-2 border-b border-zinc-800 flex justify-between items-center text-[10px] font-mono bg-zinc-900/30 border-l-2 border-blue-600">
              <span class="text-zinc-400 font-bold tracking-wider">OI vs PRICE MOMENTUM</span>
              <span id="oiBadge" class="text-amber-500 text-[8px]">LOADING</span>
            </div>
            <div id="oiMomentum" class="h-[300px]"></div>
          </div>

          <!-- Row 2 -->
          <!-- IV Surface -->
          <div class="bg-[#0B0B0B] border border-zinc-800 rounded overflow-hidden">
            <div class="p-2 border-b border-zinc-800 flex justify-between items-center text-[10px] font-mono bg-zinc-900/30 border-l-2 border-purple-600">
              <span class="text-zinc-400 font-bold tracking-wider">IMPLIED VOLATILITY SURFACE</span>
              <span id="volBadge" class="text-amber-500 text-[8px]">LOADING</span>
            </div>
            <div id="volSurface" class="h-[300px]"></div>
          </div>

          <!-- Correlation Matrix -->
          <div class="bg-[#0B0B0B] border border-zinc-800 rounded overflow-hidden">
            <div class="p-2 border-b border-zinc-800 flex justify-between items-center text-[10px] font-mono bg-zinc-900/30 border-l-2 border-amber-600">
              <span class="text-zinc-400 font-bold tracking-wider">ASSET CORRELATION MATRIX</span>
              <span id="corrBadge" class="text-amber-500 text-[8px]">LOADING</span>
            </div>
            <div id="corrMatrix" class="h-[300px]"></div>
          </div>

          <!-- Monte Carlo Preview -->
          <div class="bg-[#0B0B0B] border border-zinc-800 rounded overflow-hidden">
            <div class="p-2 border-b border-zinc-800 flex justify-between items-center text-[10px] font-mono bg-zinc-900/30 border-l-2 border-cyan-600">
              <span class="text-zinc-400 font-bold tracking-wider">MONTE CARLO PREVIEW</span>
              <span id="mcPreviewBadge" class="text-amber-500 text-[8px]">LOADING</span>
            </div>
            <div id="mcPreview" class="h-[300px]"></div>
          </div>

          <!-- Row 3 - Full Width Monte Carlo -->
          <div class="col-span-3 bg-[#0B0B0B] border border-zinc-800 rounded overflow-hidden">
            <div class="p-2 border-b border-zinc-800 flex justify-between items-center text-[10px] font-mono bg-zinc-900/30 border-l-2 border-crimson-600">
              <span class="text-zinc-400 font-bold tracking-wider">
                <iconify-icon icon="solar:chart-bold" class="mr-1 text-crimson-500"></iconify-icon>
                MONTE CARLO EQUITY PROJECTION (100 TRADES)
              </span>
              <div class="flex items-center gap-4">
                <span class="text-zinc-500">Win Rate: <span class="text-green-500">73%</span></span>
                <span class="text-zinc-500">Avg Win: <span class="text-green-500">+2.1R</span></span>
                <span class="text-zinc-500">Avg Loss: <span class="text-crimson-500">-1.0R</span></span>
                <span id="mcBadge" class="text-amber-500 text-[8px]">LOADING</span>
              </div>
            </div>
            <div id="monteCarlo" class="h-[350px]"></div>
          </div>
        </div>

        <!-- FOOTER -->
        <div class="bg-zinc-900/50 border-t border-zinc-800 p-2 flex items-center justify-between text-[9px] font-mono text-zinc-500 relative z-20">
          <div class="flex items-center gap-4">
            <span>BASTION TERMINAL v1.0</span>
            <span class="text-zinc-700">|</span>
            <span>MCF LABS</span>
          </div>
          <div class="flex items-center gap-4">
            <span>Data: Helsinki VM, Coinglass, Whale Alert</span>
            <span class="text-zinc-700">|</span>
            <span id="lastUpdate">Last update: --</span>
          </div>
        </div>
      </div>
    </main>

    <script>
        // BASTION Plotly Theme - matches terminal colors exactly
        const BASTION_LAYOUT = {
            paper_bgcolor: '#0B0B0B',
            plot_bgcolor: '#0B0B0B',
            font: {
                family: 'JetBrains Mono, monospace',
                color: '#71717a',
                size: 9
            },
            margin: { l: 45, r: 20, t: 20, b: 40 },
            scene: {
                xaxis: { gridcolor: '#27272a', zerolinecolor: '#27272a', color: '#71717a', showbackground: false },
                yaxis: { gridcolor: '#27272a', zerolinecolor: '#27272a', color: '#71717a', showbackground: false },
                zaxis: { gridcolor: '#27272a', zerolinecolor: '#27272a', color: '#71717a', showbackground: false },
                bgcolor: '#0B0B0B'
            },
            xaxis: { gridcolor: '#27272a', zerolinecolor: '#27272a', color: '#71717a' },
            yaxis: { gridcolor: '#27272a', zerolinecolor: '#27272a', color: '#71717a' },
            coloraxis: { colorbar: { tickfont: { color: '#71717a', size: 8 } } }
        };

        const CONFIG = {
            displayModeBar: false,
            responsive: true
        };

        let currentSymbol = 'BTC';
        let refreshInterval = null;

        // Clock
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toUTCString().slice(-12, -4) + ' UTC';
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Fetch visualization data
        async function fetchVizData(vizName) {
            try {
                const res = await fetch(`/api/viz-data/${vizName}?symbol=${currentSymbol}`);
                return await res.json();
            } catch (e) {
                console.error(`Error fetching ${vizName}:`, e);
                return { success: false, error: e.message };
            }
        }

        // Render Liquidation Topology
        async function renderLiqTopology() {
            const badge = document.getElementById('liqBadge');
            badge.textContent = 'LOADING';
            badge.className = 'text-amber-500 text-[8px]';
            
            const data = await fetchVizData('liquidation-topology');
            if (!data.success) return;
            
            const trace = {
                ...data.data,
                type: 'scatter3d',
                name: 'Liquidations',
                marker: {
                    ...data.data.marker,
                    colorscale: [[0, '#450A0A'], [0.5, '#DC2626'], [1, '#F87171']]
                }
            };
            
            const layout = {
                ...BASTION_LAYOUT,
                scene: {
                    ...BASTION_LAYOUT.scene,
                    xaxis: { ...BASTION_LAYOUT.scene.xaxis, title: { text: 'Price', font: { size: 8 } } },
                    yaxis: { ...BASTION_LAYOUT.scene.yaxis, title: { text: 'Leverage', font: { size: 8 } } },
                    zaxis: { ...BASTION_LAYOUT.scene.zaxis, title: { text: 'Vol ($M)', font: { size: 8 } } },
                    camera: { eye: { x: 1.5, y: 1.5, z: 1 } }
                }
            };
            
            Plotly.newPlot('liqTopology', [trace], layout, CONFIG);
            badge.textContent = 'LIVE';
            badge.className = 'text-green-500 text-[8px]';
        }

        // Render Funding Surface
        async function renderFundingSurface() {
            const badge = document.getElementById('fundBadge');
            badge.textContent = 'LOADING';
            badge.className = 'text-amber-500 text-[8px]';
            
            const data = await fetchVizData('funding-surface');
            if (!data.success) return;
            
            const trace = {
                ...data.data,
                type: 'surface',
                colorscale: [[0, '#DC2626'], [0.5, '#18181b'], [1, '#22C55E']],
                showscale: false
            };
            
            const layout = {
                ...BASTION_LAYOUT,
                scene: {
                    ...BASTION_LAYOUT.scene,
                    xaxis: { ...BASTION_LAYOUT.scene.xaxis, title: { text: 'Hour', font: { size: 8 } } },
                    yaxis: { ...BASTION_LAYOUT.scene.yaxis, title: { text: 'Exchange', font: { size: 8 } } },
                    zaxis: { ...BASTION_LAYOUT.scene.zaxis, title: { text: 'Rate %', font: { size: 8 } } },
                    camera: { eye: { x: 1.8, y: 1.2, z: 0.8 } }
                }
            };
            
            Plotly.newPlot('fundingSurface', [trace], layout, CONFIG);
            badge.textContent = 'LIVE';
            badge.className = 'text-green-500 text-[8px]';
        }

        // Render OI Momentum
        async function renderOIMomentum() {
            const badge = document.getElementById('oiBadge');
            badge.textContent = 'LOADING';
            badge.className = 'text-amber-500 text-[8px]';
            
            const data = await fetchVizData('oi-momentum');
            if (!data.success) return;
            
            const trace = {
                ...data.data,
                type: 'scatter3d',
                name: 'OI Path',
                marker: {
                    ...data.data.marker,
                    colorscale: [[0, '#DC2626'], [0.5, '#71717a'], [1, '#22C55E']]
                },
                line: { color: '#22C55E', width: 3 }
            };
            
            const layout = {
                ...BASTION_LAYOUT,
                scene: {
                    ...BASTION_LAYOUT.scene,
                    xaxis: { ...BASTION_LAYOUT.scene.xaxis, title: { text: 'Hours', font: { size: 8 } } },
                    yaxis: { ...BASTION_LAYOUT.scene.yaxis, title: { text: 'Price', font: { size: 8 } } },
                    zaxis: { ...BASTION_LAYOUT.scene.zaxis, title: { text: 'OI ($B)', font: { size: 8 } } },
                    camera: { eye: { x: 1.5, y: 1.5, z: 1 } }
                }
            };
            
            Plotly.newPlot('oiMomentum', [trace], layout, CONFIG);
            badge.textContent = 'LIVE';
            badge.className = 'text-green-500 text-[8px]';
        }

        // Render Vol Surface
        async function renderVolSurface() {
            const badge = document.getElementById('volBadge');
            badge.textContent = 'LOADING';
            badge.className = 'text-amber-500 text-[8px]';
            
            const data = await fetchVizData('vol-surface');
            if (!data.success) return;
            
            const trace = {
                ...data.data,
                type: 'surface',
                colorscale: [[0, '#1e1b4b'], [0.5, '#7c3aed'], [1, '#c4b5fd']],
                showscale: false
            };
            
            const layout = {
                ...BASTION_LAYOUT,
                scene: {
                    ...BASTION_LAYOUT.scene,
                    xaxis: { ...BASTION_LAYOUT.scene.xaxis, title: { text: 'Strike %', font: { size: 8 } } },
                    yaxis: { ...BASTION_LAYOUT.scene.yaxis, title: { text: 'Expiry', font: { size: 8 } } },
                    zaxis: { ...BASTION_LAYOUT.scene.zaxis, title: { text: 'IV %', font: { size: 8 } } },
                    camera: { eye: { x: 1.5, y: 1.5, z: 1 } }
                }
            };
            
            Plotly.newPlot('volSurface', [trace], layout, CONFIG);
            badge.textContent = 'LIVE';
            badge.className = 'text-green-500 text-[8px]';
        }

        // Render Correlation Matrix
        async function renderCorrMatrix() {
            const badge = document.getElementById('corrBadge');
            badge.textContent = 'LOADING';
            badge.className = 'text-amber-500 text-[8px]';
            
            const data = await fetchVizData('correlation-matrix');
            if (!data.success) return;
            
            const trace = {
                ...data.data,
                type: 'heatmap',
                colorscale: [[0, '#DC2626'], [0.5, '#18181b'], [1, '#22C55E']],
                showscale: false,
                text: data.data.z.map(row => row.map(val => val.toFixed(2))),
                texttemplate: '%{text}',
                textfont: { size: 8, color: '#fff' },
                hoverongaps: false
            };
            
            const layout = {
                ...BASTION_LAYOUT,
                xaxis: { ...BASTION_LAYOUT.xaxis, tickfont: { size: 8 } },
                yaxis: { ...BASTION_LAYOUT.yaxis, tickfont: { size: 8 }, autorange: 'reversed' }
            };
            
            Plotly.newPlot('corrMatrix', [trace], layout, CONFIG);
            badge.textContent = 'LIVE';
            badge.className = 'text-green-500 text-[8px]';
        }

        // Render Monte Carlo Preview (small version)
        async function renderMCPreview() {
            const badge = document.getElementById('mcPreviewBadge');
            badge.textContent = 'SIMULATING';
            badge.className = 'text-amber-500 text-[8px]';
            
            const data = await fetchVizData('monte-carlo');
            if (!data.success) return;
            
            // Just show percentile cone
            const traces = [
                {
                    x: data.data.x,
                    y: data.data.percentiles.p5,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#DC2626', width: 1 },
                    name: '5th',
                    fill: 'none'
                },
                {
                    x: data.data.x,
                    y: data.data.percentiles.p95,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#22C55E', width: 1 },
                    name: '95th',
                    fill: 'tonexty',
                    fillcolor: 'rgba(34, 197, 94, 0.1)'
                },
                {
                    x: data.data.x,
                    y: data.data.percentiles.p50,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#fff', width: 2 },
                    name: 'Median'
                }
            ];
            
            const layout = {
                ...BASTION_LAYOUT,
                showlegend: false,
                xaxis: { ...BASTION_LAYOUT.xaxis, title: { text: 'Trade #', font: { size: 8 } } },
                yaxis: { ...BASTION_LAYOUT.yaxis, title: { text: 'Value ($)', font: { size: 8 } }, tickformat: '$,.0f' }
            };
            
            Plotly.newPlot('mcPreview', traces, layout, CONFIG);
            badge.textContent = 'COMPLETE';
            badge.className = 'text-green-500 text-[8px]';
        }

        // Render Full Monte Carlo
        async function renderMonteCarlo() {
            const badge = document.getElementById('mcBadge');
            badge.textContent = 'SIMULATING';
            badge.className = 'text-amber-500 text-[8px]';
            
            const data = await fetchVizData('monte-carlo');
            if (!data.success) return;
            
            const traces = [];
            
            // Sample paths (faded)
            data.data.paths.forEach((path, i) => {
                traces.push({
                    x: data.data.x,
                    y: path,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: 'rgba(113, 113, 122, 0.15)', width: 1 },
                    showlegend: false,
                    hoverinfo: 'skip'
                });
            });
            
            // Percentile bands
            traces.push({
                x: data.data.x,
                y: data.data.percentiles.p5,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#DC2626', width: 2 },
                name: '5th %ile (Worst)'
            });
            traces.push({
                x: data.data.x,
                y: data.data.percentiles.p25,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#F59E0B', width: 1, dash: 'dot' },
                name: '25th %ile'
            });
            traces.push({
                x: data.data.x,
                y: data.data.percentiles.p50,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#fff', width: 3 },
                name: 'Median (50th)'
            });
            traces.push({
                x: data.data.x,
                y: data.data.percentiles.p75,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#22C55E', width: 1, dash: 'dot' },
                name: '75th %ile'
            });
            traces.push({
                x: data.data.x,
                y: data.data.percentiles.p95,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#06B6D4', width: 2 },
                name: '95th %ile (Best)'
            });
            
            // Starting capital line
            traces.push({
                x: [0, 100],
                y: [100000, 100000],
                type: 'scatter',
                mode: 'lines',
                line: { color: '#71717a', width: 1, dash: 'dash' },
                name: 'Starting ($100K)'
            });
            
            const layout = {
                ...BASTION_LAYOUT,
                xaxis: { ...BASTION_LAYOUT.xaxis, title: { text: 'Trade Number', font: { size: 9 } } },
                yaxis: { ...BASTION_LAYOUT.yaxis, title: { text: 'Portfolio Value', font: { size: 9 } }, tickformat: '$,.0f' },
                legend: { 
                    x: 0.01, 
                    y: 0.99, 
                    bgcolor: 'rgba(11,11,11,0.8)',
                    bordercolor: '#27272a',
                    borderwidth: 1,
                    font: { size: 8, color: '#71717a' }
                },
                showlegend: true
            };
            
            Plotly.newPlot('monteCarlo', traces, layout, CONFIG);
            badge.textContent = 'COMPLETE';
            badge.className = 'text-green-500 text-[8px]';
        }

        // Refresh all
        async function refreshAll() {
            document.getElementById('lastUpdate').textContent = 'Updating...';
            
            await Promise.all([
                renderLiqTopology(),
                renderFundingSurface(),
                renderOIMomentum(),
                renderVolSurface(),
                renderCorrMatrix(),
                renderMCPreview(),
                renderMonteCarlo()
            ]);
            
            const now = new Date();
            document.getElementById('lastUpdate').textContent = `Last update: ${now.toLocaleTimeString()}`;
        }

        // Setup auto-refresh
        function setupRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            const seconds = parseInt(document.getElementById('refreshSelect').value);
            if (seconds > 0) {
                refreshInterval = setInterval(refreshAll, seconds * 1000);
            }
        }

        // Event listeners
        document.getElementById('symbolSelect').addEventListener('change', (e) => {
            currentSymbol = e.target.value;
            refreshAll();
        });

        document.getElementById('refreshSelect').addEventListener('change', setupRefresh);

        // Update mini stats
        async function updateStats() {
            try {
                const [oi, funding] = await Promise.all([
                    fetch(`/api/oi/${currentSymbol}`).then(r => r.json()),
                    fetch('/api/funding').then(r => r.json())
                ]);
                
                if (oi.oi) {
                    const oiVal = oi.oi.total_oi || 0;
                    document.getElementById('statOI').textContent = oiVal > 1e9 ? `$${(oiVal/1e9).toFixed(1)}B` : `$${(oiVal/1e6).toFixed(0)}M`;
                }
                
                if (funding.rates) {
                    const rate = funding.rates[currentSymbol] || 0;
                    const el = document.getElementById('statFunding');
                    el.textContent = (rate * 100).toFixed(4) + '%';
                    el.className = rate >= 0 ? 'text-green-500 font-bold' : 'text-crimson-500 font-bold';
                }
            } catch (e) {
                console.error('Stats error:', e);
            }
        }
        
        // Initial load
        refreshAll();
        setupRefresh();
        updateStats();
        setInterval(updateStats, 30000);
    </script>
</body>
</html>
