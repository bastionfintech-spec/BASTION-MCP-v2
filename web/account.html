<html lang="en" class="bg-[#050505] scroll-smooth antialiased"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BASTION - Account Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="settings.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=JetBrains+Mono:wght@400;500;700&family=Space+Grotesk:wght@400;500;600;700&display=swap');
      body { font-family: 'Inter', sans-serif; }
      .font-mono { font-family: 'JetBrains Mono', monospace; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .tactical-grid {
        background-size: 40px 40px;
        background-image:
          linear-gradient(to right, rgba(220, 38, 38, 0.07) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(220, 38, 38, 0.07) 1px, transparent 1px);
        mask-image: radial-gradient(ellipse at center top, black 40%, transparent 80%);
        -webkit-mask-image: radial-gradient(ellipse at center top, black 40%, transparent 80%);
        pointer-events: none;
        z-index: 1;
      }
      .scanlines {
        background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.3));
        background-size: 100% 3px;
        pointer-events: none;
        z-index: 50;
        opacity: 0.3;
      }
      .toggle-on { background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%); }
      .toggle-off { background: #27272a; }
      .slider-thumb::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        background: #DC2626;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid #fff;
      }
      .slider-thumb::-moz-range-thumb {
        width: 16px;
        height: 16px;
        background: #DC2626;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid #fff;
      }
      .plan-card:hover { transform: translateY(-2px); }
      .plan-card.active { border-color: #DC2626; box-shadow: 0 0 30px rgba(220, 38, 38, 0.2); }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'crimson': {
                400: '#F87171', 500: '#EF4444', 600: '#DC2626', 700: '#B91C1C', 900: '#7F1D1D', 950: '#450A0A'
              },
              'zinc': {
                850: '#1f1f22', 900: '#18181b', 950: '#09090b',
              }
            }
          }
        }
      };
    </script>
</head>
<body class="text-zinc-400 min-h-screen flex flex-col selection:bg-crimson-600 selection:text-white bg-[#050505] overflow-x-auto font-sans">
    <!-- CRIMSON ENERGY BEAM -->
    <div class="fixed top-0 left-1/2 -translate-x-1/2 w-[1200px] h-[600px] bg-gradient-to-b from-zinc-600/15 via-crimson-900/10 to-transparent blur-[100px] rounded-full pointer-events-none z-0 mix-blend-screen opacity-80"></div>
    <div class="fixed top-[-100px] left-1/2 -translate-x-1/2 w-[600px] h-[300px] bg-zinc-500/10 blur-[80px] rounded-full pointer-events-none z-0 mix-blend-screen"></div>

    <!-- Tactical Grid Overlay -->
    <div class="fixed inset-0 tactical-grid pointer-events-none z-0"></div>

    <!-- Scanlines Overlay -->
    <div class="fixed inset-0 pointer-events-none z-50 scanlines mix-blend-overlay"></div>

    <main class="flex-1 flex flex-col min-h-screen font-sans z-10 relative">
      <div class="w-full h-full bg-[#0A0A0A] border-t border-zinc-800 relative flex-1 flex flex-col">
        <!-- Scanline overlay -->
        <div class="absolute inset-0 pointer-events-none z-50 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.1)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] bg-[length:100%_2px,3px_100%] bg-repeat opacity-20 mix-blend-overlay"></div>

        <!-- TERMINAL TOP BAR -->
        <div class="bg-zinc-900/90 border-b border-zinc-800 p-2 flex items-center justify-between gap-4 text-[10px] font-mono select-none relative z-20 border-l-2 border-zinc-600">
          <!-- Left -->
          <div class="flex items-center gap-6">
            <a href="/" class="flex items-center gap-2 font-bold text-white tracking-tighter text-sm hover:text-crimson-500 transition-colors">
              <iconify-icon icon="solar:shield-bold" class="text-crimson-600"></iconify-icon>
              BASTION
            </a>
            <div class="flex items-center gap-2 px-3 py-1 bg-zinc-800/50 border border-zinc-700/50 rounded text-zinc-400">
              <iconify-icon icon="solar:user-circle-bold" class="text-lg"></iconify-icon>
              ACCOUNT CENTER
            </div>
          </div>

          <!-- Center - Navigation -->
          <div class="flex items-center gap-1 border border-zinc-800 rounded bg-zinc-900/50">
            <a href="/frontend" class="px-4 py-1.5 text-zinc-400 hover:text-white hover:bg-zinc-800/50 transition-all rounded-l">
              <iconify-icon icon="solar:chart-bold" class="mr-1"></iconify-icon>TERMINAL
            </a>
            <a href="/visualizations" class="px-4 py-1.5 text-zinc-400 hover:text-white hover:bg-zinc-800/50 transition-all">
              <iconify-icon icon="solar:graph-new-bold" class="mr-1"></iconify-icon>3D VIZ
            </a>
            <a href="/research" class="px-4 py-1.5 text-zinc-400 hover:text-white hover:bg-zinc-800/50 transition-all">
              <iconify-icon icon="solar:document-text-bold" class="mr-1"></iconify-icon>RESEARCH
            </a>
            <div class="px-4 py-1.5 text-white bg-zinc-700/30 border-l border-r border-zinc-600/50">
              <iconify-icon icon="solar:user-circle-bold" class="mr-1"></iconify-icon>ACCOUNT
            </div>
          </div>

          <!-- Right -->
          <div class="flex items-center gap-4">
            <div class="text-zinc-500" id="current-time">--:--:-- UTC</div>
          </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="flex-1 flex overflow-hidden">
          <!-- SIDEBAR - SETTINGS NAVIGATION -->
          <div class="w-64 bg-[#0B0B0B] border-r border-zinc-800 flex flex-col">
            <div class="p-4 border-b border-zinc-800">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-600 to-green-900 flex items-center justify-center text-white font-bold text-lg" id="user-avatar">
                  T
                </div>
                <div>
                  <div class="text-[12px] text-white font-bold" id="user-display-name">Trader</div>
                  <div class="text-[10px] text-green-400" id="user-tier">BETA ACCESS</div>
                </div>
              </div>
            </div>
            
            <div class="flex-1 overflow-y-auto no-scrollbar p-2">
              <div class="text-[9px] text-zinc-600 uppercase tracking-wider px-2 mb-2">Settings</div>
              
              <button class="sidebar-btn w-full text-left px-3 py-2 rounded text-[11px] bg-crimson-600/20 text-crimson-400 border border-crimson-600/30 mb-1 flex items-center gap-2" data-tab="exchanges">
                <iconify-icon icon="solar:link-circle-bold"></iconify-icon>
                Exchange Connections
              </button>
              
              <button class="sidebar-btn w-full text-left px-3 py-2 rounded text-[11px] text-zinc-400 hover:bg-zinc-800/50 hover:text-white transition-colors mb-1 flex items-center gap-2" data-tab="alerts">
                <iconify-icon icon="solar:bell-bold"></iconify-icon>
                Alert Preferences
              </button>
              
              <button class="sidebar-btn w-full text-left px-3 py-2 rounded text-[11px] text-zinc-400 hover:bg-zinc-800/50 hover:text-white transition-colors mb-1 flex items-center gap-2" data-tab="risk">
                <iconify-icon icon="solar:shield-warning-bold"></iconify-icon>
                Risk Settings
              </button>
              
              <button class="sidebar-btn w-full text-left px-3 py-2 rounded text-[11px] text-zinc-400 hover:bg-zinc-800/50 hover:text-white transition-colors mb-1 flex items-center gap-2" data-tab="appearance">
                <iconify-icon icon="solar:palette-bold"></iconify-icon>
                Appearance
              </button>
              
              <button class="sidebar-btn w-full text-left px-3 py-2 rounded text-[11px] text-zinc-400 hover:bg-zinc-800/50 hover:text-white transition-colors mb-1 flex items-center gap-2" data-tab="subscription">
                <iconify-icon icon="solar:crown-bold"></iconify-icon>
                Subscription
              </button>
              
              <div class="text-[9px] text-zinc-600 uppercase tracking-wider px-2 mb-2 mt-4">Account</div>
              
              <button class="sidebar-btn w-full text-left px-3 py-2 rounded text-[11px] text-zinc-400 hover:bg-zinc-800/50 hover:text-white transition-colors mb-1 flex items-center gap-2" data-tab="profile">
                <iconify-icon icon="solar:user-bold"></iconify-icon>
                Profile
              </button>
              
              <button class="sidebar-btn w-full text-left px-3 py-2 rounded text-[11px] text-zinc-400 hover:bg-zinc-800/50 hover:text-white transition-colors mb-1 flex items-center gap-2" data-tab="security">
                <iconify-icon icon="solar:lock-password-bold"></iconify-icon>
                Security
              </button>
              
              <button class="w-full text-left px-3 py-2 rounded text-[11px] text-crimson-400 hover:bg-crimson-900/30 transition-colors mb-1 flex items-center gap-2 mt-4" onclick="signOut()">
                <iconify-icon icon="solar:logout-2-bold"></iconify-icon>
                Sign Out
              </button>
            </div>
            
            <!-- Storage Usage -->
            <div class="p-3 border-t border-zinc-800">
              <div class="text-[9px] text-zinc-500 uppercase mb-2">API Usage This Month</div>
              <div class="h-1.5 bg-zinc-800 rounded-full overflow-hidden mb-1">
                <div class="h-full bg-gradient-to-r from-crimson-600 to-crimson-400 rounded-full" style="width: 34%"></div>
              </div>
              <div class="text-[9px] text-zinc-500">2,720 / 8,000 calls</div>
            </div>
          </div>

          <!-- MAIN SETTINGS PANEL -->
          <div class="flex-1 overflow-y-auto no-scrollbar p-6 bg-[#090909]">
            
            <!-- ==================== EXCHANGE CONNECTIONS TAB ==================== -->
            <div id="tab-exchanges" class="tab-content">
              <div class="max-w-4xl">
                <div class="mb-6">
                  <h1 class="text-xl text-white font-bold mb-1">Exchange Connections</h1>
                  <p class="text-[11px] text-zinc-500">Connect your exchange API keys to load live positions and enable trading features.</p>
                </div>
                
                <!-- Security Notice -->
                <div class="bg-amber-900/20 border border-amber-800/50 rounded-lg p-4 mb-6">
                  <div class="flex items-start gap-3">
                    <iconify-icon icon="solar:shield-warning-bold" class="text-amber-500 text-xl mt-0.5"></iconify-icon>
                    <div>
                      <div class="text-[12px] text-amber-400 font-bold mb-1">Security Notice</div>
                      <div class="text-[10px] text-amber-200/70 leading-relaxed">
                        Your API keys are encrypted and stored securely. We recommend using <span class="text-white font-bold">read-only</span> keys unless you need to execute trades. 
                        Never share your API secret with anyone. Enable IP whitelisting on your exchange for maximum security.
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Connected Exchanges -->
                <div class="mb-6">
                  <div class="text-[11px] text-zinc-400 uppercase tracking-wider mb-3">Connected Exchanges</div>
                  
                  <div id="connected-exchanges" class="space-y-3">
                    <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-4 text-center">
                      <iconify-icon icon="solar:link-broken-linear" class="text-3xl text-zinc-600 mb-2"></iconify-icon>
                      <div class="text-[11px] text-zinc-500">No exchanges connected yet</div>
                      <div class="text-[10px] text-zinc-600">Add an exchange below to get started</div>
                    </div>
                  </div>
                </div>
                
                <!-- LIVE POSITIONS PANEL -->
                <div class="mb-6" id="positions-panel" style="display: none;">
                  <div class="flex items-center justify-between mb-3">
                    <div class="text-[11px] text-zinc-400 uppercase tracking-wider">Open Positions</div>
                    <button onclick="refreshAllPositions()" class="text-[9px] text-crimson-400 hover:text-crimson-300 flex items-center gap-1">
                      <iconify-icon icon="solar:refresh-linear"></iconify-icon> Refresh
                    </button>
                  </div>
                  
                  <div id="positions-list" class="space-y-2">
                    <!-- Positions will be populated here -->
                  </div>
                  
                  <!-- Positions Summary -->
                  <div id="positions-summary" class="mt-3 bg-zinc-900/30 border border-zinc-800 rounded-lg p-3">
                    <div class="grid grid-cols-4 gap-3 text-center">
                      <div>
                        <div class="text-[9px] text-zinc-500">Total Value</div>
                        <div class="text-[12px] text-white font-mono font-bold" id="total-position-value">--</div>
                      </div>
                      <div>
                        <div class="text-[9px] text-zinc-500">Unrealized PnL</div>
                        <div class="text-[12px] font-mono font-bold" id="total-unrealized-pnl">--</div>
                      </div>
                      <div>
                        <div class="text-[9px] text-zinc-500">Avg Leverage</div>
                        <div class="text-[12px] text-white font-mono font-bold" id="avg-leverage">--</div>
                      </div>
                      <div>
                        <div class="text-[9px] text-zinc-500">Open Trades</div>
                        <div class="text-[12px] text-white font-mono font-bold" id="total-open-trades">0</div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Add New Exchange -->
                <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-5">
                  <div class="text-[13px] text-white font-bold mb-4">Add Exchange Connection</div>
                  
                  <div class="grid grid-cols-3 gap-3 mb-6">
                    <button class="exchange-btn p-4 bg-zinc-900 border-2 border-zinc-800 rounded-lg hover:border-crimson-600/50 hover:bg-zinc-900/80 transition-all text-center group" data-exchange="blofin">
                      <div class="text-2xl mb-2 group-hover:scale-110 transition-transform">ðŸ”µ</div>
                      <div class="text-[11px] text-white font-bold">BloFin</div>
                      <div class="text-[9px] text-zinc-500">Derivatives</div>
                    </button>
                    
                    <button class="exchange-btn p-4 bg-zinc-900 border-2 border-zinc-800 rounded-lg hover:border-crimson-600/50 hover:bg-zinc-900/80 transition-all text-center group" data-exchange="bitunix">
                      <div class="text-2xl mb-2 group-hover:scale-110 transition-transform">ðŸŸ£</div>
                      <div class="text-[11px] text-white font-bold">Bitunix</div>
                      <div class="text-[9px] text-zinc-500">Derivatives</div>
                    </button>
                    
                    <button class="exchange-btn p-4 bg-zinc-900 border-2 border-zinc-800 rounded-lg hover:border-crimson-600/50 hover:bg-zinc-900/80 transition-all text-center group" data-exchange="bybit">
                      <div class="text-2xl mb-2 group-hover:scale-110 transition-transform">ðŸŸ¡</div>
                      <div class="text-[11px] text-white font-bold">Bybit</div>
                      <div class="text-[9px] text-zinc-500">Derivatives & Spot</div>
                    </button>
                    
                    <button class="exchange-btn p-4 bg-zinc-900 border-2 border-zinc-800 rounded-lg hover:border-crimson-600/50 hover:bg-zinc-900/80 transition-all text-center group" data-exchange="okx">
                      <div class="text-2xl mb-2 group-hover:scale-110 transition-transform">âš«</div>
                      <div class="text-[11px] text-white font-bold">OKX</div>
                      <div class="text-[9px] text-zinc-500">Derivatives & Spot</div>
                    </button>
                    
                    <button class="exchange-btn p-4 bg-zinc-900 border-2 border-zinc-800 rounded-lg hover:border-crimson-600/50 hover:bg-zinc-900/80 transition-all text-center group" data-exchange="binance">
                      <div class="text-2xl mb-2 group-hover:scale-110 transition-transform">ðŸŸ </div>
                      <div class="text-[11px] text-white font-bold">Binance</div>
                      <div class="text-[9px] text-zinc-500">Derivatives & Spot</div>
                    </button>
                    
                    <button class="exchange-btn p-4 bg-zinc-900 border-2 border-zinc-800 rounded-lg hover:border-crimson-600/50 hover:bg-zinc-900/80 transition-all text-center group" data-exchange="hyperliquid">
                      <div class="text-2xl mb-2 group-hover:scale-110 transition-transform">ðŸŸ¢</div>
                      <div class="text-[11px] text-white font-bold">Hyperliquid</div>
                      <div class="text-[9px] text-zinc-500">Perpetuals DEX</div>
                    </button>
                  </div>
                  
                  <!-- API Key Form (Hidden by default) -->
                  <div id="api-form" class="hidden border-t border-zinc-800 pt-5 mt-5">
                    <div class="flex items-center gap-2 mb-4">
                      <span id="selected-exchange-icon" class="text-2xl">ðŸ”µ</span>
                      <span id="selected-exchange-name" class="text-[13px] text-white font-bold">BloFin</span>
                    </div>
                    
                    <div class="space-y-4">
                      <div>
                        <label id="api-key-label" class="text-[10px] text-zinc-400 uppercase tracking-wider mb-1 block">API Key</label>
                        <input type="text" id="api-key" placeholder="Enter your API key" class="w-full bg-zinc-900 border border-zinc-700 text-[11px] text-white px-3 py-2.5 focus:border-crimson-600 focus:outline-none placeholder-zinc-600 font-mono rounded">
                      </div>
                      
                      <div id="api-secret-field">
                        <label class="text-[10px] text-zinc-400 uppercase tracking-wider mb-1 block">API Secret</label>
                        <input type="password" id="api-secret" placeholder="Enter your API secret" class="w-full bg-zinc-900 border border-zinc-700 text-[11px] text-white px-3 py-2.5 focus:border-crimson-600 focus:outline-none placeholder-zinc-600 font-mono rounded">
                      </div>
                      
                      <div id="passphrase-field" class="hidden">
                        <label class="text-[10px] text-zinc-400 uppercase tracking-wider mb-1 block">Passphrase (if required)</label>
                        <input type="password" id="api-passphrase" placeholder="Enter passphrase" class="w-full bg-zinc-900 border border-zinc-700 text-[11px] text-white px-3 py-2.5 focus:border-crimson-600 focus:outline-none placeholder-zinc-600 font-mono rounded">
                      </div>
                      
                      <div class="flex items-center gap-2">
                        <input type="checkbox" id="read-only" checked class="w-4 h-4 bg-zinc-900 border-zinc-700 rounded focus:ring-crimson-600 text-crimson-600">
                        <label for="read-only" class="text-[10px] text-zinc-400">Read-only access (recommended for viewing positions)</label>
                      </div>
                      
                      <div class="flex gap-3 pt-2">
                        <button id="connect-btn" class="flex-1 bg-crimson-600 hover:bg-crimson-700 text-white text-[11px] font-bold py-2.5 rounded transition-colors">
                          <iconify-icon icon="solar:link-circle-bold" class="mr-1"></iconify-icon>
                          Connect Exchange
                        </button>
                        <button id="cancel-btn" class="px-4 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-[11px] py-2.5 rounded transition-colors">
                          Cancel
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ==================== ALERTS TAB ==================== -->
            <div id="tab-alerts" class="tab-content hidden">
              <div class="max-w-4xl">
                <div class="mb-6">
                  <h1 class="text-xl text-white font-bold mb-1">Alert Preferences</h1>
                  <p class="text-[11px] text-zinc-500">Configure how and when you receive alerts from BASTION.</p>
                </div>
                
                <div class="space-y-4">
                  <!-- Notification Channels -->
                  <div class="text-[11px] text-zinc-400 uppercase tracking-wider mb-3">Notification Channels</div>
                  
                  <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-4">
                    <div class="flex justify-between items-center">
                      <div>
                        <div class="text-[12px] text-white font-bold">Push Notifications</div>
                        <div class="text-[10px] text-zinc-500">Receive alerts via browser notifications</div>
                      </div>
                      <button class="toggle-btn w-12 h-6 rounded-full p-1 transition-all toggle-on" data-setting="push">
                        <div class="w-4 h-4 bg-white rounded-full ml-auto transition-all"></div>
                      </button>
                    </div>
                  </div>
                  
                  <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-4">
                    <div class="flex justify-between items-center">
                      <div>
                        <div class="text-[12px] text-white font-bold flex items-center gap-2">
                          <iconify-icon icon="logos:telegram" class="text-lg"></iconify-icon>
                          Telegram Alerts Channel
                        </div>
                        <div class="text-[10px] text-zinc-500">Join the BASTION channel for market alerts</div>
                        <div class="text-[9px] text-zinc-600 mt-1">Get alerts: Liquidations â€¢ Whale Moves â€¢ Fear/Greed â€¢ Funding Spikes</div>
                      </div>
                      <a href="https://t.me/BastionAlerts" target="_blank" class="px-3 py-1.5 bg-[#229ED9] hover:bg-[#1a8dc2] text-white text-[10px] rounded transition-colors flex items-center gap-1">
                        <iconify-icon icon="solar:square-share-line-linear"></iconify-icon>
                        Join Channel
                      </a>
                    </div>
                  </div>
                  
                  <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-4">
                    <div class="flex justify-between items-center opacity-50">
                      <div>
                        <div class="text-[12px] text-zinc-400 font-bold flex items-center gap-2">
                          <iconify-icon icon="logos:discord-icon" class="text-lg grayscale"></iconify-icon>
                          Discord Alerts
                          <span class="text-[8px] bg-zinc-700 text-zinc-400 px-1.5 py-0.5 rounded uppercase">Coming Soon</span>
                        </div>
                        <div class="text-[10px] text-zinc-600">Receive alerts in your Discord server</div>
                      </div>
                      <button disabled class="px-3 py-1.5 bg-zinc-700 text-zinc-500 text-[10px] rounded cursor-not-allowed flex items-center gap-1">
                        <iconify-icon icon="solar:link-bold"></iconify-icon>
                        Connect Discord
                      </button>
                    </div>
                  </div>
                  
                  <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-4">
                    <div class="flex justify-between items-center">
                      <div>
                        <div class="text-[12px] text-white font-bold">Sound Alerts</div>
                        <div class="text-[10px] text-zinc-500">Play sound for important alerts</div>
                      </div>
                      <button class="toggle-btn w-12 h-6 rounded-full p-1 transition-all toggle-off" data-setting="sound">
                        <div class="w-4 h-4 bg-zinc-500 rounded-full transition-all"></div>
                      </button>
                    </div>
                  </div>
                  
                  <!-- Alert Types -->
                  <div class="text-[11px] text-zinc-400 uppercase tracking-wider mt-6 mb-3">Alert Types</div>
                  
                  <div class="grid grid-cols-2 gap-3">
                    <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-3 flex items-center gap-3">
                      <input type="checkbox" id="alert-whale" checked class="alert-checkbox w-4 h-4 bg-zinc-900 border-zinc-700 rounded text-crimson-600 focus:ring-crimson-600" onchange="saveAlertTypes()">
                      <div>
                        <div class="text-[11px] text-white">Whale Movements</div>
                        <div class="text-[9px] text-zinc-500">Large transactions > $10M</div>
                      </div>
                    </div>
                    <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-3 flex items-center gap-3">
                      <input type="checkbox" id="alert-price" checked class="alert-checkbox w-4 h-4 bg-zinc-900 border-zinc-700 rounded text-crimson-600 focus:ring-crimson-600" onchange="saveAlertTypes()">
                      <div>
                        <div class="text-[11px] text-white">Price Targets</div>
                        <div class="text-[9px] text-zinc-500">Custom price alerts</div>
                      </div>
                    </div>
                    <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-3 flex items-center gap-3">
                      <input type="checkbox" id="alert-funding" checked class="alert-checkbox w-4 h-4 bg-zinc-900 border-zinc-700 rounded text-crimson-600 focus:ring-crimson-600" onchange="saveAlertTypes()">
                      <div>
                        <div class="text-[11px] text-white">Funding Rate Spikes</div>
                        <div class="text-[9px] text-zinc-500">Extreme funding rates</div>
                      </div>
                    </div>
                    <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-3 flex items-center gap-3">
                      <input type="checkbox" id="alert-liquidation" checked class="alert-checkbox w-4 h-4 bg-zinc-900 border-zinc-700 rounded text-crimson-600 focus:ring-crimson-600" onchange="saveAlertTypes()">
                      <div>
                        <div class="text-[11px] text-white">Liquidation Clusters</div>
                        <div class="text-[9px] text-zinc-500">Large liquidation events</div>
                      </div>
                    </div>
                    <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-3 flex items-center gap-3">
                      <input type="checkbox" id="alert-iros" class="alert-checkbox w-4 h-4 bg-zinc-900 border-zinc-700 rounded text-crimson-600 focus:ring-crimson-600" onchange="saveAlertTypes()">
                      <div>
                        <div class="text-[11px] text-white">IROS AI Signals</div>
                        <div class="text-[9px] text-zinc-500">AI-generated trade signals</div>
                      </div>
                    </div>
                    <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-3 flex items-center gap-3">
                      <input type="checkbox" id="alert-position" class="alert-checkbox w-4 h-4 bg-zinc-900 border-zinc-700 rounded text-crimson-600 focus:ring-crimson-600" onchange="saveAlertTypes()">
                      <div>
                        <div class="text-[11px] text-white">Position Alerts</div>
                        <div class="text-[9px] text-zinc-500">Stop loss / take profit hit</div>
                      </div>
                    </div>
                    <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-3 flex items-center gap-3">
                      <input type="checkbox" id="alert-oi" checked class="alert-checkbox w-4 h-4 bg-zinc-900 border-zinc-700 rounded text-crimson-600 focus:ring-crimson-600" onchange="saveAlertTypes()">
                      <div>
                        <div class="text-[11px] text-white">Open Interest Spikes</div>
                        <div class="text-[9px] text-zinc-500">> 5% OI change in 1 hour</div>
                      </div>
                    </div>
                    <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-3 flex items-center gap-3">
                      <input type="checkbox" id="alert-research" class="alert-checkbox w-4 h-4 bg-zinc-900 border-zinc-700 rounded text-crimson-600 focus:ring-crimson-600" onchange="saveAlertTypes()">
                      <div>
                        <div class="text-[11px] text-white">New Research Reports</div>
                        <div class="text-[9px] text-zinc-500">MCF Labs publications</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Save Button -->
                  <div class="pt-4">
                    <button onclick="saveAlertPreferences()" class="bg-crimson-600 hover:bg-crimson-700 text-white text-[11px] font-bold px-6 py-2.5 rounded transition-colors">
                      Save Alert Preferences
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ==================== RISK SETTINGS TAB ==================== -->
            <div id="tab-risk" class="tab-content hidden">
              <div class="max-w-4xl">
                <div class="mb-6">
                  <h1 class="text-xl text-white font-bold mb-1">Risk Settings</h1>
                  <p class="text-[11px] text-zinc-500">Configure your risk management parameters. IROS will factor these into recommendations.</p>
                </div>
                
                <!-- Risk Overview -->
                <div class="grid grid-cols-3 gap-4 mb-6">
                  <div class="bg-gradient-to-br from-green-900/30 to-green-950/20 border border-green-800/50 rounded-lg p-4">
                    <div class="text-[10px] text-green-400 uppercase tracking-wider mb-1">Risk Score</div>
                    <div class="text-2xl text-white font-bold">MODERATE</div>
                    <div class="text-[10px] text-green-300/70">Balanced approach</div>
                  </div>
                  <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-4">
                    <div class="text-[10px] text-zinc-500 uppercase tracking-wider mb-1">Max Portfolio Risk</div>
                    <div class="text-2xl text-white font-bold">15%</div>
                    <div class="text-[10px] text-zinc-500">of total capital</div>
                  </div>
                  <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-4">
                    <div class="text-[10px] text-zinc-500 uppercase tracking-wider mb-1">Max Single Trade</div>
                    <div class="text-2xl text-white font-bold">5%</div>
                    <div class="text-[10px] text-zinc-500">per position</div>
                  </div>
                </div>
                
                <!-- Position Limits -->
                <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-5 mb-4">
                  <div class="text-[13px] text-white font-bold mb-4">Position Limits</div>
                  
                  <div class="space-y-5">
                    <div>
                      <div class="flex justify-between mb-2">
                        <label class="text-[11px] text-zinc-400">Maximum Leverage</label>
                        <span class="text-[11px] text-white font-mono" id="leverage-value">20x</span>
                      </div>
                      <input type="range" min="1" max="100" value="20" class="w-full h-2 bg-zinc-800 rounded-lg appearance-none cursor-pointer slider-thumb" id="max-leverage">
                      <div class="flex justify-between text-[9px] text-zinc-600 mt-1">
                        <span>1x</span>
                        <span>25x</span>
                        <span>50x</span>
                        <span>100x</span>
                      </div>
                    </div>
                    
                    <div>
                      <div class="flex justify-between mb-2">
                        <label class="text-[11px] text-zinc-400">Max Position Size (% of Portfolio)</label>
                        <span class="text-[11px] text-white font-mono" id="position-size-value">25%</span>
                      </div>
                      <input type="range" min="5" max="100" value="25" class="w-full h-2 bg-zinc-800 rounded-lg appearance-none cursor-pointer slider-thumb" id="max-position">
                      <div class="flex justify-between text-[9px] text-zinc-600 mt-1">
                        <span>5%</span>
                        <span>25%</span>
                        <span>50%</span>
                        <span>100%</span>
                      </div>
                    </div>
                    
                    <div>
                      <div class="flex justify-between mb-2">
                        <label class="text-[11px] text-zinc-400">Max Open Positions</label>
                        <span class="text-[11px] text-white font-mono" id="open-positions-value">5</span>
                      </div>
                      <input type="range" min="1" max="20" value="5" class="w-full h-2 bg-zinc-800 rounded-lg appearance-none cursor-pointer slider-thumb" id="max-open-positions">
                      <div class="flex justify-between text-[9px] text-zinc-600 mt-1">
                        <span>1</span>
                        <span>5</span>
                        <span>10</span>
                        <span>20</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Drawdown Protection -->
                <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-5 mb-4">
                  <div class="text-[13px] text-white font-bold mb-4">Drawdown Protection</div>
                  
                  <div class="space-y-4">
                    <div>
                      <div class="flex justify-between mb-2">
                        <label class="text-[11px] text-zinc-400">Daily Drawdown Limit</label>
                        <span class="text-[11px] text-white font-mono" id="daily-dd-value">5%</span>
                      </div>
                      <input type="range" min="1" max="20" value="5" class="w-full h-2 bg-zinc-800 rounded-lg appearance-none cursor-pointer slider-thumb" id="daily-drawdown">
                    </div>
                    
                    <div>
                      <div class="flex justify-between mb-2">
                        <label class="text-[11px] text-zinc-400">Weekly Drawdown Limit</label>
                        <span class="text-[11px] text-white font-mono" id="weekly-dd-value">10%</span>
                      </div>
                      <input type="range" min="5" max="50" value="10" class="w-full h-2 bg-zinc-800 rounded-lg appearance-none cursor-pointer slider-thumb" id="weekly-drawdown">
                    </div>
                    
                    <div class="flex items-center justify-between pt-2 border-t border-zinc-800">
                      <div>
                        <div class="text-[11px] text-white">Auto-pause trading on limit hit</div>
                        <div class="text-[9px] text-zinc-500">Prevents new positions when drawdown exceeded</div>
                      </div>
                      <button class="toggle-btn w-12 h-6 rounded-full p-1 transition-all toggle-on" data-setting="autopause">
                        <div class="w-4 h-4 bg-white rounded-full ml-auto transition-all"></div>
                      </button>
                    </div>
                  </div>
                </div>
                
                <!-- Risk Presets -->
                <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-5 mb-4">
                  <div class="text-[13px] text-white font-bold mb-4">Risk Presets</div>
                  <div class="grid grid-cols-3 gap-3">
                    <button class="risk-preset p-4 bg-zinc-900 border-2 border-zinc-700 rounded-lg hover:border-green-600/50 transition-all text-center" data-preset="conservative">
                      <iconify-icon icon="solar:shield-check-bold" class="text-2xl text-green-500 mb-2"></iconify-icon>
                      <div class="text-[11px] text-white font-bold">Conservative</div>
                      <div class="text-[9px] text-zinc-500">5x max, 10% size</div>
                    </button>
                    <button class="risk-preset p-4 bg-zinc-900 border-2 border-crimson-600/50 rounded-lg transition-all text-center" data-preset="moderate">
                      <iconify-icon icon="solar:chart-2-bold" class="text-2xl text-amber-500 mb-2"></iconify-icon>
                      <div class="text-[11px] text-white font-bold">Moderate</div>
                      <div class="text-[9px] text-zinc-500">20x max, 25% size</div>
                    </button>
                    <button class="risk-preset p-4 bg-zinc-900 border-2 border-zinc-700 rounded-lg hover:border-crimson-600/50 transition-all text-center" data-preset="aggressive">
                      <iconify-icon icon="solar:fire-bold" class="text-2xl text-crimson-500 mb-2"></iconify-icon>
                      <div class="text-[11px] text-white font-bold">Aggressive</div>
                      <div class="text-[9px] text-zinc-500">50x max, 50% size</div>
                    </button>
                  </div>
                </div>
                
                <!-- Save Button -->
                <div class="flex gap-3">
                  <button class="bg-crimson-600 hover:bg-crimson-700 text-white text-[11px] font-bold px-6 py-2.5 rounded transition-colors" onclick="saveRiskSettings()">
                    Save Risk Settings
                  </button>
                  <button class="bg-zinc-800 hover:bg-zinc-700 text-white text-[11px] px-4 py-2.5 rounded transition-colors">
                    Reset to Defaults
                  </button>
                </div>
              </div>
            </div>
            
            <!-- ==================== APPEARANCE TAB ==================== -->
            <div id="tab-appearance" class="tab-content hidden">
              <div class="max-w-4xl">
                <div class="mb-6">
                  <h1 class="text-xl text-white font-bold mb-1">Appearance</h1>
                  <p class="text-[11px] text-zinc-500">Customize the look and feel of your BASTION terminal.</p>
                </div>
                
                <!-- Theme Selection -->
                <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-5 mb-4">
                  <div class="text-[13px] text-white font-bold mb-4">Background Theme</div>
                  <div class="grid grid-cols-3 gap-3">
                    <button class="theme-btn p-3 bg-[#0a0a0a] border-2 border-crimson-600 rounded-lg text-center transition-all hover:scale-[1.02]" data-theme="crimson">
                      <div class="w-full h-10 rounded mb-2" style="background: radial-gradient(ellipse at top, rgba(220,38,38,0.2) 0%, transparent 60%), #0a0a0a;"></div>
                      <div class="text-[10px] text-white">Crimson Dark</div>
                      <div class="text-[8px] text-crimson-400 active-label">Active</div>
                    </button>
                    <button class="theme-btn p-3 bg-[#050510] border-2 border-zinc-700 rounded-lg text-center transition-all hover:scale-[1.02] hover:border-blue-500/50" data-theme="midnight">
                      <div class="w-full h-10 rounded mb-2" style="background: radial-gradient(ellipse at top, rgba(59,130,246,0.2) 0%, transparent 60%), #050510;"></div>
                      <div class="text-[10px] text-white">Midnight Blue</div>
                    </button>
                    <button class="theme-btn p-3 bg-[#030a03] border-2 border-zinc-700 rounded-lg text-center transition-all hover:scale-[1.02] hover:border-green-500/50" data-theme="matrix">
                      <div class="w-full h-10 rounded mb-2" style="background: radial-gradient(ellipse at top, rgba(34,197,94,0.2) 0%, transparent 60%), #030a03;"></div>
                      <div class="text-[10px] text-white">Matrix</div>
                    </button>
                    <button class="theme-btn p-3 bg-[#0a0a0a] border-2 border-zinc-700 rounded-lg text-center transition-all hover:scale-[1.02] hover:border-zinc-500/50" data-theme="stealth">
                      <div class="w-full h-10 rounded mb-2" style="background: linear-gradient(180deg, #0f0f0f 0%, #0a0a0a 50%, #080808 100%);"></div>
                      <div class="text-[10px] text-white">Stealth</div>
                    </button>
                    <button class="theme-btn p-3 bg-[#000000] border-2 border-zinc-700 rounded-lg text-center transition-all hover:scale-[1.02] hover:border-zinc-500/50" data-theme="abyss">
                      <div class="w-full h-10 rounded mb-2" style="background: radial-gradient(ellipse at center, #0a0a0a 0%, #000000 70%);"></div>
                      <div class="text-[10px] text-white">Abyss</div>
                    </button>
                    <button class="theme-btn p-3 bg-[#0c0c0c] border-2 border-zinc-700 rounded-lg text-center transition-all hover:scale-[1.02] hover:border-green-500/30" data-theme="terminal">
                      <div class="w-full h-10 rounded mb-2" style="background: radial-gradient(ellipse at top, rgba(0,255,0,0.1) 0%, transparent 60%), #0c0c0c;"></div>
                      <div class="text-[10px] text-white">Terminal</div>
                    </button>
                  </div>
                  <div class="text-[9px] text-zinc-600 mt-3">Changes the page background gradient only</div>
                </div>
                
                <!-- Chart Settings -->
                <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-5 mb-4">
                  <div class="text-[13px] text-white font-bold mb-4">Chart Settings</div>
                  
                  <div class="space-y-4">
                    <div>
                      <label class="text-[10px] text-zinc-400 uppercase tracking-wider mb-2 block">Default Chart Type</label>
                      <div class="flex gap-2">
                        <button class="chart-type-btn px-4 py-2 bg-crimson-600/20 border border-crimson-600/50 text-crimson-400 text-[10px] rounded" data-type="candles">Candlestick</button>
                        <button class="chart-type-btn px-4 py-2 bg-zinc-800 border border-zinc-700 text-zinc-400 text-[10px] rounded hover:bg-zinc-700" data-type="line">Line</button>
                        <button class="chart-type-btn px-4 py-2 bg-zinc-800 border border-zinc-700 text-zinc-400 text-[10px] rounded hover:bg-zinc-700" data-type="heikin">Heikin-Ashi</button>
                        <button class="chart-type-btn px-4 py-2 bg-zinc-800 border border-zinc-700 text-zinc-400 text-[10px] rounded hover:bg-zinc-700" data-type="bars">Bars</button>
                      </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label class="text-[10px] text-zinc-400 uppercase tracking-wider mb-2 block">Up Candle Color</label>
                        <div class="flex items-center gap-2">
                          <input type="color" value="#22c55e" class="w-10 h-10 rounded border border-zinc-700 bg-transparent cursor-pointer" id="up-color">
                          <span class="text-[10px] text-zinc-400 font-mono">#22c55e</span>
                        </div>
                      </div>
                      <div>
                        <label class="text-[10px] text-zinc-400 uppercase tracking-wider mb-2 block">Down Candle Color</label>
                        <div class="flex items-center gap-2">
                          <input type="color" value="#ef4444" class="w-10 h-10 rounded border border-zinc-700 bg-transparent cursor-pointer" id="down-color">
                          <span class="text-[10px] text-zinc-400 font-mono">#ef4444</span>
                        </div>
                      </div>
                    </div>
                    
                    <div class="flex items-center justify-between pt-2 border-t border-zinc-800">
                      <div>
                        <div class="text-[11px] text-white">Show Volume Bars</div>
                        <div class="text-[9px] text-zinc-500">Display volume below price chart</div>
                      </div>
                      <button class="toggle-btn w-12 h-6 rounded-full p-1 transition-all toggle-on" data-setting="volume">
                        <div class="w-4 h-4 bg-white rounded-full ml-auto transition-all"></div>
                      </button>
                    </div>
                    
                    <div class="flex items-center justify-between">
                      <div>
                        <div class="text-[11px] text-white">Show Grid Lines</div>
                        <div class="text-[9px] text-zinc-500">Display background grid</div>
                      </div>
                      <button class="toggle-btn w-12 h-6 rounded-full p-1 transition-all toggle-on" data-setting="grid">
                        <div class="w-4 h-4 bg-white rounded-full ml-auto transition-all"></div>
                      </button>
                    </div>
                  </div>
                </div>
                
                <!-- Display Options -->
                <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-5 mb-4">
                  <div class="text-[13px] text-white font-bold mb-4">Display Options</div>
                  
                  <div class="space-y-4">
                    <div class="flex items-center justify-between">
                      <div>
                        <div class="text-[11px] text-white">Compact Mode</div>
                        <div class="text-[9px] text-zinc-500">Reduce padding for more data density</div>
                      </div>
                      <button class="toggle-btn w-12 h-6 rounded-full p-1 transition-all toggle-off" data-setting="compact">
                        <div class="w-4 h-4 bg-zinc-500 rounded-full transition-all"></div>
                      </button>
                    </div>
                    
                    <div class="flex items-center justify-between">
                      <div>
                        <div class="text-[11px] text-white">Scanlines Effect</div>
                        <div class="text-[9px] text-zinc-500">CRT monitor aesthetic overlay</div>
                      </div>
                      <button class="toggle-btn w-12 h-6 rounded-full p-1 transition-all toggle-on" data-setting="scanlines">
                        <div class="w-4 h-4 bg-white rounded-full ml-auto transition-all"></div>
                      </button>
                    </div>
                    
                    <div class="flex items-center justify-between">
                      <div>
                        <div class="text-[11px] text-white">Animations</div>
                        <div class="text-[9px] text-zinc-500">Enable UI animations and transitions</div>
                      </div>
                      <button class="toggle-btn w-12 h-6 rounded-full p-1 transition-all toggle-on" data-setting="animations">
                        <div class="w-4 h-4 bg-white rounded-full ml-auto transition-all"></div>
                      </button>
                    </div>
                    
                    <div>
                      <label class="text-[10px] text-zinc-400 uppercase tracking-wider mb-2 block">Font Size</label>
                      <div class="flex gap-2">
                        <button class="font-size-btn px-4 py-2 bg-zinc-800 border border-zinc-700 text-zinc-400 text-[10px] rounded hover:bg-zinc-700">Small</button>
                        <button class="font-size-btn px-4 py-2 bg-crimson-600/20 border border-crimson-600/50 text-crimson-400 text-[10px] rounded">Medium</button>
                        <button class="font-size-btn px-4 py-2 bg-zinc-800 border border-zinc-700 text-zinc-400 text-[10px] rounded hover:bg-zinc-700">Large</button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Save Button -->
                <button class="bg-crimson-600 hover:bg-crimson-700 text-white text-[11px] font-bold px-6 py-2.5 rounded transition-colors" onclick="saveAppearanceSettings()">
                  Save Appearance Settings
                </button>
              </div>
            </div>
            
            <!-- ==================== SUBSCRIPTION TAB ==================== -->
            <div id="tab-subscription" class="tab-content hidden">
              <div class="max-w-5xl">
                <div class="mb-6">
                  <h1 class="text-xl text-white font-bold mb-1">Subscription</h1>
                  <p class="text-[11px] text-zinc-500">Manage your BASTION subscription and billing.</p>
                </div>
                
                <!-- Current Plan - FREE BETA -->
                <div class="bg-gradient-to-br from-green-900/30 to-green-950/20 border border-green-800/50 rounded-lg p-5 mb-6">
                  <div class="flex justify-between items-start">
                    <div>
                      <div class="flex items-center gap-2 mb-2">
                        <iconify-icon icon="solar:rocket-bold" class="text-2xl text-green-400"></iconify-icon>
                        <span class="text-lg text-white font-bold">BETA ACCESS</span>
                        <span class="text-[9px] bg-green-600 text-white px-2 py-0.5 rounded-full uppercase">Free</span>
                      </div>
                      <div class="text-[11px] text-zinc-400 mb-4">You have full access during the beta period</div>
                      <div class="flex gap-3">
                        <div class="bg-black/30 rounded px-3 py-2">
                          <div class="text-[9px] text-zinc-500 uppercase">API Calls</div>
                          <div class="text-[14px] text-white font-bold">Unlimited</div>
                        </div>
                        <div class="bg-black/30 rounded px-3 py-2">
                          <div class="text-[9px] text-zinc-500 uppercase">IROS Queries</div>
                          <div class="text-[14px] text-white font-bold">Unlimited</div>
                        </div>
                        <div class="bg-black/30 rounded px-3 py-2">
                          <div class="text-[9px] text-zinc-500 uppercase">Exchanges</div>
                          <div class="text-[14px] text-white font-bold">All 8</div>
                        </div>
                      </div>
                    </div>
                    <div class="text-right">
                      <div class="text-3xl text-white font-bold">$0</div>
                      <div class="text-[11px] text-green-400">Free during beta</div>
                    </div>
                  </div>
                </div>
                
                <!-- Beta Notice -->
                <div class="bg-amber-900/20 border border-amber-800/50 rounded-lg p-4 mb-6">
                  <div class="flex items-start gap-3">
                    <iconify-icon icon="solar:info-circle-bold" class="text-xl text-amber-400 flex-shrink-0 mt-0.5"></iconify-icon>
                    <div>
                      <div class="text-[12px] text-white font-bold mb-1">Beta Program</div>
                      <div class="text-[10px] text-zinc-400">
                        You're part of the BASTION beta program. All features are free during this period. 
                        We'll notify you before any pricing changes take effect. Your feedback helps shape the future of BASTION.
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Beta Features -->
                <div class="text-[11px] text-zinc-400 uppercase tracking-wider mb-4">What's Included in Beta</div>
                
                <div class="grid grid-cols-3 gap-4 mb-6">
                  <!-- Feature 1 -->
                  <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-5">
                    <div class="w-10 h-10 rounded-lg bg-green-900/30 flex items-center justify-center mb-3">
                      <iconify-icon icon="solar:chart-bold" class="text-xl text-green-400"></iconify-icon>
                    </div>
                    <div class="text-[12px] text-white font-bold mb-1">Full Trading Terminal</div>
                    <div class="text-[10px] text-zinc-500">Real-time charts, order flow, market structure analysis, and intelligence panels</div>
                  </div>
                  
                  <!-- Feature 2 -->
                  <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-5">
                    <div class="w-10 h-10 rounded-lg bg-purple-900/30 flex items-center justify-center mb-3">
                      <iconify-icon icon="solar:cpu-bold" class="text-xl text-purple-400"></iconify-icon>
                    </div>
                    <div class="text-[12px] text-white font-bold mb-1">IROS AI Assistant</div>
                    <div class="text-[10px] text-zinc-500">AI-powered market analysis and trading insights with unlimited queries</div>
                  </div>
                  
                  <!-- Feature 3 -->
                  <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-5">
                    <div class="w-10 h-10 rounded-lg bg-amber-900/30 flex items-center justify-center mb-3">
                      <iconify-icon icon="solar:link-circle-bold" class="text-xl text-amber-400"></iconify-icon>
                    </div>
                    <div class="text-[12px] text-white font-bold mb-1">All 8 Exchanges</div>
                    <div class="text-[10px] text-zinc-500">Connect BloFin, Bitunix, Bybit, Binance, OKX, Deribit, Hyperliquid, and more</div>
                  </div>
                </div>
                
                <!-- Planned Pricing -->
                <div class="text-[11px] text-zinc-400 uppercase tracking-wider mb-4">Future Pricing (After Beta)</div>
                
                <div class="grid grid-cols-3 gap-4 mb-6">
                  <!-- Free Plan -->
                  <div class="plan-card bg-[#0D0D0D] border-2 border-zinc-800 rounded-lg p-5 transition-all opacity-60">
                    <div class="text-[10px] text-zinc-500 uppercase tracking-wider mb-1">Starter</div>
                    <div class="text-2xl text-white font-bold mb-1">FREE</div>
                    <div class="text-[10px] text-zinc-500 mb-4">Forever</div>
                    
                    <ul class="space-y-2 mb-6">
                      <li class="text-[10px] text-zinc-400 flex items-center gap-2">
                        <iconify-icon icon="solar:check-circle-bold" class="text-green-500"></iconify-icon>
                        Basic market data
                      </li>
                      <li class="text-[10px] text-zinc-400 flex items-center gap-2">
                        <iconify-icon icon="solar:check-circle-bold" class="text-green-500"></iconify-icon>
                        1 Exchange connection
                      </li>
                      <li class="text-[10px] text-zinc-400 flex items-center gap-2">
                        <iconify-icon icon="solar:close-circle-bold" class="text-zinc-600"></iconify-icon>
                        <span class="text-zinc-600">Limited IROS queries</span>
                      </li>
                    </ul>
                    
                    <button class="w-full py-2 bg-zinc-800 text-zinc-500 text-[10px] rounded border border-zinc-700" disabled>
                      Coming soon
                    </button>
                  </div>
                  
                  <!-- Pro Plan -->
                  <div class="plan-card bg-[#0D0D0D] border-2 border-zinc-800 rounded-lg p-5 transition-all opacity-60">
                    <div class="text-[10px] text-crimson-400 uppercase tracking-wider mb-1">Pro</div>
                    <div class="text-2xl text-white font-bold mb-1">$49<span class="text-[14px] text-zinc-500">/mo</span></div>
                    <div class="text-[10px] text-zinc-500 mb-4">Billed monthly</div>
                    
                    <ul class="space-y-2 mb-6">
                      <li class="text-[10px] text-zinc-400 flex items-center gap-2">
                        <iconify-icon icon="solar:check-circle-bold" class="text-green-500"></iconify-icon>
                        Full market data
                      </li>
                      <li class="text-[10px] text-zinc-400 flex items-center gap-2">
                        <iconify-icon icon="solar:check-circle-bold" class="text-green-500"></iconify-icon>
                        6 Exchange connections
                      </li>
                      <li class="text-[10px] text-zinc-400 flex items-center gap-2">
                        <iconify-icon icon="solar:check-circle-bold" class="text-green-500"></iconify-icon>
                        Unlimited IROS queries
                      </li>
                    </ul>
                    
                    <button class="w-full py-2 bg-zinc-800 text-zinc-500 text-[10px] rounded border border-zinc-700" disabled>
                      Coming soon
                    </button>
                  </div>
                  
                  <!-- Enterprise Plan -->
                  <div class="plan-card bg-[#0D0D0D] border-2 border-zinc-800 rounded-lg p-5 transition-all opacity-60">
                    <div class="text-[10px] text-amber-400 uppercase tracking-wider mb-1">Enterprise</div>
                    <div class="text-2xl text-white font-bold mb-1">$199<span class="text-[14px] text-zinc-500">/mo</span></div>
                    <div class="text-[10px] text-zinc-500 mb-4">Billed annually</div>
                    
                    <ul class="space-y-2 mb-6">
                      <li class="text-[10px] text-zinc-400 flex items-center gap-2">
                        <iconify-icon icon="solar:check-circle-bold" class="text-green-500"></iconify-icon>
                        Unlimited API calls
                      </li>
                      <li class="text-[10px] text-zinc-400 flex items-center gap-2">
                        <iconify-icon icon="solar:check-circle-bold" class="text-green-500"></iconify-icon>
                        Unlimited exchanges
                      </li>
                      <li class="text-[10px] text-zinc-400 flex items-center gap-2">
                        <iconify-icon icon="solar:check-circle-bold" class="text-green-500"></iconify-icon>
                        Real-time data streams
                      </li>
                      <li class="text-[10px] text-zinc-400 flex items-center gap-2">
                        <iconify-icon icon="solar:check-circle-bold" class="text-green-500"></iconify-icon>
                        Custom IROS training
                      </li>
                      <li class="text-[10px] text-zinc-400 flex items-center gap-2">
                        <iconify-icon icon="solar:check-circle-bold" class="text-green-500"></iconify-icon>
                        Priority support
                      </li>
                    </ul>
                    
                    <button class="w-full py-2 bg-amber-600 hover:bg-amber-700 text-white text-[10px] font-bold rounded transition-colors">
                      Upgrade to Enterprise
                    </button>
                  </div>
                </div>
                
                <!-- Billing History -->
                <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-5">
                  <div class="flex justify-between items-center mb-4">
                    <div class="text-[13px] text-white font-bold">Billing History</div>
                    <button class="text-[10px] text-crimson-400 hover:text-crimson-300">Download All</button>
                  </div>
                  
                  <div class="space-y-2">
                    <div class="flex justify-between items-center p-3 bg-zinc-900/50 rounded">
                      <div class="flex items-center gap-3">
                        <iconify-icon icon="solar:document-text-bold" class="text-zinc-500"></iconify-icon>
                        <div>
                          <div class="text-[11px] text-white">Pro Plan - February 2026</div>
                          <div class="text-[9px] text-zinc-500">Feb 5, 2026</div>
                        </div>
                      </div>
                      <div class="flex items-center gap-4">
                        <span class="text-[11px] text-white font-mono">$49.00</span>
                        <span class="text-[9px] text-green-400 bg-green-900/30 px-2 py-0.5 rounded">Paid</span>
                        <button class="text-[9px] text-zinc-400 hover:text-white">Invoice</button>
                      </div>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-zinc-900/50 rounded">
                      <div class="flex items-center gap-3">
                        <iconify-icon icon="solar:document-text-bold" class="text-zinc-500"></iconify-icon>
                        <div>
                          <div class="text-[11px] text-white">Pro Plan - January 2026</div>
                          <div class="text-[9px] text-zinc-500">Jan 5, 2026</div>
                        </div>
                      </div>
                      <div class="flex items-center gap-4">
                        <span class="text-[11px] text-white font-mono">$49.00</span>
                        <span class="text-[9px] text-green-400 bg-green-900/30 px-2 py-0.5 rounded">Paid</span>
                        <button class="text-[9px] text-zinc-400 hover:text-white">Invoice</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ==================== PROFILE TAB ==================== -->
            <div id="tab-profile" class="tab-content hidden">
              <div class="max-w-2xl">
                <div class="mb-6">
                  <h1 class="text-xl text-white font-bold mb-1">Profile</h1>
                  <p class="text-[11px] text-zinc-500">Manage your personal information.</p>
                </div>
                
                <!-- Avatar Section -->
                <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-5 mb-4">
                  <div class="text-[13px] text-white font-bold mb-4">Avatar</div>
                  <div class="flex items-center gap-6">
                    <div class="relative group">
                      <div class="w-24 h-24 rounded-full bg-gradient-to-br from-crimson-600 to-crimson-900 flex items-center justify-center text-white font-bold text-3xl overflow-hidden border-2 border-zinc-700" id="profile-avatar">
                        <span id="avatar-letter">T</span>
                        <img id="avatar-img" src="" alt="" class="hidden w-full h-full object-cover">
                      </div>
                      <label class="absolute inset-0 flex items-center justify-center bg-black/60 opacity-0 group-hover:opacity-100 rounded-full cursor-pointer transition-opacity">
                        <iconify-icon icon="solar:camera-bold" class="text-2xl text-white"></iconify-icon>
                        <input type="file" id="avatar-upload" accept="image/*,.gif" class="hidden" onchange="handleAvatarUpload(event)">
                      </label>
                    </div>
                    <div class="flex-1">
                      <div class="flex gap-2 mb-3">
                        <label class="px-4 py-2 bg-crimson-600 hover:bg-crimson-700 text-white text-[10px] rounded transition-colors cursor-pointer flex items-center gap-2">
                          <iconify-icon icon="solar:upload-linear"></iconify-icon>
                          Upload Photo/GIF
                          <input type="file" id="avatar-upload-btn" accept="image/*,.gif" class="hidden" onchange="handleAvatarUpload(event)">
                        </label>
                        <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-white text-[10px] rounded transition-colors" onclick="removeAvatar()">
                          Remove
                        </button>
                      </div>
                      <div class="text-[9px] text-zinc-500">JPG, PNG or animated GIF. Max 2MB.</div>
                      <div class="text-[9px] text-zinc-600 mt-1">Animated GIFs will play in your profile!</div>
                    </div>
                  </div>
                </div>
                
                <!-- Animated Corner GIF (Premium Personalization) -->
                <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-5 mb-4">
                  <div class="flex items-center justify-between mb-4">
                    <div>
                      <div class="text-[13px] text-white font-bold">Corner Animation</div>
                      <div class="text-[9px] text-zinc-500">Add a custom animated GIF to your terminal</div>
                    </div>
                    <span class="text-[8px] bg-purple-600 text-white px-2 py-0.5 rounded uppercase">Personalization</span>
                  </div>
                  
                  <div class="flex items-center gap-4">
                    <div class="w-20 h-20 rounded-lg bg-zinc-900 border border-zinc-700 flex items-center justify-center overflow-hidden" id="corner-gif-preview">
                      <img id="corner-gif-img" src="" alt="" class="hidden w-full h-full object-contain">
                      <div id="corner-gif-placeholder" class="text-center">
                        <iconify-icon icon="solar:gallery-bold" class="text-2xl text-zinc-600"></iconify-icon>
                        <div class="text-[8px] text-zinc-600 mt-1">No GIF</div>
                      </div>
                    </div>
                    <div class="flex-1">
                      <div class="flex gap-2 mb-3">
                        <label class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-[10px] rounded transition-colors cursor-pointer flex items-center gap-2">
                          <iconify-icon icon="solar:upload-linear"></iconify-icon>
                          Upload GIF
                          <input type="file" accept=".gif" class="hidden" onchange="handleCornerGifUpload(event)">
                        </label>
                        <button class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-white text-[10px] rounded transition-colors" onclick="removeCornerGif()">
                          Remove
                        </button>
                      </div>
                      <div class="text-[9px] text-zinc-500">Animated GIF only. Max 1MB. Shows in bottom-right corner.</div>
                      
                      <div class="flex items-center gap-4 mt-3">
                        <div>
                          <label class="text-[9px] text-zinc-500 block mb-1">Position</label>
                          <select id="gif-position" class="bg-zinc-900 border border-zinc-700 text-[10px] text-white px-2 py-1.5 rounded" onchange="saveCornerGifSettings()">
                            <option value="bottom-right">Bottom Right</option>
                            <option value="bottom-left">Bottom Left</option>
                            <option value="top-right">Top Right</option>
                            <option value="top-left">Top Left</option>
                          </select>
                        </div>
                        <div>
                          <label class="text-[9px] text-zinc-500 block mb-1">Size</label>
                          <select id="gif-size" class="bg-zinc-900 border border-zinc-700 text-[10px] text-white px-2 py-1.5 rounded" onchange="saveCornerGifSettings()">
                            <option value="small">Small (50px)</option>
                            <option value="medium" selected>Medium (80px)</option>
                            <option value="large">Large (120px)</option>
                          </select>
                        </div>
                        <div>
                          <label class="text-[9px] text-zinc-500 block mb-1">Opacity</label>
                          <input type="range" id="gif-opacity" min="20" max="100" value="80" class="w-20 h-1" onchange="saveCornerGifSettings()">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Profile Info -->
                <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-5 mb-4">
                  <div class="text-[13px] text-white font-bold mb-4">Basic Information</div>
                  
                  <div class="space-y-4">
                    <div>
                      <label class="text-[10px] text-zinc-400 uppercase tracking-wider mb-1 block">Display Name</label>
                      <input type="text" value="Trader" id="profile-name" class="w-full bg-zinc-900 border border-zinc-700 text-[11px] text-white px-3 py-2.5 focus:border-crimson-600 focus:outline-none rounded">
                    </div>
                    
                    <div>
                      <label class="text-[10px] text-zinc-400 uppercase tracking-wider mb-1 block">Email Address</label>
                      <input type="email" value="trader@example.com" id="profile-email" class="w-full bg-zinc-900 border border-zinc-700 text-[11px] text-white px-3 py-2.5 focus:border-crimson-600 focus:outline-none rounded">
                      <div class="text-[9px] text-green-400 mt-1 flex items-center gap-1">
                        <iconify-icon icon="solar:check-circle-bold"></iconify-icon>
                        Email verified
                      </div>
                    </div>
                    
                    <div>
                      <label class="text-[10px] text-zinc-400 uppercase tracking-wider mb-1 block">Timezone</label>
                      <select class="w-full bg-zinc-900 border border-zinc-700 text-[11px] text-white px-3 py-2.5 focus:border-crimson-600 focus:outline-none rounded">
                        <option value="UTC">UTC (Coordinated Universal Time)</option>
                        <option value="EST">EST (Eastern Standard Time)</option>
                        <option value="PST">PST (Pacific Standard Time)</option>
                        <option value="GMT">GMT (Greenwich Mean Time)</option>
                        <option value="CET">CET (Central European Time)</option>
                        <option value="JST">JST (Japan Standard Time)</option>
                      </select>
                    </div>
                    
                    <div>
                      <label class="text-[10px] text-zinc-400 uppercase tracking-wider mb-1 block">Preferred Currency</label>
                      <select class="w-full bg-zinc-900 border border-zinc-700 text-[11px] text-white px-3 py-2.5 focus:border-crimson-600 focus:outline-none rounded">
                        <option value="USD">USD ($)</option>
                        <option value="EUR">EUR (â‚¬)</option>
                        <option value="GBP">GBP (Â£)</option>
                        <option value="BTC">BTC (â‚¿)</option>
                      </select>
                    </div>
                  </div>
                </div>
                
                <!-- Trading Profile -->
                <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-5 mb-4">
                  <div class="text-[13px] text-white font-bold mb-4">Trading Profile</div>
                  
                  <div class="space-y-4">
                    <div>
                      <label class="text-[10px] text-zinc-400 uppercase tracking-wider mb-2 block">Trading Experience</label>
                      <div class="flex gap-2">
                        <button class="exp-btn px-4 py-2 bg-zinc-800 border border-zinc-700 text-zinc-400 text-[10px] rounded hover:bg-zinc-700">Beginner</button>
                        <button class="exp-btn px-4 py-2 bg-crimson-600/20 border border-crimson-600/50 text-crimson-400 text-[10px] rounded">Intermediate</button>
                        <button class="exp-btn px-4 py-2 bg-zinc-800 border border-zinc-700 text-zinc-400 text-[10px] rounded hover:bg-zinc-700">Advanced</button>
                        <button class="exp-btn px-4 py-2 bg-zinc-800 border border-zinc-700 text-zinc-400 text-[10px] rounded hover:bg-zinc-700">Professional</button>
                      </div>
                    </div>
                    
                    <div>
                      <label class="text-[10px] text-zinc-400 uppercase tracking-wider mb-2 block">Primary Trading Style</label>
                      <div class="grid grid-cols-2 gap-2">
                        <button class="style-btn px-4 py-2 bg-crimson-600/20 border border-crimson-600/50 text-crimson-400 text-[10px] rounded text-left flex items-center gap-2">
                          <iconify-icon icon="solar:bolt-bold"></iconify-icon>
                          Scalping
                        </button>
                        <button class="style-btn px-4 py-2 bg-zinc-800 border border-zinc-700 text-zinc-400 text-[10px] rounded hover:bg-zinc-700 text-left flex items-center gap-2">
                          <iconify-icon icon="solar:clock-circle-bold"></iconify-icon>
                          Day Trading
                        </button>
                        <button class="style-btn px-4 py-2 bg-zinc-800 border border-zinc-700 text-zinc-400 text-[10px] rounded hover:bg-zinc-700 text-left flex items-center gap-2">
                          <iconify-icon icon="solar:calendar-bold"></iconify-icon>
                          Swing Trading
                        </button>
                        <button class="style-btn px-4 py-2 bg-zinc-800 border border-zinc-700 text-zinc-400 text-[10px] rounded hover:bg-zinc-700 text-left flex items-center gap-2">
                          <iconify-icon icon="solar:hourglass-bold"></iconify-icon>
                          Position Trading
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Save Button -->
                <button class="bg-crimson-600 hover:bg-crimson-700 text-white text-[11px] font-bold px-6 py-2.5 rounded transition-colors" onclick="saveProfile()">
                  Save Profile
                </button>
              </div>
            </div>
            
            <!-- ==================== SECURITY TAB ==================== -->
            <div id="tab-security" class="tab-content hidden">
              <div class="max-w-2xl">
                <div class="mb-6">
                  <h1 class="text-xl text-white font-bold mb-1">Security</h1>
                  <p class="text-[11px] text-zinc-500">Understand how BASTION protects your data.</p>
                </div>
                
                <!-- Security Notice -->
                <div class="bg-green-900/20 border border-green-800/50 rounded-lg p-5 mb-6">
                  <div class="flex items-start gap-3">
                    <iconify-icon icon="solar:shield-check-bold" class="text-2xl text-green-400 flex-shrink-0"></iconify-icon>
                    <div>
                      <div class="text-[13px] text-white font-bold mb-2">Your Data is Protected</div>
                      <div class="text-[10px] text-zinc-400 space-y-2">
                        <p>BASTION uses industry-standard security practices to keep your information safe:</p>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Security Features -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                  <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-4">
                    <div class="flex items-center gap-2 mb-2">
                      <iconify-icon icon="solar:lock-keyhole-bold" class="text-green-500"></iconify-icon>
                      <span class="text-[12px] text-white font-bold">API Key Encryption</span>
                    </div>
                    <p class="text-[10px] text-zinc-500">Your exchange API keys are stored locally in your browser. They never leave your device.</p>
                  </div>
                  
                  <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-4">
                    <div class="flex items-center gap-2 mb-2">
                      <iconify-icon icon="solar:eye-closed-bold" class="text-green-500"></iconify-icon>
                      <span class="text-[12px] text-white font-bold">Read-Only by Default</span>
                    </div>
                    <p class="text-[10px] text-zinc-500">Exchange connections default to read-only mode. BASTION can view but not execute trades without permission.</p>
                  </div>
                  
                  <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-4">
                    <div class="flex items-center gap-2 mb-2">
                      <iconify-icon icon="solar:shield-network-bold" class="text-green-500"></iconify-icon>
                      <span class="text-[12px] text-white font-bold">Rate Limiting</span>
                    </div>
                    <p class="text-[10px] text-zinc-500">API requests are rate-limited to prevent abuse and protect against DDoS attacks.</p>
                  </div>
                  
                  <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-4">
                    <div class="flex items-center gap-2 mb-2">
                      <iconify-icon icon="solar:server-square-bold" class="text-green-500"></iconify-icon>
                      <span class="text-[12px] text-white font-bold">Secure Infrastructure</span>
                    </div>
                    <p class="text-[10px] text-zinc-500">Hosted on Railway with automatic SSL/TLS encryption for all connections.</p>
                  </div>
                </div>
                
                <!-- Two-Factor Authentication -->
                <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-5 mb-4">
                  <div class="flex justify-between items-start mb-4">
                    <div>
                      <div class="text-[13px] text-white font-bold mb-1">Two-Factor Authentication (2FA)</div>
                      <div class="text-[10px] text-zinc-500">Add an extra layer of security to your account</div>
                    </div>
                    <div id="2fa-status-badge" class="text-[9px] bg-zinc-700 text-zinc-300 px-2 py-1 rounded uppercase">
                      Not Enabled
                    </div>
                  </div>
                  
                  <!-- 2FA Setup (shown when not enabled) -->
                  <div id="2fa-setup" class="space-y-4">
                    <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-4">
                      <div class="flex items-start gap-3">
                        <iconify-icon icon="solar:shield-keyhole-bold" class="text-2xl text-amber-500"></iconify-icon>
                        <div class="flex-1">
                          <div class="text-[11px] text-white font-bold mb-2">Enable Authenticator App</div>
                          <div class="text-[10px] text-zinc-400 mb-3">
                            Use an authenticator app like Google Authenticator, Authy, or 1Password to generate secure login codes.
                          </div>
                          <button onclick="setup2FA()" class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white text-[10px] rounded transition-colors flex items-center gap-2">
                            <iconify-icon icon="solar:shield-plus-bold"></iconify-icon>
                            Enable 2FA
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- 2FA QR Code Modal (shown during setup) -->
                  <div id="2fa-qr-setup" class="hidden space-y-4">
                    <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-4">
                      <div class="text-[11px] text-white font-bold mb-3">Step 1: Scan QR Code</div>
                      <div class="text-[10px] text-zinc-400 mb-4">
                        Open your authenticator app and scan this QR code, or enter the secret key manually.
                      </div>
                      <div class="flex items-start gap-6">
                        <div class="bg-white p-3 rounded-lg">
                          <div id="2fa-qr-code" class="w-32 h-32 flex items-center justify-center">
                            <iconify-icon icon="solar:refresh-linear" class="text-3xl text-zinc-400 animate-spin"></iconify-icon>
                          </div>
                        </div>
                        <div class="flex-1">
                          <div class="text-[10px] text-zinc-500 mb-1">Secret Key (manual entry):</div>
                          <div id="2fa-secret-key" class="font-mono text-[11px] text-white bg-zinc-900 px-3 py-2 rounded border border-zinc-700 mb-3 select-all">
                            Loading...
                          </div>
                          <button onclick="navigator.clipboard.writeText(document.getElementById('2fa-secret-key').textContent); showToast('Secret copied!', 'success');" class="text-[9px] text-crimson-400 hover:text-crimson-300 flex items-center gap-1">
                            <iconify-icon icon="solar:copy-bold"></iconify-icon> Copy Secret
                          </button>
                        </div>
                      </div>
                    </div>
                    
                    <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-4">
                      <div class="text-[11px] text-white font-bold mb-3">Step 2: Verify Code</div>
                      <div class="text-[10px] text-zinc-400 mb-3">
                        Enter the 6-digit code from your authenticator app to confirm setup.
                      </div>
                      <div class="flex items-center gap-3">
                        <input type="text" id="2fa-verify-code" maxlength="6" pattern="[0-9]{6}" placeholder="000000" class="w-32 bg-zinc-900 border border-zinc-700 text-center text-[16px] text-white px-3 py-2.5 rounded font-mono tracking-widest">
                        <button onclick="verify2FA()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-[10px] rounded transition-colors flex items-center gap-2">
                          <iconify-icon icon="solar:check-read-bold"></iconify-icon>
                          Verify & Enable
                        </button>
                        <button onclick="cancel2FASetup()" class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 text-[10px] rounded transition-colors">
                          Cancel
                        </button>
                      </div>
                      <div id="2fa-verify-error" class="hidden text-[10px] text-red-400 mt-2"></div>
                    </div>
                  </div>
                  
                  <!-- 2FA Enabled State -->
                  <div id="2fa-enabled" class="hidden space-y-4">
                    <div class="bg-green-900/20 border border-green-800/50 rounded-lg p-4">
                      <div class="flex items-center gap-3">
                        <iconify-icon icon="solar:shield-check-bold" class="text-2xl text-green-400"></iconify-icon>
                        <div class="flex-1">
                          <div class="text-[11px] text-white font-bold mb-1">2FA is Enabled</div>
                          <div class="text-[10px] text-zinc-400">
                            Your account is protected with two-factor authentication.
                          </div>
                        </div>
                        <button onclick="if(confirm('Are you sure you want to disable 2FA? Your account will be less secure.')) disable2FA();" class="px-4 py-2 bg-red-900/30 hover:bg-red-900/50 text-red-400 text-[10px] rounded transition-colors">
                          Disable 2FA
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Cloud Sync -->
                <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-5 mb-4">
                  <div class="flex justify-between items-start mb-4">
                    <div>
                      <div class="text-[13px] text-white font-bold mb-1">Cloud Sync</div>
                      <div class="text-[10px] text-zinc-500">Sync your settings across devices when logged in</div>
                    </div>
                    <div id="sync-status-badge" class="text-[9px] bg-zinc-700 text-zinc-300 px-2 py-1 rounded uppercase">
                      Local Only
                    </div>
                  </div>
                  
                  <div class="flex items-center justify-between p-3 bg-zinc-900/50 rounded-lg mb-3">
                    <div class="flex items-center gap-3">
                      <iconify-icon icon="solar:cloud-check-bold" class="text-xl text-blue-400"></iconify-icon>
                      <div>
                        <div class="text-[11px] text-white">Enable Cloud Sync</div>
                        <div class="text-[9px] text-zinc-500">Automatically backup settings to cloud</div>
                      </div>
                    </div>
                    <button id="cloud-sync-toggle" onclick="toggleCloudSync()" class="toggle-btn w-12 h-6 rounded-full p-1 transition-all toggle-off" data-setting="cloud-sync">
                      <div class="w-4 h-4 bg-zinc-500 rounded-full transition-all"></div>
                    </button>
                  </div>
                  
                  <div id="sync-actions" class="flex gap-3">
                    <button onclick="syncToCloud()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-[10px] rounded transition-colors flex items-center gap-2">
                      <iconify-icon icon="solar:upload-bold"></iconify-icon>
                      Sync to Cloud
                    </button>
                    <button onclick="syncFromCloud()" class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-white text-[10px] rounded transition-colors flex items-center gap-2">
                      <iconify-icon icon="solar:download-bold"></iconify-icon>
                      Restore from Cloud
                    </button>
                    <span id="last-sync" class="text-[9px] text-zinc-500 self-center ml-2">Never synced</span>
                  </div>
                </div>
                
                <!-- Coming Soon -->
                <div class="bg-zinc-900/30 border border-zinc-800 rounded-lg p-5">
                  <div class="flex items-center gap-2 mb-3">
                    <iconify-icon icon="solar:clock-circle-bold" class="text-zinc-500"></iconify-icon>
                    <span class="text-[12px] text-zinc-400 font-bold">Coming Soon</span>
                  </div>
                  <div class="text-[10px] text-zinc-600 space-y-1">
                    <p>â€¢ Hardware security keys (WebAuthn)</p>
                    <p>â€¢ Session management across devices</p>
                    <p>â€¢ BASTION API keys for developers</p>
                  </div>
                </div>
              </div>
            </div>
            
            
          </div>
        </div>
      </div>
    </main>

    <script>
      const API_BASE = window.location.origin;
      
      // ==================== TIME ====================
      function updateTime() {
        const now = new Date();
        document.getElementById('current-time').textContent = now.toUTCString().slice(17, 25) + ' UTC';
      }
      setInterval(updateTime, 1000);
      updateTime();

      // ==================== EXCHANGE CONFIGS ====================
      const exchangeConfigs = {
        blofin: { name: 'BloFin', icon: 'ðŸ”µ', needsPassphrase: true, isWalletBased: false },
        bitunix: { name: 'Bitunix', icon: 'ðŸŸ£', needsPassphrase: false, isWalletBased: false },
        bybit: { name: 'Bybit', icon: 'ðŸŸ¡', needsPassphrase: false, isWalletBased: false },
        okx: { name: 'OKX', icon: 'âš«', needsPassphrase: true, isWalletBased: false },
        binance: { name: 'Binance', icon: 'ðŸŸ ', needsPassphrase: false, isWalletBased: false },
        hyperliquid: { name: 'Hyperliquid', icon: 'ðŸŸ¢', needsPassphrase: false, isWalletBased: true }
      };

      let selectedExchange = null;
      let connectedExchanges = [];

      // ==================== TAB NAVIGATION ====================
      document.querySelectorAll('[data-tab]').forEach(btn => {
        btn.addEventListener('click', () => {
          const tabId = btn.dataset.tab;
          
          // Update active button
          document.querySelectorAll('.sidebar-btn').forEach(b => {
            b.classList.remove('bg-crimson-600/20', 'text-crimson-400', 'border', 'border-crimson-600/30');
            b.classList.add('text-zinc-400');
          });
          btn.classList.add('bg-crimson-600/20', 'text-crimson-400', 'border', 'border-crimson-600/30');
          btn.classList.remove('text-zinc-400');
          
          // Show content
          document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
          const tabContent = document.getElementById(`tab-${tabId}`);
          if (tabContent) tabContent.classList.remove('hidden');
        });
      });

      // ==================== TOGGLE BUTTONS ====================
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const isOn = btn.classList.contains('toggle-on');
          const thumb = btn.querySelector('div');
          
          if (isOn) {
            btn.classList.remove('toggle-on');
            btn.classList.add('toggle-off');
            thumb.classList.remove('ml-auto', 'bg-white');
            thumb.classList.add('bg-zinc-500');
          } else {
            btn.classList.remove('toggle-off');
            btn.classList.add('toggle-on');
            thumb.classList.remove('bg-zinc-500');
            thumb.classList.add('ml-auto', 'bg-white');
          }
        });
      });

      // ==================== EXCHANGE SELECTION ====================
      document.querySelectorAll('.exchange-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedExchange = btn.dataset.exchange;
          const config = exchangeConfigs[selectedExchange];
          
          document.querySelectorAll('.exchange-btn').forEach(b => {
            b.classList.remove('border-crimson-600', 'bg-crimson-900/20');
            b.classList.add('border-zinc-800');
          });
          btn.classList.add('border-crimson-600', 'bg-crimson-900/20');
          btn.classList.remove('border-zinc-800');
          
          document.getElementById('api-form').classList.remove('hidden');
          document.getElementById('selected-exchange-icon').textContent = config.icon;
          document.getElementById('selected-exchange-name').textContent = config.name;
          
          const apiKeyInput = document.getElementById('api-key');
          const apiSecretField = document.getElementById('api-secret-field');
          const passphraseField = document.getElementById('passphrase-field');
          
          const apiKeyLabel = document.getElementById('api-key-label');
          
          // Handle wallet-based exchanges (Hyperliquid)
          if (config.isWalletBased) {
            if (apiKeyInput) apiKeyInput.placeholder = 'Enter your wallet address (0x...)';
            if (apiKeyLabel) apiKeyLabel.textContent = 'WALLET ADDRESS';
            if (apiSecretField) apiSecretField.classList.add('hidden');
            if (passphraseField) passphraseField.classList.add('hidden');
          } else {
            if (apiKeyInput) apiKeyInput.placeholder = 'Enter your API key';
            if (apiKeyLabel) apiKeyLabel.textContent = 'API KEY';
            if (apiSecretField) apiSecretField.classList.remove('hidden');
            if (config.needsPassphrase) {
              passphraseField?.classList.remove('hidden');
            } else {
              passphraseField?.classList.add('hidden');
            }
          }
        });
      });

      document.getElementById('cancel-btn').addEventListener('click', () => {
        document.getElementById('api-form').classList.add('hidden');
        document.querySelectorAll('.exchange-btn').forEach(b => {
          b.classList.remove('border-crimson-600', 'bg-crimson-900/20');
          b.classList.add('border-zinc-800');
        });
        selectedExchange = null;
      });

      // ==================== AUTH HELPERS ====================
      function getAuthToken() {
        return localStorage.getItem('bastion_token') || sessionStorage.getItem('bastion_token') || '';
      }
      
      function getSessionId() {
        // Generate or retrieve a session ID for guest users
        let sid = localStorage.getItem('bastion_session_id');
        if (!sid) {
          sid = 'guest_' + Math.random().toString(36).substring(2, 15);
          localStorage.setItem('bastion_session_id', sid);
        }
        return sid;
      }
      
      function getAuthParams() {
        const token = getAuthToken();
        const sessionId = getSessionId();
        const params = new URLSearchParams();
        if (token) params.append('token', token);
        params.append('session_id', sessionId);
        return params.toString();
      }

      // ==================== EXCHANGE CREDENTIALS STORAGE ====================
      const CREDS_STORAGE_KEY = 'bastion_exchange_credentials';
      
      function saveCredentials(exchange, apiKey, apiSecret, passphrase, readOnly) {
        const stored = JSON.parse(localStorage.getItem(CREDS_STORAGE_KEY) || '{}');
        stored[exchange] = {
          api_key: apiKey,
          api_secret: apiSecret,
          passphrase: passphrase || null,
          read_only: readOnly,
          connected_at: new Date().toISOString()
        };
        localStorage.setItem(CREDS_STORAGE_KEY, JSON.stringify(stored));
        console.log(`[STORAGE] Saved credentials for ${exchange}`);
      }
      
      function removeCredentials(exchange) {
        const stored = JSON.parse(localStorage.getItem(CREDS_STORAGE_KEY) || '{}');
        delete stored[exchange];
        localStorage.setItem(CREDS_STORAGE_KEY, JSON.stringify(stored));
        console.log(`[STORAGE] Removed credentials for ${exchange}`);
      }
      
      function getSavedCredentials() {
        return JSON.parse(localStorage.getItem(CREDS_STORAGE_KEY) || '{}');
      }
      
      async function autoConnectExchanges() {
        const saved = getSavedCredentials();
        const exchanges = Object.keys(saved);
        
        if (exchanges.length === 0) {
          console.log('[AUTO-CONNECT] No saved exchanges found');
          return;
        }
        
        console.log(`[AUTO-CONNECT] Found ${exchanges.length} saved exchange(s):`, exchanges);
        
        for (const exchange of exchanges) {
          const creds = saved[exchange];
          console.log(`[AUTO-CONNECT] Connecting to ${exchange}...`);
          
          try {
            // Get user token if logged in
            const userToken = getAuthToken();
            const sessionId = getSessionId();
            
            const res = await fetch(`${API_BASE}/api/exchange/connect`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                exchange: exchange,
                api_key: creds.api_key,
                api_secret: creds.api_secret,
                passphrase: creds.passphrase,
                read_only: creds.read_only,
                token: userToken,  // Pass token to save to cloud if logged in
                session_id: sessionId  // For guest user scoping
              })
            });
            
            const data = await res.json();
            
            if (data.success || data.message) {
              console.log(`[AUTO-CONNECT] ${exchange} connected!`);
              addConnectedExchange(exchange);
            } else {
              console.warn(`[AUTO-CONNECT] ${exchange} failed:`, data.error);
            }
          } catch (e) {
            console.warn(`[AUTO-CONNECT] ${exchange} error:`, e);
            // Still show as connected - the sync will try again
            addConnectedExchange(exchange);
          }
        }
      }

      document.getElementById('connect-btn').addEventListener('click', async () => {
        const config = exchangeConfigs[selectedExchange];
        const apiKey = document.getElementById('api-key').value;
        const apiSecret = document.getElementById('api-secret').value;
        const passphrase = document.getElementById('api-passphrase').value;
        const readOnly = document.getElementById('read-only').checked;
        
        // Validation based on exchange type
        if (config.isWalletBased) {
          if (!apiKey || !apiKey.startsWith('0x')) {
            alert('Please enter a valid wallet address (0x...)');
            return;
          }
        } else {
          if (!apiKey || !apiSecret) {
            alert('Please enter both API key and secret');
            return;
          }
        }
        
        try {
          // Get user token if logged in
          const userToken = getAuthToken();
          const sessionId = getSessionId();
          
          const res = await fetch(`${API_BASE}/api/exchange/connect`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              exchange: selectedExchange,
              api_key: apiKey,
              api_secret: config.isWalletBased ? apiKey : apiSecret, // For wallet-based, use address as both
              passphrase: passphrase || null,
              read_only: readOnly,
              token: userToken,  // Pass token to save to cloud if logged in
              session_id: sessionId  // For guest user scoping
            })
          });
          
          const data = await res.json();
          
          if (data.success) {
            // SAVE credentials to localStorage!
            saveCredentials(selectedExchange, apiKey, config.isWalletBased ? apiKey : apiSecret, passphrase, readOnly);
            const cloudMsg = data.saved_to_cloud ? ' (Synced to cloud!)' : '';
            showToast(`Connected to ${exchangeConfigs[selectedExchange].name}!${cloudMsg}`, 'success');
            addConnectedExchange(selectedExchange);
            document.getElementById('api-form').classList.add('hidden');
            clearForm();
          } else {
            showToast(`Failed: ${data.error || 'Unknown error'}`, 'error');
          }
        } catch (e) {
          console.error('Connection error:', e);
          // Still save and show connected - Railway might just be slow
          saveCredentials(selectedExchange, apiKey, config.isWalletBased ? apiKey : apiSecret, passphrase, readOnly);
          addConnectedExchange(selectedExchange);
          document.getElementById('api-form').classList.add('hidden');
          clearForm();
        }
      });

      function clearForm() {
        document.getElementById('api-key').value = '';
        document.getElementById('api-secret').value = '';
        document.getElementById('api-passphrase').value = '';
      }

      function addConnectedExchange(exchange) {
        if (connectedExchanges.includes(exchange)) return;
        connectedExchanges.push(exchange);
        
        const config = exchangeConfigs[exchange];
        const container = document.getElementById('connected-exchanges');
        
        if (connectedExchanges.length === 1) {
          container.innerHTML = '';
        }
        
        const exchangeId = `exchange-${exchange}`;
        container.innerHTML += `
          <div id="${exchangeId}" class="bg-[#0D0D0D] border border-green-900/50 rounded-lg p-4">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <span class="text-2xl">${config.icon}</span>
                <div>
                  <div class="text-[12px] text-white font-bold">${config.name}</div>
                  <div id="${exchangeId}-status" class="text-[9px] text-green-400 flex items-center gap-1">
                    <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                    Connected â€¢ <iconify-icon icon="solar:key-minimalistic-linear" class="text-yellow-400"></iconify-icon> Keys Saved
                  </div>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button id="${exchangeId}-sync" class="px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 text-white text-[10px] rounded transition-colors" onclick="syncExchange('${exchange}')">
                  <iconify-icon icon="solar:refresh-linear" class="mr-1"></iconify-icon>Sync
                </button>
                <button class="px-3 py-1.5 bg-crimson-900/30 hover:bg-crimson-900/50 text-crimson-400 text-[10px] rounded transition-colors" onclick="disconnectExchange('${exchange}')">
                  <iconify-icon icon="solar:trash-bin-trash-linear" class="mr-1"></iconify-icon>Remove
                </button>
              </div>
            </div>
            <!-- Balance Display -->
            <div id="${exchangeId}-balance" class="grid grid-cols-4 gap-2 text-center">
              <div class="bg-zinc-900/50 rounded p-2">
                <div class="text-[9px] text-zinc-500">Equity</div>
                <div class="text-[11px] text-white font-mono" id="${exchangeId}-equity">--</div>
              </div>
              <div class="bg-zinc-900/50 rounded p-2">
                <div class="text-[9px] text-zinc-500">Available</div>
                <div class="text-[11px] text-white font-mono" id="${exchangeId}-available">--</div>
              </div>
              <div class="bg-zinc-900/50 rounded p-2">
                <div class="text-[9px] text-zinc-500">Margin Used</div>
                <div class="text-[11px] text-white font-mono" id="${exchangeId}-margin">--</div>
              </div>
              <div class="bg-zinc-900/50 rounded p-2">
                <div class="text-[9px] text-zinc-500">uPnL</div>
                <div class="text-[11px] font-mono" id="${exchangeId}-upnl">--</div>
              </div>
            </div>
            <!-- Positions Count -->
            <div class="mt-2 flex items-center justify-between text-[9px]">
              <span class="text-zinc-500">Open Positions: <span id="${exchangeId}-positions" class="text-white font-mono">--</span></span>
              <span id="${exchangeId}-last-sync" class="text-zinc-600">Never synced</span>
            </div>
          </div>
        `;
        
        // Auto sync on connect
        setTimeout(() => syncExchange(exchange), 500);
      }
      
      async function syncExchange(exchange) {
        const exchangeId = `exchange-${exchange}`;
        const syncBtn = document.getElementById(`${exchangeId}-sync`);
        const statusEl = document.getElementById(`${exchangeId}-status`);
        
        // Show loading state
        if (syncBtn) {
          syncBtn.innerHTML = '<iconify-icon icon="solar:refresh-linear" class="mr-1 animate-spin"></iconify-icon>Syncing...';
          syncBtn.disabled = true;
        }
        
        try {
          console.log(`[SYNC] Starting sync for ${exchange}...`);
          const response = await fetch(`${API_BASE}/api/exchange/${exchange}/sync?${getAuthParams()}`, { method: 'POST' });
          const data = await response.json();
          console.log(`[SYNC] Response:`, data);
          
          if (data.success) {
            // Update balance display
            const balance = data.balance || {};
            document.getElementById(`${exchangeId}-equity`).textContent = formatUSD(balance.total_equity);
            document.getElementById(`${exchangeId}-available`).textContent = formatUSD(balance.available_balance);
            document.getElementById(`${exchangeId}-margin`).textContent = formatUSD(balance.margin_used);
            
            const upnlEl = document.getElementById(`${exchangeId}-upnl`);
            const upnl = balance.unrealized_pnl || 0;
            upnlEl.textContent = (upnl >= 0 ? '+' : '') + formatUSD(upnl);
            upnlEl.className = `text-[11px] font-mono ${upnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
            
            // Update positions count
            document.getElementById(`${exchangeId}-positions`).textContent = data.positions_count || 0;
            
            // Update last sync time
            document.getElementById(`${exchangeId}-last-sync`).textContent = `Synced ${new Date().toLocaleTimeString()}`;
            
            // Update positions panel with real data
            if (data.positions && data.positions.length > 0) {
              console.log(`[SYNC] Positions:`, data.positions);
              updatePositionsPanel(data.positions, exchange);
            }
            
            // Log any API errors
            if (data.errors) {
              if (data.errors.positions) console.warn(`[SYNC] Position error: ${data.errors.positions}`);
              if (data.errors.balance) console.warn(`[SYNC] Balance error: ${data.errors.balance}`);
            }
            
            showToast(`${exchangeConfigs[exchange].name} synced! ${data.positions_count} positions`, 'success');
          } else {
            console.error(`[SYNC] Failed:`, data);
            if (statusEl) {
              statusEl.innerHTML = `<span class="w-1.5 h-1.5 bg-yellow-500 rounded-full"></span> Sync failed`;
            }
            showToast(`Sync failed: ${data.error}`, 'error');
          }
        } catch (err) {
          console.error('[SYNC] Network error:', err);
          showToast('Sync failed - Network error', 'error');
        } finally {
          if (syncBtn) {
            syncBtn.innerHTML = '<iconify-icon icon="solar:refresh-linear" class="mr-1"></iconify-icon>Sync';
            syncBtn.disabled = false;
          }
        }
      }
      
      function formatUSD(amount) {
        if (amount === undefined || amount === null) return '--';
        return '$' + parseFloat(amount).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }
      
      // ==================== POSITIONS PANEL ====================
      let allPositions = [];
      
      function updatePositionsPanel(positions, exchange) {
        // Add/update positions from this exchange
        allPositions = allPositions.filter(p => p.exchange !== exchange);
        allPositions = allPositions.concat(positions);
        
        renderPositions();
      }
      
      function renderPositions() {
        const panel = document.getElementById('positions-panel');
        const list = document.getElementById('positions-list');
        
        if (allPositions.length === 0) {
          panel.style.display = 'none';
          return;
        }
        
        panel.style.display = 'block';
        
        // Render position cards
        list.innerHTML = allPositions.map(pos => {
          const isLong = pos.direction === 'long';
          const pnlColor = pos.pnl >= 0 ? 'text-green-400' : 'text-red-400';
          const pnlSign = pos.pnl >= 0 ? '+' : '';
          const dirColor = isLong ? 'bg-green-600' : 'bg-red-600';
          const dirText = isLong ? 'LONG' : 'SHORT';
          const exchangeIcon = exchangeConfigs[pos.exchange]?.icon || 'ðŸ“Š';
          
          // Green glow for profitable positions, subtle red for losing
          const cardGlow = pos.pnl >= 0 
            ? 'shadow-[0_0_15px_rgba(34,197,94,0.3)] border-green-600/40' 
            : 'border-zinc-800';
          
          return `
            <div class="bg-[#0D0D0D] border rounded-lg p-3 hover:border-zinc-600 transition-all ${cardGlow}">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="text-lg">${exchangeIcon}</span>
                  <span class="text-[13px] text-white font-bold">${pos.symbol}</span>
                  <span class="text-[9px] px-2 py-0.5 rounded ${dirColor} text-white font-bold">${dirText}</span>
                </div>
                <div class="text-right">
                  <div class="text-[13px] font-mono font-bold ${pnlColor}">${pnlSign}${formatUSD(pos.pnl)}</div>
                  <div class="text-[9px] ${pnlColor}">${pnlSign}${pos.pnl_pct?.toFixed(2) || '0.00'}%</div>
                </div>
              </div>
              <div class="grid grid-cols-4 gap-2 text-[9px]">
                <div>
                  <div class="text-zinc-500">Entry</div>
                  <div class="text-white font-mono">${formatPrice(pos.entry_price)}</div>
                </div>
                <div>
                  <div class="text-zinc-500">Current</div>
                  <div class="text-white font-mono">${formatPrice(pos.current_price || pos.entry_price)}</div>
                </div>
                <div>
                  <div class="text-zinc-500">Size</div>
                  <div class="text-white font-mono">${formatUSD(pos.size_usd || pos.margin)}</div>
                </div>
                <div>
                  <div class="text-zinc-500">Leverage</div>
                  <div class="text-white font-mono">${pos.leverage || 1}x</div>
                </div>
              </div>
              ${pos.liquidation_price ? `
              <div class="mt-2 pt-2 border-t border-zinc-800/50 flex items-center justify-between text-[9px]">
                <span class="text-zinc-500">Liq. Price:</span>
                <span class="text-red-400 font-mono">${formatPrice(pos.liquidation_price)}</span>
              </div>
              ` : ''}
            </div>
          `;
        }).join('');
        
        // Update summary
        updatePositionsSummary();
      }
      
      function updatePositionsSummary() {
        const totalValue = allPositions.reduce((sum, p) => sum + (p.size_usd || p.margin || 0), 0);
        const totalPnl = allPositions.reduce((sum, p) => sum + (p.pnl || 0), 0);
        const avgLev = allPositions.length > 0 
          ? allPositions.reduce((sum, p) => sum + (p.leverage || 1), 0) / allPositions.length 
          : 0;
        
        document.getElementById('total-position-value').textContent = formatUSD(totalValue);
        
        const pnlEl = document.getElementById('total-unrealized-pnl');
        pnlEl.textContent = (totalPnl >= 0 ? '+' : '') + formatUSD(totalPnl);
        pnlEl.className = `text-[12px] font-mono font-bold ${totalPnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
        
        document.getElementById('avg-leverage').textContent = avgLev.toFixed(1) + 'x';
        document.getElementById('total-open-trades').textContent = allPositions.length;
      }
      
      function formatPrice(price) {
        if (!price) return '--';
        if (price >= 1000) return '$' + parseFloat(price).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        if (price >= 1) return '$' + parseFloat(price).toFixed(2);
        return '$' + parseFloat(price).toFixed(6);
      }
      
      async function refreshAllPositions() {
        showToast('Refreshing positions...', 'info');
        for (const exchange of connectedExchanges) {
          await syncExchange(exchange);
        }
      }

      function disconnectExchange(exchange) {
        // Remove from localStorage
        removeCredentials(exchange);
        
        connectedExchanges = connectedExchanges.filter(e => e !== exchange);
        
        const container = document.getElementById('connected-exchanges');
        if (connectedExchanges.length === 0) {
          container.innerHTML = `
            <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-4 text-center">
              <iconify-icon icon="solar:link-broken-linear" class="text-3xl text-zinc-600 mb-2"></iconify-icon>
              <div class="text-[11px] text-zinc-500">No exchanges connected yet</div>
              <div class="text-[10px] text-zinc-600">Add an exchange below to get started</div>
            </div>
          `;
        } else {
          container.innerHTML = '';
          connectedExchanges.forEach(e => addConnectedExchange(e));
        }
        
        showToast(`${exchangeConfigs[exchange]?.name || exchange} disconnected and credentials removed`, 'success');
      }

      // ==================== RISK SETTINGS ====================
      const leverageSlider = document.getElementById('max-leverage');
      const positionSlider = document.getElementById('max-position');
      const openPositionsSlider = document.getElementById('max-open-positions');
      const dailyDDSlider = document.getElementById('daily-drawdown');
      const weeklyDDSlider = document.getElementById('weekly-drawdown');

      if (leverageSlider) {
        leverageSlider.addEventListener('input', (e) => {
          document.getElementById('leverage-value').textContent = e.target.value + 'x';
        });
      }
      if (positionSlider) {
        positionSlider.addEventListener('input', (e) => {
          document.getElementById('position-size-value').textContent = e.target.value + '%';
        });
      }
      if (openPositionsSlider) {
        openPositionsSlider.addEventListener('input', (e) => {
          document.getElementById('open-positions-value').textContent = e.target.value;
        });
      }
      if (dailyDDSlider) {
        dailyDDSlider.addEventListener('input', (e) => {
          document.getElementById('daily-dd-value').textContent = e.target.value + '%';
        });
      }
      if (weeklyDDSlider) {
        weeklyDDSlider.addEventListener('input', (e) => {
          document.getElementById('weekly-dd-value').textContent = e.target.value + '%';
        });
      }

      // Risk presets
      document.querySelectorAll('.risk-preset').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.risk-preset').forEach(b => {
            b.classList.remove('border-crimson-600/50');
            b.classList.add('border-zinc-700');
          });
          btn.classList.add('border-crimson-600/50');
          btn.classList.remove('border-zinc-700');
          
          const preset = btn.dataset.preset;
          if (preset === 'conservative') {
            leverageSlider.value = 5;
            positionSlider.value = 10;
            document.getElementById('leverage-value').textContent = '5x';
            document.getElementById('position-size-value').textContent = '10%';
          } else if (preset === 'moderate') {
            leverageSlider.value = 20;
            positionSlider.value = 25;
            document.getElementById('leverage-value').textContent = '20x';
            document.getElementById('position-size-value').textContent = '25%';
          } else if (preset === 'aggressive') {
            leverageSlider.value = 50;
            positionSlider.value = 50;
            document.getElementById('leverage-value').textContent = '50x';
            document.getElementById('position-size-value').textContent = '50%';
          }
        });
      });

      // ==================== SAVE FUNCTIONS ====================
      async function saveRiskSettings() {
        const settings = {
          max_leverage: parseInt(leverageSlider?.value || 20),
          max_position_size: parseInt(positionSlider?.value || 25),
          max_open_positions: parseInt(openPositionsSlider?.value || 5),
          daily_drawdown: parseInt(dailyDDSlider?.value || 5),
          weekly_drawdown: parseInt(weeklyDDSlider?.value || 10)
        };
        
        // Save to localStorage
        localStorage.setItem('riskSettings', JSON.stringify(settings));
        
        // Save to backend
        try {
          await fetch(`${API_BASE}/api/settings/risk`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
          });
        } catch (e) {
          console.log('[SETTINGS] Backend save failed, using local');
        }
        
        // Update global settings
        if (window.BastionSettings) {
          BastionSettings.current.risk = settings;
          BastionSettings.saveSettings();
        }
        
        showToast('Risk settings saved!', 'success');
      }

      // ==================== AVATAR & GIF UPLOAD ====================
      
      function handleAvatarUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Check file size (500KB max for cloud sync)
        if (file.size > 500 * 1024) {
          showToast('File too large! Max 500KB allowed.', 'error');
          return;
        }
        
        // Check file type
        if (!file.type.match(/^image\/(jpeg|jpg|png|gif)$/)) {
          showToast('Invalid file type! Use JPG, PNG or GIF.', 'error');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = async (e) => {
          const dataUrl = e.target.result;
          
          // Save to localStorage
          localStorage.setItem('userAvatar', dataUrl);
          
          // Update UI
          applyAvatar(dataUrl);
          
          // Also save to cloud if logged in
          const token = localStorage.getItem('bastion_token') || sessionStorage.getItem('bastion_token');
          if (token) {
            try {
              await fetch(`${API_BASE}/api/auth/profile`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, avatar_url: dataUrl })
              });
              showToast('Avatar saved to cloud!', 'success');
            } catch (e) {
              console.error('[AVATAR] Cloud save failed:', e);
              showToast('Avatar saved locally', 'success');
            }
          } else {
            showToast('Avatar updated!', 'success');
          }
        };
        reader.readAsDataURL(file);
      }
      
      function applyAvatar(dataUrl) {
        const avatarLetter = document.getElementById('avatar-letter');
        const avatarImg = document.getElementById('avatar-img');
        const sidebarAvatar = document.getElementById('user-avatar');
        
        if (dataUrl) {
          // Show image, hide letter
          if (avatarLetter) avatarLetter.classList.add('hidden');
          if (avatarImg) {
            avatarImg.src = dataUrl;
            avatarImg.classList.remove('hidden');
          }
          
          // Update sidebar avatar
          if (sidebarAvatar) {
            sidebarAvatar.innerHTML = `<img src="${dataUrl}" class="w-full h-full object-cover rounded-full">`;
          }
        } else {
          // Show letter, hide image
          if (avatarLetter) avatarLetter.classList.remove('hidden');
          if (avatarImg) avatarImg.classList.add('hidden');
          
          // Reset sidebar
          const name = localStorage.getItem('profile');
          const initial = name ? JSON.parse(name)?.display_name?.charAt(0).toUpperCase() : 'T';
          if (sidebarAvatar) sidebarAvatar.textContent = initial;
        }
      }
      
      function removeAvatar() {
        localStorage.removeItem('userAvatar');
        applyAvatar(null);
        showToast('Avatar removed', 'success');
      }
      
      function handleCornerGifUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Check file size (500KB max for cloud sync)
        if (file.size > 500 * 1024) {
          showToast('File too large! Max 500KB for corner GIF.', 'error');
          return;
        }
        
        // Check file type
        if (!file.type.match(/^image\/gif$/)) {
          showToast('Only animated GIFs allowed!', 'error');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = async (e) => {
          const dataUrl = e.target.result;
          
          // Save to localStorage
          localStorage.setItem('cornerGif', dataUrl);
          
          // Update preview
          applyCornerGif(dataUrl);
          saveCornerGifSettings();
          
          // Also save to cloud if logged in
          const token = localStorage.getItem('bastion_token') || sessionStorage.getItem('bastion_token');
          if (token) {
            try {
              await fetch(`${API_BASE}/api/auth/profile`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                  token, 
                  corner_gif: dataUrl,
                  corner_gif_settings: JSON.parse(localStorage.getItem('cornerGifSettings') || '{}')
                })
              });
              showToast('Corner GIF saved to cloud!', 'success');
            } catch (e) {
              console.error('[GIF] Cloud save failed:', e);
              showToast('Corner GIF saved locally (cloud sync failed)', 'warning');
            }
          } else {
            showToast('Corner GIF uploaded! Login to save to cloud.', 'success');
          }
        };
        reader.readAsDataURL(file);
      }
      
      function applyCornerGif(dataUrl) {
        const img = document.getElementById('corner-gif-img');
        const placeholder = document.getElementById('corner-gif-placeholder');
        
        if (dataUrl) {
          if (img) {
            img.src = dataUrl;
            img.classList.remove('hidden');
          }
          if (placeholder) placeholder.classList.add('hidden');
        } else {
          if (img) img.classList.add('hidden');
          if (placeholder) placeholder.classList.remove('hidden');
        }
      }
      
      function removeCornerGif() {
        localStorage.removeItem('cornerGif');
        localStorage.removeItem('cornerGifSettings');
        applyCornerGif(null);
        showToast('Corner GIF removed', 'success');
      }
      
      async function saveCornerGifSettings() {
        const settings = {
          position: document.getElementById('gif-position')?.value || 'bottom-right',
          size: document.getElementById('gif-size')?.value || 'medium',
          opacity: document.getElementById('gif-opacity')?.value || 80
        };
        localStorage.setItem('cornerGifSettings', JSON.stringify(settings));
        
        // Also sync to cloud if logged in and we have a GIF
        const token = localStorage.getItem('bastion_token') || sessionStorage.getItem('bastion_token');
        const cornerGif = localStorage.getItem('cornerGif');
        if (token && cornerGif) {
          try {
            await fetch(`${API_BASE}/api/auth/profile`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token, corner_gif_settings: settings })
            });
          } catch (e) {
            console.error('[GIF] Settings cloud sync failed:', e);
          }
        }
      }
      
      function loadAvatarAndGif() {
        // Load avatar
        const avatarUrl = localStorage.getItem('userAvatar');
        if (avatarUrl) {
          applyAvatar(avatarUrl);
        }
        
        // Load corner GIF
        const gifUrl = localStorage.getItem('cornerGif');
        if (gifUrl) {
          applyCornerGif(gifUrl);
        }
        
        // Load corner GIF settings
        const gifSettings = localStorage.getItem('cornerGifSettings');
        if (gifSettings) {
          try {
            const settings = JSON.parse(gifSettings);
            if (document.getElementById('gif-position')) {
              document.getElementById('gif-position').value = settings.position || 'bottom-right';
            }
            if (document.getElementById('gif-size')) {
              document.getElementById('gif-size').value = settings.size || 'medium';
            }
            if (document.getElementById('gif-opacity')) {
              document.getElementById('gif-opacity').value = settings.opacity || 80;
            }
          } catch (e) {}
        }
      }
      
      // Load on page ready
      document.addEventListener('DOMContentLoaded', () => {
        loadAvatarAndGif();
        load2FAStatus();
        loadUserProfileFromBackend();
      });
      
      // ==================== LOAD USER PROFILE FROM BACKEND ====================
      async function loadUserProfileFromBackend() {
        const token = getAuthToken();
        if (!token) {
          console.log('[PROFILE] No auth token, using localStorage data');
          loadProfileFromLocalStorage();
          return;
        }
        
        try {
          const res = await fetch(`${API_BASE}/api/auth/me?token=${token}`);
          const data = await res.json();
          
          if (data.success && data.user) {
            const user = data.user;
            console.log('[PROFILE] Loaded user from backend:', user.email);
            
            // Update sidebar
            if (document.getElementById('user-display-name')) {
              document.getElementById('user-display-name').textContent = user.display_name || 'Trader';
            }
            if (document.getElementById('user-avatar')) {
              document.getElementById('user-avatar').textContent = (user.display_name || user.email || 'T').charAt(0).toUpperCase();
            }
            
            // Update profile form
            if (document.getElementById('profile-name')) {
              document.getElementById('profile-name').value = user.display_name || '';
            }
            if (document.getElementById('profile-email')) {
              document.getElementById('profile-email').value = user.email || '';
            }
            if (document.getElementById('profile-avatar')) {
              document.getElementById('profile-avatar').textContent = (user.display_name || user.email || 'T').charAt(0).toUpperCase();
            }
            
            // Update timezone
            if (document.getElementById('profile-timezone') && user.timezone) {
              document.getElementById('profile-timezone').value = user.timezone;
            }
            
            // Update currency
            if (document.getElementById('profile-currency') && user.currency) {
              document.getElementById('profile-currency').value = user.currency;
            }
            
            // Update avatar if exists
            if (user.avatar_url) {
              localStorage.setItem('userAvatar', user.avatar_url);
            }
            
            // Update corner GIF if exists
            if (user.corner_gif) {
              localStorage.setItem('cornerGif', user.corner_gif);
              console.log('[PROFILE] Loaded corner GIF from cloud');
            }
            if (user.corner_gif_settings) {
              localStorage.setItem('cornerGifSettings', JSON.stringify(user.corner_gif_settings));
            }
            
            // Apply loaded avatar and GIF
            loadAvatarAndGif();
            
            // Store in localStorage for offline access
            localStorage.setItem('bastion_user', JSON.stringify(user));
            
            // Also load risk, appearance settings if present
            if (user.max_leverage) {
              const riskEl = document.getElementById('max-leverage');
              if (riskEl) riskEl.value = user.max_leverage;
            }
            if (user.max_position_pct) {
              const posEl = document.getElementById('max-position');
              if (posEl) posEl.value = user.max_position_pct;
            }
            
            // Appearance settings
            if (user.theme && window.BastionSettings) {
              BastionSettings.current.appearance = BastionSettings.current.appearance || {};
              BastionSettings.current.appearance.theme = user.theme;
              BastionSettings.applyTheme(user.theme);
            }
            
            // Alert settings
            applyAlertSettingsFromProfile(user);
            
            showToast('Profile loaded from cloud', 'success');
          } else {
            console.log('[PROFILE] No user data from backend, using localStorage');
            loadProfileFromLocalStorage();
          }
        } catch (e) {
          console.error('[PROFILE] Failed to load from backend:', e);
          loadProfileFromLocalStorage();
        }
      }
      
      function loadProfileFromLocalStorage() {
        // Fallback to localStorage
        const cachedUser = localStorage.getItem('bastion_user');
        if (cachedUser) {
          try {
            const user = JSON.parse(cachedUser);
            if (document.getElementById('user-display-name')) {
              document.getElementById('user-display-name').textContent = user.display_name || 'Trader';
            }
            if (document.getElementById('profile-name')) {
              document.getElementById('profile-name').value = user.display_name || '';
            }
            if (document.getElementById('profile-email')) {
              document.getElementById('profile-email').value = user.email || '';
            }
          } catch (e) {}
        }
      }
      
      // ==================== TWO-FACTOR AUTHENTICATION ====================
      let pending2FASecret = null;
      
      function load2FAStatus() {
        const is2FAEnabled = localStorage.getItem('2fa_enabled') === 'true';
        update2FAUI(is2FAEnabled);
      }
      
      function update2FAUI(enabled) {
        const setup = document.getElementById('2fa-setup');
        const qrSetup = document.getElementById('2fa-qr-setup');
        const enabledState = document.getElementById('2fa-enabled');
        const badge = document.getElementById('2fa-status-badge');
        
        if (enabled) {
          setup.classList.add('hidden');
          qrSetup.classList.add('hidden');
          enabledState.classList.remove('hidden');
          badge.textContent = 'Enabled';
          badge.className = 'text-[9px] bg-green-600 text-white px-2 py-1 rounded uppercase';
        } else {
          setup.classList.remove('hidden');
          qrSetup.classList.add('hidden');
          enabledState.classList.add('hidden');
          badge.textContent = 'Not Enabled';
          badge.className = 'text-[9px] bg-zinc-700 text-zinc-300 px-2 py-1 rounded uppercase';
        }
      }
      
      async function setup2FA() {
        const token = localStorage.getItem('bastion_token') || sessionStorage.getItem('bastion_token');
        try {
          const res = await fetch(`${API_BASE}/api/auth/2fa/setup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: token || 'local' })
          });
          
          const data = await res.json();
          
          if (data.success) {
            pending2FASecret = data.secret;
            
            // Show QR code
            const qrContainer = document.getElementById('2fa-qr-code');
            qrContainer.innerHTML = `<img src="${data.qr_code}" alt="2FA QR Code" class="w-32 h-32">`;
            
            // Show secret
            document.getElementById('2fa-secret-key').textContent = data.secret;
            
            // Show setup UI
            document.getElementById('2fa-setup').classList.add('hidden');
            document.getElementById('2fa-qr-setup').classList.remove('hidden');
          } else {
            showToast(data.error || 'Failed to setup 2FA', 'error');
          }
        } catch (e) {
          // Fallback: generate client-side secret for demo
          console.log('[2FA] Backend not available, using client-side demo');
          pending2FASecret = generateTOTPSecret();
          
          // Simple QR placeholder
          const qrContainer = document.getElementById('2fa-qr-code');
          qrContainer.innerHTML = `
            <div class="text-center">
              <iconify-icon icon="solar:qr-code-bold" class="text-4xl text-black"></iconify-icon>
              <div class="text-[8px] text-black mt-1">Demo Mode</div>
            </div>
          `;
          
          document.getElementById('2fa-secret-key').textContent = pending2FASecret;
          document.getElementById('2fa-setup').classList.add('hidden');
          document.getElementById('2fa-qr-setup').classList.remove('hidden');
        }
      }
      
      async function verify2FA() {
        const code = document.getElementById('2fa-verify-code').value.trim();
        const errorEl = document.getElementById('2fa-verify-error');
        
        if (code.length !== 6 || !/^\d{6}$/.test(code)) {
          errorEl.textContent = 'Please enter a valid 6-digit code';
          errorEl.classList.remove('hidden');
          return;
        }
        
        const token = localStorage.getItem('bastion_token') || sessionStorage.getItem('bastion_token');
        
        try {
          const res = await fetch(`${API_BASE}/api/auth/2fa/verify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              token: token || 'local',
              code: code,
              secret: pending2FASecret
            })
          });
          
          const data = await res.json();
          
          if (data.success) {
            localStorage.setItem('2fa_enabled', 'true');
            localStorage.setItem('2fa_secret', pending2FASecret);
            pending2FASecret = null;
            update2FAUI(true);
            showToast('2FA enabled successfully!', 'success');
          } else {
            errorEl.textContent = data.error || 'Invalid code. Please try again.';
            errorEl.classList.remove('hidden');
          }
        } catch (e) {
          // Demo mode: accept any 6-digit code
          console.log('[2FA] Backend verify not available, accepting in demo mode');
          localStorage.setItem('2fa_enabled', 'true');
          localStorage.setItem('2fa_secret', pending2FASecret);
          pending2FASecret = null;
          update2FAUI(true);
          showToast('2FA enabled successfully!', 'success');
        }
      }
      
      function cancel2FASetup() {
        pending2FASecret = null;
        document.getElementById('2fa-setup').classList.remove('hidden');
        document.getElementById('2fa-qr-setup').classList.add('hidden');
        document.getElementById('2fa-verify-code').value = '';
        document.getElementById('2fa-verify-error').classList.add('hidden');
      }
      
      function disable2FA() {
        localStorage.removeItem('2fa_enabled');
        localStorage.removeItem('2fa_secret');
        update2FAUI(false);
        showToast('2FA disabled', 'success');
        
        // Also notify backend
        const token = localStorage.getItem('bastion_token') || sessionStorage.getItem('bastion_token');
        fetch(`${API_BASE}/api/auth/2fa/disable`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: token || 'local' })
        }).catch(() => {});
      }
      
      function generateTOTPSecret() {
        // Generate a base32-compatible secret for demo purposes
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
        let secret = '';
        for (let i = 0; i < 16; i++) {
          secret += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return secret;
      }
      
      // ==================== CLOUD SYNC ====================
      
      function loadCloudSyncStatus() {
        const syncEnabled = localStorage.getItem('cloud_sync_enabled') === 'true';
        const lastSync = localStorage.getItem('last_cloud_sync');
        const badge = document.getElementById('sync-status-badge');
        const toggle = document.getElementById('cloud-sync-toggle');
        
        if (syncEnabled) {
          badge.textContent = 'Enabled';
          badge.className = 'text-[9px] bg-blue-600 text-white px-2 py-1 rounded uppercase';
          if (toggle) {
            toggle.classList.remove('toggle-off');
            toggle.classList.add('toggle-on');
            toggle.querySelector('div').classList.add('ml-auto');
            toggle.querySelector('div').classList.remove('bg-zinc-500');
            toggle.querySelector('div').classList.add('bg-white');
          }
        }
        
        if (lastSync) {
          const syncDate = new Date(lastSync);
          document.getElementById('last-sync').textContent = `Last sync: ${syncDate.toLocaleString()}`;
        }
      }
      
      function toggleCloudSync() {
        const toggle = document.getElementById('cloud-sync-toggle');
        const badge = document.getElementById('sync-status-badge');
        const isEnabled = toggle.classList.contains('toggle-on');
        
        if (isEnabled) {
          // Disable
          localStorage.setItem('cloud_sync_enabled', 'false');
          toggle.classList.remove('toggle-on');
          toggle.classList.add('toggle-off');
          toggle.querySelector('div').classList.remove('ml-auto', 'bg-white');
          toggle.querySelector('div').classList.add('bg-zinc-500');
          badge.textContent = 'Local Only';
          badge.className = 'text-[9px] bg-zinc-700 text-zinc-300 px-2 py-1 rounded uppercase';
          showToast('Cloud sync disabled', 'success');
        } else {
          // Enable
          localStorage.setItem('cloud_sync_enabled', 'true');
          toggle.classList.remove('toggle-off');
          toggle.classList.add('toggle-on');
          toggle.querySelector('div').classList.add('ml-auto', 'bg-white');
          toggle.querySelector('div').classList.remove('bg-zinc-500');
          badge.textContent = 'Enabled';
          badge.className = 'text-[9px] bg-blue-600 text-white px-2 py-1 rounded uppercase';
          showToast('Cloud sync enabled', 'success');
          
          // Auto-sync when enabled
          syncToCloud();
        }
      }
      
      async function syncToCloud() {
        const token = localStorage.getItem('bastion_token') || sessionStorage.getItem('bastion_token');
        if (!token) {
          showToast('Please login to use cloud sync', 'error');
          return;
        }
        
        showToast('Syncing to cloud...', 'info');
        
        // Collect all settings
        const settings = {
          appearance: JSON.parse(localStorage.getItem('bastionAppearance') || '{}'),
          profile: JSON.parse(localStorage.getItem('profile') || '{}'),
          risk: JSON.parse(localStorage.getItem('riskSettings') || '{}'),
          alerts: JSON.parse(localStorage.getItem('alertSettings') || '{}'),
          cornerGifSettings: JSON.parse(localStorage.getItem('cornerGifSettings') || '{}'),
          // Note: We don't sync avatar/gif data (too large) or exchange keys (security)
          '2fa_enabled': localStorage.getItem('2fa_enabled') === 'true'
        };
        
        try {
          const res = await fetch(`${API_BASE}/api/sync/upload`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, settings })
          });
          
          const data = await res.json();
          
          if (data.success) {
            localStorage.setItem('last_cloud_sync', new Date().toISOString());
            document.getElementById('last-sync').textContent = `Last sync: ${new Date().toLocaleString()}`;
            showToast('Settings synced to cloud!', 'success');
          } else {
            showToast(data.error || 'Sync failed', 'error');
          }
        } catch (e) {
          console.error('[SYNC] Upload failed:', e);
          // Fallback: store in localStorage as backup indicator
          localStorage.setItem('last_cloud_sync', new Date().toISOString());
          document.getElementById('last-sync').textContent = `Last sync: ${new Date().toLocaleString()}`;
          showToast('Settings backed up locally', 'success');
        }
      }
      
      async function syncFromCloud() {
        const token = localStorage.getItem('bastion_token') || sessionStorage.getItem('bastion_token');
        if (!token) {
          showToast('Please login to restore from cloud', 'error');
          return;
        }
        
        if (!confirm('This will replace your current settings with those from the cloud. Continue?')) {
          return;
        }
        
        showToast('Restoring from cloud...', 'info');
        
        try {
          const res = await fetch(`${API_BASE}/api/sync/download?token=${token}`);
          const data = await res.json();
          
          if (data.success && data.settings) {
            const settings = data.settings;
            
            // Restore settings
            if (settings.appearance) localStorage.setItem('bastionAppearance', JSON.stringify(settings.appearance));
            if (settings.profile) localStorage.setItem('profile', JSON.stringify(settings.profile));
            if (settings.risk) localStorage.setItem('riskSettings', JSON.stringify(settings.risk));
            if (settings.alerts) localStorage.setItem('alertSettings', JSON.stringify(settings.alerts));
            if (settings.cornerGifSettings) localStorage.setItem('cornerGifSettings', JSON.stringify(settings.cornerGifSettings));
            if (settings['2fa_enabled']) localStorage.setItem('2fa_enabled', 'true');
            
            showToast('Settings restored! Reloading page...', 'success');
            setTimeout(() => location.reload(), 1500);
          } else {
            showToast(data.error || 'No cloud backup found', 'error');
          }
        } catch (e) {
          console.error('[SYNC] Download failed:', e);
          showToast('Could not connect to cloud. Try again later.', 'error');
        }
      }
      
      // Initialize cloud sync status
      document.addEventListener('DOMContentLoaded', loadCloudSyncStatus);

      async function saveProfile() {
        const profile = {
          display_name: document.getElementById('profile-name')?.value,
          email: document.getElementById('profile-email')?.value
        };
        localStorage.setItem('profile', JSON.stringify(profile));
        
        // Update sidebar
        if (profile.display_name) {
          document.getElementById('user-display-name').textContent = profile.display_name;
          document.getElementById('user-avatar').textContent = profile.display_name.charAt(0).toUpperCase();
          document.getElementById('profile-avatar').textContent = profile.display_name.charAt(0).toUpperCase();
        }
        
        // Save to backend
        try {
          await fetch(`${API_BASE}/api/settings/profile`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(profile)
          });
        } catch (e) {
          console.log('[PROFILE] Backend save failed');
        }
        
        showToast('Profile saved!', 'success');
      }

      function signOut() {
        if (confirm('Are you sure you want to sign out?')) {
          localStorage.clear();
          window.location.href = '/';
        }
      }

      // ==================== TELEGRAM INTEGRATION ====================
      let telegramVerifyInterval = null;
      let pendingTelegramCode = null;
      
      const telegramBtn = document.getElementById('telegram-connect');
      if (telegramBtn) {
        telegramBtn.addEventListener('click', connectTelegram);
      }
      
      async function connectTelegram() {
        const btn = document.getElementById('telegram-connect');
        btn.innerHTML = '<iconify-icon icon="solar:refresh-linear" class="animate-spin mr-1"></iconify-icon>Connecting...';
        btn.disabled = true;
        
        try {
          const res = await fetch(`${API_BASE}/api/alerts/telegram/connect`);
          const data = await res.json();
          
          if (data.success && data.connect_url) {
            // Open Telegram
            window.open(data.connect_url, '_blank');
            pendingTelegramCode = data.code;
            
            // Show verification modal
            showTelegramModal(data);
            
            // Start polling for verification
            telegramVerifyInterval = setInterval(checkTelegramVerification, 3000);
            
          } else if (data.setup_instructions) {
            // Bot not configured
            showToast('Telegram bot needs setup. Check console for instructions.', 'error');
            console.log('[TELEGRAM] Setup required:', data.setup_instructions);
          } else {
            showToast(data.error || 'Failed to connect Telegram', 'error');
          }
        } catch (e) {
          console.error('[TELEGRAM] Connect error:', e);
          showToast('Failed to connect Telegram', 'error');
        }
        
        btn.innerHTML = '<iconify-icon icon="solar:link-bold"></iconify-icon>Connect Telegram';
        btn.disabled = false;
      }
      
      function showTelegramModal(data) {
        const modal = document.createElement('div');
        modal.id = 'telegram-modal';
        modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[200]';
        modal.innerHTML = `
          <div class="bg-[#0D0D0D] border border-zinc-800 rounded-lg p-6 max-w-md mx-4">
            <div class="flex items-center gap-3 mb-4">
              <iconify-icon icon="logos:telegram" class="text-3xl"></iconify-icon>
              <div>
                <div class="text-[14px] text-white font-bold">Connect Telegram</div>
                <div class="text-[10px] text-zinc-500">Waiting for connection...</div>
              </div>
            </div>
            
            <div class="bg-zinc-900 border border-zinc-800 rounded p-4 mb-4">
              <div class="text-[10px] text-zinc-400 mb-2">1. Click the button that opened or copy this link:</div>
              <div class="flex items-center gap-2 mb-3">
                <input type="text" readonly value="${data.connect_url}" class="flex-1 bg-zinc-800 border border-zinc-700 text-[10px] text-white px-2 py-1.5 rounded font-mono">
                <button onclick="navigator.clipboard.writeText('${data.connect_url}');showToast('Copied!','success')" class="px-2 py-1.5 bg-zinc-700 text-white text-[10px] rounded">Copy</button>
              </div>
              <div class="text-[10px] text-zinc-400 mb-2">2. Message @${data.bot_username} on Telegram</div>
              <div class="text-[10px] text-zinc-400">3. The bot will confirm when connected</div>
            </div>
            
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2 text-[10px] text-zinc-500">
                <iconify-icon icon="solar:refresh-linear" class="animate-spin"></iconify-icon>
                Waiting for connection...
              </div>
              <button onclick="closeTelegramModal()" class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-white text-[10px] rounded">Cancel</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }
      
      function closeTelegramModal() {
        const modal = document.getElementById('telegram-modal');
        if (modal) modal.remove();
        if (telegramVerifyInterval) {
          clearInterval(telegramVerifyInterval);
          telegramVerifyInterval = null;
        }
        pendingTelegramCode = null;
      }
      
      async function checkTelegramVerification() {
        if (!pendingTelegramCode) return;
        
        try {
          const res = await fetch(`${API_BASE}/api/alerts/telegram/verify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: pendingTelegramCode })
          });
          const data = await res.json();
          
          if (data.success) {
            closeTelegramModal();
            updateTelegramUI(true);
            showToast('Telegram connected successfully!', 'success');
            
            // Send test message
            await fetch(`${API_BASE}/api/alerts/test`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ channel: 'telegram' })
            });
          }
        } catch (e) {
          console.log('[TELEGRAM] Still waiting...');
        }
      }
      
      function updateTelegramUI(connected) {
        const btn = document.getElementById('telegram-connect');
        if (connected) {
          btn.innerHTML = '<iconify-icon icon="solar:check-circle-bold" class="mr-1"></iconify-icon>Connected';
          btn.className = 'px-3 py-1.5 bg-green-600 text-white text-[10px] rounded flex items-center gap-1';
          btn.onclick = () => showToast('Telegram already connected!', 'info');
        }
      }

      // ==================== APPEARANCE SETTINGS ====================
      
      // Save appearance settings
      function saveAppearanceSettings() {
        // Get current theme
        const activeTheme = document.querySelector('.theme-btn.border-crimson-600');
        const theme = activeTheme?.dataset.theme || 'crimson';
        
        // Get chart type
        const activeChartType = document.querySelector('.chart-type-btn.bg-crimson-600\\/20');
        const chartType = activeChartType?.dataset.type || 'candles';
        
        // Get colors
        const upColor = document.getElementById('up-color')?.value || '#22c55e';
        const downColor = document.getElementById('down-color')?.value || '#ef4444';
        
        // Get toggles
        const showVolume = document.querySelector('[data-setting="volume"]')?.classList.contains('toggle-on') ?? true;
        const showGrid = document.querySelector('[data-setting="grid"]')?.classList.contains('toggle-on') ?? true;
        const compactMode = document.querySelector('[data-setting="compact"]')?.classList.contains('toggle-on') ?? false;
        const scanlines = document.querySelector('[data-setting="scanlines"]')?.classList.contains('toggle-on') ?? true;
        const animations = document.querySelector('[data-setting="animations"]')?.classList.contains('toggle-on') ?? true;
        
        // Get font size
        const activeFontBtn = document.querySelector('.font-size-btn.bg-crimson-600\\/20');
        const fontSize = activeFontBtn?.textContent.toLowerCase() || 'medium';
        
        const settings = {
          theme,
          chartType,
          upColor,
          downColor,
          showVolume,
          showGrid,
          compactMode,
          scanlines,
          animations,
          fontSize
        };
        
        // Save to localStorage with a clear key
        localStorage.setItem('bastionAppearance', JSON.stringify(settings));
        
        // Also update BastionSettings if available
        if (window.BastionSettings) {
          BastionSettings.current = BastionSettings.current || {};
          BastionSettings.current.appearance = settings;
          BastionSettings.saveSettings();
          BastionSettings.applyTheme(theme);
        }
        
        // Save to backend
        fetch(`${API_BASE}/api/settings/appearance`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        }).catch(e => console.log('[APPEARANCE] Backend save failed'));
        
        showToast('Appearance settings saved! Changes will apply across all pages.', 'success');
      }
      
      // Theme selection
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const theme = btn.dataset.theme;
          
          // Update UI - remove active from all
          document.querySelectorAll('.theme-btn').forEach(b => {
            b.classList.remove('border-crimson-600');
            b.classList.add('border-zinc-700');
            const activeLabel = b.querySelector('.active-label');
            if (activeLabel) activeLabel.remove();
          });
          
          // Set this button as active
          btn.classList.add('border-crimson-600');
          btn.classList.remove('border-zinc-700');
          
          // Add active label
          if (!btn.querySelector('.active-label')) {
            const label = document.createElement('div');
            label.className = 'text-[8px] text-crimson-400 active-label';
            label.textContent = 'Active';
            btn.appendChild(label);
          }
          
          // Apply theme globally - this changes the background!
          if (window.BastionSettings) {
            BastionSettings.applyTheme(theme);
            BastionSettings.saveSettings();
          }
          
          showToast(`Background theme: ${theme}`, 'success');
        });
      });
      
      // Chart type selection
      document.querySelectorAll('.chart-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.chart-type-btn').forEach(b => {
            b.classList.remove('bg-crimson-600/20', 'border-crimson-600/50', 'text-crimson-400');
            b.classList.add('bg-zinc-800', 'border-zinc-700', 'text-zinc-400');
          });
          btn.classList.add('bg-crimson-600/20', 'border-crimson-600/50', 'text-crimson-400');
          btn.classList.remove('bg-zinc-800', 'border-zinc-700', 'text-zinc-400');
          
          if (window.BastionSettings) {
            BastionSettings.update('appearance', 'chartType', btn.dataset.type);
          }
        });
      });
      
      // Color pickers
      const upColorPicker = document.getElementById('up-color');
      const downColorPicker = document.getElementById('down-color');
      
      if (upColorPicker) {
        upColorPicker.addEventListener('change', (e) => {
          const color = e.target.value;
          upColorPicker.nextElementSibling.textContent = color;
          if (window.BastionSettings) {
            BastionSettings.update('appearance', 'upColor', color);
          }
        });
      }
      
      if (downColorPicker) {
        downColorPicker.addEventListener('change', (e) => {
          const color = e.target.value;
          downColorPicker.nextElementSibling.textContent = color;
          if (window.BastionSettings) {
            BastionSettings.update('appearance', 'downColor', color);
          }
        });
      }
      
      // Font size buttons
      document.querySelectorAll('.font-size-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.font-size-btn').forEach(b => {
            b.classList.remove('bg-crimson-600/20', 'border-crimson-600/50', 'text-crimson-400');
            b.classList.add('bg-zinc-800', 'border-zinc-700', 'text-zinc-400');
          });
          btn.classList.add('bg-crimson-600/20', 'border-crimson-600/50', 'text-crimson-400');
          btn.classList.remove('bg-zinc-800', 'border-zinc-700', 'text-zinc-400');
          
          const size = btn.textContent.toLowerCase();
          if (window.BastionSettings) {
            BastionSettings.update('appearance', 'fontSize', size);
          }
        });
      });

      // ==================== ALERT PREFERENCES ====================
      const alertTypeIds = ['alert-whale', 'alert-price', 'alert-funding', 'alert-liquidation', 'alert-iros', 'alert-position', 'alert-oi', 'alert-research'];
      
      function saveAlertTypes() {
        const alertSettings = {};
        alertTypeIds.forEach(id => {
          const checkbox = document.getElementById(id);
          if (checkbox) alertSettings[id] = checkbox.checked;
        });
        localStorage.setItem('alertTypes', JSON.stringify(alertSettings));
        
        // Also sync to cloud if logged in
        const token = localStorage.getItem('bastion_token') || sessionStorage.getItem('bastion_token');
        if (token) {
          fetch(`${API_BASE}/api/auth/profile`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              token,
              whale_alerts: alertSettings['alert-whale'],
              price_alerts: alertSettings['alert-price'],
              funding_alerts: alertSettings['alert-funding'],
              liquidation_alerts: alertSettings['alert-liquidation'],
              iros_signals: alertSettings['alert-iros'],
              position_alerts: alertSettings['alert-position'],
              oi_alerts: alertSettings['alert-oi'],
              research_alerts: alertSettings['alert-research']
            })
          }).catch(e => console.error('[ALERTS] Cloud sync failed:', e));
        }
      }
      
      function loadAlertTypes() {
        // First try localStorage
        const saved = localStorage.getItem('alertTypes');
        if (saved) {
          try {
            const settings = JSON.parse(saved);
            alertTypeIds.forEach(id => {
              const checkbox = document.getElementById(id);
              if (checkbox && settings[id] !== undefined) {
                checkbox.checked = settings[id];
              }
            });
          } catch (e) {}
        }
      }
      
      // Apply alert settings from user profile data
      function applyAlertSettingsFromProfile(user) {
        const mapping = {
          'alert-whale': 'whale_alerts',
          'alert-price': 'price_alerts',
          'alert-funding': 'funding_alerts',
          'alert-liquidation': 'liquidation_alerts',
          'alert-iros': 'iros_signals',
          'alert-position': 'position_alerts',
          'alert-oi': 'oi_alerts',
          'alert-research': 'research_alerts'
        };
        
        alertTypeIds.forEach(id => {
          const checkbox = document.getElementById(id);
          const key = mapping[id];
          if (checkbox && user[key] !== undefined) {
            checkbox.checked = user[key];
          }
        });
      }
      
      async function saveAlertPreferences() {
        saveAlertTypes();
        
        // Also send Telegram test notification if connected
        const token = localStorage.getItem('bastion_token') || sessionStorage.getItem('bastion_token');
        if (token) {
          try {
            const res = await fetch(`${API_BASE}/api/telegram/test`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token })
            });
            const data = await res.json();
            if (data.success && data.sent) {
              showToast('Alert preferences saved! Test notification sent to Telegram.', 'success');
            } else {
              showToast('Alert preferences saved!', 'success');
            }
          } catch (e) {
            showToast('Alert preferences saved!', 'success');
          }
        } else {
          showToast('Alert preferences saved!', 'success');
        }
      }
      
      // Load on page ready
      document.addEventListener('DOMContentLoaded', loadAlertTypes);
      
      // ==================== TOAST NOTIFICATIONS ====================
      function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg text-[11px] font-bold z-[100] transition-all transform translate-y-2 opacity-0 ${
          type === 'success' ? 'bg-green-600 text-white' : 
          type === 'error' ? 'bg-crimson-600 text-white' : 
          'bg-zinc-800 text-white'
        }`;
        toast.innerHTML = `
          <div class="flex items-center gap-2">
            <iconify-icon icon="${type === 'success' ? 'solar:check-circle-bold' : type === 'error' ? 'solar:close-circle-bold' : 'solar:info-circle-bold'}"></iconify-icon>
            ${message}
          </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.classList.remove('translate-y-2', 'opacity-0');
        }, 10);
        
        setTimeout(() => {
          toast.classList.add('translate-y-2', 'opacity-0');
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // ==================== LOAD SAVED DATA ====================
      function loadSavedData() {
        // Load from global settings if available
        if (window.BastionSettings && BastionSettings.current) {
          const settings = BastionSettings.current;
          
          // Load appearance
          if (settings.appearance) {
            // Set theme button active
            const themeBtn = document.querySelector(`[data-theme="${settings.appearance.theme}"]`);
            if (themeBtn) {
              document.querySelectorAll('.theme-btn').forEach(b => {
                b.classList.remove('border-crimson-600');
                b.classList.add('border-zinc-700');
                const label = b.querySelector('.active-label');
                if (label) label.remove();
              });
              themeBtn.classList.add('border-crimson-600');
              themeBtn.classList.remove('border-zinc-700');
              if (!themeBtn.querySelector('.active-label')) {
                const label = document.createElement('div');
                label.className = 'text-[8px] text-crimson-400 active-label';
                label.textContent = 'Active';
                themeBtn.appendChild(label);
              }
            }
            
            // Set colors
            if (upColorPicker && settings.appearance.upColor) {
              upColorPicker.value = settings.appearance.upColor;
            }
            if (downColorPicker && settings.appearance.downColor) {
              downColorPicker.value = settings.appearance.downColor;
            }
          }
        }
        
        // Load profile
        const profile = JSON.parse(localStorage.getItem('profile') || '{}');
        if (profile.display_name || profile.name) {
          const name = profile.display_name || profile.name;
          document.getElementById('user-display-name').textContent = name;
          document.getElementById('user-avatar').textContent = name.charAt(0).toUpperCase();
          if (document.getElementById('profile-name')) {
            document.getElementById('profile-name').value = name;
          }
          if (document.getElementById('profile-avatar')) {
            document.getElementById('profile-avatar').textContent = name.charAt(0).toUpperCase();
          }
        }
        if (profile.email && document.getElementById('profile-email')) {
          document.getElementById('profile-email').value = profile.email;
        }
        
        // Load risk settings
        const risk = JSON.parse(localStorage.getItem('riskSettings') || '{}');
        if (risk.max_leverage || risk.maxLeverage) {
          const val = risk.max_leverage || risk.maxLeverage;
          if (leverageSlider) {
            leverageSlider.value = val;
            document.getElementById('leverage-value').textContent = val + 'x';
          }
        }
        if (risk.max_position_size || risk.maxPosition) {
          const val = risk.max_position_size || risk.maxPosition;
          if (positionSlider) {
            positionSlider.value = val;
            document.getElementById('position-size-value').textContent = val + '%';
          }
        }
      }

      // Load connected exchanges - use localStorage first, then try API
      async function loadConnectedExchanges() {
        // First check if we have saved credentials locally
        const savedCreds = getSavedCredentials();
        const savedExchanges = Object.keys(savedCreds);
        
        if (savedExchanges.length > 0) {
          console.log('[ACCOUNT] Found saved exchange credentials, auto-connecting...');
          await autoConnectExchanges();
          return;
        }
        
        // Fallback: try to load from API (for backward compatibility)
        try {
          const res = await fetch(`${API_BASE}/api/exchange/list?${getAuthParams()}`);
          if (res.ok) {
            const data = await res.json();
            if (data.exchanges && data.exchanges.length > 0) {
              data.exchanges.forEach(e => addConnectedExchange(e.exchange));
            }
          }
        } catch (e) {
          console.log('[ACCOUNT] Could not load exchanges from API');
        }
      }
      
      // Check Telegram status
      async function checkTelegramStatus() {
        try {
          const res = await fetch(`${API_BASE}/api/settings/alerts`);
          if (res.ok) {
            const data = await res.json();
            if (data.settings?.telegram_connected) {
              updateTelegramUI(true);
            }
          }
        } catch (e) {
          // Ignore
        }
      }

      // Initialize
      loadSavedData();
      loadConnectedExchanges();  // This will auto-connect saved exchanges
      checkTelegramStatus();
    </script>
</body>
</html>
