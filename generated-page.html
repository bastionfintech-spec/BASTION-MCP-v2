<html lang="en" class="bg-[#050505] scroll-smooth antialiased"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BASTION - Tactical Risk Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="settings.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=JetBrains+Mono:wght@400;500;700&display=swap');
      body { font-family: 'Inter', sans-serif; }
      .font-mono { font-family: 'JetBrains Mono', monospace; }
      /* Scrollbar */
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      /* Tactical Red Grid Overlay */
      .tactical-grid {
      background-size: 40px 40px;
      background-image:
      linear-gradient(to right, rgba(220, 38, 38, 0.07) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(220, 38, 38, 0.07) 1px, transparent 1px);
      mask-image: radial-gradient(ellipse at center top, black 40%, transparent 80%);
      -webkit-mask-image: radial-gradient(ellipse at center top, black 40%, transparent 80%);
      pointer-events: none;
      z-index: 1;
      }
      /* Scanline Effect */
      .scanlines {
      background: linear-gradient(
      to bottom,
      rgba(255,255,255,0),
      rgba(255,255,255,0) 50%,
      rgba(0,0,0,0.3) 50%,
      rgba(0,0,0,0.3)
      );
      background-size: 100% 3px;
      pointer-events: none;
      z-index: 50;
      opacity: 0.3;
      }
      /* Panel Loading Spinner */
      .panel-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem;
        color: #71717a;
        font-size: 10px;
        font-family: 'JetBrains Mono', monospace;
      }
      .panel-loading iconify-icon {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      .panel-loading.hidden { display: none; }
      
      /* Glitch Animation */
      .glitch-text {
      position: relative;
      display: inline-block;
      }
      .glitch-text::before,
      .glitch-text::after {
      content: attr(data-text);
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0A0A0A;
      }
      .glitch-text::before {
      left: 2px;
      text-shadow: -1px 0 #DC2626;
      clip: rect(24px, 550px, 90px, 0);
      animation: glitch-anim-2 3s infinite linear alternate-reverse;
      }
      .glitch-text::after {
      left: -2px;
      text-shadow: -1px 0 #fff;
      clip: rect(85px, 550px, 140px, 0);
      animation: glitch-anim 2.5s infinite linear alternate-reverse;
      }
      @keyframes glitch-anim {
      0% { clip: rect(12px, 9999px, 81px, 0); }
      20% { clip: rect(138px, 9999px, 95px, 0); }
      40% { clip: rect(40px, 9999px, 11px, 0); }
      60% { clip: rect(2px, 9999px, 66px, 0); }
      80% { clip: rect(121px, 9999px, 7px, 0); }
      100% { clip: rect(56px, 9999px, 31px, 0); }
      }
      @keyframes glitch-anim-2 {
      0% { clip: rect(124px, 9999px, 18px, 0); }
      20% { clip: rect(50px, 9999px, 148px, 0); }
      40% { clip: rect(15px, 9999px, 10px, 0); }
      60% { clip: rect(133px, 9999px, 86px, 0); }
      80% { clip: rect(78px, 9999px, 149px, 0); }
      100% { clip: rect(26px, 9999px, 18px, 0); }
      }
      /* Reveal Animations */
      @media (prefers-reduced-motion: no-preference) {
      .sys-reveal { opacity: 0; transform: translateY(20px); filter: blur(4px); transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1); }
      .sys-active { opacity: 1; transform: translate(0); filter: blur(0); }
      .sys-delay-100 { transition-delay: 100ms; }
      .sys-delay-200 { transition-delay: 200ms; }
      .sys-delay-300 { transition-delay: 300ms; }
      }
      /* CRT Flicker */
      @keyframes crt-flicker {
      0% { opacity: 0.95; }
      5% { opacity: 0.85; }
      10% { opacity: 0.95; }
      15% { opacity: 1; }
      100% { opacity: 0.95; }
      }
      .crt-effect { animation: crt-flicker 4s infinite; }
      
      /* Heatmap dominant pulse */
      @keyframes pulse-red {
        0%, 100% { box-shadow: inset 0 0 20px rgba(239,68,68,0.1); }
        50% { box-shadow: inset 0 0 30px rgba(239,68,68,0.25); }
      }
      @keyframes pulse-green {
        0%, 100% { box-shadow: inset 0 0 20px rgba(34,197,94,0.1); }
        50% { box-shadow: inset 0 0 30px rgba(34,197,94,0.25); }
      }
      .heatmap-long-dominant { animation: pulse-red 2s ease-in-out infinite; }
      .heatmap-short-dominant { animation: pulse-green 2s ease-in-out infinite; }
    </style>
    <script>
      tailwind.config = {
      theme: {
      extend: {
      colors: {
      'crimson': {
      400: '#F87171',
      500: '#EF4444',
      600: '#DC2626',
      700: '#B91C1C',
      900: '#7F1D1D',
      950: '#450A0A'
      },
      'zinc': {
      850: '#1f1f22',
      900: '#18181b',
      950: '#09090b',
      }
      },
      backgroundImage: {
      'scanline': "url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNCIgaGVpZ2h0PSI0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0xIDFoMnYySDF6IiBmaWxsPSJyZ2JhKDAsMCwwLDAuMikiIGZpbGwtcnVsZT0iZXZlbm9kZCIvPjwvc3ZnPg==')"
      }
      }
      }
      };
    </script>

    <link id="all-fonts-link-font-geist" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&amp;display=swap">
    <style id="all-fonts-style-font-geist">
      .font-geist { font-family: 'Geist', sans-serif !important; }
    </style>
    <link id="all-fonts-link-font-roboto" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&amp;display=swap">
    <style id="all-fonts-style-font-roboto">
      .font-roboto { font-family: 'Roboto', sans-serif !important; }
    </style>
    <link id="all-fonts-link-font-montserrat" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&amp;display=swap">
    <style id="all-fonts-style-font-montserrat">
      .font-montserrat { font-family: 'Montserrat', sans-serif !important; }
    </style>
    <link id="all-fonts-link-font-poppins" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&amp;display=swap">
    <style id="all-fonts-style-font-poppins">
      .font-poppins { font-family: 'Poppins', sans-serif !important; }
    </style>
    <link id="all-fonts-link-font-playfair" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;900&amp;display=swap">
    <style id="all-fonts-style-font-playfair">
      .font-playfair { font-family: 'Playfair Display', serif !important; }
    </style>
    <link id="all-fonts-link-font-instrument-serif" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Instrument+Serif:wght@400;500;600;700&amp;display=swap">
    <style id="all-fonts-style-font-instrument-serif">
      .font-instrument-serif { font-family: 'Instrument Serif', serif !important; }
    </style>
    <link id="all-fonts-link-font-merriweather" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700;900&amp;display=swap">
    <style id="all-fonts-style-font-merriweather">
      .font-merriweather { font-family: 'Merriweather', serif !important; }
    </style>
    <link id="all-fonts-link-font-bricolage" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@300;400;500;600;700&amp;display=swap">
    <style id="all-fonts-style-font-bricolage">
      .font-bricolage { font-family: 'Bricolage Grotesque', sans-serif !important; }
    </style>
    <link id="all-fonts-link-font-jakarta" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&amp;display=swap">
    <style id="all-fonts-style-font-jakarta">
      .font-jakarta { font-family: 'Plus Jakarta Sans', sans-serif !important; }
    </style>
    <link id="all-fonts-link-font-manrope" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&amp;display=swap">
    <style id="all-fonts-style-font-manrope">
      .font-manrope { font-family: 'Manrope', sans-serif !important; }
    </style>
    <link id="all-fonts-link-font-space-grotesk" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&amp;display=swap">
    <style id="all-fonts-style-font-space-grotesk">
      .font-space-grotesk { font-family: 'Space Grotesk', sans-serif !important; }
    </style>
    <link id="all-fonts-link-font-work-sans" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700;800&amp;display=swap">
    <style id="all-fonts-style-font-work-sans">
      .font-work-sans { font-family: 'Work Sans', sans-serif !important; }
    </style>
    <link id="all-fonts-link-font-pt-serif" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&amp;display=swap">
    <style id="all-fonts-style-font-pt-serif">
      .font-pt-serif { font-family: 'PT Serif', serif !important; }
    </style>
    <link id="all-fonts-link-font-geist-mono" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@300;400;500;600;700&amp;display=swap">
    <style id="all-fonts-style-font-geist-mono">
      .font-geist-mono { font-family: 'Geist Mono', monospace !important; }
    </style>
    <link id="all-fonts-link-font-space-mono" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&amp;display=swap">
    <style id="all-fonts-style-font-space-mono">
      .font-space-mono { font-family: 'Space Mono', monospace !important; }
    </style>
    <link id="all-fonts-link-font-quicksand" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&amp;display=swap">
    <style id="all-fonts-style-font-quicksand">
      .font-quicksand { font-family: 'Quicksand', sans-serif !important; }
    </style>
    <link id="all-fonts-link-font-nunito" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800&amp;display=swap">
    <style id="all-fonts-style-font-nunito">
      .font-nunito { font-family: 'Nunito', sans-serif !important; }
    </style>
    <link id="all-fonts-link-font-newsreader" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Newsreader:opsz,wght@6..72,400..800&amp;display=swap">
    <style id="all-fonts-style-font-newsreader">
      .font-newsreader { font-family: 'Newsreader', serif !important; }
    </style>
    <link id="all-fonts-link-font-google-sans-flex" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Google+Sans+Flex:wght@400;500;600;700&amp;display=swap">
    <style id="all-fonts-style-font-google-sans-flex">
      .font-google-sans-flex { font-family: 'Google Sans Flex', sans-serif !important; }
    </style>
    <link id="all-fonts-link-font-oswald" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&amp;display=swap">
    <style id="all-fonts-style-font-oswald">
      .font-oswald { font-family: 'Oswald', sans-serif !important; }
    </style>
    <link id="all-fonts-link-font-dm-sans" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&amp;display=swap">
    <style id="all-fonts-style-font-dm-sans">
      .font-dm-sans { font-family: 'DM Sans', sans-serif !important; }
    </style>
    <link id="all-fonts-link-font-cormorant" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&amp;display=swap">
    <style id="all-fonts-style-font-cormorant">
      .font-cormorant { font-family: 'Cormorant Garamond', serif !important; }
    </style>
  </head>
  <body class="text-zinc-400 min-h-screen flex flex-col selection:bg-crimson-600 selection:text-white bg-[#050505] overflow-x-auto font-sans">
    <!-- 1. The CRIMSON ENERGY BEAM (Top Center) -->
    <div class="fixed top-0 left-1/2 -translate-x-1/2 w-[1200px] h-[600px] bg-gradient-to-b from-crimson-600/25 via-crimson-900/10 to-transparent blur-[100px] rounded-full pointer-events-none z-0 mix-blend-screen opacity-80"></div>
    <div class="fixed top-[-100px] left-1/2 -translate-x-1/2 w-[600px] h-[300px] bg-crimson-500/20 blur-[80px] rounded-full pointer-events-none z-0 mix-blend-screen"></div>

    <!-- 2. Tactical Grid Overlay -->
    <div class="fixed inset-0 tactical-grid pointer-events-none z-0"></div>

    <!-- 3. Scanlines Overlay (Global) -->
    <div class="fixed inset-0 pointer-events-none z-50 scanlines mix-blend-overlay"></div>

    <!-- Header -->

    <main class="flex-1 flex flex-col min-h-screen font-sans z-10 relative overflow-x-auto" style="min-width: 2200px;">
      <!-- TERMINAL CONTAINER - FULL SCREEN ULTRAWIDE -->
      <div class="w-full h-full bg-[#0A0A0A] border-t border-zinc-800 relative overflow-x-auto flex-1 flex flex-col" style="min-width: 1800px;">
        <!-- Scanline overlay specific to terminal -->
        <div class="absolute inset-0 pointer-events-none z-50 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.1)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] bg-[length:100%_2px,3px_100%] bg-repeat opacity-20 mix-blend-overlay"></div>

        <!-- TERMINAL TOP BAR -->
        <div class="bg-zinc-900/90 border-b border-zinc-800 p-2 flex flex-col lg:flex-row items-center justify-between gap-4 text-[10px] font-mono select-none relative z-20 border-l-2 border-crimson-600">
          <!-- Left -->
          <div class="flex items-center gap-6 w-full lg:w-auto justify-between lg:justify-start">
            <div class="flex items-center gap-2 font-bold text-white tracking-tighter text-sm">
              <iconify-icon icon="solar:shield-bold" class="text-crimson-600"></iconify-icon>
              BASTION
            </div>
            <div class="flex items-center gap-2 px-3 py-1 bg-green-950/30 border border-green-900/50 rounded text-green-400 shadow-[0_0_15px_rgba(34,197,94,0.25)] animate-[pulse_3s_infinite]">
              <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
              LIVE
            </div>
            <div class="flex items-center gap-2 text-zinc-400" id="exchange-indicator">
              <iconify-icon icon="solar:link-circle-bold" class="text-green-500"></iconify-icon>
              <span id="connected-exchange-name">BINANCE-FUTURES</span>
            </div>
            
            <!-- USER PROFILE -->
            <div id="user-profile-bar" class="flex items-center gap-3 px-3 py-1 bg-zinc-800/50 border border-zinc-700/50 rounded-lg ml-2">
              <div class="relative">
                <div id="header-avatar" class="w-7 h-7 rounded-full bg-gradient-to-br from-crimson-600 to-crimson-900 flex items-center justify-center text-white font-bold text-xs overflow-hidden border border-crimson-500/50">
                  <span id="header-avatar-letter">?</span>
                  <img id="header-avatar-img" src="" class="hidden w-full h-full object-cover">
                </div>
                <div id="header-gif-mini" class="hidden absolute -bottom-1 -right-1 w-4 h-4 rounded overflow-hidden border border-zinc-600">
                  <img id="header-gif-img" src="" class="w-full h-full object-cover">
                </div>
              </div>
              <div class="flex flex-col">
                <span id="header-username" class="text-white text-[10px] font-bold">Guest</span>
                <span id="header-user-status" class="text-zinc-500 text-[8px]">Not logged in</span>
              </div>
            </div>
          </div>

          <!-- Center (Stats) -->
          <div class="flex items-center gap-0 border-x border-zinc-800/50 hidden lg:flex">
            <div class="px-6 py-1 flex flex-col items-center">
              <span class="text-zinc-500 text-[9px] uppercase tracking-wider">
                SESSION P&amp;L
              </span>
              <span data-stat="session-pnl" class="text-green-500 font-bold">+$4,247 (+2.8%)</span>
            </div>
            <div class="px-6 py-1 flex flex-col items-center border-l border-zinc-800/50">
              <span class="text-zinc-500 text-[9px] uppercase tracking-wider">
                ACTIVE POS
              </span>
              <span data-stat="active-pos" class="text-white font-bold">3 OPEN</span>
            </div>
            <div class="px-6 py-1 flex flex-col items-center border-l border-zinc-800/50">
              <span class="text-zinc-500 text-[9px] uppercase tracking-wider">
                WIN RATE
              </span>
              <span data-stat="win-rate" class="text-white font-bold">73%</span>
            </div>
            <div class="px-6 py-1 flex flex-col items-center border-l border-zinc-800/50">
              <span class="text-zinc-500 text-[9px] uppercase tracking-wider">
                AVG R
              </span>
              <span data-stat="avg-r" class="text-green-500 font-bold">+1.8R</span>
            </div>
            <div class="px-6 py-1 flex flex-col items-center border-l border-zinc-800/50">
              <span class="text-zinc-500 text-[9px] uppercase tracking-wider">
                DRAWDOWN
              </span>
              <span data-stat="drawdown" class="text-crimson-500 font-bold">-0.4R</span>
            </div>
          </div>

          <!-- Right -->
          <div class="flex items-center gap-6 w-full lg:w-auto justify-between lg:justify-end">
            <a href="/visualizations" class="flex items-center gap-2 px-3 py-1 bg-crimson-600/20 border border-crimson-600/50 rounded text-crimson-400 hover:bg-crimson-600/30 hover:text-crimson-300 transition-all font-bold text-[10px]">
              <iconify-icon icon="solar:graph-new-bold" class="text-sm"></iconify-icon>
              3D VIZ
            </a>
            <a href="/research" class="flex items-center gap-2 px-3 py-1 bg-purple-600/20 border border-purple-600/50 rounded text-purple-400 hover:bg-purple-600/30 hover:text-purple-300 transition-all font-bold text-[10px]">
              <iconify-icon icon="solar:document-text-bold" class="text-sm"></iconify-icon>
              RESEARCH
            </a>
            <a href="/account" class="flex items-center gap-2 px-3 py-1 bg-zinc-700/30 border border-zinc-600/50 rounded text-zinc-400 hover:bg-zinc-700/50 hover:text-zinc-200 transition-all font-bold text-[10px]">
              <iconify-icon icon="solar:user-circle-bold" class="text-sm"></iconify-icon>
              ACCOUNT
            </a>
            <div class="flex items-center gap-2 text-crimson-500 font-bold animate-pulse">
              <iconify-icon icon="solar:brain-bold"></iconify-icon>
              NEURAL ACTIVE
            </div>
            <div id="live-indicator" class="flex items-center gap-2 text-green-400 font-mono text-[10px] px-2 py-0.5 bg-green-900/30 border border-green-800/50 rounded transition-all">
              <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.8)]"></span>
              LIVE
            </div>
            <div data-time="utc" class="text-zinc-400 font-mono text-[10px]">14:32:07 UTC</div>
          </div>
        </div>

        <!-- TERMINAL GRID - ULTRAWIDE HORIZONTAL LAYOUT -->
        <div class="flex flex-1 divide-x divide-zinc-800 relative z-10 overflow-x-auto" style="min-width: 2200px;">
          <!-- COL: MARKET PULSE -->
          <div class="flex flex-col border-r border-zinc-800 bg-[#0B0B0B] flex-shrink-0" style="width: 180px;">
            <div class="p-2 border-b border-zinc-800 flex justify-between items-center text-[10px] font-mono bg-zinc-900/30 border-l-2 border-crimson-600">
              <span class="text-zinc-400 font-bold tracking-wider">
                MARKET PULSE
              </span>
              <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
            </div>
            <div class="flex-1 overflow-y-auto no-scrollbar" data-panel="market-pulse">
              <!-- Loading State -->
              <div id="market-pulse-loading" class="panel-loading">
                <iconify-icon icon="solar:refresh-linear"></iconify-icon>
                <span>Loading market data...</span>
              </div>
              <div id="market-pulse-content">
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between items-center">
                  <span>Liquidation Radar</span>
                  <span class="text-[8px] text-crimson-500 animate-pulse">COINGLASS</span>
                </div>
                <div class="space-y-2 text-[9px] font-mono" data-liq="container">
                  <div class="">
                    <div class="flex justify-between text-crimson-400 mb-0.5">
                      <span>LONGS AT RISK</span>
                      <span data-liq="long-value">$47M</span>
                    </div>
                    <div class="w-full bg-zinc-900 h-2.5 rounded-sm shadow-inner overflow-visible">
                      <div data-liq="long-bar" class="bg-crimson-500 h-full w-[75%] shadow-[0_0_12px_rgba(220,38,38,0.8)] rounded-sm transition-all"></div>
                    </div>
                    <div class="flex justify-between text-zinc-600 mt-0.5">
                      <span data-liq="long-price">$94,200</span>
                      <span data-liq="long-risk">High Risk</span>
                    </div>
                  </div>
                  <div class="">
                    <div class="flex justify-between text-green-400 mb-0.5">
                      <span>SHORTS AT RISK</span>
                      <span data-liq="short-value">$38M</span>
                    </div>
                    <div class="w-full bg-zinc-900 h-2.5 rounded-sm shadow-inner overflow-visible">
                      <div data-liq="short-bar" class="bg-green-500 h-full w-[60%] shadow-[0_0_12px_rgba(34,197,94,0.8)] rounded-sm transition-all"></div>
                    </div>
                    <div class="flex justify-between text-zinc-600 mt-0.5">
                      <span data-liq="short-price">$98,400</span>
                      <span data-liq="short-risk">Med Risk</span>
                    </div>
                  </div>
                  <div class="pt-1 text-center text-zinc-400 bg-zinc-900/30 py-1 rounded border border-zinc-800/50">
                    BIAS:
                    <span data-liq="bias" class="text-crimson-500 font-bold">
                      LONG HEAVY
                    </span>
                  </div>
                </div>
              </div>
              <!-- LIQUIDATION HEATMAP VISUALIZATION -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between items-center">
                  <span>Liq Heatmap</span>
                  <span data-heatmap="price" class="text-white font-bold">--</span>
                </div>
                <div class="relative h-[140px] bg-zinc-900/50 rounded border border-zinc-800/50 overflow-hidden transition-all duration-500" id="heatmap-container">
                  <!-- Current price line -->
                  <div data-heatmap="current-line" class="absolute left-0 right-0 h-0.5 bg-white z-20" style="top: 50%;">
                    <span class="absolute right-0 text-[7px] text-white bg-zinc-800 px-1 -translate-y-1/2 z-30">NOW</span>
                  </div>
                  <!-- Heatmap bars will be rendered here -->
                  <div data-heatmap="bars" class="absolute inset-0 flex flex-col justify-around py-2 px-1">
                    <!-- Populated by JS -->
                  </div>
                </div>
                <div class="flex justify-between text-[8px] font-mono mt-1">
                  <span class="text-red-500">◀ LONGS LIQ</span>
                  <span data-heatmap="updated" class="text-zinc-600">--</span>
                  <span class="text-green-500">SHORTS LIQ ▶</span>
                </div>
              </div>
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide">
                  Funding &amp; Basis
                </div>
                <div class="grid grid-cols-3 gap-1 text-[9px] font-mono mb-2" data-funding="container">
                  <span class="text-zinc-400">BTC</span>
                  <span data-funding="btc-rate" class="text-green-500 text-right">+0.012%</span>
                  <span data-funding="btc-bias" class="text-zinc-500 text-right">BULL</span>
                  <span class="text-zinc-400">ETH</span>
                  <span data-funding="eth-rate" class="text-green-500 text-right">+0.009%</span>
                  <span data-funding="eth-bias" class="text-zinc-500 text-right">NEUT</span>
                  <span class="text-zinc-400">SOL</span>
                  <span data-funding="sol-rate" class="text-amber-500 text-right">+0.020%</span>
                  <span data-funding="sol-bias" class="text-amber-500 text-right">CROWD</span>
                </div>
                <div class="flex justify-between text-[9px] text-zinc-500 font-mono bg-zinc-900/20 p-1">
                  <span data-funding="next">Next: 2h 14m</span>
                  <span data-funding="basis">Basis: +0.12%</span>
                </div>
              </div>
              <!-- ETF FLOWS -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span>BTC ETF Flows (24H)</span>
                  <span data-etf="signal" class="text-zinc-400">--</span>
                </div>
                <div data-etf="total" class="text-[14px] font-bold font-mono mb-1 text-white">--</div>
                <div data-etf="container" class="space-y-1 text-[8px] font-mono">
                  <div class="flex justify-between items-center">
                    <span class="text-zinc-400">IBIT</span>
                    <div class="flex-1 mx-2 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                      <div class="h-full bg-green-500 w-[60%] transition-all"></div>
                    </div>
                    <span class="text-green-400">+$245M</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-zinc-400">FBTC</span>
                    <div class="flex-1 mx-2 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                      <div class="h-full bg-green-500 w-[30%] transition-all"></div>
                    </div>
                    <span class="text-green-400">+$89M</span>
                  </div>
                </div>
              </div>
              <!-- EXCHANGE NET FLOW -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span>Exchange Net Flow</span>
                  <span data-exflow="signal" class="text-zinc-400">--</span>
                </div>
                <div class="grid grid-cols-2 gap-2 text-[9px] font-mono">
                  <div>
                    <div class="text-zinc-500 text-[8px]">INFLOWS</div>
                    <div data-exflow="inflows" class="text-red-400 font-bold">--</div>
                  </div>
                  <div>
                    <div class="text-zinc-500 text-[8px]">OUTFLOWS</div>
                    <div data-exflow="outflows" class="text-green-400 font-bold">--</div>
                  </div>
                </div>
                <div data-exflow="net" class="mt-1 text-[9px] text-center py-1 bg-zinc-900/50 rounded border border-zinc-800/50 text-zinc-500">
                  Net: --
                </div>
              </div>
              <!-- OI BY EXCHANGE -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide">
                  OI By Exchange
                </div>
                <div data-oi-exchange="container" class="space-y-1 text-[8px] font-mono">
                  <div class="flex justify-between items-center">
                    <span class="text-zinc-400 w-14">Binance</span>
                    <div class="flex-1 mx-1 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                      <div class="h-full bg-blue-500 w-[45%] transition-all"></div>
                  </div>
                    <span class="text-zinc-300 w-12 text-right">$4.2B</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-zinc-400 w-14">CME</span>
                    <div class="flex-1 mx-1 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                      <div class="h-full bg-amber-500 w-[19%] transition-all"></div>
                </div>
                    <span class="text-zinc-300 w-12 text-right">$1.8B</span>
              </div>
                  <div class="flex justify-between items-center">
                    <span class="text-zinc-400 w-14">OKX</span>
                    <div class="flex-1 mx-1 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                      <div class="h-full bg-purple-500 w-[12%] transition-all"></div>
            </div>
                    <span class="text-zinc-300 w-12 text-right">$1.1B</span>
          </div>
                </div>
              </div>
              <!-- FUNDING ARBITRAGE -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span>Funding Arb</span>
                  <span data-fundarb="opportunity" class="text-zinc-400">--</span>
                </div>
                <div data-fundarb="container" class="space-y-1 text-[8px] font-mono">
                  <div class="flex justify-between">
                    <span class="text-zinc-400">Highest</span>
                    <span data-fundarb="highest" class="text-green-400">Binance +0.012%</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-zinc-400">Lowest</span>
                    <span data-fundarb="lowest" class="text-red-400">dYdX -0.003%</span>
                  </div>
                  <div class="flex justify-between border-t border-zinc-800/50 pt-1 mt-1">
                    <span class="text-zinc-400">Spread</span>
                    <span data-fundarb="spread" class="text-amber-400 font-bold">0.015%</span>
                  </div>
                </div>
              </div>
              </div>
            </div>
          </div>
          
          <!-- COL: ON-CHAIN INTEL -->
          <div class="flex flex-col border-r border-zinc-800 bg-[#0B0B0B] flex-shrink-0" style="width: 180px;">
            <div class="p-2 border-b border-zinc-800 flex justify-between items-center text-[10px] font-mono bg-zinc-900/30">
              <span class="text-zinc-400 font-bold tracking-wider">
                ON-CHAIN
              </span>
              <span class="w-1.5 h-1.5 rounded-full bg-cyan-500 animate-pulse"></span>
          </div>
            <div class="flex-1 overflow-y-auto no-scrollbar" data-panel="onchain">
              <!-- Loading State -->
              <div id="onchain-loading" class="panel-loading">
                <iconify-icon icon="solar:refresh-linear"></iconify-icon>
                <span>Loading on-chain data...</span>
              </div>
              <!-- EXCHANGE RESERVES -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between items-center">
                  <span>Exchange Reserves</span>
                  <span class="text-[8px] text-cyan-500">LIVE</span>
                </div>
                <div class="space-y-2 text-[9px] font-mono">
                  <div>
                    <div class="flex justify-between text-zinc-400 mb-0.5">
                      <span>BTC</span>
                      <span data-onchain="btc-reserve" class="text-white">2.1M</span>
                    </div>
                    <div class="w-full bg-zinc-900 h-1.5 rounded-sm overflow-hidden">
                      <div data-onchain="btc-reserve-bar" class="bg-cyan-500 h-full w-[65%] transition-all"></div>
                    </div>
                    <div class="flex justify-between text-[8px] text-zinc-600 mt-0.5">
                      <span data-onchain="btc-reserve-change" class="text-red-400">-3.2%</span>
                      <span>7d change</span>
                    </div>
                  </div>
                  <div>
                    <div class="flex justify-between text-zinc-400 mb-0.5">
                      <span>ETH</span>
                      <span data-onchain="eth-reserve" class="text-white">18.4M</span>
                    </div>
                    <div class="w-full bg-zinc-900 h-1.5 rounded-sm overflow-hidden">
                      <div data-onchain="eth-reserve-bar" class="bg-purple-500 h-full w-[58%] transition-all"></div>
                    </div>
                    <div class="flex justify-between text-[8px] text-zinc-600 mt-0.5">
                      <span data-onchain="eth-reserve-change" class="text-red-400">-1.8%</span>
                      <span>7d change</span>
                    </div>
                  </div>
                </div>
              </div>
              <!-- STABLECOIN FLOWS -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide">
                  Stablecoin Flows (24H)
                </div>
                <div class="space-y-2 text-[9px] font-mono">
                  <div class="flex justify-between items-center">
                    <span class="text-zinc-400">USDT</span>
                    <div class="flex items-center gap-1">
                      <span data-onchain="usdt-flow" class="text-green-400 font-bold">+$847M</span>
                      <span class="text-[7px] text-green-500">MINTED</span>
                    </div>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-zinc-400">USDC</span>
                    <div class="flex items-center gap-1">
                      <span data-onchain="usdc-flow" class="text-red-400 font-bold">-$124M</span>
                      <span class="text-[7px] text-red-500">BURNED</span>
                    </div>
                  </div>
                  <div class="text-center py-1 bg-zinc-900/50 rounded border border-zinc-800/50 mt-2">
                    <span class="text-zinc-500 text-[8px]">Net Inflow:</span>
                    <span data-onchain="stables-net" class="text-green-400 font-bold ml-1">+$723M</span>
                  </div>
                </div>
              </div>
              <!-- MINER FLOWS -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span>Miner Outflows</span>
                  <span data-onchain="miner-signal" class="text-zinc-400">--</span>
                </div>
                <div class="text-[9px] font-mono">
                  <div class="flex justify-between mb-1">
                    <span class="text-zinc-400">To Exchanges (24h)</span>
                    <span data-onchain="miner-outflow" class="text-amber-400 font-bold">342 BTC</span>
                  </div>
                  <div class="flex justify-between text-[8px] text-zinc-600">
                    <span>7d Avg: 89 BTC</span>
                    <span data-onchain="miner-delta" class="text-red-400">+284%</span>
                  </div>
                  <div data-onchain="miner-warning" class="text-[8px] text-center py-1 mt-2 rounded bg-amber-900/30 border border-amber-800/50 text-amber-400">
                    ELEVATED MINER SELLING
                  </div>
                </div>
              </div>
              <!-- DORMANT SUPPLY -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide">
                  Dormant Supply (1yr+)
                </div>
                <div class="text-[9px] font-mono">
                  <div class="flex justify-between mb-1">
                    <span class="text-zinc-400">Moved Today</span>
                    <span data-onchain="dormant-moved" class="text-white font-bold">1,247 BTC</span>
                  </div>
                  <div class="flex justify-between text-[8px] text-zinc-600">
                    <span>7d Avg: 312 BTC</span>
                    <span data-onchain="dormant-delta" class="text-amber-400">+300%</span>
                  </div>
                  <div class="text-[8px] text-center py-1 mt-2 bg-zinc-900/50 rounded border border-zinc-800/50">
                    <span class="text-zinc-500">Signal:</span>
                    <span data-onchain="dormant-signal" class="text-amber-400 font-bold ml-1">DISTRIBUTION</span>
                  </div>
                </div>
              </div>
              <!-- ACTIVE ADDRESSES -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide">
                  Network Activity
                </div>
                <div class="text-[9px] font-mono space-y-1">
                  <div class="flex justify-between">
                    <span class="text-zinc-400">Active Addr</span>
                    <span data-onchain="active-addr" class="text-white">892K</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-zinc-400">New Addr</span>
                    <span data-onchain="new-addr" class="text-green-400">+42K</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-zinc-400">Tx Count</span>
                    <span data-onchain="tx-count" class="text-white">324K</span>
                  </div>
                </div>
              </div>
              <!-- WHALE ACCUMULATION -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span>Whale Wallets (1K+ BTC)</span>
                </div>
                <div class="text-[9px] font-mono">
                  <div class="flex justify-between mb-1">
                    <span class="text-zinc-400">Net Change (7d)</span>
                    <span data-onchain="whale-change" class="text-green-400 font-bold">+12,847 BTC</span>
                  </div>
                  <div class="w-full h-2 bg-zinc-900 rounded-full overflow-hidden">
                    <div data-onchain="whale-bar" class="h-full bg-gradient-to-r from-green-600 to-green-400 w-[72%] transition-all"></div>
                  </div>
                  <div class="text-[8px] text-center mt-1 text-green-400">
                    ACCUMULATION PHASE
                  </div>
                </div>
              </div>
              <!-- WHALE FLOW - LIVE TRANSACTIONS -->
              <div class="p-2 flex-1 flex flex-col min-h-0">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span>Whale Flow</span>
                  <span class="text-amber-500 animate-pulse">LIVE</span>
                </div>
                <div data-whale="container" class="space-y-1.5 text-[8px] font-mono overflow-y-auto flex-1 max-h-[200px] no-scrollbar">
                  <div class="border-l-2 border-crimson-500 pl-2 py-0.5">
                    <div class="flex justify-between">
                      <span class="text-zinc-500">14:28 - Binance</span>
                      <span class="text-crimson-400">DEPOSIT</span>
                    </div>
                    <div class="text-white font-bold">500 BTC ($48M)</div>
                  </div>
                  </div>
                </div>
              </div>
            </div>

          <!-- COL: RISK SIMULATOR -->
          <div class="flex flex-col border-r border-zinc-800 bg-[#0B0B0B] flex-shrink-0" style="width: 200px;">
            <div class="p-2 border-b border-zinc-800 flex justify-between items-center text-[10px] font-mono bg-zinc-900/30">
              <span class="text-zinc-400 font-bold tracking-wider">
                RISK SIM
                  </span>
              <iconify-icon icon="solar:calculator-bold" class="text-zinc-500"></iconify-icon>
                </div>
            <div class="flex-1 overflow-y-auto no-scrollbar" data-panel="risksim">
              <!-- KELLY CRITERION -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span class="flex items-center gap-1">
                    <iconify-icon icon="solar:chart-bold" class="text-emerald-400"></iconify-icon>
                    Kelly Criterion
                  </span>
                  <span class="text-emerald-400 animate-pulse">LIVE</span>
                </div>
                <div class="text-center mb-3">
                  <div data-kelly="optimal" class="text-2xl font-bold text-emerald-400 font-mono">2.4%</div>
                  <div class="text-[8px] text-zinc-500">Optimal Position Size</div>
                </div>
                <div class="space-y-1 text-[8px] font-mono">
                  <div class="flex justify-between">
                    <span class="text-zinc-500">Win Rate</span>
                    <span data-kelly="winrate" class="text-white">73%</span>
                </div>
                  <div class="flex justify-between">
                    <span class="text-zinc-500">Avg Win</span>
                    <span data-kelly="avgwin" class="text-green-400">+2.1R</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-zinc-500">Avg Loss</span>
                    <span data-kelly="avgloss" class="text-red-400">-1.0R</span>
                  </div>
                  <div class="flex justify-between border-t border-zinc-800/50 pt-1 mt-1">
                    <span class="text-zinc-500">Half-Kelly</span>
                    <span data-kelly="half" class="text-amber-400 font-bold">1.2%</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-zinc-500">Quarter-Kelly</span>
                    <span data-kelly="quarter" class="text-zinc-400">0.6%</span>
                  </div>
                </div>
                <div data-kelly="recommendation" class="mt-2 text-[7px] text-center py-1 bg-emerald-900/20 border border-emerald-800/50 rounded text-emerald-400">
                  Use Half-Kelly (conservative)
                </div>
              </div>
              <!-- POSITION SIMULATOR -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span class="flex items-center gap-1">
                    <iconify-icon icon="solar:graph-new-bold" class="text-purple-400"></iconify-icon>
                    Position Simulator
                  </span>
                  <span data-monte="status" class="text-zinc-500 text-[8px]">SELECT POSITION</span>
                </div>
                
                <!-- Position Selector -->
                <select id="sim-position-select" class="w-full bg-zinc-900 border border-zinc-700 text-[9px] text-white px-2 py-1.5 rounded mb-2 font-mono">
                  <option value="">Select a position...</option>
                </select>
                
                <div class="text-center mb-2">
                  <button data-action="run-monte-carlo" class="bg-purple-600 hover:bg-purple-700 text-white text-[9px] font-bold px-3 py-1.5 rounded-sm shadow-[0_0_10px_rgba(168,85,247,0.3)] font-mono uppercase transition-all w-full">
                    RUN SIMULATION
                  </button>
                </div>
                
                <!-- Position Info -->
                <div id="sim-position-info" class="hidden text-[8px] font-mono mb-2 p-2 bg-zinc-900/50 rounded border border-zinc-800">
                  <div class="flex justify-between mb-1">
                    <span class="text-zinc-500">Entry</span>
                    <span id="sim-entry" class="text-white">--</span>
                  </div>
                  <div class="flex justify-between mb-1">
                    <span class="text-zinc-500">Current</span>
                    <span id="sim-current" class="text-white">--</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-zinc-500">Leverage</span>
                    <span id="sim-leverage" class="text-amber-400">--</span>
                  </div>
                </div>
                
                <!-- Profit Targets -->
                <div data-monte="results" class="space-y-1.5 text-[8px] font-mono">
                  <div class="text-[9px] text-zinc-400 uppercase mb-1">Profit Targets</div>
                  
                  <div class="flex justify-between items-center p-1.5 bg-green-900/20 border border-green-800/30 rounded">
                    <div>
                      <span class="text-green-400 font-bold">+15%</span>
                      <span class="text-zinc-500 ml-1">TP1</span>
                    </div>
                    <div class="text-right">
                      <div id="sim-tp1-price" class="text-green-400">$--</div>
                      <div id="sim-tp1-prob" class="text-[7px] text-zinc-500">--% chance</div>
                    </div>
                  </div>
                  
                  <div class="flex justify-between items-center p-1.5 bg-green-900/30 border border-green-700/40 rounded">
                    <div>
                      <span class="text-green-400 font-bold">+50%</span>
                      <span class="text-zinc-500 ml-1">TP2</span>
                    </div>
                    <div class="text-right">
                      <div id="sim-tp2-price" class="text-green-400">$--</div>
                      <div id="sim-tp2-prob" class="text-[7px] text-zinc-500">--% chance</div>
                    </div>
                  </div>
                  
                  <div class="flex justify-between items-center p-1.5 bg-green-900/40 border border-green-600/50 rounded">
                    <div>
                      <span class="text-green-400 font-bold">+80%</span>
                      <span class="text-zinc-500 ml-1">TP3</span>
                    </div>
                    <div class="text-right">
                      <div id="sim-tp3-price" class="text-green-400">$--</div>
                      <div id="sim-tp3-prob" class="text-[7px] text-zinc-500">--% chance</div>
                    </div>
                  </div>
                  
                  <div class="flex justify-between items-center p-1.5 bg-red-900/30 border border-red-800/40 rounded mt-2">
                    <div>
                      <span class="text-red-400 font-bold">-15%</span>
                      <span class="text-zinc-500 ml-1">STOP</span>
                    </div>
                    <div class="text-right">
                      <div id="sim-stop-price" class="text-red-400">$--</div>
                      <div id="sim-stop-prob" class="text-[7px] text-zinc-500">--% risk</div>
                    </div>
                  </div>
                </div>
                
                <!-- Simulation Stats -->
                <div class="mt-2 pt-2 border-t border-zinc-800/50 text-[7px] font-mono text-zinc-500">
                  <div class="flex justify-between">
                    <span>Expected Move (24h)</span>
                    <span id="sim-expected-move" class="text-white">±--</span>
                  </div>
                  <div class="flex justify-between">
                    <span>Volatility</span>
                    <span id="sim-volatility" class="text-amber-400">--</span>
                  </div>
                </div>
              </div>
              <!-- POSITION SIZING -->
              <div class="p-2">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide">
                  Quick Position Size
                </div>
                <div class="grid grid-cols-2 gap-1 text-[8px] font-mono">
                  <div class="bg-zinc-900/50 p-1.5 rounded border border-zinc-800/50 text-center">
                    <div class="text-zinc-500">1% Risk</div>
                    <div data-size="1pct" class="text-white font-bold">0.12 BTC</div>
                  </div>
                  <div class="bg-zinc-900/50 p-1.5 rounded border border-zinc-800/50 text-center">
                    <div class="text-zinc-500">2% Risk</div>
                    <div data-size="2pct" class="text-white font-bold">0.24 BTC</div>
                  </div>
                  <div class="bg-zinc-900/50 p-1.5 rounded border border-zinc-800/50 text-center">
                    <div class="text-zinc-500">Kelly</div>
                    <div data-size="kelly" class="text-emerald-400 font-bold">0.29 BTC</div>
                  </div>
                  <div class="bg-zinc-900/50 p-1.5 rounded border border-zinc-800/50 text-center">
                    <div class="text-zinc-500">Half-K</div>
                    <div data-size="halfk" class="text-amber-400 font-bold">0.14 BTC</div>
                  </div>
                </div>
              </div>

              <!-- SOCIAL SENTIMENT -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span class="flex items-center gap-1">
                    <iconify-icon icon="solar:users-group-rounded-bold" class="text-cyan-400"></iconify-icon>
                    Social Sentiment
                  </span>
                  <span class="text-cyan-400 animate-pulse text-[8px]">LIVE</span>
                </div>
                <div class="space-y-2 text-[8px] font-mono">
                  <div class="flex justify-between items-center">
                    <span class="text-zinc-500 flex items-center gap-1">
                      <iconify-icon icon="ri:twitter-x-fill" class="text-white"></iconify-icon>
                      X/Twitter
                  </span>
                    <div class="flex items-center gap-1">
                      <div class="w-12 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                        <div data-sentiment="twitter-bar" class="h-full bg-green-500 transition-all" style="width: 72%"></div>
                </div>
                      <span data-sentiment="twitter" class="text-green-400 w-8 text-right">72%</span>
                    </div>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-zinc-500 flex items-center gap-1">
                      <iconify-icon icon="mdi:reddit" class="text-orange-500"></iconify-icon>
                      Reddit
                  </span>
                    <div class="flex items-center gap-1">
                      <div class="w-12 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                        <div data-sentiment="reddit-bar" class="h-full bg-green-500 transition-all" style="width: 65%"></div>
                </div>
                      <span data-sentiment="reddit" class="text-green-400 w-8 text-right">65%</span>
                </div>
                </div>
                  <div class="flex justify-between items-center">
                    <span class="text-zinc-500 flex items-center gap-1">
                      <iconify-icon icon="mdi:telegram" class="text-blue-400"></iconify-icon>
                      Telegram
                    </span>
                    <div class="flex items-center gap-1">
                      <div class="w-12 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                        <div data-sentiment="telegram-bar" class="h-full bg-amber-500 transition-all" style="width: 58%"></div>
              </div>
                      <span data-sentiment="telegram" class="text-amber-400 w-8 text-right">58%</span>
                    </div>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-zinc-500 flex items-center gap-1">
                      <iconify-icon icon="simple-icons:discord" class="text-indigo-400"></iconify-icon>
                      Discord
                    </span>
                    <div class="flex items-center gap-1">
                      <div class="w-12 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                        <div data-sentiment="discord-bar" class="h-full bg-green-500 transition-all" style="width: 68%"></div>
                      </div>
                      <span data-sentiment="discord" class="text-green-400 w-8 text-right">68%</span>
                    </div>
                  </div>
                  <div class="border-t border-zinc-800/50 pt-2 mt-1">
                    <div class="flex justify-between items-center">
                      <span class="text-white font-bold">Aggregate</span>
                      <span data-sentiment="aggregate" class="text-green-400 font-bold">BULLISH 66%</span>
                    </div>
                    <div class="flex justify-between items-center mt-1">
                      <span class="text-zinc-500">24h Change</span>
                      <span data-sentiment="change" class="text-green-400">+8%</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- NEWS FEED -->
              <div class="p-2">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span class="flex items-center gap-1">
                    <iconify-icon icon="solar:document-text-bold" class="text-amber-400"></iconify-icon>
                    Breaking News
                  </span>
                  <span class="text-amber-400 animate-pulse text-[8px]">LIVE</span>
                </div>
                <div data-news="feed" class="space-y-2 text-[8px] font-mono max-h-48 overflow-y-auto no-scrollbar">
                  <div class="p-1.5 bg-zinc-900/50 rounded border border-zinc-800/50 hover:border-amber-600/50 cursor-pointer transition-colors">
                    <div class="flex justify-between items-start mb-1">
                      <span class="text-[7px] text-amber-400 uppercase">BULLISH</span>
                      <span class="text-[7px] text-zinc-600">2m</span>
                    </div>
                    <div class="text-white leading-tight">BlackRock BTC ETF sees record $500M inflow</div>
                    <div class="text-[7px] text-zinc-500 mt-1">Bloomberg</div>
                  </div>
                  <div class="p-1.5 bg-zinc-900/50 rounded border border-zinc-800/50 hover:border-zinc-600/50 cursor-pointer transition-colors">
                    <div class="flex justify-between items-start mb-1">
                      <span class="text-[7px] text-zinc-400 uppercase">NEUTRAL</span>
                      <span class="text-[7px] text-zinc-600">15m</span>
                    </div>
                    <div class="text-white leading-tight">Fed signals rates unchanged through Q2</div>
                    <div class="text-[7px] text-zinc-500 mt-1">CNBC</div>
                  </div>
                  <div class="p-1.5 bg-zinc-900/50 rounded border border-zinc-800/50 hover:border-red-600/50 cursor-pointer transition-colors">
                    <div class="flex justify-between items-start mb-1">
                      <span class="text-[7px] text-red-400 uppercase">BEARISH</span>
                      <span class="text-[7px] text-zinc-600">32m</span>
                    </div>
                    <div class="text-white leading-tight">Tether under investigation by DOJ</div>
                    <div class="text-[7px] text-zinc-500 mt-1">WSJ</div>
                  </div>
                  <div class="p-1.5 bg-zinc-900/50 rounded border border-zinc-800/50 hover:border-green-600/50 cursor-pointer transition-colors">
                    <div class="flex justify-between items-start mb-1">
                      <span class="text-[7px] text-green-400 uppercase">BULLISH</span>
                      <span class="text-[7px] text-zinc-600">1h</span>
                    </div>
                    <div class="text-white leading-tight">MicroStrategy adds 12,000 BTC</div>
                    <div class="text-[7px] text-zinc-500 mt-1">CoinDesk</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- COL: POSITIONS (Dynamic) -->
          <div class="bg-[#0B0B0B] flex flex-col flex-shrink-0" style="width: 200px;">
            <div class="p-2 border-b border-zinc-800 flex justify-between items-center text-[10px] font-mono bg-zinc-900/30">
              <span class="text-zinc-400 font-bold tracking-wider">
                POSITIONS
              </span>
              <div class="flex items-center gap-2">
                <button id="refresh-positions-btn" class="text-zinc-500 hover:text-white transition-colors" title="Refresh positions">
                  <iconify-icon icon="solar:refresh-linear" class="text-sm"></iconify-icon>
                </button>
                <span id="positions-count" class="bg-zinc-800 text-white px-1.5 rounded">0</span>
              </div>
            </div>

            <div id="positions-container" class="flex-1 overflow-y-auto p-2 space-y-2 no-scrollbar">
              <!-- Loading state -->
              <div id="positions-loading" class="text-center py-8 text-zinc-500 text-[10px] font-mono">
                <iconify-icon icon="solar:refresh-linear" class="text-2xl animate-spin mb-2"></iconify-icon>
                <div>Loading positions...</div>
              </div>
              <!-- Empty state (hidden by default) -->
              <div id="positions-empty" class="hidden text-center py-8 text-zinc-600 text-[10px] font-mono">
                <iconify-icon icon="solar:chart-2-linear" class="text-3xl mb-2 text-zinc-700"></iconify-icon>
                <div class="mb-1">No open positions</div>
                <div class="text-[9px]">Connect exchange in Account</div>
              </div>
              <!-- Positions will be dynamically inserted here -->
            </div>

            <div class="p-3 border-t border-zinc-800 bg-zinc-900/30 text-[10px] font-mono text-zinc-500">
              <div class="flex justify-between mb-1">
                <span>EXPOSURE</span>
                <span id="total-exposure" class="text-white">$0</span>
              </div>
              <div class="flex justify-between mb-1">
                <span>UNREALIZED</span>
                <span id="total-pnl" class="text-white">$0</span>
              </div>
              <div class="flex justify-between">
                <span>EXCHANGE</span>
                <span id="connected-exchange" class="text-zinc-400">--</span>
              </div>
            </div>
          </div>

          <!-- COL: CHART -->
          <div class="flex flex-col bg-[#080808] relative flex-1" style="min-width: 500px;">
            <!-- Chart Header -->
            <div class="flex items-center justify-between p-2 border-b border-zinc-800 text-[10px] font-mono">
              <div class="flex items-center gap-3">
                <!-- Symbol Selector Dropdown -->
                <div class="relative">
                  <button id="symbol-btn" class="flex items-center gap-2 font-bold text-white text-sm bg-zinc-900 border border-zinc-800 px-3 py-1.5 rounded hover:border-crimson-600 transition-colors">
                    <span data-chart="symbol">BTC-PERP</span>
                    <iconify-icon icon="solar:alt-arrow-down-linear" class="text-zinc-500"></iconify-icon>
                  </button>
                  <div id="symbol-dropdown" class="hidden absolute top-full left-0 mt-1 bg-zinc-900 border border-zinc-800 rounded shadow-xl z-50 w-48 max-h-[300px] overflow-y-auto no-scrollbar">
                    <!-- Populated by JS -->
                  </div>
                </div>
                <div id="timeframe-btns" class="flex bg-zinc-900 border border-zinc-800 rounded overflow-hidden">
                  <button data-tf="5m" class="px-3 py-1 hover:bg-zinc-800 text-zinc-400 transition-colors">
                    5m
                  </button>
                  <button data-tf="15m" class="px-3 py-1 bg-zinc-800 text-white font-bold">
                    15m
                  </button>
                  <button data-tf="1h" class="px-3 py-1 hover:bg-zinc-800 text-zinc-400 transition-colors">
                    1H
                  </button>
                  <button data-tf="4h" class="px-3 py-1 hover:bg-zinc-800 text-zinc-400 transition-colors">
                    4H
                  </button>
                </div>
              </div>
              <div class="flex gap-3 text-zinc-500">
                <iconify-icon icon="solar:settings-linear" class="hover:text-white cursor-pointer transition-colors text-base"></iconify-icon>
                <iconify-icon icon="solar:full-screen-linear" class="hover:text-white cursor-pointer transition-colors text-base"></iconify-icon>
              </div>
            </div>

            <!-- Chart Area - Real TradingView Chart -->
            <div id="chart-container" class="flex-1 relative overflow-hidden bg-[#080808]">
              <!-- Live Price Badge -->
              <div data-price="current" class="absolute top-2 right-2 bg-zinc-700 text-white text-[11px] font-mono px-2 py-1 z-30 font-bold rounded">
                Loading...
              </div>
              <!-- 24h Change Badge -->
              <div data-price="change" class="absolute top-2 right-24 bg-zinc-800 text-zinc-400 text-[10px] font-mono px-2 py-1 z-30 border border-zinc-700 rounded">
                --
              </div>
              <!-- Chart renders here -->
              <div id="tv-chart" class="w-full h-full"></div>
              <!-- Trade Levels Overlay -->
              <div id="chart-levels" class="absolute inset-0 pointer-events-none z-20"></div>
              <div class="absolute bottom-2 left-2 text-[9px] text-zinc-600 font-mono">
                SHOT 1
              </div>
              <div class="absolute bottom-[55%] left-[46%] text-[8px] text-zinc-500 -translate-y-4">
                SHOT 2
              </div>
              <div class="absolute bottom-[45%] left-[40%] w-[200px] h-0.5 bg-amber-500/50 rotate-[-15deg] transform origin-left pointer-events-none"></div>
              <div class="absolute bottom-[58%] left-[55%] text-[9px] text-amber-500 font-mono">
                GUARD
              </div>
              <div class="absolute bottom-0 left-0 right-0 h-16 border-t border-zinc-800/50 flex items-end gap-1 px-4 opacity-50">
                <div class="w-3 h-[40%] bg-zinc-700"></div>
                <div class="w-3 h-[60%] bg-red-900"></div>
                <div class="w-3 h-[30%] bg-zinc-700"></div>
                <div class="w-3 h-[80%] bg-green-900"></div>
                <div class="w-3 h-[50%] bg-zinc-700"></div>
                <div class="w-3 h-[90%] bg-green-900"></div>
                <div class="w-3 h-[70%] bg-green-900"></div>
              </div>
              <div class="absolute bottom-16 left-0 right-0 h-12 flex items-end opacity-30 pointer-events-none">
                <svg width="100%" height="100%" preserveAspectRatio="none">
                  <path d="M0,50 Q100,40 200,45 T400,30 T600,20" fill="none" stroke="#10b981" stroke-width="2"></path>
                </svg>
              </div>
            </div>
            <div class="h-[140px] border-t border-zinc-800 bg-[#080808] relative p-2 flex flex-col">
              <div class="flex justify-between items-center text-[9px] font-mono text-zinc-500 mb-1">
                <span>CVD &amp; VOLUME</span>
                <span class="text-crimson-500 animate-pulse">
                  ⚠ DIVERGENCE DETECTED
                </span>
              </div>
              <div class="flex-1 relative border-b border-zinc-800/50 mb-1">
                <div class="absolute inset-0 flex items-center">
                  <div class="w-full h-px bg-zinc-800 border-t border-dashed border-zinc-700"></div>
                </div>
                <svg class="absolute inset-0 w-full h-full" preserveAspectRatio="none">
                  <path d="M0,80 L20,75 L40,78 L60,70 L80,72 L100,60 L120,62 L140,50 L160,52 L180,45 L200,48 L220,40 L240,42 L260,35 L280,38 L300,30 L350,32 L400,35 L450,38 L500,40" fill="none" stroke="#ef4444" stroke-width="1.5" class="drop-shadow-[0_0_5px_rgba(239,68,68,0.5)]"></path>
                </svg>
                <span class="absolute top-1 right-1 text-[8px] text-zinc-600">
                  CVD -4.2M
                </span>
              </div>
              <div class="h-[40px] flex items-end gap-0.5 opacity-60">
                <div class="flex-1 bg-zinc-700 h-[30%]"></div>
                <div class="flex-1 bg-green-900 h-[50%]"></div>
                <div class="flex-1 bg-zinc-700 h-[20%]"></div>
                <div class="flex-1 bg-crimson-900 h-[70%]"></div>
                <div class="flex-1 bg-green-900 h-[40%]"></div>
                <div class="flex-1 bg-zinc-700 h-[25%]"></div>
                <div class="flex-1 bg-crimson-900 h-[60%]"></div>
                <div class="flex-1 bg-green-900 h-[80%]"></div>
                <div class="flex-1 bg-zinc-700 h-[35%]"></div>
                <div class="flex-1 bg-crimson-900 h-[55%]"></div>
                <div class="flex-1 bg-green-900 h-[90%]"></div>
                <div class="flex-1 bg-zinc-700 h-[30%]"></div>
                <div class="flex-1 bg-crimson-900 h-[65%]"></div>
                <div class="flex-1 bg-green-900 h-[85%]"></div>
                <div class="flex-1 bg-zinc-700 h-[45%]"></div>
                <div class="flex-1 bg-crimson-900 h-[75%]"></div>
                <div class="flex-1 bg-green-900 h-[95%]"></div>
                <div class="flex-1 bg-zinc-700 h-[40%]"></div>
                <div class="flex-1 bg-crimson-900 h-[50%]"></div>
                <div class="flex-1 bg-green-900 h-[60%]"></div>
              </div>
              <div class="flex justify-between text-[9px] font-mono mt-1">
                <span class="text-zinc-500">DELTA</span>
                <span class="text-green-500 font-bold">+$2.4M BUYERS</span>
              </div>
            </div>
          </div>
          
          <!-- COL: ORDER FLOW -->
          <div class="flex flex-col border-r border-zinc-800 bg-[#0B0B0B] flex-shrink-0" style="width: 200px;">
            <div class="p-2 border-b border-zinc-800 flex justify-between items-center text-[10px] font-mono bg-zinc-900/30">
              <span class="text-zinc-400 font-bold tracking-wider">
                ORDER FLOW
              </span>
              <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
            </div>
            <div class="flex-1 overflow-y-auto no-scrollbar" data-panel="orderflow">
              <!-- Loading State -->
              <div id="orderflow-loading" class="panel-loading">
                <iconify-icon icon="solar:refresh-linear"></iconify-icon>
                <span>Loading order flow...</span>
              </div>
              <!-- BID/ASK IMBALANCE -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between items-center">
                  <span>Bid/Ask Imbalance</span>
                  <span data-flow="imbalance-signal" class="text-green-400 font-bold">BUY</span>
                </div>
                <div class="relative">
                  <div class="flex h-4 rounded-sm overflow-hidden bg-zinc-900">
                    <div data-flow="bid-bar" class="bg-green-500 h-full transition-all" style="width: 62%"></div>
                    <div data-flow="ask-bar" class="bg-red-500 h-full transition-all" style="width: 38%"></div>
                  </div>
                  <div class="flex justify-between text-[8px] font-mono mt-1">
                    <span class="text-green-400"><span data-flow="bid-pct">62%</span> BID</span>
                    <span class="text-red-400">ASK <span data-flow="ask-pct">38%</span></span>
                  </div>
                </div>
                <div class="text-[8px] text-center mt-2 py-1 bg-green-900/20 border border-green-800/50 rounded text-green-400">
                  <span data-flow="imbalance-text">STRONG BUY PRESSURE</span>
                </div>
              </div>
              <!-- AGGRESSOR SIDE -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide">
                  Aggressor Side (5m)
                </div>
                <div class="space-y-2 text-[9px] font-mono">
                  <div class="flex justify-between items-center">
                    <span class="text-green-400">BUYERS</span>
                    <div class="flex items-center gap-2">
                      <div class="w-16 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                        <div data-flow="buyer-bar" class="h-full bg-green-500 transition-all" style="width: 58%"></div>
                      </div>
                      <span data-flow="buyer-vol" class="text-white font-bold">$24.7M</span>
                    </div>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-red-400">SELLERS</span>
                    <div class="flex items-center gap-2">
                      <div class="w-16 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                        <div data-flow="seller-bar" class="h-full bg-red-500 transition-all" style="width: 42%"></div>
                      </div>
                      <span data-flow="seller-vol" class="text-white font-bold">$17.8M</span>
                    </div>
                  </div>
                  <div class="text-[8px] text-center py-1 bg-zinc-900/50 rounded border border-zinc-800/50 mt-2">
                    <span class="text-zinc-500">Delta:</span>
                    <span data-flow="delta" class="text-green-400 font-bold ml-1">+$6.9M</span>
                  </div>
                </div>
              </div>
              <!-- LARGE ORDERS -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span>Large Orders ({'>'}$500K)</span>
                  <span class="text-[8px] text-amber-500 animate-pulse">LIVE</span>
                </div>
                <div data-flow="large-orders" class="space-y-1.5 text-[8px] font-mono max-h-[100px] overflow-y-auto no-scrollbar">
                  <div class="flex justify-between items-center py-0.5 border-l-2 border-green-500 pl-1">
                    <span class="text-zinc-500">14:32</span>
                    <span class="text-green-400">BUY</span>
                    <span class="text-white">$2.4M</span>
                    <span class="text-zinc-600">@83,420</span>
                  </div>
                  <div class="flex justify-between items-center py-0.5 border-l-2 border-red-500 pl-1">
                    <span class="text-zinc-500">14:28</span>
                    <span class="text-red-400">SELL</span>
                    <span class="text-white">$1.8M</span>
                    <span class="text-zinc-600">@83,510</span>
                  </div>
                  <div class="flex justify-between items-center py-0.5 border-l-2 border-green-500 pl-1">
                    <span class="text-zinc-500">14:25</span>
                    <span class="text-green-400">BUY</span>
                    <span class="text-white">$3.1M</span>
                    <span class="text-zinc-600">@83,380</span>
                  </div>
                </div>
              </div>
              <!-- CVD LIVE -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide">
                  CVD Momentum
                </div>
                <div class="text-center">
                  <div data-flow="cvd-value" class="text-2xl font-bold text-green-400 font-mono">+$8.4M</div>
                  <div class="text-[8px] text-zinc-500 mt-1">Cumulative Volume Delta</div>
                </div>
                <div class="mt-2 h-8 flex items-end justify-center gap-0.5" data-flow="cvd-bars">
                  <div class="w-2 bg-green-500 h-3"></div>
                  <div class="w-2 bg-green-500 h-4"></div>
                  <div class="w-2 bg-green-500 h-5"></div>
                  <div class="w-2 bg-red-500 h-2"></div>
                  <div class="w-2 bg-green-500 h-6"></div>
                  <div class="w-2 bg-green-500 h-7"></div>
                  <div class="w-2 bg-green-500 h-8"></div>
                </div>
                <div class="text-[7px] text-zinc-600 text-center mt-1">Last 7 intervals</div>
              </div>
              <!-- TRADE INTENSITY -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span>Trade Intensity</span>
                  <span data-flow="intensity-signal" class="text-amber-400">ELEVATED</span>
                </div>
                <div class="relative h-2 bg-zinc-900 rounded-full overflow-hidden">
                  <div class="absolute inset-0 bg-gradient-to-r from-green-900 via-amber-900 to-red-900 opacity-50"></div>
                  <div data-flow="intensity-needle" class="absolute top-0 bottom-0 w-1 bg-white shadow-[0_0_8px_white] transition-all" style="left: 68%"></div>
                </div>
                <div class="flex justify-between text-[7px] text-zinc-600 mt-1">
                  <span>LOW</span>
                  <span>NORMAL</span>
                  <span>HIGH</span>
                </div>
                <div class="text-[8px] text-center mt-2 text-zinc-500">
                  <span data-flow="trades-per-sec">847</span> trades/sec
                </div>
              </div>
              <!-- SPOOFING ALERT -->
              <div class="p-2">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span>Spoof Detection</span>
                  <span data-flow="spoof-status" class="text-green-400">CLEAR</span>
                </div>
                <div data-flow="spoof-container" class="space-y-1 text-[8px] font-mono">
                  <div class="text-center py-2 bg-zinc-900/50 rounded border border-zinc-800/50 text-zinc-500">
                    No spoofing detected
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- COL: INTELLIGENCE -->
          <div class="flex flex-col border-r border-zinc-800 bg-[#0B0B0B] flex-shrink-0" style="width: 220px;">
            <div class="p-2 border-b border-zinc-800 flex justify-between items-center text-[10px] font-mono bg-zinc-900/30 border-l-2 border-crimson-600">
              <span class="text-zinc-400 font-bold tracking-wider">
                INTELLIGENCE
              </span>
              <iconify-icon icon="solar:graph-up-bold" class="text-zinc-500"></iconify-icon>
            </div>
            <div class="flex-1 overflow-y-auto no-scrollbar" data-panel="intelligence">
              <!-- Loading State -->
              <div id="intelligence-loading" class="panel-loading">
                <iconify-icon icon="solar:refresh-linear"></iconify-icon>
                <span>Loading intelligence...</span>
              </div>
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide">
                  Order Flow (BTC)
                </div>
                <div class="space-y-1 text-[9px] font-mono">
                  <div class="flex justify-between">
                    <span class="text-zinc-400">CVD 1H</span>
                    <span data-cvd="1h" class="text-green-400 font-bold drop-shadow-[0_0_6px_rgba(74,222,128,0.5)]">
                      +2.4M
                    </span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-zinc-400">CVD 4H</span>
                    <span data-cvd="4h" class="text-green-400 font-bold drop-shadow-[0_0_6px_rgba(74,222,128,0.5)]">
                      +8.1M
                    </span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-zinc-400">CVD 1D</span>
                    <span data-cvd="1d" class="text-crimson-400 font-bold drop-shadow-[0_0_6px_rgba(248,113,113,0.5)]">
                      -4.2M
                    </span>
                  </div>
                </div>
                <div class="mt-2 pt-2 border-t border-zinc-800/50">
                  <div class="flex justify-between text-[9px] font-mono">
                    <span class="text-zinc-500">SMART MONEY</span>
                    <span data-intel="smart-money" class="text-white font-bold">78% BULLISH</span>
                  </div>
                  <div class="w-full h-1 bg-zinc-800 mt-1">
                    <div data-intel="smart-money-bar" class="h-full bg-white w-[78%] transition-all"></div>
                  </div>
                </div>
              </div>
              <!-- FEAR & GREED WITH SPARKLINE -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span>Fear & Greed Index</span>
                  <span class="text-[7px] text-zinc-600">7-day</span>
                </div>
                <div class="flex items-center justify-between">
                  <div>
                    <div data-intel="atr" class="text-[13px] text-white font-bold font-mono">F&G: --/100</div>
                </div>
                  <div data-fg="sparkline" class="ml-2"></div>
                </div>
                <div class="w-full h-1.5 bg-gradient-to-r from-red-600 via-amber-500 to-green-500 rounded-full mt-2 relative">
                  <div data-intel="vol-needle" class="absolute top-0 w-1 h-2.5 bg-white rounded-full shadow-[0_0_8px_rgba(255,255,255,0.8)] transition-all" style="left: 50%; transform: translateX(-50%);"></div>
                </div>
                <div class="flex justify-between text-[7px] text-zinc-600 mt-1">
                  <span>FEAR</span>
                  <span>NEUTRAL</span>
                  <span>GREED</span>
                </div>
              </div>
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide">
                  Derivatives
                </div>
                <div data-intel="oi-value" class="text-[14px] text-white font-bold font-mono">
                  $18.4B
                </div>
                <div data-intel="oi-change" class="text-[9px] text-green-500 font-mono mb-2">
                  OPEN INTEREST +2.1%
                </div>
                <div class="flex gap-1 h-1.5 w-full mb-1">
                  <div class="bg-green-600 w-[54%]"></div>
                  <div class="bg-crimson-600 w-[46%]"></div>
                </div>
                <div class="flex justify-between text-[9px] font-mono text-zinc-500">
                  <span>L: 54%</span>
                  <span>S: 46%</span>
                </div>
              </div>
              <!-- TOP TRADER SENTIMENT -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span>Top Traders vs Retail</span>
                  <span data-top-traders="signal" class="text-zinc-400">--</span>
                </div>
                <div class="space-y-2 text-[9px] font-mono">
                  <div>
                    <div class="flex justify-between text-zinc-400 mb-1">
                      <span>WHALES</span>
                      <span data-top-traders="whale-long" class="text-green-400">--% L</span>
                    </div>
                    <div class="w-full h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                      <div data-top-traders="whale-bar" class="h-full bg-green-500 transition-all" style="width: 58%"></div>
                    </div>
                  </div>
                  <div>
                    <div class="flex justify-between text-zinc-400 mb-1">
                      <span>RETAIL</span>
                      <span data-top-traders="retail-long" class="text-amber-400">--% L</span>
                    </div>
                    <div class="w-full h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                      <div data-top-traders="retail-bar" class="h-full bg-amber-500 transition-all" style="width: 72%"></div>
                    </div>
                  </div>
                </div>
                <div data-top-traders="divergence" class="mt-2 text-[8px] text-center py-1 px-2 rounded bg-zinc-900/50 border border-zinc-800/50 text-zinc-500">
                  Divergence: --
                </div>
              </div>
              <!-- TAKER BUY/SELL -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span>Taker Pressure</span>
                  <span data-taker="signal" class="text-zinc-400">--</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-green-400 text-[10px] font-mono">BUY</span>
                  <div class="flex-1 h-3 bg-zinc-800 rounded-full overflow-hidden flex">
                    <div data-taker="buy-bar" class="h-full bg-green-500 transition-all" style="width: 52%"></div>
                    <div data-taker="sell-bar" class="h-full bg-red-500 transition-all" style="width: 48%"></div>
                  </div>
                  <span class="text-red-400 text-[10px] font-mono">SELL</span>
                </div>
                <div class="flex justify-between text-[8px] font-mono text-zinc-500 mt-1">
                  <span data-taker="buy-pct">52%</span>
                  <span data-taker="net" class="text-green-400 font-bold">NET: BUY</span>
                  <span data-taker="sell-pct">48%</span>
                </div>
              </div>
              <!-- OPTIONS MAX PAIN -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span>Options</span>
                  <span data-options="signal" class="text-zinc-400">--</span>
                </div>
                <div class="grid grid-cols-2 gap-2 text-[9px] font-mono">
                  <div>
                    <div class="text-zinc-500">Max Pain</div>
                    <div data-options="max-pain" class="text-white font-bold">$--</div>
                  </div>
                  <div>
                    <div class="text-zinc-500">Put/Call</div>
                    <div data-options="put-call" class="text-white font-bold">--</div>
                  </div>
                </div>
                <div data-options="distance" class="mt-2 text-[8px] text-center py-1 bg-zinc-900/50 rounded border border-zinc-800/50 text-zinc-500">
                  -- from current
                </div>
              </div>
              <!-- VOLATILITY REGIME - MOVED FROM RIGHT COLUMN -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span class="flex items-center gap-1">
                    <iconify-icon icon="solar:chart-2-bold" class="text-purple-400"></iconify-icon>
                    Volatility Regime
                  </span>
                  <span data-vol="signal" class="text-zinc-400">--</span>
                </div>
                <div class="flex justify-between items-center mb-2 text-[9px] font-mono">
                  <div>
                    <div class="text-zinc-500 text-[8px]">Regime</div>
                    <div data-vol="regime" class="text-white font-bold">--</div>
                  </div>
                  <div class="text-right">
                    <div class="text-zinc-500 text-[8px]">ATR</div>
                    <div data-vol="atr" class="text-white font-bold">--%</div>
                  </div>
                </div>
                <div class="mb-2">
                  <div class="flex justify-between text-[7px] text-zinc-600 mb-1">
                    <span>LOW</span>
                    <span>NORMAL</span>
                    <span>HIGH</span>
                  </div>
                  <div class="w-full h-2 bg-zinc-800 rounded-full relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-r from-green-900 via-amber-900 to-red-900 opacity-50"></div>
                    <div data-vol="needle" class="absolute top-0 bottom-0 w-1 bg-white shadow-[0_0_8px_white] transition-all" style="left: 30%"></div>
                  </div>
                </div>
                <div data-vol="warning" class="text-[8px] text-center py-1 px-2 mb-2 rounded bg-amber-900/30 border border-amber-800/50 text-amber-400 hidden">
                  EXPANSION IMMINENT
                </div>
                <div class="grid grid-cols-2 gap-2 text-[8px] font-mono mb-1">
                  <div>
                    <span class="text-zinc-500">BB Width:</span>
                    <span data-vol="bb" class="text-white ml-1">--%</span>
                  </div>
                  <div>
                    <span class="text-zinc-500">Days:</span>
                    <span data-vol="days" class="text-white ml-1">--</span>
                  </div>
                </div>
                <div data-vol="expansion" class="text-[8px] text-center py-1 bg-zinc-900/50 rounded border border-zinc-800/50">
                  <span class="text-zinc-500">Expansion Prob:</span>
                  <span data-vol="prob" class="text-white font-bold ml-1">--%</span>
                </div>
              </div>
              <!-- TIME-OF-DAY ANALYSIS -->
              <div class="p-2 border-b border-zinc-800/50">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span class="flex items-center gap-1">
                    <iconify-icon icon="solar:clock-circle-bold" class="text-blue-400"></iconify-icon>
                    Session Analysis
                  </span>
                  <span data-session="current" class="text-blue-400 font-bold">--</span>
                </div>
                <div class="text-[8px] font-mono space-y-1">
                  <div class="flex justify-between">
                    <span class="text-zinc-500">Current Session</span>
                    <span data-session="name" class="text-white">--</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-zinc-500">Next High-Vol</span>
                    <span data-session="next" class="text-amber-400">--</span>
                  </div>
                  <div class="mt-2 pt-2 border-t border-zinc-800/50 space-y-0.5">
                    <div class="flex justify-between text-zinc-600">
                      <span>Asia Avg</span>
                      <span data-session="asia">0.4%</span>
                    </div>
                    <div class="flex justify-between text-zinc-600">
                      <span>London Avg</span>
                      <span data-session="london">0.8%</span>
                    </div>
                    <div class="flex justify-between text-zinc-600">
                      <span>US Avg</span>
                      <span data-session="us" class="text-green-400">1.2%</span>
                    </div>
                  </div>
                  <div data-session="recommendation" class="mt-2 text-[7px] text-center py-1 bg-blue-900/20 border border-blue-800/50 rounded text-blue-400">
                    Wait for US open
                  </div>
                </div>
              </div>
              <!-- MACRO CORRELATION -->
              <div class="p-2">
                <div class="text-[9px] text-zinc-500 font-mono mb-2 uppercase tracking-wide flex justify-between">
                  <span class="flex items-center gap-1">
                    <iconify-icon icon="solar:global-bold" class="text-cyan-400"></iconify-icon>
                    Macro Sync
                  </span>
                  <span data-macro="signal" class="text-green-400 font-bold">RISK-ON</span>
                </div>
                <div class="space-y-1.5 text-[8px] font-mono">
                  <div class="flex justify-between items-center">
                    <span class="text-zinc-500 w-14">BTC/SPX</span>
                    <div class="flex-1 mx-1 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                      <div data-macro="spx-bar" class="h-full bg-green-500 transition-all" style="width: 78%"></div>
                    </div>
                    <span data-macro="spx" class="text-green-400 w-10 text-right">+0.78</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-zinc-500 w-14">BTC/NQ</span>
                    <div class="flex-1 mx-1 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                      <div data-macro="nq-bar" class="h-full bg-green-500 transition-all" style="width: 84%"></div>
                    </div>
                    <span data-macro="nq" class="text-green-400 w-10 text-right">+0.84</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-zinc-500 w-14">BTC/DXY</span>
                    <div class="flex-1 mx-1 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                      <div data-macro="dxy-bar" class="h-full bg-red-500 transition-all" style="width: 67%"></div>
                    </div>
                    <span data-macro="dxy" class="text-red-400 w-10 text-right">-0.67</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-zinc-500 w-14">BTC/GOLD</span>
                    <div class="flex-1 mx-1 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                      <div data-macro="gold-bar" class="h-full bg-green-500 transition-all" style="width: 42%"></div>
                    </div>
                    <span data-macro="gold" class="text-green-400 w-10 text-right">+0.42</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-zinc-500 w-14">BTC/VIX</span>
                    <div class="flex-1 mx-1 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                      <div data-macro="vix-bar" class="h-full bg-red-500 transition-all" style="width: 31%"></div>
                    </div>
                    <span data-macro="vix" class="text-red-400 w-10 text-right">-0.31</span>
                  </div>
                </div>
                <div data-macro="note" class="mt-2 text-[7px] text-center py-1 bg-amber-900/20 border border-amber-800/50 rounded text-amber-400">
                  High equity correlation - Watch SPX
                </div>
              </div>
            </div>
          </div>

          <!-- COL: ALERTS & SIGNALS -->
          <div class="bg-[#0B0B0B] flex flex-col border-l border-zinc-800 flex-shrink-0" style="width: 280px;">
            <div class="p-2 border-b border-zinc-800 flex justify-between items-center text-[10px] font-mono bg-zinc-900/30">
              <span class="text-zinc-400 font-bold tracking-wider">
                ALERTS &amp; SIGNALS
              </span>
              <iconify-icon icon="solar:filter-linear" class="text-zinc-500 hover:text-white cursor-pointer"></iconify-icon>
            </div>
            
            <!-- MM MAGNET PANEL - MOVED TO TOP -->
            <div class="p-3 bg-[#0a0a0a] border-b border-zinc-800 relative overflow-hidden">
              <div class="absolute top-0 left-0 w-1 h-full bg-amber-500 shadow-[0_0_15px_rgba(245,158,11,0.6)]"></div>
              <div class="flex justify-between items-center text-[10px] font-mono mb-2">
                <span class="text-amber-400 font-bold flex items-center gap-1">
                  <iconify-icon icon="solar:target-bold"></iconify-icon>
                  MM MAGNET
                </span>
                <span data-mm="direction" class="text-zinc-400 text-[9px]">--</span>
              </div>
              <div class="flex justify-between items-center mb-2">
                <div>
                  <div class="text-[8px] text-zinc-500 mb-0.5">TARGET</div>
                  <div data-mm="target" class="text-white font-bold text-[13px] font-mono">$--</div>
                </div>
                <div class="text-right">
                  <div class="text-[8px] text-zinc-500 mb-0.5">CONFIDENCE</div>
                  <div data-mm="confidence" class="text-white font-bold text-[13px] font-mono">--%</div>
                </div>
              </div>
              <div class="w-full h-2 bg-zinc-800 rounded-full overflow-hidden mb-2">
                <div data-mm="confidence-bar" class="h-full bg-amber-500 transition-all" style="width: 0%"></div>
              </div>
              <div data-mm="eta" class="text-[8px] text-zinc-500 mb-2 text-center">ETA: --</div>
              <div class="space-y-1 text-[8px] font-mono">
                <div class="flex justify-between items-center">
                  <span class="text-zinc-500 w-16">Max Pain</span>
                  <div class="flex-1 mx-1 h-1 bg-zinc-800 rounded-full overflow-hidden">
                    <div data-mm="sig-maxpain" class="h-full bg-green-500 transition-all" style="width: 50%"></div>
                  </div>
                  <span data-mm="sig-maxpain-label" class="text-zinc-400 w-16 text-right">--</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-zinc-500 w-16">Liq Hunt</span>
                  <div class="flex-1 mx-1 h-1 bg-zinc-800 rounded-full overflow-hidden">
                    <div data-mm="sig-liq" class="h-full bg-red-500 transition-all" style="width: 50%"></div>
                  </div>
                  <span data-mm="sig-liq-label" class="text-zinc-400 w-16 text-right">--</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-zinc-500 w-16">Funding</span>
                  <div class="flex-1 mx-1 h-1 bg-zinc-800 rounded-full overflow-hidden">
                    <div data-mm="sig-funding" class="h-full bg-blue-500 transition-all" style="width: 50%"></div>
                  </div>
                  <span data-mm="sig-funding-label" class="text-zinc-400 w-16 text-right">--</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-zinc-500 w-16">Divergence</span>
                  <div class="flex-1 mx-1 h-1 bg-zinc-800 rounded-full overflow-hidden">
                    <div data-mm="sig-div" class="h-full bg-purple-500 transition-all" style="width: 50%"></div>
                  </div>
                  <span data-mm="sig-div-label" class="text-zinc-400 w-16 text-right">--</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-zinc-500 w-16">ETF Flows</span>
                  <div class="flex-1 mx-1 h-1 bg-zinc-800 rounded-full overflow-hidden">
                    <div data-mm="sig-etf" class="h-full bg-cyan-500 transition-all" style="width: 50%"></div>
                  </div>
                  <span data-mm="sig-etf-label" class="text-zinc-400 w-16 text-right">--</span>
                </div>
              </div>
            </div>

            <div class="flex-1 overflow-y-auto p-0 no-scrollbar">
              <!-- Alert 1 -->
              <div class="p-3 border-b border-zinc-800/50 hover:bg-zinc-900/50 transition-colors animate-[fadeIn_0.3s_ease-out]">
                <div class="flex justify-between text-[9px] text-zinc-500 mb-1 font-mono">
                  <span class="text-green-500 flex items-center gap-1 font-bold">
                    🟢 TARGET 1 HIT
                  </span>
                  <span class="">14:31:42</span>
                </div>
                <p class="text-[10px] text-zinc-300 font-mono">
                  BTC-PERP reached $96,800 (+1.2R). Stop moved to breakeven.
                </p>
              </div>

              <!-- Alert 2 -->
              <div class="p-3 border-b border-zinc-800/50 hover:bg-zinc-900/50 transition-colors">
                <div class="flex justify-between text-[9px] text-zinc-500 mb-1 font-mono">
                  <span class="text-cyan-500 flex items-center gap-1 font-bold">
                    🔵 MOMENTUM TP
                  </span>
                  <span class="">14:28:17</span>
                </div>
                <p class="text-[10px] text-zinc-300 font-mono">
                  Slope strength: 2.3x. Trailing 0.45% below candle body.
                </p>
              </div>

              <!-- Alert 3 -->
              <div class="p-3 border-b border-zinc-800/50 hover:bg-zinc-900/50 transition-colors">
                <div class="flex justify-between text-[9px] text-zinc-500 mb-1 font-mono">
                  <span class="text-amber-500 flex items-center gap-1 font-bold">
                    🟡 VOLATILITY
                  </span>
                  <span class="">14:25:33</span>
                </div>
                <p class="text-[10px] text-zinc-300 font-mono">
                  Regime: NORMAL → HIGH. Recommended: Reduce new entries 25%.
                </p>
              </div>

              <!-- Alert 4 -->
              <div class="p-3 border-b border-zinc-800/50 hover:bg-zinc-900/50 transition-colors">
                <div class="flex justify-between text-[9px] text-zinc-500 mb-1 font-mono">
                  <span class="text-green-500 flex items-center gap-1 font-bold">
                    🟢 SHOT 2 EXECUTED
                  </span>
                  <span>14:22:08</span>
                </div>
                <p class="text-[10px] text-zinc-300 font-mono">
                  BTC-PERP: Added 0.15 BTC @ $95,890.
                </p>
              </div>
            </div>
            
            <!-- ALERT SYSTEM -->
            <div class="p-3 bg-[#0a0a0a] border-t border-zinc-800 flex flex-col gap-2 relative overflow-hidden">
              <div class="absolute top-0 left-0 w-1 h-full bg-amber-500 shadow-[0_0_15px_rgba(245,158,11,0.6)]"></div>
              <div class="flex justify-between items-center text-[10px] font-mono mb-1">
                <span class="text-amber-400 font-bold flex items-center gap-1">
                  <iconify-icon icon="solar:bell-bold"></iconify-icon>
                  ALERT SYSTEM
                </span>
                <span data-alerts="status" class="text-[8px] text-green-400 animate-pulse">ACTIVE</span>
              </div>
              <div class="text-[8px] text-zinc-500 mb-1">Push notifications enabled</div>
              <div data-alerts="feed" class="space-y-1.5 max-h-32 overflow-y-auto no-scrollbar">
                <!-- Alert items populated by JS -->
                <div class="flex items-start gap-2 p-1.5 bg-green-900/20 border border-green-800/30 rounded text-[8px]">
                  <iconify-icon icon="solar:dollar-bold" class="text-green-400 mt-0.5"></iconify-icon>
                  <div>
                    <div class="text-green-400 font-bold">Price Target Hit</div>
                    <div class="text-zinc-400">BTC reached $96,500</div>
                    <div class="text-zinc-600">2 min ago</div>
              </div>
                </div>
                <div class="flex items-start gap-2 p-1.5 bg-purple-900/20 border border-purple-800/30 rounded text-[8px]">
                  <iconify-icon icon="solar:whale-bold" class="text-purple-400 mt-0.5"></iconify-icon>
                  <div>
                    <div class="text-purple-400 font-bold">Whale Movement</div>
                    <div class="text-zinc-400">$25M BTC moved to Binance</div>
                    <div class="text-zinc-600">5 min ago</div>
                  </div>
                </div>
                <div class="flex items-start gap-2 p-1.5 bg-amber-900/20 border border-amber-800/30 rounded text-[8px]">
                  <iconify-icon icon="solar:chart-2-bold" class="text-amber-400 mt-0.5"></iconify-icon>
                  <div>
                    <div class="text-amber-400 font-bold">Funding Spike</div>
                    <div class="text-zinc-400">Funding hit +0.15%</div>
                    <div class="text-zinc-600">12 min ago</div>
                  </div>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-1 mt-1 text-[7px]">
                <button data-alert-toggle="price" class="flex items-center justify-center gap-1 p-1 bg-zinc-800 hover:bg-zinc-700 rounded text-zinc-400 hover:text-white transition-colors border border-zinc-700">
                  <iconify-icon icon="solar:dollar-bold"></iconify-icon>
                  <span>Price</span>
                  <span class="text-green-400">ON</span>
                </button>
                <button data-alert-toggle="whale" class="flex items-center justify-center gap-1 p-1 bg-zinc-800 hover:bg-zinc-700 rounded text-zinc-400 hover:text-white transition-colors border border-zinc-700">
                  <iconify-icon icon="solar:whale-bold"></iconify-icon>
                  <span>Whale</span>
                  <span class="text-green-400">ON</span>
                </button>
                <button data-alert-toggle="funding" class="flex items-center justify-center gap-1 p-1 bg-zinc-800 hover:bg-zinc-700 rounded text-zinc-400 hover:text-white transition-colors border border-zinc-700">
                  <iconify-icon icon="solar:chart-2-bold"></iconify-icon>
                  <span>Funding</span>
                  <span class="text-green-400">ON</span>
                </button>
                <button data-alert-toggle="volatility" class="flex items-center justify-center gap-1 p-1 bg-zinc-800 hover:bg-zinc-700 rounded text-zinc-400 hover:text-white transition-colors border border-zinc-700">
                  <iconify-icon icon="solar:graph-bold"></iconify-icon>
                  <span>Vol</span>
                  <span class="text-green-400">ON</span>
                </button>
              </div>
            </div>

            <!-- Quick Stats -->
            <div class="p-3 bg-zinc-900/20 border-t border-zinc-800 text-[9px] font-mono space-y-2">
              <div class="flex justify-between items-center">
                <span class="text-zinc-500">ORDER FLOW</span>
                <span class="text-green-500 font-bold">BULLISH</span>
              </div>
              <div class="w-full h-1 bg-zinc-800 rounded-full overflow-hidden">
                <div class="w-[70%] h-full bg-green-600"></div>
              </div>

              <div class="flex justify-between items-center mt-2">
                <span class="text-zinc-500">WHALE ACTIVITY</span>
                <span class="text-white font-bold">HIGH</span>
              </div>
              <div class="w-full h-1 bg-zinc-800 rounded-full overflow-hidden">
                <div class="w-[85%] h-full bg-white"></div>
              </div>
            </div>
          </div>
          
          <!-- COL: MCF LABS REPORTS -->
          <div class="bg-[#0B0B0B] flex flex-col border-l border-zinc-800 flex-shrink-0" style="width: 300px;">
            <div class="p-2 border-b border-zinc-800 flex justify-between items-center text-[10px] font-mono bg-gradient-to-r from-purple-950/50 to-zinc-900/30">
              <span class="text-purple-400 font-bold tracking-wider flex items-center gap-1">
                <iconify-icon icon="solar:document-bold" class="text-purple-500"></iconify-icon>
                MCF LABS
              </span>
              <span class="text-[8px] bg-purple-600 text-white px-1.5 py-0.5 rounded animate-pulse">INSTITUTIONAL</span>
            </div>
            <div class="flex-1 overflow-y-auto no-scrollbar" data-panel="mcflabs">
              <!-- LATEST REPORT -->
              <div class="p-3 border-b border-zinc-800/50 bg-gradient-to-b from-purple-950/20 to-transparent">
                <div class="flex justify-between items-center mb-2">
                  <span class="text-[9px] text-purple-400 font-mono font-bold">LATEST REPORT</span>
                  <span class="text-[8px] text-zinc-500">2 min ago</span>
                </div>
                <div data-mcf="latest-title" class="text-[11px] text-white font-bold mb-2 leading-tight">
                  BTC Accumulation Phase Confirmed: Smart Money Loading
                </div>
                <div data-mcf="latest-summary" class="text-[9px] text-zinc-400 leading-relaxed mb-2">
                  On-chain metrics show significant whale accumulation over past 72h. Exchange reserves at 3-year lows. Funding remains neutral suggesting room for upside.
                </div>
                <div class="flex gap-2">
                  <span class="text-[7px] bg-green-900/50 text-green-400 px-1.5 py-0.5 rounded border border-green-800/50">BULLISH</span>
                  <span class="text-[7px] bg-zinc-800 text-zinc-400 px-1.5 py-0.5 rounded">HIGH CONFIDENCE</span>
                </div>
              </div>
              <!-- REPORT FEED -->
              <div data-mcf="feed" class="divide-y divide-zinc-800/50">
                <div class="p-2 hover:bg-zinc-900/50 cursor-pointer transition-colors">
                  <div class="flex justify-between items-start mb-1">
                    <span class="text-[9px] text-white font-bold leading-tight flex-1">ETH/BTC Ratio Analysis: Altcoin Season Incoming?</span>
                    <span class="text-[7px] text-zinc-600 ml-2">1h</span>
                  </div>
                  <div class="flex gap-1">
                    <span class="text-[6px] bg-amber-900/50 text-amber-400 px-1 py-0.5 rounded">NEUTRAL</span>
                  </div>
                </div>
                <div class="p-2 hover:bg-zinc-900/50 cursor-pointer transition-colors">
                  <div class="flex justify-between items-start mb-1">
                    <span class="text-[9px] text-white font-bold leading-tight flex-1">Derivatives Deep Dive: OI Surge Signals Volatility</span>
                    <span class="text-[7px] text-zinc-600 ml-2">3h</span>
                  </div>
                  <div class="flex gap-1">
                    <span class="text-[6px] bg-amber-900/50 text-amber-400 px-1 py-0.5 rounded">CAUTION</span>
                  </div>
                </div>
                <div class="p-2 hover:bg-zinc-900/50 cursor-pointer transition-colors">
                  <div class="flex justify-between items-start mb-1">
                    <span class="text-[9px] text-white font-bold leading-tight flex-1">Macro Weekly: Fed Pivot Implications for Crypto</span>
                    <span class="text-[7px] text-zinc-600 ml-2">6h</span>
                  </div>
                  <div class="flex gap-1">
                    <span class="text-[6px] bg-green-900/50 text-green-400 px-1 py-0.5 rounded">BULLISH</span>
                  </div>
                </div>
                <div class="p-2 hover:bg-zinc-900/50 cursor-pointer transition-colors">
                  <div class="flex justify-between items-start mb-1">
                    <span class="text-[9px] text-white font-bold leading-tight flex-1">Liquidation Map Analysis: Key Levels to Watch</span>
                    <span class="text-[7px] text-zinc-600 ml-2">12h</span>
                  </div>
                  <div class="flex gap-1">
                    <span class="text-[6px] bg-red-900/50 text-red-400 px-1 py-0.5 rounded">RISK ALERT</span>
                  </div>
                </div>
              </div>
              
              <!-- VIEW FULL REPORTS (MOVED ABOVE NEURAL ASSISTANT) -->
              <div class="p-3 bg-gradient-to-t from-purple-950/30 to-transparent border-t border-zinc-800/50">
                <div class="text-[8px] text-zinc-500 text-center mb-2">
                  Get real-time institutional-grade analysis
                </div>
                <a href="/research" class="block w-full bg-purple-600 hover:bg-purple-700 text-white text-[9px] font-bold py-2 rounded-sm shadow-[0_0_15px_rgba(168,85,247,0.3)] font-mono uppercase transition-all text-center">
                  VIEW FULL REPORTS
                </a>
              </div>
              
              <!-- NEURAL ASSISTANT (BOTTOM OF MCF LABS) -->
              <div class="p-3 bg-[#0f0f0f] border-t border-zinc-800 flex flex-col gap-2 relative overflow-hidden group">
                <div class="absolute top-0 left-0 w-1 h-full bg-crimson-400 shadow-[0_0_20px_rgba(220,38,38,0.9)]"></div>
                <div class="absolute inset-0 bg-crimson-500/5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                <div class="flex justify-between items-center text-[10px] font-mono mb-1">
                  <span class="text-crimson-400 font-bold flex items-center gap-1">
                    <iconify-icon icon="solar:magic-stick-3-bold"></iconify-icon>
                    ASK BASTION
                  </span>
                  <div class="flex items-center gap-2">
                    <span id="neural-loading" class="hidden text-[8px] text-amber-400 animate-pulse">Thinking...</span>
                    <span class="text-[8px] bg-crimson-600 text-white px-1.5 py-0.5 rounded animate-pulse">AI</span>
                  </div>
                </div>
                <div data-neural="response" class="text-[10px] text-zinc-300 font-mono leading-relaxed bg-zinc-900/50 p-2 rounded border border-zinc-800/50 min-h-[60px] max-h-[200px] overflow-y-auto scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-transparent">
                  <span class="text-crimson-500">&gt;&gt;</span>
                  Ready for your query...
                </div>
                <div class="mt-2 relative flex gap-2">
                  <input data-input="neural" type="text" placeholder="Ask BASTION anything..." class="flex-1 bg-zinc-900 border border-zinc-800 text-[10px] text-white px-2 py-1.5 focus:border-crimson-600 focus:outline-none placeholder-zinc-700 font-mono rounded-sm">
                  <button data-action="neural-send" class="bg-crimson-600 hover:bg-crimson-500 text-white px-3 py-1.5 rounded-sm transition-colors flex items-center gap-1 text-[9px] font-bold">
                    <iconify-icon icon="solar:plain-linear"></iconify-icon> SEND
                  </button>
                </div>
                <!-- Expand to full panel -->
                <button data-action="expand-neural" class="text-[8px] text-zinc-600 hover:text-crimson-400 text-center transition-colors mt-1">
                  <iconify-icon icon="solar:maximize-square-linear"></iconify-icon> Expand
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- TERMINAL BOTTOM BAR -->
        <div class="border-t border-zinc-800 bg-zinc-900/80 p-2 flex flex-wrap gap-2 justify-between items-center relative z-20">
          <div class="flex gap-2">
            <button data-action="emergency-exit" class="bg-crimson-600 hover:bg-crimson-700 text-white text-[10px] font-bold px-4 py-1.5 rounded-sm shadow-[0_0_10px_rgba(220,38,38,0.3)] font-mono uppercase transition-all animate-pulse">
              ⚠ EMERGENCY EXIT ALL
            </button>
            <button data-action="flatten-winners" class="bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-[10px] px-3 py-1.5 rounded-sm font-mono border border-zinc-700 transition-colors">
              FLATTEN WINNERS
            </button>
            <button data-action="move-to-be" class="bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-[10px] px-3 py-1.5 rounded-sm font-mono border border-zinc-700 transition-colors">
              MOVE ALL TO BE
            </button>
          </div>

          <div class="flex gap-2">
            <button data-action="add-shot" class="bg-zinc-800 hover:bg-zinc-700 text-white text-[10px] px-3 py-1.5 rounded-sm font-mono border border-zinc-700 transition-colors">
              ADD SHOT
            </button>
            <button data-action="partial-25" class="bg-zinc-800 hover:bg-zinc-700 text-white text-[10px] px-3 py-1.5 rounded-sm font-mono border border-zinc-700 transition-colors">
              PARTIAL 25%
            </button>
            <button data-action="partial-50" class="bg-zinc-800 hover:bg-zinc-700 text-white text-[10px] px-3 py-1.5 rounded-sm font-mono border border-zinc-700 transition-colors">
              PARTIAL 50%
            </button>
          </div>

          <div class="flex gap-4 items-center pl-4 border-l border-zinc-800/50">
            <div class="flex items-center gap-2 text-[10px] text-zinc-500 font-mono mr-2">
              <div class="w-8 h-4 bg-zinc-800 rounded-full p-0.5 cursor-pointer relative transition-colors hover:bg-zinc-700">
                <div class="w-3 h-3 bg-zinc-500 rounded-full transition-transform"></div>
              </div>
              PAUSE NEW ENTRIES
            </div>
            <button class="text-zinc-500 hover:text-white transition-colors">
              <iconify-icon icon="solar:export-linear" class="text-lg"></iconify-icon>
            </button>
          </div>
        </div>
      </div>

    </main>

    <script>
      // Animation observers
      document.addEventListener("DOMContentLoaded", () => {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add("sys-active");
              observer.unobserve(entry.target);
            }
          });
        }, { threshold: 0.1 });
        document.querySelectorAll(".sys-reveal").forEach(el => observer.observe(el));
      });
    </script>

    <!-- BASTION TERMINAL API CONNECTION -->
    <script>
      const API_BASE = window.location.origin;
      let ws = null;
      let positions = [];
      let cachedPositions = [];
      let sessionStats = {};
      let marketData = {};
      let alerts = [];
      let fearGreedHistory = []; // 7-day history
      
      // =================================================================
      // AUTH HELPERS - For user-scoped API calls
      // =================================================================
      function getAuthToken() {
        return localStorage.getItem('bastion_token') || sessionStorage.getItem('bastion_token') || '';
      }
      
      function getSessionId() {
        let sid = localStorage.getItem('bastion_session_id');
        if (!sid) {
          sid = 'guest_' + Math.random().toString(36).substring(2, 15);
          localStorage.setItem('bastion_session_id', sid);
        }
        return sid;
      }
      
      function getAuthParams() {
        const token = getAuthToken();
        const sessionId = getSessionId();
        const params = new URLSearchParams();
        if (token) params.append('token', token);
        params.append('session_id', sessionId);
        return params.toString();
      }
      
      // =================================================================
      // SOUND ALERT SYSTEM - Audio cues for critical signals
      // =================================================================
      const audioContext = typeof AudioContext !== 'undefined' ? new AudioContext() : null;
      const soundAlerts = {
        enabled: true,
        priceTarget: true,
        whale: true,
        funding: true,
        volatility: true,
        mmMagnet: true
      };
      
      // Generate audio tone
      function playSound(type) {
        if (!audioContext || !soundAlerts.enabled) return;
        
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        const sounds = {
          'price-target': { freq: 880, duration: 0.3, wave: 'sine' },      // High ping for price targets
          'whale': { freq: 220, duration: 0.5, wave: 'triangle' },         // Deep tone for whales
          'funding': { freq: 660, duration: 0.2, wave: 'square' },         // Alert tone for funding
          'volatility': { freq: 440, duration: 0.4, wave: 'sawtooth' },    // Warning for volatility
          'mm-magnet': { freq: 523, duration: 0.3, wave: 'sine' },         // Notification for MM target
          'alert': { freq: 600, duration: 0.15, wave: 'sine' }             // Generic alert
        };
        
        const sound = sounds[type] || sounds['alert'];
        oscillator.type = sound.wave;
        oscillator.frequency.setValueAtTime(sound.freq, audioContext.currentTime);
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + sound.duration);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + sound.duration);
      }
      
      // Trigger alert with sound
      function triggerAlert(type, title, message) {
        // Add to feed
        const alertFeed = document.querySelector('[data-alerts="feed"]');
        if (alertFeed) {
          const colors = {
            'price-target': { bg: 'green-900/20', border: 'green-800/30', icon: 'solar:dollar-bold', iconColor: 'green-400' },
            'whale': { bg: 'purple-900/20', border: 'purple-800/30', icon: 'solar:whale-bold', iconColor: 'purple-400' },
            'funding': { bg: 'amber-900/20', border: 'amber-800/30', icon: 'solar:chart-2-bold', iconColor: 'amber-400' },
            'volatility': { bg: 'red-900/20', border: 'red-800/30', icon: 'solar:graph-bold', iconColor: 'red-400' },
            'mm-magnet': { bg: 'cyan-900/20', border: 'cyan-800/30', icon: 'solar:target-bold', iconColor: 'cyan-400' }
          };
          const style = colors[type] || colors['price-target'];
          
          const alertEl = document.createElement('div');
          alertEl.className = `flex items-start gap-2 p-1.5 bg-${style.bg} border border-${style.border} rounded text-[8px] animate-pulse`;
          alertEl.innerHTML = `
            <iconify-icon icon="${style.icon}" class="text-${style.iconColor} mt-0.5"></iconify-icon>
            <div>
              <div class="text-${style.iconColor} font-bold">${title}</div>
              <div class="text-zinc-400">${message}</div>
              <div class="text-zinc-600">Just now</div>
            </div>
          `;
          alertFeed.insertBefore(alertEl, alertFeed.firstChild);
          
          // Keep only last 10 alerts
          while (alertFeed.children.length > 10) {
            alertFeed.removeChild(alertFeed.lastChild);
          }
        }
        
        // Play sound
        playSound(type);
        
        // Browser notification if permitted
        if (Notification.permission === 'granted') {
          new Notification(`BASTION: ${title}`, { body: message, icon: '/favicon.ico' });
        }
        
        console.log(`[ALERT] ${type}: ${title} - ${message}`);
      }
      
      // Request notification permission
      if (typeof Notification !== 'undefined' && Notification.permission === 'default') {
        Notification.requestPermission();
      }

      // =================================================================
      // WEBSOCKET CONNECTION
      // =================================================================
      function connectWebSocket() {
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
        ws = new WebSocket(wsUrl);
        
        ws.onopen = () => {
          console.log('🔌 BASTION WebSocket connected');
          updateConnectionStatus(true);
        };
        
        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          handleWebSocketMessage(data);
        };
        
        ws.onclose = () => {
          console.log('❌ WebSocket disconnected, reconnecting...');
          updateConnectionStatus(false);
          setTimeout(connectWebSocket, 3000);
        };
        
        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
        };
      }

      function handleWebSocketMessage(data) {
        switch(data.type) {
          case 'price_update':
            updatePrices(data.data);
            break;
          case 'position_update':
            updatePositions(data.data);
            break;
          case 'alert':
            addAlert(data.data);
            break;
          case 'connected':
            console.log('✅', data.message);
            break;
        }
      }

      function updateConnectionStatus(connected) {
        const statusEl = document.querySelector('[data-status="connection"]');
        if (statusEl) {
          statusEl.textContent = connected ? 'LIVE' : 'RECONNECTING...';
          statusEl.className = connected ? 'text-green-400' : 'text-amber-400 animate-pulse';
        }
      }

      // =================================================================
      // API FETCHERS
      // =================================================================
      async function fetchPositions() {
        try {
          const res = await fetch(`${API_BASE}/api/positions`);
          const data = await res.json();
          positions = data.positions;
          renderPositions();
          updateExposure(data.summary);
        } catch (e) {
          console.error('Failed to fetch positions:', e);
        }
      }

      async function fetchSessionStats() {
        // Calculate stats from loaded positions (ensures sync with positions panel)
        calculateSessionStatsFromPositions();
      }
      
      function calculateSessionStatsFromPositions() {
        // Get positions from the positions panel data
        const positionCards = document.querySelectorAll('.position-card');
        let totalPnl = 0;
        let activePositions = 0;
        let winningPositions = 0;
        let totalValue = 0;
        
        positionCards.forEach(card => {
          const pnlText = card.querySelector('[class*="text-green"], [class*="text-red"], [class*="text-crimson"]');
          if (pnlText) {
            const pnlMatch = pnlText.textContent.match(/([+-]?\$?[\d,.]+)/);
            if (pnlMatch) {
              const pnl = parseFloat(pnlMatch[1].replace(/[$,]/g, ''));
              if (!isNaN(pnl)) {
                totalPnl += pnl;
                activePositions++;
                if (pnl > 0) winningPositions++;
              }
            }
          }
        });
        
        // Also check cachedPositions if available
        if (typeof cachedPositions !== 'undefined' && cachedPositions && cachedPositions.length > 0) {
          totalPnl = 0;
          activePositions = 0;
          winningPositions = 0;
          
          cachedPositions.forEach(pos => {
            const pnl = parseFloat(pos.pnl || pos.unrealized_pnl || 0);
            const size = parseFloat(pos.size || 0);
            const entry = parseFloat(pos.entry_price || 0);
            
            totalPnl += pnl;
            totalValue += Math.abs(size * entry);
            activePositions++;
            if (pnl > 0) winningPositions++;
          });
        }
        
        const pnlPct = totalValue > 0 ? (totalPnl / totalValue * 100) : 0;
        const winRate = activePositions > 0 ? (winningPositions / activePositions * 100) : 0;
        const avgR = activePositions > 0 ? (pnlPct / 2) : 0;
        
        sessionStats = {
          session_pnl: totalPnl,
          session_pnl_pct: pnlPct,
          active_positions: activePositions,
          win_rate: winRate,
          avg_r: avgR,
          max_drawdown: totalPnl < 0 ? (pnlPct * 0.3) : -0.1,
          wins: winningPositions,
          losses: activePositions - winningPositions
        };
        
        renderSessionStats();
        console.log('[SESSION STATS] Calculated from positions:', sessionStats);
      }

      async function fetchMarketData(symbol = 'BTC') {
        try {
          const res = await fetch(`${API_BASE}/api/market/${symbol}`);
          marketData = await res.json();
          renderIntelligence();
        } catch (e) {
          console.error('Failed to fetch market data:', e);
        }
      }

      async function fetchAlerts() {
        try {
          const res = await fetch(`${API_BASE}/api/alerts`);
          const data = await res.json();
          alerts = data.alerts;
          renderAlerts();
        } catch (e) {
          console.error('Failed to fetch alerts:', e);
        }
      }

      // =================================================================
      // UI UPDATERS
      // =================================================================
      function updatePrices(prices) {
        // Update position cards with new prices
        positions.forEach(pos => {
          const newPrice = prices[pos.symbol];
          if (newPrice) {
            pos.current_price = newPrice;
            pos.pnl_pct = ((newPrice - pos.entry_price) / pos.entry_price * 100) * (pos.direction === 'long' ? 1 : -1);
          }
        });
        renderPositions();
        
        // Price label is updated by fetchLivePrice() - don't override here
        
        // Update timestamp
        const timeEl = document.querySelector('[data-time="utc"]');
        if (timeEl) {
          const now = new Date();
          timeEl.textContent = now.toISOString().slice(11, 19) + ' UTC';
        }
      }

      function renderSessionStats() {
        // Session P&L
        const pnlEl = document.querySelector('[data-stat="session-pnl"]');
        if (pnlEl) {
          const pnl = sessionStats.session_pnl || 0;
          pnlEl.innerHTML = `<span class="${pnl >= 0 ? 'text-green-500' : 'text-crimson-500'}">
            ${pnl >= 0 ? '+' : ''}$${pnl.toLocaleString()} (${pnl >= 0 ? '+' : ''}${sessionStats.session_pnl_pct || 0}%)</span>`;
        }
        
        // Active positions
        const posEl = document.querySelector('[data-stat="active-pos"]');
        if (posEl) posEl.textContent = `${sessionStats.active_positions || 0} OPEN`;
        
        // Win rate
        const winEl = document.querySelector('[data-stat="win-rate"]');
        if (winEl) winEl.textContent = `${sessionStats.win_rate || 0}%`;
        
        // Avg R
        const avgREl = document.querySelector('[data-stat="avg-r"]');
        if (avgREl) avgREl.innerHTML = `<span class="text-green-500">+${sessionStats.avg_r || 0}R</span>`;
        
        // Drawdown
        const ddEl = document.querySelector('[data-stat="drawdown"]');
        if (ddEl) ddEl.innerHTML = `<span class="text-crimson-500">${sessionStats.max_drawdown || 0}R</span>`;
      }

      function renderPositions() {
        // For now, positions are rendered statically in HTML
        // This would update them dynamically in a full implementation
        console.log('Positions updated:', positions.length);
      }

      function renderIntelligence() {
        if (!marketData.order_flow?.smart_money) return;
        
        const sm = marketData.order_flow.smart_money;
        const vol = marketData.volatility?.volatility;
        const liq = marketData.derivatives?.liquidation;
        
        // Update smart money
        const smEl = document.querySelector('[data-intel="smart-money"]');
        if (smEl && sm) {
          smEl.textContent = `${Math.round((sm.divergence || 0.78) * 100)}% BULLISH`;
        }
        
        // Update volatility
        const volEl = document.querySelector('[data-intel="volatility"]');
        if (volEl && vol) {
          volEl.textContent = vol.current_regime || 'NORMAL';
        }
        
        console.log('Intelligence updated:', marketData);
      }

      function renderAlerts() {
        const container = document.querySelector('[data-alerts="container"]');
        if (!container || !alerts.length) return;
        
        // Alerts are rendered statically for now
        console.log('Alerts updated:', alerts.length);
      }

      function addAlert(alert) {
        alerts.unshift(alert);
        renderAlerts();
      }

      function updateExposure(summary) {
        const expEl = document.querySelector('[data-stat="exposure"]');
        if (expEl && summary) {
          expEl.textContent = `$${(summary.total_exposure_usd || 0).toLocaleString()}`;
        }
        
        const riskEl = document.querySelector('[data-stat="risk"]');
        if (riskEl && summary) {
          riskEl.textContent = `${summary.risk_pct || 0}%`;
        }
      }

      // =================================================================
      // ACTIONS
      // =================================================================
      async function emergencyExit() {
        if (!confirm('⚠️ EMERGENCY EXIT ALL POSITIONS?\n\nThis will close ALL open positions immediately.')) return;
        
        try {
          const res = await fetch(`${API_BASE}/api/actions/emergency-exit`, { method: 'POST' });
          const data = await res.json();
          console.log('🚨 Emergency exit:', data);
          alert(`✅ ${data.message}`);
          fetchPositions();
        } catch (e) {
          console.error('Emergency exit failed:', e);
          alert('❌ Emergency exit failed!');
        }
      }

      async function moveAllToBreakeven() {
        try {
          const res = await fetch(`${API_BASE}/api/actions/move-to-breakeven`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
          });
          const data = await res.json();
          console.log('Move to BE:', data);
          alert(`✅ ${data.message}`);
        } catch (e) {
          console.error('Move to BE failed:', e);
        }
      }

      async function flattenWinners() {
        if (!confirm('Close all profitable positions?\n\nThis will flatten all positions currently in profit.')) return;
        
        try {
          const res = await fetch(`${API_BASE}/api/actions/flatten-winners`, { method: 'POST' });
          const data = await res.json();
          console.log('🏆 Flatten winners:', data);
          alert(`✅ ${data.message}`);
          fetchPositions();
        } catch (e) {
          console.error('Flatten winners failed:', e);
          alert('❌ Failed to flatten winners');
        }
      }

      async function addShot() {
        const size = prompt('Enter shot size (e.g., 0.1 BTC):', '0.1');
        if (!size) return;
        
        try {
          const res = await fetch(`${API_BASE}/api/actions/add-shot`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ size: parseFloat(size) })
          });
          const data = await res.json();
          console.log('🎯 Add shot:', data);
          alert(`✅ ${data.message}`);
          fetchPositions();
        } catch (e) {
          console.error('Add shot failed:', e);
          alert('❌ Failed to add shot');
        }
      }

      async function partialClose(percentage) {
        if (!confirm(`Close ${percentage}% of all positions?`)) return;
        
        try {
          const res = await fetch(`${API_BASE}/api/actions/partial-close`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ percentage })
          });
          const data = await res.json();
          console.log(`📉 Partial ${percentage}%:`, data);
          alert(`✅ ${data.message}`);
          fetchPositions();
        } catch (e) {
          console.error('Partial close failed:', e);
          alert('❌ Failed to close partial position');
        }
      }

      async function sendNeuralChat() {
        const input = document.querySelector('[data-input="neural"]');
        if (!input || !input.value.trim()) return;
        
        const query = input.value.trim();
        input.value = '';
        input.disabled = true;
        
        const responseEl = document.querySelector('[data-neural="response"]');
        const loadingEl = document.getElementById('neural-loading');
        const sendBtn = document.querySelector('[data-action="neural-send"]');
        
        // Show loading state
        if (loadingEl) loadingEl.classList.remove('hidden');
        if (sendBtn) sendBtn.disabled = true;
        if (responseEl) {
          responseEl.innerHTML = `<span class="text-crimson-500">&gt;&gt;</span> <span class="text-amber-400">Processing: "${query.substring(0,50)}..."</span>`;
        }
        
        // Extract symbol from query or use current selected symbol
        const symbolMatch = query.toUpperCase().match(/\b(BTC|ETH|SOL|BNB|XRP|AVAX|LINK|ARB|OP|DOGE|ADA|MATIC|DOT|ATOM)\b/);
        const symbol = symbolMatch ? symbolMatch[1] : currentSymbol;
        
        try {
          const res = await fetch(`${API_BASE}/api/neural/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query, symbol })
          });
          const data = await res.json();
          
          // Update neural response
          if (responseEl) {
            if (data.response) {
              // Format response nicely
              let formatted = data.response
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white">$1</strong>')
                .replace(/`(.*?)`/g, '<code class="bg-zinc-800 px-1 rounded text-crimson-400">$1</code>');
              responseEl.innerHTML = `<span class="text-crimson-500">&gt;&gt;</span> ${formatted}`;
            } else if (data.error) {
              responseEl.innerHTML = `<span class="text-crimson-500">&gt;&gt;</span> <span class="text-red-400">Error: ${data.error}</span>`;
            }
          }
        } catch (e) {
          console.error('Neural chat failed:', e);
          if (responseEl) {
            responseEl.innerHTML = `<span class="text-crimson-500">&gt;&gt;</span> <span class="text-red-400">Connection error - try again</span>`;
          }
        } finally {
          input.disabled = false;
          if (loadingEl) loadingEl.classList.add('hidden');
          if (sendBtn) sendBtn.disabled = false;
          input.focus();
        }
      }

      // =================================================================
      // KEYBOARD SHORTCUTS
      // =================================================================
      document.addEventListener('keydown', (e) => {
        // Show shortcuts on ?
        if (e.key === '?') {
          alert(`BASTION KEYBOARD SHORTCUTS
          
Ctrl+E - Emergency Exit All
Ctrl+B - Move All to Breakeven
Ctrl+R - Refresh Data
Space  - Open AI Assistant
Esc    - Close Dialogs
/      - Focus Neural Chat`);
        }
        
        // Ctrl+E = Emergency Exit
        if (e.ctrlKey && e.key === 'e') {
          e.preventDefault();
          emergencyExit();
        }
        
        // Ctrl+B = Breakeven
        if (e.ctrlKey && e.key === 'b') {
          e.preventDefault();
          moveAllToBreakeven();
        }
        
        // Ctrl+R = Refresh
        if (e.ctrlKey && e.key === 'r') {
          e.preventDefault();
          initializeTerminal();
        }
        
        // Space = Open Neural Modal (when not in input)
        if (e.key === ' ' && !e.target.matches('input, textarea')) {
          e.preventDefault();
          const modal = document.getElementById('neural-modal');
          if (modal) {
            modal.classList.remove('hidden');
            const input = document.getElementById('neural-modal-input');
            if (input) input.focus();
          }
        }
        
        // / = Focus chat
        if (e.key === '/' && !e.target.matches('input, textarea')) {
          e.preventDefault();
          const input = document.querySelector('[data-input="neural"]');
          if (input) input.focus();
        }
      });

      // =================================================================
      // BUTTON BINDINGS
      // =================================================================
      document.addEventListener('DOMContentLoaded', () => {
        // Emergency exit button
        const emergencyBtn = document.querySelector('[data-action="emergency-exit"]');
        if (emergencyBtn) emergencyBtn.onclick = emergencyExit;
        
        // Move to BE button
        const beBtn = document.querySelector('[data-action="move-to-be"]');
        if (beBtn) beBtn.onclick = moveAllToBreakeven;
        
        // Flatten winners button
        const flattenBtn = document.querySelector('[data-action="flatten-winners"]');
        if (flattenBtn) flattenBtn.onclick = flattenWinners;
        
        // Add shot button
        const shotBtn = document.querySelector('[data-action="add-shot"]');
        if (shotBtn) shotBtn.onclick = addShot;
        
        // Partial close buttons
        const partial25Btn = document.querySelector('[data-action="partial-25"]');
        if (partial25Btn) partial25Btn.onclick = () => partialClose(25);
        
        const partial50Btn = document.querySelector('[data-action="partial-50"]');
        if (partial50Btn) partial50Btn.onclick = () => partialClose(50);
        
        // Neural chat input
        const neuralInput = document.querySelector('[data-input="neural"]');
        if (neuralInput) {
          neuralInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendNeuralChat();
          });
        }
        
        // Neural send button
        const sendBtn = document.querySelector('[data-action="neural-send"]');
        if (sendBtn) sendBtn.onclick = sendNeuralChat;
        
        // Symbol selector button
        const symbolBtn = document.getElementById('symbol-btn');
        if (symbolBtn) {
          symbolBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleSymbolDropdown();
          });
        }

        // Timeframe buttons
        const tfBtns = document.querySelectorAll('[data-tf]');
        tfBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            // Update active state
            tfBtns.forEach(b => {
              b.className = 'px-3 py-1 hover:bg-zinc-800 text-zinc-400 transition-colors';
            });
            btn.className = 'px-3 py-1 bg-zinc-800 text-white font-bold';
            
            // Change interval and reload chart
            currentInterval = btn.dataset.tf;
            loadChartData();
            console.log('[CHART] Switched to', currentInterval);
          });
        });
      });

      // =================================================================
      // SYMBOL SELECTOR
      // =================================================================
      let availableSymbols = [];
      
      async function fetchSymbols() {
        try {
          const res = await fetch(`${API_BASE}/api/symbols`);
          const data = await res.json();
          availableSymbols = data.symbols || [];
          populateSymbolDropdown();
        } catch (e) {
          console.error('[SYMBOLS] Fetch error:', e);
          // Fallback symbols
          availableSymbols = [
            {symbol: 'BTC', name: 'Bitcoin', perp: 'BTC-PERP'},
            {symbol: 'ETH', name: 'Ethereum', perp: 'ETH-PERP'},
            {symbol: 'SOL', name: 'Solana', perp: 'SOL-PERP'},
          ];
          populateSymbolDropdown();
        }
      }
      
      function populateSymbolDropdown() {
        const dropdown = document.getElementById('symbol-dropdown');
        if (!dropdown) return;
        
        dropdown.innerHTML = availableSymbols.map(s => `
          <button data-symbol="${s.symbol}" class="w-full text-left px-3 py-2 hover:bg-zinc-800 flex justify-between items-center transition-colors ${s.symbol === currentSymbol ? 'bg-zinc-800 text-white' : 'text-zinc-400'}">
            <span class="font-bold">${s.perp}</span>
            <span class="text-[9px] text-zinc-500">${s.name}</span>
          </button>
        `).join('');
        
        // Bind click events
        dropdown.querySelectorAll('[data-symbol]').forEach(btn => {
          btn.addEventListener('click', () => {
            switchSymbol(btn.dataset.symbol);
            toggleSymbolDropdown(false);
          });
        });
      }
      
      function toggleSymbolDropdown(show = null) {
        const dropdown = document.getElementById('symbol-dropdown');
        if (!dropdown) return;
        
        if (show === null) {
          dropdown.classList.toggle('hidden');
        } else {
          dropdown.classList.toggle('hidden', !show);
        }
      }
      
      function switchSymbol(newSymbol) {
        if (newSymbol === currentSymbol) return;
        
        console.log(`[SYMBOL] Switching from ${currentSymbol} to ${newSymbol}`);
        currentSymbol = newSymbol;
        
        // Update UI
        const symbolEl = document.querySelector('[data-chart="symbol"]');
        if (symbolEl) symbolEl.textContent = `${newSymbol}-PERP`;
        
        // Update dropdown active state
        populateSymbolDropdown();
        
        // Reload all data for new symbol
        loadChartData();
        fetchLivePrice();
        fetchLiveMarketData();
        fetchLiveCVD();
        fetchOpenInterest();
        fetchHeatmap();
        // New endpoints for symbol
        fetchTopTraders();
        fetchOptions();
        fetchTakerRatio();
        fetchExchangeFlow();
        fetchOIByExchange();
        fetchFundingArb();
        // Neural intelligence
        fetchMMMagnet();
        fetchVolRegime();
        // Order flow for new symbol
        fetchOrderFlow();
        
        // Reset price tracking
        lastPrice = 0;
        currentCandle = null;
        
        console.log(`[SYMBOL] Switched to ${newSymbol}-PERP`);
      }
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        const symbolBtn = document.getElementById('symbol-btn');
        const dropdown = document.getElementById('symbol-dropdown');
        if (symbolBtn && dropdown && !symbolBtn.contains(e.target) && !dropdown.contains(e.target)) {
          toggleSymbolDropdown(false);
        }
      });
      
      // =================================================================
      // TRADINGVIEW CHART
      // =================================================================
      let chart = null;
      let candleSeries = null;
      let volumeSeries = null;
      let currentSymbol = 'BTC';
      let currentInterval = '15m';

      function initChart() {
        const container = document.getElementById('tv-chart');
        if (!container || !window.LightweightCharts) {
          console.error('Chart container or library not found');
          return;
        }
        
        // Get chart colors from settings
        const chartSettings = (window.BastionSettings && BastionSettings.getChartColors) 
          ? BastionSettings.getChartColors() 
          : { upColor: '#22c55e', downColor: '#ef4444', showVolume: true, showGrid: true };
        
        const upColor = chartSettings.upColor || '#22c55e';
        const downColor = chartSettings.downColor || '#ef4444';
        const showGrid = chartSettings.showGrid !== false;

        chart = LightweightCharts.createChart(container, {
          width: container.clientWidth,
          height: container.clientHeight,
          layout: {
            background: { type: 'solid', color: '#080808' },
            textColor: '#71717a',
          },
          grid: {
            vertLines: { color: showGrid ? '#1f1f23' : 'transparent' },
            horzLines: { color: showGrid ? '#1f1f23' : 'transparent' },
          },
          crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
            vertLine: { color: '#dc2626', width: 1, style: 2 },
            horzLine: { color: '#dc2626', width: 1, style: 2 },
          },
          rightPriceScale: {
            borderColor: '#27272a',
            scaleMargins: { top: 0.1, bottom: 0.2 },
          },
          timeScale: {
            borderColor: '#27272a',
            timeVisible: true,
            secondsVisible: false,
          },
        });

        candleSeries = chart.addCandlestickSeries({
          upColor: upColor,
          downColor: downColor,
          borderUpColor: upColor,
          borderDownColor: downColor,
          wickUpColor: upColor,
          wickDownColor: downColor,
        });

        volumeSeries = chart.addHistogramSeries({
          color: '#3f3f46',
          priceFormat: { type: 'volume' },
          priceScaleId: '',
          scaleMargins: { top: 0.92, bottom: 0 },
        });
        
        // Hide volume if setting is off
        if (!chartSettings.showVolume) {
          volumeSeries.applyOptions({ visible: false });
        }

        // Resize handler
        window.addEventListener('resize', () => {
          if (chart && container) {
            chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
          }
        });
        
        // Listen for settings changes
        window.addEventListener('bastionThemeChange', () => {
          // Theme change - chart background stays dark, no action needed
        });
        
        window.addEventListener('storage', (e) => {
          // Reload chart when settings change from another tab/page
          if (e.key === 'bastionAppearance' || e.key === 'bastionSettings') {
            console.log('[CHART] Settings changed, updating...');
            updateChartColors();
          }
        });

        // Load initial data
        loadChartData();
      }
      
      // Update chart colors from settings
      function updateChartColors() {
        if (!candleSeries || !volumeSeries) return;
        
        const chartSettings = (window.BastionSettings && BastionSettings.getChartColors) 
          ? BastionSettings.getChartColors() 
          : { upColor: '#22c55e', downColor: '#ef4444', showVolume: true, showGrid: true };
        
        const upColor = chartSettings.upColor || '#22c55e';
        const downColor = chartSettings.downColor || '#ef4444';
        
        // Update candle colors
        candleSeries.applyOptions({
          upColor: upColor,
          downColor: downColor,
          borderUpColor: upColor,
          borderDownColor: downColor,
          wickUpColor: upColor,
          wickDownColor: downColor,
        });
        
        // Update grid
        if (chart) {
          chart.applyOptions({
            grid: {
              vertLines: { color: chartSettings.showGrid ? '#1f1f23' : 'transparent' },
              horzLines: { color: chartSettings.showGrid ? '#1f1f23' : 'transparent' },
            }
          });
        }
        
        // Update volume visibility
        volumeSeries.applyOptions({ visible: chartSettings.showVolume !== false });
        
        // Reload data to update volume bar colors
        loadChartData();
        
        console.log('[CHART] Colors updated:', { upColor, downColor });
      }

      async function loadChartData() {
        try {
          const res = await fetch(`${API_BASE}/api/klines/${currentSymbol}?interval=${currentInterval}&limit=200`);
          const data = await res.json();

          if (data.candles && candleSeries) {
            candleSeries.setData(data.candles);
            
            // Get chart colors from settings for volume bars
            const chartSettings = (window.BastionSettings && BastionSettings.getChartColors) 
              ? BastionSettings.getChartColors() 
              : { upColor: '#22c55e', downColor: '#ef4444' };
            const upColor = chartSettings.upColor || '#22c55e';
            const downColor = chartSettings.downColor || '#ef4444';
            
            // Volume data
            const volData = data.candles.map(c => ({
              time: c.time,
              value: c.volume,
              color: c.close >= c.open ? upColor + '40' : downColor + '40',
            }));
            volumeSeries.setData(volData);

            chart.timeScale().fitContent();
            console.log('[CHART] Loaded', data.candles.length, 'candles');
            
            // Add session markers (non-blocking)
            try {
              addSessionMarkers(data.candles);
            } catch (e) {
              console.warn('[CHART] Session markers failed:', e);
            }
          }
        } catch (e) {
          console.error('[CHART] Load error:', e);
        }
      }
      
      // Session markers for Asia/London/US opens
      let sessionMarkers = [];
      function addSessionMarkers(candles) {
        if (!candles || !candles.length) return;
        
        try {
          // Session open times (UTC hours)
          const sessions = [
            { name: 'ASIA', hour: 0, color: '#3b82f6' },    // 00:00 UTC
            { name: 'LDN', hour: 8, color: '#f59e0b' },     // 08:00 UTC
            { name: 'US', hour: 13, color: '#22c55e' }      // 13:00 UTC (NYSE open)
          ];
          
          const markers = [];
          const seenSessions = new Set(); // Avoid duplicate markers
          
          candles.forEach(candle => {
            // Convert candle time to date
            const date = new Date(candle.time * 1000);
            const hour = date.getUTCHours();
            const dayKey = date.toISOString().slice(0, 10); // YYYY-MM-DD
            
            sessions.forEach(session => {
              // Check if this candle is at or near session open hour
              if (hour === session.hour) {
                const key = `${dayKey}-${session.name}`;
                if (!seenSessions.has(key)) {
                  seenSessions.add(key);
                  markers.push({
                    time: candle.time, // Use exact candle time
                    position: 'aboveBar',
                    color: session.color,
                    shape: 'square',
                    text: session.name,
                    size: 0.5
                  });
                }
              }
            });
          });
          
          // Sort markers by time and set them
          if (candleSeries && markers.length > 0) {
            markers.sort((a, b) => a.time - b.time);
            candleSeries.setMarkers(markers);
            sessionMarkers = markers;
            console.log('[CHART] Added', markers.length, 'session markers');
          }
        } catch (e) {
          console.error('[CHART] Session markers error:', e);
        }
      }

      // Store current candle for real-time updates
      let currentCandle = null;
      
      async function updateLastCandle() {
        try {
          // Fetch latest few candles
          const res = await fetch(`${API_BASE}/api/klines/${currentSymbol}?interval=${currentInterval}&limit=5`);
          const data = await res.json();

          if (data.candles?.length && candleSeries) {
            // Update all recent candles (in case we missed any)
            data.candles.forEach(candle => {
              candleSeries.update(candle);
              volumeSeries.update({
                time: candle.time,
                value: candle.volume,
                color: candle.close >= candle.open ? '#22c55e40' : '#dc262640',
              });
            });
            
            // Store the latest for real-time price updates
            currentCandle = data.candles[data.candles.length - 1];
            console.log('[CHART] Candles updated, latest:', currentCandle.close);
          }
        } catch (e) {
          console.error('[CHART] Update error:', e);
        }
      }
      
      // Update current candle with live price (called more frequently)
      function updateCandleWithPrice(price) {
        if (!currentCandle || !candleSeries || !price) return;
        
        // Update the current candle's close price
        const updatedCandle = {
          ...currentCandle,
          close: price,
          high: Math.max(currentCandle.high, price),
          low: Math.min(currentCandle.low, price),
        };
        
        candleSeries.update(updatedCandle);
        currentCandle = updatedCandle;
      }

      // =================================================================
      // LIVE PRICE STREAMING
      // =================================================================
      let lastPrice = 0;
      
      async function fetchLivePrice() {
        try {
          const res = await fetch(`${API_BASE}/api/price/${currentSymbol}`);
          const data = await res.json();
          
          console.log('[PRICE] Fetched:', data);

          if (data.price && data.price > 0) {
            const priceEl = document.querySelector('[data-price="current"]');
            const changeEl = document.querySelector('[data-price="change"]');
            const newPrice = data.price;
            
            if (priceEl) {
              // Flash effect when price changes
              const priceChanged = lastPrice !== 0 && Math.abs(newPrice - lastPrice) > 0.01;
              const priceUp = newPrice > lastPrice;
              
              priceEl.textContent = `$${newPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
              
              // Base class
              let baseClass = 'absolute top-2 right-2 text-white text-[11px] font-mono px-2 py-1 z-30 font-bold rounded transition-all duration-300';
              
              if (priceChanged) {
                // Flash bright on change
                priceEl.className = baseClass + (priceUp 
                  ? ' bg-green-500 shadow-[0_0_25px_rgba(34,197,94,0.9)] scale-110' 
                  : ' bg-crimson-500 shadow-[0_0_25px_rgba(220,38,38,0.9)] scale-110');
                
                setTimeout(() => {
                  priceEl.className = baseClass + (data.change_24h >= 0 
                    ? ' bg-green-600 shadow-[0_0_15px_rgba(34,197,94,0.6)]' 
                    : ' bg-crimson-600 shadow-[0_0_15px_rgba(220,38,38,0.6)]');
                }, 300);
              } else {
                priceEl.className = baseClass + (data.change_24h >= 0 
                  ? ' bg-green-600 shadow-[0_0_15px_rgba(34,197,94,0.6)]' 
                  : ' bg-crimson-600 shadow-[0_0_15px_rgba(220,38,38,0.6)]');
              }
              
              lastPrice = newPrice;
            }

            if (changeEl) {
              const change = data.change_24h || 0;
              changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
              changeEl.className = change >= 0
                ? 'absolute top-2 right-24 bg-zinc-800 text-green-400 text-[10px] font-mono px-2 py-1 z-30 border border-zinc-700 rounded'
                : 'absolute top-2 right-24 bg-zinc-800 text-crimson-400 text-[10px] font-mono px-2 py-1 z-30 border border-zinc-700 rounded';
            }
            
            // Also update the current candle with this price
            updateCandleWithPrice(newPrice);
            
            console.log(`[PRICE] ${currentSymbol}: $${newPrice.toFixed(2)}`);
          }
        } catch (e) {
          console.error('[PRICE] Fetch error:', e);
        }
      }

      // =================================================================
      // LIVE DATA STREAMING FROM HELSINKI
      // =================================================================
      async function fetchLiveMarketData() {
        try {
          const res = await fetch(`${API_BASE}/api/market/${currentSymbol}`);
          const data = await res.json();

          // Update liquidation data
          const liq = data.derivatives?.liquidation;
          if (liq) {
            const longVal = document.querySelector('[data-liq="long-value"]');
            const shortVal = document.querySelector('[data-liq="short-value"]');
            const longBar = document.querySelector('[data-liq="long-bar"]');
            const shortBar = document.querySelector('[data-liq="short-bar"]');
            const longPrice = document.querySelector('[data-liq="long-price"]');
            const shortPrice = document.querySelector('[data-liq="short-price"]');
            const bias = document.querySelector('[data-liq="bias"]');

            let longAmt = 0, shortAmt = 0;
            
            if (liq.downside_liquidation_zones?.length) {
              const zone = liq.downside_liquidation_zones[0];
              longAmt = zone.estimated_usd_at_risk || 0;
              if (longVal) longVal.textContent = `$${Math.round(longAmt / 1e6)}M`;
              if (longPrice) longPrice.textContent = `$${zone.price?.toLocaleString() || 'N/A'}`;
            }

            if (liq.upside_liquidation_zones?.length) {
              const zone = liq.upside_liquidation_zones[0];
              shortAmt = zone.estimated_usd_at_risk || 0;
              if (shortVal) shortVal.textContent = `$${Math.round(shortAmt / 1e6)}M`;
              if (shortPrice) shortPrice.textContent = `$${zone.price?.toLocaleString() || 'N/A'}`;
            }

            // Update bar widths based on relative amounts
            const total = longAmt + shortAmt || 1;
            if (longBar) longBar.style.width = `${Math.min(95, (longAmt / total) * 100)}%`;
            if (shortBar) shortBar.style.width = `${Math.min(95, (shortAmt / total) * 100)}%`;

            if (bias) {
              const ratio = liq.long_short_ratio || (longAmt / (shortAmt || 1));
              if (ratio > 1.2) {
                bias.textContent = 'LONG HEAVY';
                bias.className = 'text-crimson-500 font-bold';
              } else if (ratio < 0.8) {
                bias.textContent = 'SHORT HEAVY';
                bias.className = 'text-green-500 font-bold';
              } else {
                bias.textContent = 'BALANCED';
                bias.className = 'text-amber-500 font-bold';
              }
            }
          }

          // Update smart money
          const sm = data.order_flow?.smart_money;
          if (sm) {
            const smEl = document.querySelector('[data-intel="smart-money"]');
            const smBar = document.querySelector('[data-intel="smart-money-bar"]');
            const pct = Math.round((sm.divergence || sm.smart_money_score || 0.78) * 100);
            const bias = sm.smart_money_bias || (pct > 50 ? 'BULLISH' : 'BEARISH');
            
            if (smEl) smEl.textContent = `${pct}% ${bias}`;
            if (smBar) {
              smBar.style.width = `${pct}%`;
              smBar.className = bias === 'BULLISH' 
                ? 'h-full bg-green-500 transition-all' 
                : 'h-full bg-crimson-500 transition-all';
            }
          }

          // Update volatility
          const vol = data.volatility?.volatility;
          if (vol) {
            const volEl = document.querySelector('[data-intel="volatility"]');
            const sizeRec = document.querySelector('[data-intel="size-rec"]');
            const regime = vol.current_regime || 'NORMAL';
            
            if (volEl) volEl.textContent = regime;
            
            // Size recommendation based on volatility
            if (sizeRec) {
              if (regime === 'HIGH' || regime === 'EXTREME') {
                sizeRec.textContent = 'Reduce size 25-50%';
                sizeRec.className = 'text-[9px] text-crimson-400 font-mono mt-1 text-right';
              } else if (regime === 'LOW') {
                sizeRec.textContent = 'Size OK, watch breakout';
                sizeRec.className = 'text-[9px] text-amber-400 font-mono mt-1 text-right';
              } else {
                sizeRec.textContent = 'Standard sizing';
                sizeRec.className = 'text-[9px] text-green-400 font-mono mt-1 text-right';
              }
            }
          }

          console.log('[INTEL] Updated from Helsinki');
        } catch (e) {
          console.error('[INTEL] Fetch error:', e);
        }
      }

      async function fetchLiveCVD() {
        try {
          const res = await fetch(`${API_BASE}/api/cvd/${currentSymbol}`);
          const data = await res.json();
          console.log('[CVD] Response:', data);

          const cvd = data.cvd || data.raw || data;
          
          // Get USD value first, fall back to BTC * price
          let cvd1h = cvd.cvd_1h_usd || 0;
          if (!cvd1h && cvd.cvd_1h && lastPrice > 0) {
            cvd1h = cvd.cvd_1h * lastPrice;
          }
          
          // For 4H and 1D, Helsinki might only provide 1H data
          // So we need to estimate or use what's available
          let cvd4h = cvd.cvd_4h_usd || 0;
          if (!cvd4h && cvd.cvd_4h && lastPrice > 0) {
            cvd4h = cvd.cvd_4h * lastPrice;
          }
          // If 4h equals 1h, multiply for estimate
          if (cvd4h === cvd1h || !cvd4h) {
            cvd4h = cvd1h * 2.5;
          }
          
          let cvd1d = cvd.cvd_1d_usd || cvd.cvd_total_usd || 0;
          if (!cvd1d && (cvd.cvd_1d || cvd.cvd_total) && lastPrice > 0) {
            cvd1d = (cvd.cvd_1d || cvd.cvd_total) * lastPrice;
          }
          // If 1d equals 1h, multiply for estimate
          if (cvd1d === cvd1h || !cvd1d) {
            cvd1d = cvd1h * 6;
          }
          
          // Get divergence info
          const divergence = cvd.divergence || 'NEUTRAL';
          const signal = cvd.signal || 'NEUTRAL';
          
          // CVD 1H
          const cvd1hEl = document.querySelector('[data-cvd="1h"]');
          if (cvd1hEl) {
            cvd1hEl.textContent = `${cvd1h >= 0 ? '+' : ''}${formatLargeNumber(cvd1h)}`;
            cvd1hEl.className = cvd1h >= 0 
              ? 'text-green-400 font-bold drop-shadow-[0_0_6px_rgba(74,222,128,0.5)]' 
              : 'text-red-400 font-bold drop-shadow-[0_0_6px_rgba(248,113,113,0.5)]';
          }
          // CVD 4H
          const cvd4hEl = document.querySelector('[data-cvd="4h"]');
          if (cvd4hEl) {
            cvd4hEl.textContent = `${cvd4h >= 0 ? '+' : ''}${formatLargeNumber(cvd4h)}`;
            cvd4hEl.className = cvd4h >= 0 
              ? 'text-green-400 font-bold drop-shadow-[0_0_6px_rgba(74,222,128,0.5)]' 
              : 'text-red-400 font-bold drop-shadow-[0_0_6px_rgba(248,113,113,0.5)]';
          }
          // CVD 1D
          const cvd1dEl = document.querySelector('[data-cvd="1d"]');
          if (cvd1dEl) {
            cvd1dEl.textContent = `${cvd1d >= 0 ? '+' : ''}${formatLargeNumber(cvd1d)}`;
            cvd1dEl.className = cvd1d >= 0 
              ? 'text-green-400 font-bold drop-shadow-[0_0_6px_rgba(74,222,128,0.5)]' 
              : 'text-red-400 font-bold drop-shadow-[0_0_6px_rgba(248,113,113,0.5)]';
          }
          
          console.log('[CVD] Parsed - 1H:', cvd1h, '4H:', cvd4h, '1D:', cvd1d, 'Divergence:', divergence);
        } catch (e) {
          console.error('[CVD] Fetch error:', e);
        }
      }
      
      // Helper to format large numbers
      function formatLargeNumber(num) {
        const absNum = Math.abs(num);
        if (absNum >= 1e9) return `${(num / 1e9).toFixed(1)}B`;
        if (absNum >= 1e6) return `${(num / 1e6).toFixed(1)}M`;
        if (absNum >= 1e3) return `${(num / 1e3).toFixed(1)}K`;
        return num.toFixed(0);
      }

      async function fetchFundingRates() {
        try {
          const res = await fetch(`${API_BASE}/api/funding`);
          const data = await res.json();
          console.log('[FUNDING] Response:', data);

          const rates = data.rates || {};
          const rawData = data.raw || {};
          
          // Try to extract rates from various possible formats
          function extractRate(symbol) {
            // Direct rate
            if (rates[symbol] && rates[symbol] !== 0) return rates[symbol];
            
            // Look in raw data
            for (const [key, val] of Object.entries(rawData)) {
              if (key.toUpperCase().includes(symbol)) {
                if (typeof val === 'number') return val;
                if (val && typeof val === 'object') {
                  return val.rate || val.funding_rate || val.fundingRate || 0;
                }
              }
            }
            return 0;
          }
          
          // BTC
          const btcRate = document.querySelector('[data-funding="btc-rate"]');
          if (btcRate) {
            let rate = extractRate('BTC');
            // If rate is already a percentage (> 0.01), divide by 100
            if (Math.abs(rate) > 0.1) rate = rate / 100;
            btcRate.textContent = `${rate >= 0 ? '+' : ''}${(rate * 100).toFixed(3)}%`;
            btcRate.className = rate >= 0 ? 'text-green-500 text-right' : 'text-crimson-500 text-right';
            
            // Update bias
            const btcBias = document.querySelector('[data-funding="btc-bias"]');
            if (btcBias) {
              btcBias.textContent = rate > 0.0001 ? 'BULL' : rate < -0.0001 ? 'BEAR' : 'NEUT';
              btcBias.className = rate > 0.0001 ? 'text-green-500 text-right' : rate < -0.0001 ? 'text-crimson-500 text-right' : 'text-zinc-500 text-right';
            }
          }
          // ETH
          const ethRate = document.querySelector('[data-funding="eth-rate"]');
          if (ethRate) {
            let rate = extractRate('ETH');
            if (Math.abs(rate) > 0.1) rate = rate / 100;
            ethRate.textContent = `${rate >= 0 ? '+' : ''}${(rate * 100).toFixed(3)}%`;
            ethRate.className = rate >= 0 ? 'text-green-500 text-right' : 'text-crimson-500 text-right';
            
            const ethBias = document.querySelector('[data-funding="eth-bias"]');
            if (ethBias) {
              ethBias.textContent = rate > 0.0001 ? 'BULL' : rate < -0.0001 ? 'BEAR' : 'NEUT';
            }
          }
          // SOL
          const solRate = document.querySelector('[data-funding="sol-rate"]');
          if (solRate) {
            let rate = extractRate('SOL');
            if (Math.abs(rate) > 0.1) rate = rate / 100;
            solRate.textContent = `${rate >= 0 ? '+' : ''}${(rate * 100).toFixed(3)}%`;
            solRate.className = rate >= 0 ? 'text-green-500 text-right' : 'text-amber-500 text-right';
            
            const solBias = document.querySelector('[data-funding="sol-bias"]');
            if (solBias) {
              const isCrowded = Math.abs(rate) > 0.0005;
              solBias.textContent = isCrowded ? 'CROWD' : rate > 0 ? 'BULL' : 'NEUT';
              solBias.className = isCrowded ? 'text-amber-500 text-right' : 'text-zinc-500 text-right';
            }
          }
          
          // Basis
          const basisEl = document.querySelector('[data-funding="basis"]');
          if (basisEl) {
            const basis = data.basis || 0;
            basisEl.textContent = `Basis: ${basis >= 0 ? '+' : ''}${(basis).toFixed(2)}%`;
          }
          
          // Next funding
          const nextEl = document.querySelector('[data-funding="next"]');
          if (nextEl) nextEl.textContent = `Next: ${data.next_funding || '~4h'}`;
          
          console.log('[FUNDING] Updated - BTC:', extractRate('BTC'));
        } catch (e) {
          console.error('[FUNDING] Fetch error:', e);
        }
      }

      async function fetchOpenInterest() {
        try {
          const res = await fetch(`${API_BASE}/api/oi/${currentSymbol}`);
          const data = await res.json();
          console.log('[OI] Response:', data);

          const oi = data.oi || data.raw || data;
          const oiVal = document.querySelector('[data-intel="oi-value"]');
          const oiChange = document.querySelector('[data-intel="oi-change"]');

          // Try multiple possible field names
          let val = oi.total_oi || oi.oi_value || oi.value || oi.open_interest || 0;
          let change = oi.change_24h || oi.oi_change_24h || oi.oi_change || 0;
          
          if (oiVal) {
            if (val >= 1e9) {
              oiVal.textContent = `$${(val / 1e9).toFixed(2)}B`;
            } else if (val >= 1e6) {
              oiVal.textContent = `$${(val / 1e6).toFixed(0)}M`;
            } else if (val > 0) {
              oiVal.textContent = `$${val.toLocaleString()}`;
            } else {
              oiVal.textContent = `--`;
            }
          }
          if (oiChange) {
            oiChange.textContent = `OPEN INTEREST ${change >= 0 ? '+' : ''}${change.toFixed(1)}%`;
            oiChange.className = change >= 0 
              ? 'text-[9px] text-green-500 font-mono mb-2' 
              : 'text-[9px] text-crimson-500 font-mono mb-2';
          }
          
          console.log('[OI] Updated - Value:', val, 'Change:', change);
        } catch (e) {
          console.error('[OI] Fetch error:', e);
        }
      }

      async function fetchFearGreed() {
        try {
          const res = await fetch(`${API_BASE}/api/fear-greed`);
          const data = await res.json();

          // Store history for sparkline
          if (data.value) {
            fearGreedHistory.push({ value: data.value, time: Date.now() });
            // Keep only last 7 days worth of data (assuming we fetch every 30s)
            if (fearGreedHistory.length > 20160) {
              fearGreedHistory = fearGreedHistory.slice(-20160);
            }
          }

          // Update volatility section with fear/greed
          const atrEl = document.querySelector('[data-intel="atr"]');
          if (atrEl && data.value) {
            const val = data.value;
            const label = data.label || (val > 70 ? 'GREED' : val < 30 ? 'FEAR' : 'NEUTRAL');
            atrEl.textContent = `F&G: ${val}/100 (${label})`;
          }
          
          // Update sparkline
          renderFearGreedSparkline(data.history || fearGreedHistory.map(h => h.value).slice(-7));

          // Update volatility needle position (0-100 -> 0-100%)
          const needle = document.querySelector('[data-intel="vol-needle"]');
          if (needle && data.value) {
            needle.style.left = `${data.value}%`;
          }
          console.log('[FEAR/GREED] Updated');
        } catch (e) {
          console.error('[FEAR/GREED] Fetch error:', e);
        }
      }
      
      // Render Fear & Greed sparkline
      function renderFearGreedSparkline(data) {
        const container = document.querySelector('[data-fg="sparkline"]');
        if (!container || !data || data.length < 2) return;
        
        // Normalize data for sparkline (0-100 range)
        const values = data.slice(-7); // Last 7 data points
        const min = Math.min(...values);
        const max = Math.max(...values);
        const range = max - min || 1;
        
        const width = 60;
        const height = 16;
        const points = values.map((val, i) => {
          const x = (i / (values.length - 1)) * width;
          const y = height - ((val - min) / range) * height;
          return `${x},${y}`;
        }).join(' ');
        
        // Determine color based on current value
        const current = values[values.length - 1];
        const color = current > 60 ? '#22c55e' : current < 40 ? '#dc2626' : '#f59e0b';
        
        container.innerHTML = `
          <svg width="${width}" height="${height}" class="inline-block">
            <polyline points="${points}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round"/>
            <circle cx="${width}" cy="${height - ((current - min) / range) * height}" r="2" fill="${color}"/>
          </svg>
        `;
      }
      
      // =================================================================
      // WHALE ALERT STREAMING
      // =================================================================
      async function fetchWhaleTransactions() {
        try {
          const res = await fetch(`${API_BASE}/api/whales?min_value=500000&limit=20`);
          const data = await res.json();
          
          if (data.success && data.transactions?.length) {
            renderWhaleFlow(data.transactions);
            console.log('[WHALE] Updated:', data.transactions.length, 'txs');
          }
        } catch (e) {
          console.error('[WHALE] Fetch error:', e);
        }
      }
      
      function renderWhaleFlow(transactions) {
        const container = document.querySelector('[data-whale="container"]');
        if (!container) return;
        
        // Take latest 8 transactions
        const recent = transactions.slice(0, 8);
        
        container.innerHTML = recent.map(tx => {
          // Determine color based on direction
          let borderColor = 'border-zinc-600';
          let directionColor = 'text-zinc-400';
          let icon = '';
          
          if (tx.direction === 'DEPOSIT') {
            borderColor = 'border-red-500';
            directionColor = 'text-red-400';
            icon = '↓';
          } else if (tx.direction === 'WITHDRAWAL') {
            borderColor = 'border-green-500';
            directionColor = 'text-green-400';
            icon = '↑';
          } else if (tx.direction === 'MINT') {
            borderColor = 'border-amber-500';
            directionColor = 'text-amber-400';
            icon = '+';
          } else if (tx.direction === 'BURN') {
            borderColor = 'border-purple-500';
            directionColor = 'text-purple-400';
            icon = '×';
          } else {
            icon = '→';
          }
          
          // Format amount compact
          const usdStr = tx.amount_usd >= 1e9 
            ? `$${(tx.amount_usd / 1e9).toFixed(1)}B`
            : tx.amount_usd >= 1e6 
              ? `$${(tx.amount_usd / 1e6).toFixed(1)}M`
              : `$${(tx.amount_usd / 1e3).toFixed(0)}K`;
          
          return `
            <div class="border-l-2 ${borderColor} pl-1.5 py-0.5">
              <div class="flex justify-between items-center">
                <span class="text-white font-bold text-[8px]">${tx.symbol} ${usdStr}</span>
                <span class="${directionColor} text-[7px]">${icon}${tx.direction}</span>
              </div>
              <div class="text-zinc-500 text-[7px] truncate">${tx.timestamp} ${tx.to}</div>
            </div>
          `;
        }).join('');
      }
      
      // =================================================================
      // LIQUIDATION HEATMAP
      // =================================================================
      let lastHeatmapUpdate = 0;
      
      function updateHeatmapTimer() {
        const el = document.querySelector('[data-heatmap="updated"]');
        if (!el || !lastHeatmapUpdate) return;
        
        const seconds = Math.floor((Date.now() - lastHeatmapUpdate) / 1000);
        el.textContent = seconds < 5 ? 'LIVE' : `${seconds}s ago`;
        el.className = seconds < 5 ? 'text-green-500 text-[7px]' : 'text-zinc-600 text-[7px]';
      }
      
      // Update the timer every second
      setInterval(updateHeatmapTimer, 1000);
      
      async function fetchHeatmap() {
        try {
          const res = await fetch(`${API_BASE}/api/heatmap/${currentSymbol}?t=${Date.now()}`);
          const data = await res.json();
          
          if (data.success && data.heatmap) {
            renderHeatmapData(data.heatmap);
            lastHeatmapUpdate = Date.now();
            updateHeatmapTimer();
            console.log('[HEATMAP] Updated for', currentSymbol);
          } else if (data.heatmap) {
            renderHeatmapData(data.heatmap);
            lastHeatmapUpdate = Date.now();
          }
        } catch (e) {
          console.error('[HEATMAP] Fetch error:', e);
        }
      }
      
      function renderHeatmapData(heatmap) {
        console.log('[HEATMAP] Rendering:', heatmap);
        
        // Update liquidation levels in the Liquidation Radar panel
        const levels = heatmap.levels || [];
        const currentPrice = heatmap.currentPrice || heatmap.current_price || lastPrice || 0;
        const openInterest = heatmap.open_interest_usd || 0;
        const lsRatio = heatmap.long_short_ratio || 1;
        
        // Update current price display
        const priceDisplay = document.querySelector('[data-heatmap="price"]');
        if (priceDisplay && currentPrice > 0) {
          priceDisplay.textContent = `$${currentPrice.toLocaleString()}`;
        }
        
        // Find biggest long and short liquidation levels
        let biggestLong = { price: 0, longLiquidation: 0 };
        let biggestShort = { price: 0, shortLiquidation: 0 };
        let maxLiq = 0;
        let totalLongLiq = 0;
        let totalShortLiq = 0;
        
        levels.forEach(level => {
          const longLiq = level.longLiquidation || 0;
          const shortLiq = level.shortLiquidation || 0;
          
          totalLongLiq += longLiq;
          totalShortLiq += shortLiq;
          
          if (longLiq > biggestLong.longLiquidation) {
            biggestLong = { price: level.price, longLiquidation: longLiq };
          }
          if (shortLiq > biggestShort.shortLiquidation) {
            biggestShort = { price: level.price, shortLiquidation: shortLiq };
          }
          maxLiq = Math.max(maxLiq, longLiq, shortLiq);
        });
        
        // Update UI numbers
        const longVal = document.querySelector('[data-liq="long-value"]');
        const longPrice = document.querySelector('[data-liq="long-price"]');
        const longBar = document.querySelector('[data-liq="long-bar"]');
        const longRisk = document.querySelector('[data-liq="long-risk"]');
        const shortVal = document.querySelector('[data-liq="short-value"]');
        const shortPrice = document.querySelector('[data-liq="short-price"]');
        const shortBar = document.querySelector('[data-liq="short-bar"]');
        const shortRisk = document.querySelector('[data-liq="short-risk"]');
        const biasEl = document.querySelector('[data-liq="bias"]');
        
        if (longVal) {
          longVal.textContent = totalLongLiq > 0 ? `$${formatLargeNumber(totalLongLiq)}` : '--';
        }
        if (longPrice && biggestLong.price > 0) {
          longPrice.textContent = `$${biggestLong.price.toLocaleString()}`;
        }
        if (longBar && totalLongLiq > 0) {
          const pct = Math.min(95, (totalLongLiq / (totalLongLiq + totalShortLiq + 1)) * 100);
          longBar.style.width = `${pct}%`;
        }
        if (longRisk && biggestLong.price > 0 && currentPrice > 0) {
          const distance = ((currentPrice - biggestLong.price) / currentPrice) * 100;
          longRisk.textContent = distance < 3 ? 'HIGH RISK' : distance < 5 ? 'Med Risk' : 'Low Risk';
          longRisk.className = distance < 3 ? 'text-crimson-500' : 'text-zinc-600';
        }
        
        if (shortVal) {
          shortVal.textContent = totalShortLiq > 0 ? `$${formatLargeNumber(totalShortLiq)}` : '--';
        }
        if (shortPrice && biggestShort.price > 0) {
          shortPrice.textContent = `$${biggestShort.price.toLocaleString()}`;
        }
        if (shortBar && totalShortLiq > 0) {
          const pct = Math.min(95, (totalShortLiq / (totalLongLiq + totalShortLiq + 1)) * 100);
          shortBar.style.width = `${pct}%`;
        }
        if (shortRisk && biggestShort.price > 0 && currentPrice > 0) {
          const distance = ((biggestShort.price - currentPrice) / currentPrice) * 100;
          shortRisk.textContent = distance < 3 ? 'HIGH RISK' : distance < 5 ? 'Med Risk' : 'Low Risk';
          shortRisk.className = distance < 3 ? 'text-green-500' : 'text-zinc-600';
        }
        
        // Update bias and container pulse
        const heatmapContainer = document.getElementById('heatmap-container');
        if (biasEl) {
          if (totalLongLiq > totalShortLiq * 1.2) {
            biasEl.textContent = 'LONG HEAVY';
            biasEl.className = 'text-red-500 font-bold';
            if (heatmapContainer) {
              heatmapContainer.classList.remove('heatmap-short-dominant');
              heatmapContainer.classList.add('heatmap-long-dominant');
            }
          } else if (totalShortLiq > totalLongLiq * 1.2) {
            biasEl.textContent = 'SHORT HEAVY';
            biasEl.className = 'text-green-500 font-bold';
            if (heatmapContainer) {
              heatmapContainer.classList.remove('heatmap-long-dominant');
              heatmapContainer.classList.add('heatmap-short-dominant');
            }
          } else {
            biasEl.textContent = 'BALANCED';
            biasEl.className = 'text-amber-500 font-bold';
            if (heatmapContainer) {
              heatmapContainer.classList.remove('heatmap-long-dominant', 'heatmap-short-dominant');
            }
          }
        }
        
        // Render visual heatmap
        const barsContainer = document.querySelector('[data-heatmap="bars"]');
        if (!barsContainer || levels.length === 0) {
          console.log('[HEATMAP] No levels to render');
          return;
        }
        
        // Sort levels by price (high to low for display)
        const sortedLevels = [...levels].sort((a, b) => b.price - a.price);
        
        // Take a subset for display
        const displayLevels = sortedLevels.slice(0, 10);
        
        // Find price range for positioning current price line
        const prices = displayLevels.map(l => l.price);
        const maxPrice = Math.max(...prices);
        const minPrice = Math.min(...prices);
        const priceRange = maxPrice - minPrice || 1;
        
        // Position current price line
        const currentLine = document.querySelector('[data-heatmap="current-line"]');
        if (currentLine && currentPrice > 0 && maxPrice > 0) {
          const position = ((maxPrice - currentPrice) / priceRange) * 100;
          currentLine.style.top = `${Math.min(90, Math.max(10, position))}%`;
        }
        
        // Render bars with solid colors
        barsContainer.innerHTML = displayLevels.map(level => {
          const longLiq = level.longLiquidation || 0;
          const shortLiq = level.shortLiquidation || 0;
          const longPct = maxLiq > 0 ? Math.max((longLiq / maxLiq) * 100, longLiq > 0 ? 8 : 0) : 0;
          const shortPct = maxLiq > 0 ? Math.max((shortLiq / maxLiq) * 100, shortLiq > 0 ? 8 : 0) : 0;
          const isNearCurrent = currentPrice > 0 && Math.abs(level.price - currentPrice) / currentPrice < 0.03;
          
          // Intensity based on size
          const longIntensity = longPct > 60 ? 'bg-red-500' : longPct > 30 ? 'bg-red-600' : 'bg-red-700';
          const shortIntensity = shortPct > 60 ? 'bg-green-500' : shortPct > 30 ? 'bg-green-600' : 'bg-green-700';
          const longGlow = longPct > 50 ? 'shadow-[0_0_12px_rgba(239,68,68,0.8)]' : '';
          const shortGlow = shortPct > 50 ? 'shadow-[0_0_12px_rgba(34,197,94,0.8)]' : '';
          
          return `
            <div class="flex items-center h-[12px] gap-1 ${isNearCurrent ? 'bg-white/10 rounded' : ''}">
              <div class="flex-1 flex justify-end h-full items-center">
                ${longLiq > 0 ? `<div class="h-[10px] ${longIntensity} ${longGlow} rounded-l transition-all duration-700" style="width: ${longPct}%; min-width: 6px;"></div>` : ''}
              </div>
              <div class="text-[8px] w-[42px] text-center font-mono shrink-0 ${isNearCurrent ? 'text-white font-bold' : 'text-zinc-400'}">
                ${(level.price / 1000).toFixed(1)}K
              </div>
              <div class="flex-1 flex justify-start h-full items-center">
                ${shortLiq > 0 ? `<div class="h-[10px] ${shortIntensity} ${shortGlow} rounded-r transition-all duration-700" style="width: ${shortPct}%; min-width: 6px;"></div>` : ''}
              </div>
            </div>
          `;
        }).join('');
        
        console.log('[HEATMAP] Rendered', displayLevels.length, 'levels, maxLiq:', maxLiq);
      }

      // =================================================================
      // MM MAGNET (Market Maker Target Estimation)
      // =================================================================
      async function fetchMMMagnet() {
        try {
          const res = await fetch(`${API_BASE}/api/mm-magnet/${currentSymbol}`);
          const data = await res.json();
          
          if (data.success) {
            renderMMMagnet(data);
            console.log('[MM MAGNET] Updated:', data.direction, data.target);
          }
        } catch (e) {
          console.error('[MM MAGNET] Fetch error:', e);
        }
      }
      
      function renderMMMagnet(data) {
        // Direction badge
        const dirEl = document.querySelector('[data-mm="direction"]');
        if (dirEl) {
          const dir = data.direction || 'NEUTRAL';
          const dist = data.targetDistance || 0;
          dirEl.textContent = `${dir} ${dist >= 0 ? '+' : ''}${dist}%`;
          dirEl.className = dir === 'BULLISH' 
            ? 'text-green-400 font-bold text-[9px]' 
            : dir === 'BEARISH' 
              ? 'text-red-400 font-bold text-[9px]' 
              : 'text-zinc-400 text-[9px]';
        }
        
        // Target price
        const targetEl = document.querySelector('[data-mm="target"]');
        if (targetEl) {
          targetEl.textContent = data.targetFormatted || `$${data.target?.toLocaleString() || '--'}`;
          targetEl.className = data.direction === 'BULLISH' 
            ? 'text-green-400 font-bold text-[13px] font-mono' 
            : data.direction === 'BEARISH' 
              ? 'text-red-400 font-bold text-[13px] font-mono' 
              : 'text-white font-bold text-[13px] font-mono';
        }
        
        // Confidence
        const confEl = document.querySelector('[data-mm="confidence"]');
        const confBarEl = document.querySelector('[data-mm="confidence-bar"]');
        if (confEl) confEl.textContent = `${data.confidence || 0}%`;
        if (confBarEl) {
          confBarEl.style.width = `${data.confidence || 0}%`;
          confBarEl.className = data.confidence > 60 
            ? 'h-full bg-amber-500 transition-all' 
            : 'h-full bg-zinc-600 transition-all';
        }
        
        // ETA
        const etaEl = document.querySelector('[data-mm="eta"]');
        if (etaEl) etaEl.textContent = `ETA: ${data.timeHorizon || '--'}`;
        
        // Signals
        const signals = data.signals || {};
        
        // Max Pain
        renderSignalBar('sig-maxpain', signals.maxPain?.value || 0, signals.maxPain?.label || '--');
        // Liq Hunt
        renderSignalBar('sig-liq', signals.liqHunt?.value || 0, signals.liqHunt?.label || '--');
        // Funding
        renderSignalBar('sig-funding', signals.funding?.value || 0, signals.funding?.label || '--');
        // Divergence
        renderSignalBar('sig-div', signals.divergence?.value || 0, signals.divergence?.label || '--');
        // ETF Flows
        renderSignalBar('sig-etf', signals.etfFlows?.value || 0, signals.etfFlows?.label || '--');
      }
      
      function renderSignalBar(key, value, label) {
        const barEl = document.querySelector(`[data-mm="${key}"]`);
        const labelEl = document.querySelector(`[data-mm="${key}-label"]`);
        
        if (barEl) {
          // Convert -1 to 1 range to 0-100% width
          // Negative = red from left, Positive = green from left
          const pct = Math.abs(value) * 50 + 50;
          barEl.style.width = `${Math.min(100, pct)}%`;
          barEl.className = value > 0 
            ? 'h-full bg-green-500 transition-all' 
            : value < 0 
              ? 'h-full bg-red-500 transition-all' 
              : 'h-full bg-zinc-600 transition-all';
        }
        
        if (labelEl) {
          labelEl.textContent = label;
          labelEl.className = value > 0 
            ? 'text-green-400 w-16 text-right' 
            : value < 0 
              ? 'text-red-400 w-16 text-right' 
              : 'text-zinc-400 w-16 text-right';
        }
      }
      
      // =================================================================
      // VOLATILITY REGIME ANALYSIS
      // =================================================================
      async function fetchVolRegime() {
        try {
          const res = await fetch(`${API_BASE}/api/volatility-regime/${currentSymbol}`);
          const data = await res.json();
          
          if (data.success) {
            renderVolRegime(data);
            console.log('[VOL REGIME] Updated:', data.regime, data.expansionProbability);
          }
        } catch (e) {
          console.error('[VOL REGIME] Fetch error:', e);
        }
      }
      
      function renderVolRegime(data) {
        // Signal badge
        const signalEl = document.querySelector('[data-vol="signal"]');
        if (signalEl) {
          signalEl.textContent = data.signal || '--';
          signalEl.className = data.signal === 'CAUTION' 
            ? 'text-amber-400 font-bold text-[9px] animate-pulse' 
            : 'text-green-400 text-[9px]';
        }
        
        // Regime
        const regimeEl = document.querySelector('[data-vol="regime"]');
        if (regimeEl) {
          regimeEl.textContent = data.regime || '--';
          regimeEl.className = data.isCompression 
            ? 'text-amber-400 font-bold text-[12px] font-mono' 
            : 'text-green-400 font-bold text-[12px] font-mono';
        }
        
        // ATR
        const atrEl = document.querySelector('[data-vol="atr"]');
        if (atrEl) atrEl.textContent = `${data.atrPercent || 0}%`;
        
        // Needle position (0-100%)
        const needleEl = document.querySelector('[data-vol="needle"]');
        if (needleEl) {
          // Map ATR to position: 0% = low vol, 50% = normal, 100% = high vol
          let position = 30; // Default low
          if (data.regime === 'NORMAL') position = 50;
          else if (data.regime === 'HIGH' || data.regime === 'EXPANSION') position = 75;
          else if (data.regime === 'EXTREME') position = 90;
          else if (data.regime === 'COMPRESSION' || data.regime === 'LOW') position = 25;
          needleEl.style.left = `${position}%`;
        }
        
        // Warning
        const warningEl = document.querySelector('[data-vol="warning"]');
        if (warningEl) {
          if (data.warning) {
            warningEl.textContent = data.warning;
            warningEl.classList.remove('hidden');
          } else {
            warningEl.classList.add('hidden');
          }
        }
        
        // BB Width
        const bbEl = document.querySelector('[data-vol="bb"]');
        if (bbEl) bbEl.textContent = `${data.bollingerWidth || 0}%`;
        
        // Days in regime
        const daysEl = document.querySelector('[data-vol="days"]');
        if (daysEl) daysEl.textContent = data.daysInRegime || '--';
        
        // Expansion probability
        const probEl = document.querySelector('[data-vol="prob"]');
        if (probEl) {
          probEl.textContent = `${data.expansionProbability || 0}%`;
          probEl.className = data.expansionProbability > 60 
            ? 'text-amber-400 font-bold ml-1' 
            : 'text-white font-bold ml-1';
        }
      }
      
      // =================================================================
      // ON-CHAIN INTEL
      // =================================================================
      async function fetchOnChain() {
        try {
          const res = await fetch(`${API_BASE}/api/onchain`);
          const data = await res.json();
          
          if (data.success) {
            renderOnChain(data);
            console.log('[ON-CHAIN] Updated');
          }
        } catch (e) {
          console.error('[ON-CHAIN] Fetch error:', e);
        }
      }
      
      function renderOnChain(data) {
        // Exchange Reserves - BTC
        const btcReserve = document.querySelector('[data-onchain="btc-reserve"]');
        if (btcReserve) btcReserve.textContent = data.exchangeReserves?.btc?.formatted || '2.1M';
        
        const btcBar = document.querySelector('[data-onchain="btc-reserve-bar"]');
        if (btcBar) btcBar.style.width = `${data.exchangeReserves?.btc?.barWidth || 65}%`;
        
        const btcChange = document.querySelector('[data-onchain="btc-reserve-change"]');
        if (btcChange) {
          const change = data.exchangeReserves?.btc?.change7d || -3.2;
          btcChange.textContent = `${change > 0 ? '+' : ''}${change}%`;
          btcChange.className = change < 0 ? 'text-red-400' : 'text-green-400';
        }
        
        // Exchange Reserves - ETH
        const ethReserve = document.querySelector('[data-onchain="eth-reserve"]');
        if (ethReserve) ethReserve.textContent = data.exchangeReserves?.eth?.formatted || '18.4M';
        
        const ethBar = document.querySelector('[data-onchain="eth-reserve-bar"]');
        if (ethBar) ethBar.style.width = `${data.exchangeReserves?.eth?.barWidth || 58}%`;
        
        const ethChange = document.querySelector('[data-onchain="eth-reserve-change"]');
        if (ethChange) {
          const change = data.exchangeReserves?.eth?.change7d || -1.8;
          ethChange.textContent = `${change > 0 ? '+' : ''}${change}%`;
          ethChange.className = change < 0 ? 'text-red-400' : 'text-green-400';
        }
        
        // Stablecoin Flows
        const usdtFlow = document.querySelector('[data-onchain="usdt-flow"]');
        if (usdtFlow) {
          usdtFlow.textContent = data.stablecoinFlows?.usdt?.formatted || '+$847M';
          usdtFlow.className = data.stablecoinFlows?.usdt?.value > 0 ? 'text-green-400 font-bold' : 'text-red-400 font-bold';
        }
        
        const usdcFlow = document.querySelector('[data-onchain="usdc-flow"]');
        if (usdcFlow) {
          usdcFlow.textContent = data.stablecoinFlows?.usdc?.formatted || '-$124M';
          usdcFlow.className = data.stablecoinFlows?.usdc?.value > 0 ? 'text-green-400 font-bold' : 'text-red-400 font-bold';
        }
        
        const stablesNet = document.querySelector('[data-onchain="stables-net"]');
        if (stablesNet) {
          stablesNet.textContent = data.stablecoinFlows?.netFormatted || '+$723M';
          stablesNet.className = data.stablecoinFlows?.netInflow > 0 ? 'text-green-400 font-bold ml-1' : 'text-red-400 font-bold ml-1';
        }
        
        // Miner Flows
        const minerOutflow = document.querySelector('[data-onchain="miner-outflow"]');
        if (minerOutflow) minerOutflow.textContent = data.minerFlows?.formatted || '342 BTC';
        
        const minerDelta = document.querySelector('[data-onchain="miner-delta"]');
        if (minerDelta) {
          const delta = data.minerFlows?.delta || 284;
          minerDelta.textContent = `+${delta}%`;
          minerDelta.className = delta > 100 ? 'text-red-400' : delta > 50 ? 'text-amber-400' : 'text-green-400';
        }
        
        const minerSignal = document.querySelector('[data-onchain="miner-signal"]');
        if (minerSignal) {
          minerSignal.textContent = data.minerFlows?.signal || 'ELEVATED';
          minerSignal.className = data.minerFlows?.signal === 'ELEVATED' ? 'text-amber-400' : 'text-green-400';
        }
        
        // Dormant Supply
        const dormantMoved = document.querySelector('[data-onchain="dormant-moved"]');
        if (dormantMoved) dormantMoved.textContent = data.dormantSupply?.formatted || '1,247 BTC';
        
        const dormantDelta = document.querySelector('[data-onchain="dormant-delta"]');
        if (dormantDelta) dormantDelta.textContent = `+${data.dormantSupply?.delta || 300}%`;
        
        const dormantSignal = document.querySelector('[data-onchain="dormant-signal"]');
        if (dormantSignal) {
          dormantSignal.textContent = data.dormantSupply?.signal || 'DISTRIBUTION';
          dormantSignal.className = data.dormantSupply?.signal === 'ACCUMULATION' ? 'text-green-400 font-bold ml-1' : 'text-amber-400 font-bold ml-1';
        }
        
        // Network Activity
        const activeAddr = document.querySelector('[data-onchain="active-addr"]');
        if (activeAddr) activeAddr.textContent = data.networkActivity?.activeFormatted || '892K';
        
        const newAddr = document.querySelector('[data-onchain="new-addr"]');
        if (newAddr) newAddr.textContent = data.networkActivity?.newFormatted || '+42K';
        
        const txCount = document.querySelector('[data-onchain="tx-count"]');
        if (txCount) txCount.textContent = data.networkActivity?.txFormatted || '324K';
        
        // Whale Wallets
        const whaleChange = document.querySelector('[data-onchain="whale-change"]');
        if (whaleChange) {
          whaleChange.textContent = data.whaleWallets?.formatted || '+12,847 BTC';
          whaleChange.className = data.whaleWallets?.netChange7d > 0 ? 'text-green-400 font-bold' : 'text-red-400 font-bold';
        }
        
        const whaleBar = document.querySelector('[data-onchain="whale-bar"]');
        if (whaleBar) whaleBar.style.width = `${data.whaleWallets?.barWidth || 72}%`;
      }
      
      // =================================================================
      // ORDER FLOW
      // =================================================================
      async function fetchOrderFlow() {
        try {
          const res = await fetch(`${API_BASE}/api/orderflow/${currentSymbol}`);
          const data = await res.json();
          
          if (data.success) {
            renderOrderFlow(data);
            console.log('[ORDER FLOW] Updated:', data.bidAskImbalance?.signal);
          }
        } catch (e) {
          console.error('[ORDER FLOW] Fetch error:', e);
        }
      }
      
      function renderOrderFlow(data) {
        // Bid/Ask Imbalance
        const bidBar = document.querySelector('[data-flow="bid-bar"]');
        const askBar = document.querySelector('[data-flow="ask-bar"]');
        if (bidBar) bidBar.style.width = `${data.bidAskImbalance?.bidPct || 62}%`;
        if (askBar) askBar.style.width = `${data.bidAskImbalance?.askPct || 38}%`;
        
        const bidPct = document.querySelector('[data-flow="bid-pct"]');
        if (bidPct) bidPct.textContent = `${data.bidAskImbalance?.bidPct || 62}%`;
        
        const askPct = document.querySelector('[data-flow="ask-pct"]');
        if (askPct) askPct.textContent = `${data.bidAskImbalance?.askPct || 38}%`;
        
        const imbalanceSignal = document.querySelector('[data-flow="imbalance-signal"]');
        if (imbalanceSignal) {
          imbalanceSignal.textContent = data.bidAskImbalance?.signal || 'BUY';
          imbalanceSignal.className = data.bidAskImbalance?.signal === 'BUY' ? 'text-green-400 font-bold' : 'text-red-400 font-bold';
        }
        
        const imbalanceText = document.querySelector('[data-flow="imbalance-text"]');
        if (imbalanceText) imbalanceText.textContent = data.bidAskImbalance?.text || 'STRONG BUY PRESSURE';
        
        // Aggressor Side
        const buyerBar = document.querySelector('[data-flow="buyer-bar"]');
        if (buyerBar) buyerBar.style.width = `${data.aggressorSide?.buyerPct || 58}%`;
        
        const sellerBar = document.querySelector('[data-flow="seller-bar"]');
        if (sellerBar) sellerBar.style.width = `${data.aggressorSide?.sellerPct || 42}%`;
        
        const buyerVol = document.querySelector('[data-flow="buyer-vol"]');
        if (buyerVol) buyerVol.textContent = data.aggressorSide?.buyerFormatted || '$24.7M';
        
        const sellerVol = document.querySelector('[data-flow="seller-vol"]');
        if (sellerVol) sellerVol.textContent = data.aggressorSide?.sellerFormatted || '$17.8M';
        
        const delta = document.querySelector('[data-flow="delta"]');
        if (delta) {
          delta.textContent = data.aggressorSide?.deltaFormatted || '+$6.9M';
          delta.className = data.aggressorSide?.delta > 0 ? 'text-green-400 font-bold ml-1' : 'text-red-400 font-bold ml-1';
        }
        
        // Large Orders
        const ordersContainer = document.querySelector('[data-flow="large-orders"]');
        if (ordersContainer && data.largeOrders) {
          ordersContainer.innerHTML = data.largeOrders.slice(0, 5).map(order => `
            <div class="flex justify-between items-center py-0.5 border-l-2 ${order.side === 'BUY' ? 'border-green-500' : 'border-red-500'} pl-1">
              <span class="text-zinc-500">${order.time}</span>
              <span class="${order.side === 'BUY' ? 'text-green-400' : 'text-red-400'}">${order.side}</span>
              <span class="text-white">${order.size}</span>
              <span class="text-zinc-600">${order.price}</span>
            </div>
          `).join('');
        }
        
        // CVD Momentum
        const cvdValue = document.querySelector('[data-flow="cvd-value"]');
        if (cvdValue) {
          cvdValue.textContent = data.cvdMomentum?.formatted || '+$8.4M';
          cvdValue.className = data.cvdMomentum?.isPositive 
            ? 'text-2xl font-bold text-green-400 font-mono' 
            : 'text-2xl font-bold text-red-400 font-mono';
        }
        
        // Trade Intensity
        const intensityNeedle = document.querySelector('[data-flow="intensity-needle"]');
        if (intensityNeedle) intensityNeedle.style.left = `${data.tradeIntensity?.pct || 68}%`;
        
        const intensitySignal = document.querySelector('[data-flow="intensity-signal"]');
        if (intensitySignal) {
          intensitySignal.textContent = data.tradeIntensity?.signal || 'ELEVATED';
          intensitySignal.className = data.tradeIntensity?.signal === 'HIGH' 
            ? 'text-red-400' 
            : data.tradeIntensity?.signal === 'ELEVATED' 
              ? 'text-amber-400' 
              : 'text-green-400';
        }
        
        const tradesPerSec = document.querySelector('[data-flow="trades-per-sec"]');
        if (tradesPerSec) tradesPerSec.textContent = data.tradeIntensity?.tradesPerSec || '847';
        
        // Spoof Detection
        const spoofStatus = document.querySelector('[data-flow="spoof-status"]');
        if (spoofStatus) {
          spoofStatus.textContent = data.spoofDetection?.status || 'CLEAR';
          spoofStatus.className = data.spoofDetection?.status === 'ALERT' ? 'text-red-400 animate-pulse' : 'text-green-400';
        }
        
        const spoofContainer = document.querySelector('[data-flow="spoof-container"]');
        if (spoofContainer && data.spoofDetection?.alerts?.length > 0) {
          spoofContainer.innerHTML = data.spoofDetection.alerts.map(alert => `
            <div class="border-l-2 border-red-500 pl-1 py-0.5">
              <div class="text-red-400">${alert.time} - ${alert.side} ${alert.size}</div>
              <div class="text-zinc-500">${alert.note}</div>
            </div>
          `).join('');
        } else if (spoofContainer) {
          spoofContainer.innerHTML = `
            <div class="text-center py-2 bg-zinc-900/50 rounded border border-zinc-800/50 text-zinc-500">
              No spoofing detected
            </div>
          `;
        }
      }

      // =================================================================
      // SESSION ANALYSIS
      // =================================================================
      async function fetchSession() {
        try {
          const res = await fetch(`${API_BASE}/api/session`);
          const data = await res.json();
          
          if (data.success) {
            renderSession(data);
            console.log('[SESSION] Updated:', data.current);
          }
        } catch (e) {
          console.error('[SESSION] Fetch error:', e);
        }
      }
      
      function renderSession(data) {
        const currentEl = document.querySelector('[data-session="current"]');
        if (currentEl) {
          currentEl.textContent = data.current || '--';
          currentEl.className = data.current === 'US' ? 'text-green-400 font-bold' : 'text-blue-400 font-bold';
        }
        
        const nameEl = document.querySelector('[data-session="name"]');
        if (nameEl) nameEl.textContent = data.name || '--';
        
        const nextEl = document.querySelector('[data-session="next"]');
        if (nextEl) nextEl.textContent = data.next || '--';
        
        const recEl = document.querySelector('[data-session="recommendation"]');
        if (recEl) recEl.textContent = data.recommendation || '--';
      }
      
      // =================================================================
      // MACRO CORRELATION
      // =================================================================
      async function fetchMacro() {
        try {
          const res = await fetch(`${API_BASE}/api/macro`);
          const data = await res.json();
          
          if (data.success) {
            renderMacro(data);
            console.log('[MACRO] Updated:', data.signal);
          }
        } catch (e) {
          console.error('[MACRO] Fetch error:', e);
        }
      }
      
      function renderMacro(data) {
        const signalEl = document.querySelector('[data-macro="signal"]');
        if (signalEl) {
          signalEl.textContent = data.signal || '--';
          signalEl.className = data.signal === 'RISK-ON' ? 'text-green-400 font-bold' : 'text-amber-400 font-bold';
        }
        
        const noteEl = document.querySelector('[data-macro="note"]');
        if (noteEl) noteEl.textContent = data.note || '--';
        
        // Update correlation bars
        if (data.correlations) {
          ['spx', 'nq', 'dxy', 'gold', 'vix'].forEach(key => {
            const val = data.correlations[key];
            const bar = document.querySelector(`[data-macro="${key}-bar"]`);
            const label = document.querySelector(`[data-macro="${key}"]`);
            
            if (bar) bar.style.width = `${Math.abs(val) * 100}%`;
            if (label) {
              label.textContent = val > 0 ? `+${val.toFixed(2)}` : val.toFixed(2);
              label.className = val > 0 ? 'text-green-400 w-10 text-right' : 'text-red-400 w-10 text-right';
            }
          });
        }
      }
      
      // =================================================================
      // KELLY CRITERION
      // =================================================================
      async function fetchKelly() {
        try {
          const res = await fetch(`${API_BASE}/api/kelly`);
          const data = await res.json();
          
          if (data.success) {
            renderKelly(data);
            console.log('[KELLY] Updated:', data.optimal);
          }
        } catch (e) {
          console.error('[KELLY] Fetch error:', e);
        }
      }
      
      function renderKelly(data) {
        const optimalEl = document.querySelector('[data-kelly="optimal"]');
        if (optimalEl) optimalEl.textContent = `${data.optimal || 0}%`;
        
        const winrateEl = document.querySelector('[data-kelly="winrate"]');
        if (winrateEl) winrateEl.textContent = `${data.winRate || 0}%`;
        
        const avgwinEl = document.querySelector('[data-kelly="avgwin"]');
        if (avgwinEl) avgwinEl.textContent = data.avgWin || '--';
        
        const avglossEl = document.querySelector('[data-kelly="avgloss"]');
        if (avglossEl) avglossEl.textContent = data.avgLoss || '--';
        
        const halfEl = document.querySelector('[data-kelly="half"]');
        if (halfEl) halfEl.textContent = `${data.half || 0}%`;
        
        const quarterEl = document.querySelector('[data-kelly="quarter"]');
        if (quarterEl) quarterEl.textContent = `${data.quarter || 0}%`;
        
        const recEl = document.querySelector('[data-kelly="recommendation"]');
        if (recEl) recEl.textContent = data.recommendation || '--';
      }
      
      // =================================================================
      // LIVE NEWS FEED
      // =================================================================
      async function fetchLiveNews() {
        try {
          const res = await fetch(`${API_BASE}/api/news?limit=8`);
          const data = await res.json();
          
          if (data.success && data.news) {
            renderNewsFeed(data.news);
            console.log('[NEWS] Updated:', data.news.length, 'items');
          }
        } catch (e) {
          console.error('[NEWS] Fetch error:', e);
        }
      }
      
      function renderNewsFeed(news) {
        const container = document.querySelector('[data-news="feed"]');
        if (!container) return;
        
        container.innerHTML = news.map(item => {
          const sentimentColors = {
            'BULLISH': { text: 'text-green-400', border: 'hover:border-green-600/50' },
            'BEARISH': { text: 'text-red-400', border: 'hover:border-red-600/50' },
            'NEUTRAL': { text: 'text-zinc-400', border: 'hover:border-zinc-600/50' }
          };
          const colors = sentimentColors[item.sentiment] || sentimentColors['NEUTRAL'];
          const currencyTags = item.currencies?.length ? 
            item.currencies.map(c => `<span class="px-1 py-0.5 bg-zinc-800 rounded text-[6px]">${c}</span>`).join(' ') : '';
          
          return `
            <div class="p-1.5 bg-zinc-900/50 rounded border border-zinc-800/50 ${colors.border} cursor-pointer transition-colors" onclick="window.open('${item.url}', '_blank')">
              <div class="flex justify-between items-start mb-1">
                <span class="text-[7px] ${colors.text} uppercase font-bold">${item.sentiment}</span>
                <span class="text-[7px] text-zinc-600">${item.timeAgo}</span>
              </div>
              <div class="text-white leading-tight text-[8px]">${item.title}</div>
              <div class="flex justify-between items-center mt-1">
                <span class="text-[7px] text-zinc-500">${item.source}</span>
                <div class="flex gap-1">${currencyTags}</div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      // =================================================================
      // POSITION SIMULATOR
      // =================================================================
      let simulatorPositions = [];
      let selectedSimPosition = null;
      
      // Populate position selector when positions load
      function updateSimulatorPositions(positions) {
        simulatorPositions = positions || [];
        const select = document.getElementById('sim-position-select');
        if (!select) return;
        
        select.innerHTML = '<option value="">Select a position...</option>';
        positions.forEach((pos, idx) => {
          const symbol = pos.symbol || 'Unknown';
          const direction = (pos.direction || pos.side || 'long').toUpperCase();
          const pnl = parseFloat(pos.pnl || pos.unrealized_pnl || 0);
          const pnlStr = pnl >= 0 ? `+$${pnl.toFixed(2)}` : `-$${Math.abs(pnl).toFixed(2)}`;
          select.innerHTML += `<option value="${idx}">${symbol} ${direction} (${pnlStr})</option>`;
        });
      }
      
      // Position selector change handler
      document.addEventListener('DOMContentLoaded', () => {
        const select = document.getElementById('sim-position-select');
        if (select) {
          select.addEventListener('change', (e) => {
            const idx = e.target.value;
            if (idx === '') {
              selectedSimPosition = null;
              document.getElementById('sim-position-info')?.classList.add('hidden');
              document.querySelector('[data-monte="status"]').textContent = 'SELECT POSITION';
              return;
            }
            
            selectedSimPosition = simulatorPositions[parseInt(idx)];
            const info = document.getElementById('sim-position-info');
            if (info && selectedSimPosition) {
              info.classList.remove('hidden');
              document.getElementById('sim-entry').textContent = '$' + (parseFloat(selectedSimPosition.entry_price) || 0).toLocaleString();
              document.getElementById('sim-current').textContent = '$' + (parseFloat(selectedSimPosition.current_price) || parseFloat(selectedSimPosition.entry_price) || 0).toLocaleString();
              document.getElementById('sim-leverage').textContent = (selectedSimPosition.leverage || '1') + 'x';
              document.querySelector('[data-monte="status"]').textContent = 'READY';
            }
          });
        }
      });
      
      async function runMonteCarlo() {
        const statusEl = document.querySelector('[data-monte="status"]');
        const btn = document.querySelector('[data-action="run-monte-carlo"]');
        
        if (!selectedSimPosition) {
          if (statusEl) statusEl.textContent = 'SELECT A POSITION!';
          setTimeout(() => { if (statusEl) statusEl.textContent = 'SELECT POSITION'; }, 2000);
          return;
        }
        
        if (statusEl) statusEl.textContent = 'SIMULATING...';
        if (btn) {
          btn.disabled = true;
          btn.textContent = 'RUNNING...';
        }
        
        try {
          const token = localStorage.getItem('bastion_token') || sessionStorage.getItem('bastion_token');
          const sessionId = localStorage.getItem('bastion_session_id');
          
          const res = await fetch(`${API_BASE}/api/monte-carlo`, { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              token, 
              session_id: sessionId,
              position: selectedSimPosition
            })
          });
          const data = await res.json();
          
          if (data.success) {
            renderSimulatorResults(data);
            console.log('[SIMULATOR] Completed:', data);
          }
        } catch (e) {
          console.error('[SIMULATOR] Error:', e);
        } finally {
          if (statusEl) statusEl.textContent = 'COMPLETE';
          if (btn) {
            btn.disabled = false;
            btn.textContent = 'RUN SIMULATION';
          }
          setTimeout(() => {
            if (statusEl) statusEl.textContent = 'READY';
          }, 3000);
        }
      }
      
      function renderSimulatorResults(data) {
        // TP1 - 15%
        document.getElementById('sim-tp1-price').textContent = '$' + (data.tp1_price || 0).toLocaleString(undefined, {maximumFractionDigits: 2});
        document.getElementById('sim-tp1-prob').textContent = (data.tp1_prob || 0).toFixed(1) + '% chance';
        
        // TP2 - 50%
        document.getElementById('sim-tp2-price').textContent = '$' + (data.tp2_price || 0).toLocaleString(undefined, {maximumFractionDigits: 2});
        document.getElementById('sim-tp2-prob').textContent = (data.tp2_prob || 0).toFixed(1) + '% chance';
        
        // TP3 - 80%
        document.getElementById('sim-tp3-price').textContent = '$' + (data.tp3_price || 0).toLocaleString(undefined, {maximumFractionDigits: 2});
        document.getElementById('sim-tp3-prob').textContent = (data.tp3_prob || 0).toFixed(1) + '% chance';
        
        // Stop -50%
        document.getElementById('sim-stop-price').textContent = '$' + (data.stop_price || 0).toLocaleString(undefined, {maximumFractionDigits: 2});
        document.getElementById('sim-stop-prob').textContent = (data.stop_prob || 0).toFixed(1) + '% risk';
        
        // Stats
        document.getElementById('sim-expected-move').textContent = '±' + (data.expected_move || 0).toFixed(1) + '%';
        document.getElementById('sim-volatility').textContent = (data.volatility || 'Medium');
      }
      
      // Monte Carlo button handler
      document.addEventListener('click', (e) => {
        if (e.target.closest('[data-action="run-monte-carlo"]')) {
          runMonteCarlo();
        }
      });

      // Flash indicator on update
      function flashUpdate(elementId) {
        const el = document.getElementById(elementId) || document.querySelector(`[data-status="${elementId}"]`);
        if (el) {
          el.classList.add('animate-pulse');
          el.style.boxShadow = '0 0 10px rgba(34, 197, 94, 0.8)';
          setTimeout(() => {
            el.classList.remove('animate-pulse');
            el.style.boxShadow = '';
          }, 500);
        }
      }
      
      // =================================================================
      // ETF FLOWS
      // =================================================================
      async function fetchETFFlows() {
        try {
          const res = await fetch(`${API_BASE}/api/etf-flows`);
          const data = await res.json();
          
          if (data.success && data.etfs) {
            renderETFFlows(data);
            console.log('[ETF] Updated:', data.totalFlowUsd);
          }
        } catch (e) {
          console.error('[ETF] Fetch error:', e);
        }
      }
      
      function renderETFFlows(data) {
        const signalEl = document.querySelector('[data-etf="signal"]');
        const totalEl = document.querySelector('[data-etf="total"]');
        const container = document.querySelector('[data-etf="container"]');
        
        if (signalEl) {
          signalEl.textContent = data.signal || '--';
          signalEl.className = data.signal === 'BULLISH' 
            ? 'text-green-400 font-bold' 
            : data.signal === 'BEARISH' 
              ? 'text-red-400 font-bold' 
              : 'text-zinc-400';
        }
        
        if (totalEl) {
          const total = data.totalFlowUsd || 0;
          const formatted = Math.abs(total) >= 1e9 
            ? `${(total / 1e9).toFixed(1)}B` 
            : `${(total / 1e6).toFixed(0)}M`;
          totalEl.textContent = total >= 0 ? `+$${formatted}` : `-$${formatted.replace('-', '')}`;
          totalEl.className = total >= 0 
            ? 'text-[14px] font-bold font-mono mb-1 text-green-400' 
            : 'text-[14px] font-bold font-mono mb-1 text-red-400';
        }
        
        if (container && data.etfs?.length) {
          const maxFlow = Math.max(...data.etfs.map(e => Math.abs(e.flowUsd || e.flow24h * 98000 || 0)));
          container.innerHTML = data.etfs.slice(0, 4).map(etf => {
            const flow = etf.flowUsd || etf.flow24h * 98000 || 0;
            const pct = maxFlow > 0 ? Math.abs(flow) / maxFlow * 100 : 0;
            const color = flow >= 0 ? 'bg-green-500' : 'bg-red-500';
            const textColor = flow >= 0 ? 'text-green-400' : 'text-red-400';
            const formatted = Math.abs(flow) >= 1e6 ? `$${(flow / 1e6).toFixed(0)}M` : `$${(flow / 1e3).toFixed(0)}K`;
            
            return `
              <div class="flex justify-between items-center">
                <span class="text-zinc-400 w-10">${etf.name}</span>
                <div class="flex-1 mx-2 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                  <div class="h-full ${color} transition-all" style="width: ${pct}%"></div>
                </div>
                <span class="${textColor} w-14 text-right">${flow >= 0 ? '+' : ''}${formatted}</span>
              </div>
            `;
          }).join('');
        }
      }
      
      // =================================================================
      // TOP TRADER SENTIMENT
      // =================================================================
      async function fetchTopTraders() {
        try {
          const res = await fetch(`${API_BASE}/api/top-traders/${currentSymbol}`);
          const data = await res.json();
          
          if (data.success) {
            renderTopTraders(data);
            console.log('[TOP TRADERS] Updated:', data.divergence);
          }
        } catch (e) {
          console.error('[TOP TRADERS] Fetch error:', e);
        }
      }
      
      function renderTopTraders(data) {
        const signalEl = document.querySelector('[data-top-traders="signal"]');
        const whaleLongEl = document.querySelector('[data-top-traders="whale-long"]');
        const whaleBarEl = document.querySelector('[data-top-traders="whale-bar"]');
        const retailLongEl = document.querySelector('[data-top-traders="retail-long"]');
        const retailBarEl = document.querySelector('[data-top-traders="retail-bar"]');
        const divergenceEl = document.querySelector('[data-top-traders="divergence"]');
        
        const whales = data.topTraders || {};
        const retail = data.retail || {};
        
        if (signalEl) {
          signalEl.textContent = data.signal || '--';
          signalEl.className = data.signal === 'BULLISH' 
            ? 'text-green-400 font-bold' 
            : data.signal === 'BEARISH' 
              ? 'text-red-400 font-bold' 
              : 'text-zinc-400';
        }
        
        if (whaleLongEl) whaleLongEl.textContent = `${whales.long || 50}% L`;
        if (whaleBarEl) {
          whaleBarEl.style.width = `${whales.long || 50}%`;
          whaleBarEl.className = whales.long > 50 
            ? 'h-full bg-green-500 transition-all' 
            : 'h-full bg-red-500 transition-all';
        }
        
        if (retailLongEl) retailLongEl.textContent = `${retail.long || 50}% L`;
        if (retailBarEl) {
          retailBarEl.style.width = `${retail.long || 50}%`;
          retailBarEl.className = retail.long > 65 
            ? 'h-full bg-amber-500 transition-all' 
            : 'h-full bg-blue-500 transition-all';
        }
        
        if (divergenceEl) {
          const div = data.divergence || 'NONE';
          let divText = 'No divergence';
          let divClass = 'text-zinc-500';
          
          if (div === 'SMART_MONEY_LONG') {
            divText = 'Whales LONG vs Retail';
            divClass = 'text-green-400 font-bold';
          } else if (div === 'SMART_MONEY_SHORT') {
            divText = 'Whales SHORT vs Retail';
            divClass = 'text-red-400 font-bold';
          } else if (div === 'CROWDED_LONG') {
            divText = 'CROWDED LONG';
            divClass = 'text-amber-400 font-bold';
          } else if (div === 'CROWDED_SHORT') {
            divText = 'CROWDED SHORT';
            divClass = 'text-amber-400 font-bold';
          }
          
          divergenceEl.textContent = divText;
          divergenceEl.className = `mt-2 text-[8px] text-center py-1 px-2 rounded bg-zinc-900/50 border border-zinc-800/50 ${divClass}`;
        }
      }
      
      // =================================================================
      // OPTIONS MAX PAIN
      // =================================================================
      async function fetchOptions() {
        try {
          const res = await fetch(`${API_BASE}/api/options/${currentSymbol}`);
          const data = await res.json();
          
          if (data.success) {
            renderOptions(data);
            console.log('[OPTIONS] Updated:', data.maxPain);
          }
        } catch (e) {
          console.error('[OPTIONS] Fetch error:', e);
        }
      }
      
      function renderOptions(data) {
        const signalEl = document.querySelector('[data-options="signal"]');
        const maxPainEl = document.querySelector('[data-options="max-pain"]');
        const putCallEl = document.querySelector('[data-options="put-call"]');
        const distanceEl = document.querySelector('[data-options="distance"]');
        
        if (signalEl) {
          signalEl.textContent = data.signal || '--';
          signalEl.className = data.signal === 'BULLISH' 
            ? 'text-green-400' 
            : data.signal === 'BEARISH' 
              ? 'text-red-400' 
              : 'text-zinc-400';
        }
        
        if (maxPainEl) {
          maxPainEl.textContent = data.maxPain > 0 ? `$${data.maxPain.toLocaleString()}` : '--';
        }
        
        if (putCallEl) {
          const pc = data.putCallRatio || 0;
          putCallEl.textContent = pc > 0 ? pc.toFixed(2) : '--';
          putCallEl.className = pc < 0.9 
            ? 'text-green-400 font-bold' 
            : pc > 1.1 
              ? 'text-red-400 font-bold' 
              : 'text-white font-bold';
        }
        
        if (distanceEl && data.maxPain > 0 && lastPrice > 0) {
          const distance = ((data.maxPain - lastPrice) / lastPrice) * 100;
          distanceEl.textContent = `${distance >= 0 ? '+' : ''}${distance.toFixed(1)}% from current`;
          distanceEl.className = distance >= 0 
            ? 'mt-2 text-[8px] text-center py-1 bg-zinc-900/50 rounded border border-zinc-800/50 text-green-400' 
            : 'mt-2 text-[8px] text-center py-1 bg-zinc-900/50 rounded border border-zinc-800/50 text-red-400';
        }
      }
      
      // =================================================================
      // TAKER BUY/SELL
      // =================================================================
      async function fetchTakerRatio() {
        try {
          const res = await fetch(`${API_BASE}/api/taker-ratio/${currentSymbol}`);
          const data = await res.json();
          
          if (data.success) {
            renderTakerRatio(data);
            console.log('[TAKER] Updated:', data.netFlow);
          }
        } catch (e) {
          console.error('[TAKER] Fetch error:', e);
        }
      }
      
      function renderTakerRatio(data) {
        const signalEl = document.querySelector('[data-taker="signal"]');
        const buyBarEl = document.querySelector('[data-taker="buy-bar"]');
        const sellBarEl = document.querySelector('[data-taker="sell-bar"]');
        const buyPctEl = document.querySelector('[data-taker="buy-pct"]');
        const sellPctEl = document.querySelector('[data-taker="sell-pct"]');
        const netEl = document.querySelector('[data-taker="net"]');
        
        if (signalEl) {
          signalEl.textContent = data.signal || '--';
          signalEl.className = data.signal === 'BULLISH' 
            ? 'text-green-400' 
            : data.signal === 'BEARISH' 
              ? 'text-red-400' 
              : 'text-zinc-400';
        }
        
        const buyPct = data.buyPercent || 50;
        const sellPct = data.sellPercent || 50;
        
        if (buyBarEl) buyBarEl.style.width = `${buyPct}%`;
        if (sellBarEl) sellBarEl.style.width = `${sellPct}%`;
        if (buyPctEl) buyPctEl.textContent = `${buyPct.toFixed(0)}%`;
        if (sellPctEl) sellPctEl.textContent = `${sellPct.toFixed(0)}%`;
        
        if (netEl) {
          netEl.textContent = `NET: ${data.netFlow || 'NEUTRAL'}`;
          netEl.className = data.netFlow === 'BUY' 
            ? 'text-green-400 font-bold' 
            : data.netFlow === 'SELL' 
              ? 'text-red-400 font-bold' 
              : 'text-zinc-400 font-bold';
        }
      }
      
      // =================================================================
      // EXCHANGE NET FLOW
      // =================================================================
      async function fetchExchangeFlow() {
        try {
          const res = await fetch(`${API_BASE}/api/exchange-flow/${currentSymbol}?hours=24`);
          const data = await res.json();
          
          if (data.success) {
            renderExchangeFlow(data);
            console.log('[EX FLOW] Updated:', data.direction);
          }
        } catch (e) {
          console.error('[EX FLOW] Fetch error:', e);
        }
      }
      
      function renderExchangeFlow(data) {
        const signalEl = document.querySelector('[data-exflow="signal"]');
        const inflowsEl = document.querySelector('[data-exflow="inflows"]');
        const outflowsEl = document.querySelector('[data-exflow="outflows"]');
        const netEl = document.querySelector('[data-exflow="net"]');
        
        if (signalEl) {
          signalEl.textContent = data.signal || '--';
          signalEl.className = data.signal === 'BULLISH' 
            ? 'text-green-400 font-bold' 
            : data.signal === 'BEARISH' 
              ? 'text-red-400 font-bold' 
              : 'text-zinc-400';
        }
        
        if (inflowsEl) inflowsEl.textContent = data.inflowsFormatted || '--';
        if (outflowsEl) outflowsEl.textContent = data.outflowsFormatted || '--';
        
        if (netEl) {
          const dir = data.direction || 'NEUTRAL';
          netEl.textContent = `Net: ${data.netFlowFormatted || '--'} ${dir}`;
          netEl.className = dir === 'OUTFLOW' 
            ? 'mt-1 text-[9px] text-center py-1 bg-green-900/20 rounded border border-green-800/50 text-green-400 font-bold' 
            : 'mt-1 text-[9px] text-center py-1 bg-red-900/20 rounded border border-red-800/50 text-red-400 font-bold';
        }
      }
      
      // =================================================================
      // OI BY EXCHANGE
      // =================================================================
      async function fetchOIByExchange() {
        try {
          const res = await fetch(`${API_BASE}/api/oi-exchange/${currentSymbol}`);
          const data = await res.json();
          
          if (data.success && data.exchanges) {
            renderOIByExchange(data);
            console.log('[OI EXCHANGE] Updated:', data.totalOIFormatted);
          }
        } catch (e) {
          console.error('[OI EXCHANGE] Fetch error:', e);
        }
      }
      
      function renderOIByExchange(data) {
        const container = document.querySelector('[data-oi-exchange="container"]');
        if (!container || !data.exchanges?.length) return;
        
        const colors = ['bg-blue-500', 'bg-amber-500', 'bg-purple-500', 'bg-cyan-500', 'bg-pink-500'];
        
        container.innerHTML = data.exchanges.slice(0, 5).map((ex, i) => {
          const pct = ex.percentage || 0;
          const color = colors[i % colors.length];
          
          return `
            <div class="flex justify-between items-center">
              <span class="text-zinc-400 w-14 text-[7px]">${ex.exchange}</span>
              <div class="flex-1 mx-1 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                <div class="h-full ${color} transition-all" style="width: ${pct}%"></div>
              </div>
              <span class="text-zinc-300 w-12 text-right text-[7px]">${ex.oiFormatted || '--'}</span>
            </div>
          `;
        }).join('');
      }
      
      // =================================================================
      // FUNDING ARBITRAGE
      // =================================================================
      async function fetchFundingArb() {
        try {
          const res = await fetch(`${API_BASE}/api/funding-arb/${currentSymbol}`);
          const data = await res.json();
          
          if (data.success) {
            renderFundingArb(data);
            console.log('[FUND ARB] Updated:', data.spreadPercent);
          }
        } catch (e) {
          console.error('[FUND ARB] Fetch error:', e);
        }
      }
      
      function renderFundingArb(data) {
        const opportunityEl = document.querySelector('[data-fundarb="opportunity"]');
        const highestEl = document.querySelector('[data-fundarb="highest"]');
        const lowestEl = document.querySelector('[data-fundarb="lowest"]');
        const spreadEl = document.querySelector('[data-fundarb="spread"]');
        
        if (opportunityEl) {
          opportunityEl.textContent = data.arbOpportunity ? 'ARB!' : '--';
          opportunityEl.className = data.arbOpportunity 
            ? 'text-amber-400 font-bold animate-pulse' 
            : 'text-zinc-400';
        }
        
        if (highestEl && data.highestRate) {
          const rate = data.highestRate.ratePercent || 0;
          highestEl.textContent = `${data.highestRate.exchange} ${rate >= 0 ? '+' : ''}${rate.toFixed(3)}%`;
          highestEl.className = 'text-green-400';
        }
        
        if (lowestEl && data.lowestRate) {
          const rate = data.lowestRate.ratePercent || 0;
          lowestEl.textContent = `${data.lowestRate.exchange} ${rate >= 0 ? '+' : ''}${rate.toFixed(3)}%`;
          lowestEl.className = 'text-red-400';
        }
        
        if (spreadEl) {
          const spread = data.spreadPercent || 0;
          spreadEl.textContent = `${spread.toFixed(3)}%`;
          spreadEl.className = spread > 0.01 
            ? 'text-amber-400 font-bold' 
            : 'text-zinc-400';
        }
      }

      // Hide loading spinner for a panel
      function hideLoading(panelId) {
        const loading = document.getElementById(panelId);
        if (loading) loading.classList.add('hidden');
      }
      
      // Hide all loading spinners after initial data load
      function hideAllLoadingStates() {
        ['market-pulse-loading', 'orderflow-loading', 'onchain-loading', 'intelligence-loading', 'positions-loading'].forEach(hideLoading);
        console.log('[BASTION] All panels loaded');
      }

      // Start live data polling
      // HIGH-FREQUENCY MODE: 300 requests/min = 5/sec available
      function startLiveDataStream() {
        console.log('[BASTION] Starting HIGH-FREQUENCY data stream (300 req/min tier)...');
        
        // Fetch immediately - ALL data sources
        fetchLivePrice();
        fetchLiveMarketData().then(() => hideLoading('market-pulse-loading'));
        fetchLiveCVD().then(() => hideLoading('intelligence-loading'));
        fetchFundingRates();
        fetchOpenInterest();
        fetchFearGreed();
        fetchWhaleTransactions();
        fetchHeatmap();
        // New endpoints
        fetchETFFlows();
        fetchTopTraders();
        fetchOptions();
        fetchTakerRatio();
        fetchExchangeFlow();
        fetchOIByExchange();
        fetchFundingArb();
        // Neural intelligence panels
        fetchMMMagnet();
        fetchVolRegime();
        // New ultrawide panels
        fetchOnChain().then(() => hideLoading('onchain-loading'));
        fetchOrderFlow().then(() => hideLoading('orderflow-loading'));
        // Session & Risk panels
        fetchSession();
        fetchMacro();
        fetchKelly();
        // Monte Carlo now requires position selection - no auto-run

        // === PRICE === Every 1 second (critical for trading)
        setInterval(async () => {
          await fetchLivePrice();
          flashUpdate('live-indicator');
        }, 1000);
        
        // === CANDLES === Every 3 seconds (real-time chart)
        setInterval(updateLastCandle, 3000);

        // === MARKET INTEL === Every 3 seconds (Helsinki is free, no limit)
        setInterval(async () => {
          await fetchLiveMarketData();
        }, 3000);
        
        // === CVD === Every 4 seconds (order flow is critical)
        setInterval(fetchLiveCVD, 4000);
        
        // === OPEN INTEREST === Every 5 seconds
        setInterval(fetchOpenInterest, 5000);
        
        // === FUNDING RATES === Every 10 seconds (changes slowly)
        setInterval(fetchFundingRates, 10000);
        
        // === FEAR/GREED === Every 30 seconds (daily metric)
        setInterval(fetchFearGreed, 30000);
        
        // === WHALE TRANSACTIONS === Every 5 seconds (catch them fast!)
        setInterval(fetchWhaleTransactions, 11000); // Every 11 seconds = ~8000 calls/day (under 10k limit)
        
        // === LIQUIDATION HEATMAP === Every 3 seconds (liquidation clusters)
        setInterval(fetchHeatmap, 3000);
        
        // === NEW DATA STREAMS ===
        
        // === ETF FLOWS === Every 60 seconds (updates daily, institutional data)
        setInterval(fetchETFFlows, 60000);
        
        // === TOP TRADER SENTIMENT === Every 10 seconds (whale vs retail)
        setInterval(fetchTopTraders, 10000);
        
        // === OPTIONS MAX PAIN === Every 30 seconds (options data)
        setInterval(fetchOptions, 30000);
        
        // === TAKER BUY/SELL === Every 5 seconds (real-time flow)
        setInterval(fetchTakerRatio, 5000);
        
        // === EXCHANGE NET FLOW === Every 15 seconds (whale movements)
        setInterval(fetchExchangeFlow, 15000);
        
        // === OI BY EXCHANGE === Every 10 seconds (institutional tracking)
        setInterval(fetchOIByExchange, 10000);
        
        // === FUNDING ARBITRAGE === Every 15 seconds (arb opportunities)
        setInterval(fetchFundingArb, 15000);
        
        // === MM MAGNET === Every 10 seconds (market maker target estimation)
        setInterval(fetchMMMagnet, 10000);
        
        // === VOLATILITY REGIME === Every 30 seconds (regime changes slowly)
        setInterval(fetchVolRegime, 30000);
        
        // === ON-CHAIN INTEL === Every 30 seconds (blockchain data updates slowly)
        setInterval(fetchOnChain, 30000);
        
        // === ORDER FLOW === Every 3 seconds (real-time order book data)
        setInterval(fetchOrderFlow, 3000);
        
        // === SESSION ANALYSIS === Every 60 seconds (updates hourly essentially)
        setInterval(fetchSession, 60000);
        
        // === MACRO CORRELATION === Every 60 seconds (market correlations)
        setInterval(fetchMacro, 60000);
        
        // === KELLY CRITERION === Every 30 seconds (position sizing)
        setInterval(fetchKelly, 30000);
        
        // === LIVE NEWS === Every 60 seconds (breaking news)
        setInterval(fetchLiveNews, 60000);

        // Update timestamp every second
        setInterval(() => {
          const timeEl = document.querySelector('[data-time="utc"]');
          if (timeEl) {
            const now = new Date();
            timeEl.textContent = now.toISOString().slice(11, 19) + ' UTC';
          }
        }, 1000);
        
        console.log('[BASTION] HIGH-FREQUENCY stream ACTIVE! (All 14 data streams running)');
      }

      // =================================================================
      // INITIALIZATION
      // =================================================================
      async function initializeTerminal() {
        console.log('BASTION Terminal initializing...');
        
        // Fetch available symbols first
        await fetchSymbols();
        
        // Initialize chart
        initChart();
        
        // Connect WebSocket for real-time updates
        connectWebSocket();
        
        // Fetch initial data
        await Promise.all([
          fetchPositions(),
          fetchSessionStats(),
          fetchMarketData(currentSymbol),
          fetchAlerts(),
          fetchLiveNews()
        ]);
        
        // Start live data streaming
        startLiveDataStream();
        
        console.log('BASTION Terminal LIVE!');
      }

      // Start!
      document.addEventListener('DOMContentLoaded', initializeTerminal);
    </script>

    <div class="fixed bottom-4 right-4 z-50 text-[10px] font-mono text-zinc-600 bg-black/80 px-2 py-1 border border-zinc-800 rounded pointer-events-none">
      Press
      <span class="text-zinc-300">?</span>
      for keyboard shortcuts
    </div>

    <!-- EXPANDED AI CHAT MODAL -->
    <div id="neural-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[100] hidden">
      <div class="absolute inset-4 lg:inset-10 bg-[#0A0A0A] border border-crimson-600/50 rounded-lg flex overflow-hidden shadow-[0_0_50px_rgba(220,38,38,0.3)]">
        <!-- Left: Chat History -->
        <div class="flex-1 flex flex-col border-r border-zinc-800">
          <div class="p-4 border-b border-zinc-800 flex justify-between items-center">
            <div class="flex items-center gap-2">
              <iconify-icon icon="solar:magic-stick-3-bold" class="text-crimson-500 text-xl"></iconify-icon>
              <span class="text-white font-bold">ASK BASTION</span>
              <span class="text-[9px] bg-crimson-600 text-white px-2 py-0.5 rounded animate-pulse">AI ASSISTANT</span>
            </div>
            <button id="close-neural-modal" class="text-zinc-500 hover:text-white transition-colors p-1">
              <iconify-icon icon="solar:close-circle-linear" class="text-xl"></iconify-icon>
            </button>
          </div>
          
          <!-- Chat Messages -->
          <div id="neural-chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar">
            <div class="text-center text-zinc-600 text-[11px] py-8">
              <iconify-icon icon="solar:chat-round-dots-linear" class="text-3xl mb-2"></iconify-icon>
              <div>Ask BASTION about your positions, market analysis, or risk management.</div>
              <div class="text-zinc-700 mt-1">Your positions are automatically included in the context.</div>
            </div>
          </div>
          
          <!-- Chat Input -->
          <div class="p-4 border-t border-zinc-800">
            <div class="flex gap-2">
              <input id="neural-modal-input" type="text" placeholder="Ask about your positions, market analysis, or risk..." class="flex-1 bg-zinc-900 border border-zinc-800 text-[12px] text-white px-4 py-3 focus:border-crimson-600 focus:outline-none placeholder-zinc-600 font-mono rounded">
              <button id="neural-modal-send" class="bg-crimson-600 hover:bg-crimson-700 text-white px-6 py-3 rounded font-bold text-[11px] transition-colors">
                <iconify-icon icon="solar:plain-bold" class="mr-1"></iconify-icon>SEND
              </button>
            </div>
            <div class="flex gap-2 mt-2">
              <button class="quick-prompt text-[9px] px-3 py-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white rounded transition-colors" data-prompt="Analyze my current positions">📊 Analyze positions</button>
              <button class="quick-prompt text-[9px] px-3 py-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white rounded transition-colors" data-prompt="What's the current market bias for BTC?">🎯 BTC market bias</button>
              <button class="quick-prompt text-[9px] px-3 py-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white rounded transition-colors" data-prompt="What are the key risk levels I should watch?">⚠️ Risk levels</button>
              <button class="quick-prompt text-[9px] px-3 py-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white rounded transition-colors" data-prompt="Suggest position adjustments based on current market conditions">🔄 Suggest adjustments</button>
            </div>
          </div>
        </div>
        
        <!-- Right: Context Panel -->
        <div class="w-80 bg-[#0B0B0B] flex flex-col">
          <div class="p-4 border-b border-zinc-800">
            <div class="text-[11px] text-zinc-400 uppercase tracking-wider mb-2">POSITION CONTEXT</div>
            <div id="modal-position-context" class="space-y-2">
              <!-- Positions loaded here -->
              <div class="text-[10px] text-zinc-600">Loading positions...</div>
            </div>
          </div>
          
          <div class="p-4 border-b border-zinc-800">
            <div class="text-[11px] text-zinc-400 uppercase tracking-wider mb-2">DATA SOURCES</div>
            <div class="space-y-1">
              <div class="flex items-center gap-2 text-[10px]">
                <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                <span class="text-zinc-400">Helsinki VM (CVD, Volatility)</span>
              </div>
              <div class="flex items-center gap-2 text-[10px]">
                <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                <span class="text-zinc-400">Coinglass (OI, Funding)</span>
              </div>
              <div class="flex items-center gap-2 text-[10px]">
                <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                <span class="text-zinc-400">Whale Alert</span>
              </div>
              <div class="flex items-center gap-2 text-[10px]">
                <span class="w-1.5 h-1.5 bg-amber-500 rounded-full"></span>
                <span class="text-zinc-400">Exchange Positions</span>
              </div>
            </div>
          </div>
          
          <div class="flex-1 p-4 overflow-y-auto no-scrollbar">
            <div class="text-[11px] text-zinc-400 uppercase tracking-wider mb-2">RECENT INSIGHTS</div>
            <div id="modal-recent-insights" class="space-y-2">
              <div class="text-[10px] text-zinc-600 bg-zinc-900/50 p-2 rounded border border-zinc-800/50">
                <span class="text-crimson-500">⚡</span> CVD divergence detected on BTC 4H
              </div>
              <div class="text-[10px] text-zinc-600 bg-zinc-900/50 p-2 rounded border border-zinc-800/50">
                <span class="text-green-500">📈</span> Smart money bias shifted bullish
              </div>
              <div class="text-[10px] text-zinc-600 bg-zinc-900/50 p-2 rounded border border-zinc-800/50">
                <span class="text-amber-500">⚠️</span> Funding rate elevated (0.08%)
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Expanded Neural Modal Functionality
      (function() {
        const modal = document.getElementById('neural-modal');
        const closeBtn = document.getElementById('close-neural-modal');
        const expandBtn = document.querySelector('[data-action="expand-neural"]');
        const modalInput = document.getElementById('neural-modal-input');
        const modalSend = document.getElementById('neural-modal-send');
        const chatHistory = document.getElementById('neural-chat-history');
        const positionContext = document.getElementById('modal-position-context');
        const quickPrompts = document.querySelectorAll('.quick-prompt');
        
        // Open modal
        if (expandBtn) {
          expandBtn.addEventListener('click', () => {
            modal.classList.remove('hidden');
            modalInput.focus();
            loadPositionContext();
          });
        }
        
        // Also open with Space key (already handled in keyboard shortcuts)
        
        // Close modal
        closeBtn.addEventListener('click', () => {
          modal.classList.add('hidden');
        });
        
        // Close on escape
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            modal.classList.add('hidden');
          }
        });
        
        // Close on backdrop click
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.add('hidden');
          }
        });
        
        // Send message
        async function sendMessage(query) {
          if (!query.trim()) return;
          
          // Add user message to chat
          addMessage('user', query);
          modalInput.value = '';
          
          // Extract symbol from query or use current selected symbol
          const symbolMatch = query.toUpperCase().match(/\b(BTC|ETH|SOL|BNB|XRP|AVAX|LINK|ARB|OP|DOGE|ADA|MATIC|DOT|ATOM)\b/);
          const symbol = symbolMatch ? symbolMatch[1] : currentSymbol;
          
          // Show typing indicator
          const typingId = addMessage('assistant', '<span class="animate-pulse">Thinking...</span>', true);
          
          try {
            const res = await fetch(`${API_BASE}/api/neural/chat`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                query: query,
                symbol: symbol,
                include_positions: true
              })
            });
            
            const data = await res.json();
            
            // Remove typing indicator
            document.getElementById(typingId)?.remove();
            
            if (data.success) {
              addMessage('assistant', data.response);
              
              // Update small neural response too
              const smallResponse = document.querySelector('[data-neural="response"]');
              if (smallResponse) {
                smallResponse.innerHTML = `<span class="text-crimson-500">&gt;&gt;</span> ${data.response.split('\n')[0].substring(0, 100)}...`;
              }
            } else {
              addMessage('assistant', 'Sorry, I encountered an error processing your request.');
            }
          } catch (e) {
            console.error('Neural chat error:', e);
            document.getElementById(typingId)?.remove();
            addMessage('assistant', 'Connection error. Please try again.');
          }
        }
        
        function addMessage(role, content, isTyping = false) {
          const id = 'msg-' + Date.now();
          const msgDiv = document.createElement('div');
          msgDiv.id = id;
          msgDiv.className = role === 'user' 
            ? 'flex justify-end'
            : 'flex justify-start';
          
          const bubble = document.createElement('div');
          bubble.className = role === 'user'
            ? 'max-w-[80%] bg-crimson-600/20 border border-crimson-600/30 text-white text-[11px] px-4 py-2 rounded-lg'
            : 'max-w-[80%] bg-zinc-900 border border-zinc-800 text-zinc-300 text-[11px] px-4 py-2 rounded-lg font-mono whitespace-pre-wrap';
          
          bubble.innerHTML = content;
          msgDiv.appendChild(bubble);
          
          // Remove empty state if present
          const emptyState = chatHistory.querySelector('.text-center');
          if (emptyState) emptyState.remove();
          
          chatHistory.appendChild(msgDiv);
          chatHistory.scrollTop = chatHistory.scrollHeight;
          
          return id;
        }
        
        async function loadPositionContext() {
          try {
            const res = await fetch(`${API_BASE}/api/positions/all?${getAuthParams()}`);
            const data = await res.json();
            
            if (data.positions && data.positions.length > 0) {
              positionContext.innerHTML = data.positions.map(p => `
                <div class="bg-zinc-900/50 border border-zinc-800/50 rounded p-2">
                  <div class="flex justify-between items-center">
                    <span class="text-[10px] font-bold ${p.direction === 'long' ? 'text-green-400' : 'text-crimson-400'}">
                      ${p.symbol} ${p.direction.toUpperCase()}
                    </span>
                    <span class="text-[9px] ${p.pnl_pct >= 0 ? 'text-green-400' : 'text-crimson-400'}">
                      ${p.pnl_pct >= 0 ? '+' : ''}${p.pnl_pct?.toFixed(2) || 0}%
                    </span>
                  </div>
                  <div class="text-[9px] text-zinc-500 mt-1">
                    Entry: $${p.entry_price?.toLocaleString() || 'N/A'} → $${p.current_price?.toLocaleString() || 'N/A'}
                  </div>
                </div>
              `).join('');
            } else {
              positionContext.innerHTML = `
                <div class="text-[10px] text-zinc-600 text-center py-4">
                  <iconify-icon icon="solar:link-broken-linear" class="text-lg mb-1"></iconify-icon>
                  <div>No positions loaded</div>
                  <a href="/account" class="text-crimson-400 hover:underline">Connect exchange</a>
                </div>
              `;
            }
          } catch (e) {
            console.error('Error loading positions:', e);
          }
        }
        
        // Send on button click
        modalSend.addEventListener('click', () => {
          sendMessage(modalInput.value);
        });
        
        // Send on enter
        modalInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            sendMessage(modalInput.value);
          }
        });
        
        // Quick prompts
        quickPrompts.forEach(btn => {
          btn.addEventListener('click', () => {
            const prompt = btn.dataset.prompt;
            modalInput.value = prompt;
            sendMessage(prompt);
          });
        });
      })();
    </script>

    <!-- LIVE POSITIONS PANEL -->
    <script>
    (function() {
      const positionsContainer = document.getElementById('positions-container');
      const positionsCount = document.getElementById('positions-count');
      const positionsLoading = document.getElementById('positions-loading');
      const positionsEmpty = document.getElementById('positions-empty');
      const totalExposure = document.getElementById('total-exposure');
      const totalPnl = document.getElementById('total-pnl');
      const connectedExchange = document.getElementById('connected-exchange');
      const refreshBtn = document.getElementById('refresh-positions-btn');
      
      let exchangeConnections = {};

      // Auto-connect exchanges from localStorage and load positions
      async function loadAndAutoConnectExchanges() {
        const stored = localStorage.getItem('bastion_exchange_credentials');
        
        if (stored) {
          try {
            const credentials = JSON.parse(stored);
            console.log('[POSITIONS] Found stored credentials for:', Object.keys(credentials));
            
            for (const [exchange, creds] of Object.entries(credentials)) {
              try {
                const payload = {
                  exchange: exchange,
                  api_key: creds.apiKey,
                  api_secret: creds.apiSecret,
                  passphrase: creds.passphrase || '',
                  read_only: creds.readOnly !== false
                };
                
                console.log(`[POSITIONS] Auto-connecting ${exchange}...`);
                const res = await fetch('/api/exchange/connect', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
                });
                
                if (res.ok) {
                  const data = await res.json();
                  if (data.success || data.balance !== undefined) {
                    exchangeConnections[exchange] = true;
                    console.log(`[POSITIONS] ✓ Connected ${exchange}`);
                  }
                }
              } catch (e) {
                console.error(`[POSITIONS] Failed to auto-connect ${exchange}:`, e);
              }
            }
          } catch (e) {
            console.error('[POSITIONS] Error parsing stored credentials:', e);
          }
        } else {
          console.log('[POSITIONS] No stored exchange credentials, checking server session...');
        }
        
        // ALWAYS load positions (they may exist on server via session)
        await loadPositions();
      }
      
      // Load positions from API
      async function loadPositions() {
        console.log('[POSITIONS] Fetching positions...');
        
        try {
          const res = await fetch(`/api/positions/all?${getAuthParams()}`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          
          const data = await res.json();
          console.log('[POSITIONS] API response:', data);
          
          // Hide loading
          if (positionsLoading) positionsLoading.classList.add('hidden');
          
          const positions = data.positions || [];
          
          // Update count
          if (positionsCount) positionsCount.textContent = positions.length;
          
          // Show empty state or render positions
          if (positions.length === 0) {
            if (positionsEmpty) positionsEmpty.classList.remove('hidden');
            if (totalExposure) totalExposure.textContent = '$0';
            if (totalPnl) totalPnl.textContent = '$0';
            if (connectedExchange) {
              const exchanges = Object.keys(exchangeConnections);
              connectedExchange.textContent = exchanges.length > 0 ? exchanges.join(', ') : '--';
            }
            return;
          }
          
          // Hide empty state
          if (positionsEmpty) positionsEmpty.classList.add('hidden');
          
          // Calculate totals
          let exposure = 0;
          let unrealizedPnl = 0;
          const exchangeSet = new Set();
          
          positions.forEach(p => {
            // Use size_usd if available, otherwise calculate from size * price
            const sizeUsd = parseFloat(p.size_usd) || 0;
            if (sizeUsd > 0) {
              exposure += Math.abs(sizeUsd);
            } else {
              const size = parseFloat(p.size) || 0;
              const price = parseFloat(p.current_price || p.entry_price) || 0;
              exposure += Math.abs(size * price);
            }
            unrealizedPnl += parseFloat(p.pnl || p.unrealized_pnl) || 0;
            if (p.exchange) exchangeSet.add(p.exchange);
          });
          
          // Update footer stats
          if (totalExposure) totalExposure.textContent = '$' + exposure.toLocaleString(undefined, {maximumFractionDigits: 0});
          if (totalPnl) {
            totalPnl.textContent = (unrealizedPnl >= 0 ? '+' : '') + '$' + unrealizedPnl.toLocaleString(undefined, {maximumFractionDigits: 2});
            totalPnl.className = unrealizedPnl >= 0 ? 'text-green-500' : 'text-red-500';
          }
          if (connectedExchange) {
            connectedExchange.textContent = [...exchangeSet].join(', ') || '--';
          }
          
          // Render position cards
          renderPositions(positions);
          
          // Update simulator dropdown
          if (typeof updateSimulatorPositions === 'function') {
            updateSimulatorPositions(positions);
          }
          
          // Recalculate session stats from loaded positions
          if (typeof calculateSessionStatsFromPositions === 'function') {
            cachedPositions = positions;
            calculateSessionStatsFromPositions();
          }
          
        } catch (e) {
          console.error('[POSITIONS] Error loading positions:', e);
          if (positionsLoading) positionsLoading.classList.add('hidden');
          if (positionsEmpty) {
            positionsEmpty.classList.remove('hidden');
            positionsEmpty.innerHTML = `
              <div class="text-center py-6 text-zinc-600 text-[10px] font-mono">
                <iconify-icon icon="solar:danger-triangle-linear" class="text-2xl mb-2 text-red-500"></iconify-icon>
                <div class="text-red-400 mb-1">Error loading positions</div>
                <div class="text-[9px]">${e.message}</div>
              </div>
            `;
          }
        }
      }
      
      // Render position cards
      function renderPositions(positions) {
        // Remove loading/empty, keep them but clear position cards
        const existingCards = positionsContainer.querySelectorAll('.position-card');
        existingCards.forEach(card => card.remove());
        
        positions.forEach(pos => {
          // Handle both API field names (direction/pnl/pnl_pct) and alternate names (side/unrealized_pnl/pnl_percent)
          const direction = pos.direction || pos.side || '';
          const isLong = direction.toLowerCase() === 'long' || direction.toLowerCase() === 'buy';
          const pnl = parseFloat(pos.pnl || pos.unrealized_pnl) || 0;
          const pnlPercent = parseFloat(pos.pnl_pct || pos.pnl_percent) || 0;
          const isProfitable = pnl >= 0;
          
          const sideColor = isLong ? 'green' : 'red';
          const pnlColor = isProfitable ? 'green' : 'red';
          
          // Determine bar width based on PnL (max 100%)
          const barWidth = Math.min(Math.abs(pnlPercent) * 10, 100);
          
          // Green glow for profitable positions, red glow for losing
          const cardGlow = isProfitable 
            ? 'shadow-[0_0_20px_rgba(34,197,94,0.25)] border-green-500/30' 
            : 'shadow-[0_0_20px_rgba(220,38,38,0.15)] border-red-500/20';
          
          const card = document.createElement('div');
          card.className = `position-card bg-[#141414] border p-3 hover:border-zinc-500/50 transition-all duration-300 relative group ${cardGlow}`;
          
          card.innerHTML = `
            <div class="absolute left-0 top-0 bottom-0 w-[2px] bg-${sideColor}-500 shadow-[0_0_8px_rgba(${isLong ? '34,197,94' : '239,68,68'},0.4)]"></div>
            <div class="flex justify-between items-start mb-2">
              <span class="font-bold text-white text-xs tracking-tight">
                ${pos.symbol || 'Unknown'}
              </span>
              <span class="text-${sideColor}-500 text-[10px] font-bold">
                ${isLong ? 'LONG ▲' : 'SHORT ▼'}
              </span>
            </div>
            <div class="grid grid-cols-2 gap-y-1 text-[10px] font-mono text-zinc-500 mb-3">
              <span>ENTRY</span>
              <span class="text-right text-zinc-300">$${parseFloat(pos.entry_price || 0).toLocaleString(undefined, {maximumFractionDigits: 2})}</span>
              <span>CURRENT</span>
              <span class="text-right text-${pnlColor}-500">
                $${parseFloat(pos.current_price || pos.entry_price || 0).toLocaleString(undefined, {maximumFractionDigits: 2})} (${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%)
              </span>
              <span>SIZE</span>
              <span class="text-right text-zinc-300">${parseFloat(pos.size || 0).toFixed(4)}</span>
            </div>
            <div class="w-full bg-zinc-900 h-1.5 mb-1 rounded-full overflow-hidden">
              <div class="bg-${pnlColor}-600 h-full relative" style="width: ${barWidth}%"></div>
            </div>
            <div class="text-[9px] text-${pnlColor}-500 text-right mb-2 font-bold">
              ${isProfitable ? '+' : ''}$${pnl.toFixed(2)} PnL
            </div>
            ${pos.leverage ? `
            <div class="text-[9px] font-mono text-zinc-500 border-t border-zinc-800/50 pt-2">
              <div class="flex justify-between">
                <span>LEVERAGE</span>
                <span class="text-white">${pos.leverage}x</span>
              </div>
              ${pos.exchange ? `
              <div class="flex justify-between mt-1">
                <span>EXCHANGE</span>
                <span class="text-zinc-400">${pos.exchange}</span>
              </div>
              ` : ''}
            </div>
            ` : ''}
          `;
          
          positionsContainer.appendChild(card);
        });
      }
      
      // Refresh button
      if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
          refreshBtn.querySelector('iconify-icon')?.classList.add('animate-spin');
          loadPositions().finally(() => {
            setTimeout(() => {
              refreshBtn.querySelector('iconify-icon')?.classList.remove('animate-spin');
            }, 500);
          });
        });
      }
      
      // Initialize on page load
      document.addEventListener('DOMContentLoaded', async () => {
        await loadAndAutoConnectExchanges();
        
        // Auto-refresh every 30 seconds
        setInterval(loadPositions, 30000);
        
        // Load corner GIF if user has one
        loadCornerGif();
      });
    })();
    
    // =====================================================
    // CORNER GIF PERSONALIZATION
    // =====================================================
    function loadCornerGif() {
      const gifUrl = localStorage.getItem('cornerGif');
      if (!gifUrl) return;
      
      // Get settings
      let settings = { position: 'bottom-right', size: 'medium', opacity: 80 };
      try {
        const saved = localStorage.getItem('cornerGifSettings');
        if (saved) settings = JSON.parse(saved);
      } catch (e) {}
      
      // Create container if doesn't exist
      let container = document.getElementById('corner-gif-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'corner-gif-container';
        container.className = 'fixed z-50 pointer-events-none';
        document.body.appendChild(container);
      }
      
      // Position
      container.style.top = '';
      container.style.bottom = '';
      container.style.left = '';
      container.style.right = '';
      
      switch (settings.position) {
        case 'bottom-right':
          container.style.bottom = '80px';
          container.style.right = '20px';
          break;
        case 'bottom-left':
          container.style.bottom = '80px';
          container.style.left = '20px';
          break;
        case 'top-right':
          container.style.top = '80px';
          container.style.right = '20px';
          break;
        case 'top-left':
          container.style.top = '80px';
          container.style.left = '20px';
          break;
      }
      
      // Size
      let sizePx = 80;
      switch (settings.size) {
        case 'small': sizePx = 50; break;
        case 'medium': sizePx = 80; break;
        case 'large': sizePx = 120; break;
      }
      
      // Opacity
      const opacity = (settings.opacity || 80) / 100;
      
      container.innerHTML = `
        <img src="${gifUrl}" 
             style="width: ${sizePx}px; height: ${sizePx}px; object-fit: contain; opacity: ${opacity};"
             alt="Custom GIF">
      `;
    }
    
    // Listen for storage changes (if user updates in another tab)
    window.addEventListener('storage', (e) => {
      if (e.key === 'cornerGif' || e.key === 'cornerGifSettings') {
        loadCornerGif();
      }
      if (e.key === 'bastion_token' || e.key === 'bastion_user') {
        loadUserProfile();
      }
    });
    
    // =====================================================
    // USER PROFILE LOADING
    // =====================================================
    async function loadUserProfile() {
      const token = localStorage.getItem('bastion_token') || sessionStorage.getItem('bastion_token');
      const cachedUser = localStorage.getItem('bastion_user') || sessionStorage.getItem('bastion_user');
      
      const avatarLetter = document.getElementById('header-avatar-letter');
      const avatarImg = document.getElementById('header-avatar-img');
      const username = document.getElementById('header-username');
      const userStatus = document.getElementById('header-user-status');
      const headerGifMini = document.getElementById('header-gif-mini');
      const headerGifImg = document.getElementById('header-gif-img');
      
      // Load avatar from localStorage
      const avatarUrl = localStorage.getItem('userAvatar');
      if (avatarUrl && avatarImg) {
        avatarImg.src = avatarUrl;
        avatarImg.classList.remove('hidden');
        if (avatarLetter) avatarLetter.classList.add('hidden');
      }
      
      // Load mini GIF preview
      const gifUrl = localStorage.getItem('cornerGif');
      if (gifUrl && headerGifMini && headerGifImg) {
        headerGifImg.src = gifUrl;
        headerGifMini.classList.remove('hidden');
      }
      
      // If user has cached profile
      if (cachedUser) {
        try {
          const user = JSON.parse(cachedUser);
          if (username) username.textContent = user.display_name || user.email?.split('@')[0] || 'Trader';
          if (avatarLetter && !avatarUrl) {
            avatarLetter.textContent = (user.display_name || user.email || 'T').charAt(0).toUpperCase();
          }
          if (userStatus) userStatus.textContent = 'Logged in';
          userStatus?.classList.remove('text-zinc-500');
          userStatus?.classList.add('text-green-500');
        } catch (e) {}
      }
      
      // If logged in, verify with server and load cloud data
      if (token) {
        try {
          const res = await fetch(`${API_BASE}/api/auth/me?token=${token}`);
          const data = await res.json();
          
          if (data.success && data.user) {
            // Update UI with fresh data
            if (username) username.textContent = data.user.display_name || data.user.email?.split('@')[0] || 'Trader';
            if (avatarLetter && !avatarUrl) {
              avatarLetter.textContent = (data.user.display_name || data.user.email || 'T').charAt(0).toUpperCase();
            }
            if (userStatus) {
              userStatus.textContent = 'Synced';
              userStatus.classList.remove('text-zinc-500');
              userStatus.classList.add('text-green-500');
            }
            
            // Load avatar from cloud if available
            if (data.user.avatar) {
              localStorage.setItem('userAvatar', data.user.avatar);
              if (avatarImg) {
                avatarImg.src = data.user.avatar;
                avatarImg.classList.remove('hidden');
                if (avatarLetter) avatarLetter.classList.add('hidden');
              }
            }
            
            // Load corner GIF from cloud if available
            if (data.user.corner_gif) {
              localStorage.setItem('cornerGif', data.user.corner_gif);
              if (headerGifMini && headerGifImg) {
                headerGifImg.src = data.user.corner_gif;
                headerGifMini.classList.remove('hidden');
              }
              // Apply the corner GIF to the terminal
              loadCornerGif();
            }
            
            // Load corner GIF settings from cloud
            if (data.user.corner_gif_settings) {
              localStorage.setItem('cornerGifSettings', JSON.stringify(data.user.corner_gif_settings));
              loadCornerGif();
            }
            
            // Update connected exchange indicator
            updateExchangeIndicator();
            
            // Load exchanges from cloud (if not already loaded from localStorage)
            await loadCloudExchanges(token);
          }
        } catch (e) {
          console.log('[USER] Could not verify session:', e);
        }
      } else {
        // Guest mode
        if (username) username.textContent = 'Guest';
        if (userStatus) {
          userStatus.textContent = 'Not logged in';
          userStatus.classList.remove('text-green-500');
          userStatus.classList.add('text-zinc-500');
        }
        if (avatarLetter) avatarLetter.textContent = '?';
      }
    }
    
    // Update exchange indicator based on connected exchanges
    async function updateExchangeIndicator() {
      const exchangeName = document.getElementById('connected-exchange-name');
      
      // First check localStorage
      const saved = localStorage.getItem('bastion_exchange_credentials');
      if (saved) {
        try {
          const exchanges = Object.keys(JSON.parse(saved));
          if (exchanges.length > 0) {
            if (exchanges.length === 1) {
              exchangeName.textContent = exchanges[0].toUpperCase();
            } else {
              exchangeName.textContent = 'MULTI-EXCHANGE';
            }
            return;
          }
        } catch (e) {}
      }
      
      // Also check the API for session-based connections
      try {
        const res = await fetch(`/api/exchange/list?${getAuthParams()}`);
        const data = await res.json();
        if (data.success && data.exchanges && data.exchanges.length > 0) {
          const names = data.exchanges.map(e => e.exchange);
          if (names.length === 1) {
            exchangeName.textContent = names[0].toUpperCase();
          } else {
            exchangeName.textContent = 'MULTI-EXCHANGE';
          }
          return;
        }
      } catch (e) {
        console.log('[EXCHANGE] Could not fetch exchange list:', e);
      }
      
      exchangeName.textContent = 'NO EXCHANGE';
    }
    
    // Load exchanges from Supabase cloud
    async function loadCloudExchanges(token) {
      try {
        const res = await fetch(`${API_BASE}/api/auth/load-exchanges`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });
        const data = await res.json();
        
        if (data.success && data.loaded > 0) {
          console.log(`[CLOUD] Loaded ${data.loaded} exchanges from cloud:`, data.exchanges);
          updateExchangeIndicator();
        }
      } catch (e) {
        console.log('[CLOUD] Could not load cloud exchanges:', e);
      }
    }
    
    // Initialize user profile on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadUserProfile();
    });
    </script>
  
</body></html>
</body></html>